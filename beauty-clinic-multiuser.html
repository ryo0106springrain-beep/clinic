<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ–½è¡“å®¤ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰ˆï¼‰</title>
    <style>
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: #667eea;
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 5px;
            margin: 20px;
            display: none;
        }

        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-icon {
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        .sync-icon.synced {
            animation: none;
            border-color: #48bb78;
            position: relative;
        }

        .sync-icon.synced::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #48bb78;
            font-size: 12px;
        }

        .sync-icon.error {
            animation: none;
            border-color: #f56565;
        }

        .user-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .active-users {
            font-size: 12px;
            color: #666;
        }

        .user-list {
            margin-top: 5px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            margin: 2px 0;
        }

        .user-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="errorMessage" class="error-message"></div>

    <!-- åŒæœŸçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="sync-indicator">
        <div class="sync-status">
            <div id="syncIcon" class="sync-icon synced"></div>
            <div id="syncText">åŒæœŸæ¸ˆã¿</div>
        </div>
        <div style="font-size: 10px; color: #999; margin-top: 5px;">
            æœ€çµ‚åŒæœŸ: <span id="lastSync">-</span>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º -->
    <div class="user-indicator">
        <div class="active-users">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
        <div id="userList" class="user-list">
            <div class="user-item">
                <div class="user-status-dot"></div>
                <span>ã‚ãªãŸï¼ˆç«¯æœ«1ï¼‰</span>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã“ã“ã«å‹•çš„ã«æŒ¿å…¥ -->
    <div id="mainContent"></div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¯ãƒ©ã‚¹
        class DataManager {
            constructor() {
                this.appointments = [];
                this.patients = [];
                this.staff = [];
                this.treatments = [];
                this.devices = [];
                this.settings = {};
                this.lastSyncTime = null;
                this.lastModified = null;
                this.syncInterval = 5000; // 5ç§’ã”ã¨ã«åŒæœŸ
                this.syncTimer = null;
                this.clientId = this.generateClientId();
                
                // JSONBin.ioè¨­å®š
                this.binId = '68ba4a4a43b1c97be9373a5f'; // å®Ÿéš›ã®Bin ID
                this.apiKey = '$2a$10$rUJlLkq4wOYmc5W3nJ7I1epb3PqfDqG7TIy6mcdtkZKcuxUiKO46m'; // å®Ÿéš›ã®APIã‚­ãƒ¼
                this.baseUrl = 'https://api.jsonbin.io/v3/b/';
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
                this.debugMode = true;
            }

            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDç”Ÿæˆ
            generateClientId() {
                return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸèª­ã¿è¾¼ã¿ï¼ˆJSONBin.ioã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ï¼‰
            async loadAllData() {
                try {
                    console.log('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
                    
                    // ã¾ãšã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const onlineData = await this.loadFromOnline();
                    
                    if (onlineData) {
                        console.log('ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                        this.appointments = onlineData.appointments || [];
                        this.patients = onlineData.patients || [];
                        this.staff = onlineData.staff || [];
                        this.treatments = onlineData.treatments || [];
                        this.settings = onlineData.settings || {};
                        this.lastModified = onlineData.lastModified;
                    } else {
                        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å–å¾—å¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        console.log('ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«/ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                        await this.loadFromLocal();
                    }
                    
                    this.lastSyncTime = new Date();
                    this.updateSyncStatus('synced');
                    return true;
                } catch (error) {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    this.showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    return false;
                }
            }

            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            async loadFromOnline() {
                try {
                    this.updateSyncStatus('syncing');
                    const response = await fetch(`${this.baseUrl}${this.binId}/latest`, {
                        headers: {
                            'X-Master-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('ğŸ“¡ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
                        return result.record;
                    }
                    return null;
                } catch (error) {
                    console.warn('âš ï¸ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            async loadFromLocal() {
                const dataFiles = [
                    { name: 'appointments', file: 'appointments.json' },
                    { name: 'patients', file: 'patients.json' },
                    { name: 'staff', file: 'staff.json' },
                    { name: 'treatments', file: 'treatments.json' },
                    { name: 'settings', file: 'settings.json' }
                ];
                
                for (const dataFile of dataFiles) {
                    try {
                        // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰
                        const localData = localStorage.getItem(`clinic_${dataFile.name}`);
                        if (localData) {
                            this[dataFile.name] = JSON.parse(localData);
                            console.log(`ğŸ“± ${dataFile.name}ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿`);
                        } else {
                            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
                            const response = await fetch('./data/' + dataFile.file);
                            if (response.ok) {
                                this[dataFile.name] = await response.json();
                                console.log(`ğŸ“ ${dataFile.name}ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿`);
                            } else {
                                this.setDefaultData(dataFile.name);
                            }
                        }
                    } catch (error) {
                        console.warn(`âš ï¸ ${dataFile.name}èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
                        this.setDefaultData(dataFile.name);
                    }
                }
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®š
            setDefaultData(dataType) {
                switch(dataType) {
                    case 'appointments':
                        this.appointments = [];
                        break;
                    case 'patients':
                        this.patients = [];
                        break;
                    case 'staff':
                        this.staff = [
                            { id: 'N001', name: 'ç”°ä¸­çœ‹è­·å¸«', type: 'nurse' },
                            { id: 'N002', name: 'å±±ç”°çœ‹è­·å¸«', type: 'nurse' }
                        ];
                        break;
                    case 'treatments':
                        this.treatments = [
                            { id: 'T001', name: 'ãƒ•ã‚§ã‚¤ã‚·ãƒ£ãƒ«', duration: 60 },
                            { id: 'T002', name: 'ãƒœãƒˆãƒƒã‚¯ã‚¹', duration: 30 }
                        ];
                        break;
                    case 'settings':
                        this.settings = {
                            businessHours: { start: '09:00', end: '18:00' },
                            timeSlotInterval: 30
                        };
                        break;
                }
            }

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¿å­˜
            async saveAllData() {
                try {
                    this.updateSyncStatus('syncing');
                    
                    const allData = {
                        appointments: this.appointments,
                        patients: this.patients,
                        staff: this.staff,
                        treatments: this.treatments,
                        settings: this.settings,
                        lastModified: new Date().toISOString(),
                        clientId: this.clientId
                    };
                    
                    const response = await fetch(`${this.baseUrl}${this.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey,
                            'X-Bin-Name': 'clinic-data'
                        },
                        body: JSON.stringify(allData)
                    });

                    if (response.ok) {
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
                        Object.keys(allData).forEach(key => {
                            if (key !== 'lastModified' && key !== 'clientId') {
                                localStorage.setItem(`clinic_${key}`, JSON.stringify(allData[key]));
                            }
                        });
                        
                        // lastModified ã‚’æ›´æ–°
                        this.lastModified = allData.lastModified;
                        
                        console.log('ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ');
                        this.updateSyncStatus('synced');
                        return true;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('âŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    if (this.debugMode) {
                        console.error('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
                        console.error('Bin ID:', this.binId);
                        console.error('API Key:', this.apiKey ? 'ã‚ã‚Šï¼ˆ' + this.apiKey.length + 'æ–‡å­—ï¼‰' : 'ãªã—');
                        console.error('URL:', `${this.baseUrl}${this.binId}`);
                        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message);
                        
                        // è¨­å®šå€¤ãƒã‚§ãƒƒã‚¯
                        if (this.binId === '676001a8ad19ca34f8c8b4c8') {
                            console.error('âš ï¸ Bin IDãŒãƒ€ãƒŸãƒ¼å€¤ã®ã¾ã¾ã§ã™ï¼å®Ÿéš›ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„');
                        }
                        if (this.apiKey === '$2a$10$example...') {
                            console.error('âš ï¸ APIã‚­ãƒ¼ãŒãƒ€ãƒŸãƒ¼å€¤ã®ã¾ã¾ã§ã™ï¼å®Ÿéš›ã®å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„');
                        }
                    }
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                    this.showError('äºˆç´„ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    
                    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    ['appointments', 'patients', 'staff', 'treatments', 'settings'].forEach(key => {
                        localStorage.setItem(`clinic_${key}`, JSON.stringify(this[key]));
                    });
                    
                    console.log('ğŸ“± å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰');
                    this.updateSyncStatus('error');
                    return false;
                }
            }

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®é–‹å§‹
            startSync() {
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                
                this.syncTimer = setInterval(async () => {
                    await this.checkForUpdates();
                }, this.syncInterval);
                
                console.log(`ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹ (${this.syncInterval/1000}ç§’é–“éš”)`);
            }
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®åœæ­¢
            stopSync() {
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                    this.syncTimer = null;
                    console.log('â¸ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸåœæ­¢');
                }
            }
            
            // æ›´æ–°ç¢ºèª
            async checkForUpdates() {
                try {
                    const onlineData = await this.loadFromOnline();
                    if (onlineData && onlineData.lastModified !== this.lastModified) {
                        // ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                        if (onlineData.clientId !== this.clientId) {
                            console.log('ğŸ”„ ä»–ã®ç«¯æœ«ã‹ã‚‰ã®æ›´æ–°ã‚’æ¤œå‡º');
                            this.appointments = onlineData.appointments || [];
                            this.patients = onlineData.patients || [];
                            this.staff = onlineData.staff || [];
                            this.treatments = onlineData.treatments || [];
                            this.settings = onlineData.settings || {};
                            this.lastModified = onlineData.lastModified;
                            
                            // UIã‚’æ›´æ–°
                            if (typeof renderAppointments === 'function') renderAppointments();
                            if (typeof updateStats === 'function') updateStats();
                            
                            console.log('âœ¨ ãƒ‡ãƒ¼ã‚¿ã‚’ä»–ã®ç«¯æœ«ã®æ›´æ–°ã§åŒæœŸã—ã¾ã—ãŸ');
                        }
                    }
                } catch (error) {
                    console.warn('âš ï¸ åŒæœŸç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆJSONBin.ioã«ä¿å­˜ï¼‰ - å¾Œæ–¹äº’æ›ç”¨
            async saveData(dataType) {
                return await this.saveAllData();
            }

            // åŒæœŸçŠ¶æ…‹ã®æ›´æ–°
            updateSyncStatus(status) {
                const syncIcon = document.getElementById('syncIcon');
                const syncText = document.getElementById('syncText');
                const lastSyncElement = document.getElementById('lastSync');
                
                syncIcon.className = 'sync-icon ' + status;
                
                switch(status) {
                    case 'syncing':
                        syncText.textContent = 'åŒæœŸä¸­...';
                        break;
                    case 'synced':
                        syncText.textContent = 'åŒæœŸæ¸ˆã¿';
                        if (this.lastSyncTime) {
                            const time = this.lastSyncTime.toLocaleTimeString('ja-JP');
                            lastSyncElement.textContent = time;
                        }
                        break;
                    case 'error':
                        syncText.textContent = 'ã‚¨ãƒ©ãƒ¼';
                        break;
                }
            }

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }

            // è‡ªå‹•åŒæœŸé–‹å§‹
            startAutoSync() {
                setInterval(() => {
                    this.syncData();
                }, this.syncInterval);
            }

            // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
            async syncData() {
                this.updateSyncStatus('syncing');
                
                // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const success = await this.loadAllData();
                
                if (success) {
                    this.updateSyncStatus('synced');
                    
                    // UIã‚’æ›´æ–°ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é€šçŸ¥ï¼‰
                    if (window.calendar) {
                        window.calendar.onDataUpdated(this);
                    }
                } else {
                    this.updateSyncStatus('error');
                }
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰ˆã‚’èµ·å‹•ä¸­...');
            
            // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
            window.dataManager = new DataManager();
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            const success = await window.dataManager.loadAllData();
            
            if (success) {
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’é–‹å§‹
                window.dataManager.startSync();
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
                loadMainApplication();
                
                // è‡ªå‹•åŒæœŸé–‹å§‹
                window.dataManager.startAutoSync();
            } else {
                document.getElementById('loadingOverlay').innerHTML = 
                    '<div style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</div>';
            }
        });

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
        function loadMainApplication() {
            console.log('ğŸ“± ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            // ç°¡å˜ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®UI
            document.getElementById('mainContent').innerHTML = `
                <div class="main-app">
                    <header class="app-header">
                        <h1>ğŸ¥ ç¾å®¹ã‚¯ãƒªãƒ‹ãƒƒã‚¯äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå‹•ä½œç¢ºèªç‰ˆï¼‰</h1>
                        <div class="data-stats">
                            <span>ğŸ“… äºˆç´„: <strong id="appointmentCount">${window.dataManager.appointments.length}</strong>ä»¶</span>
                            <span>ğŸ‘¥ æ‚£è€…: <strong id="patientCount">${window.dataManager.patients.length}</strong>å</span>
                            <span>ğŸ‘©â€âš•ï¸ ã‚¹ã‚¿ãƒƒãƒ•: <strong id="staffCount">${window.dataManager.staff.length}</strong>å</span>
                        </div>
                    </header>

                    <div class="app-body">
                        <div class="left-panel">
                            <div class="panel-section">
                                <h3>ğŸ“‹ äºˆç´„ä¸€è¦§</h3>
                                <div id="appointmentsList" class="appointments-list">
                                    <!-- äºˆç´„ãƒªã‚¹ãƒˆã‚’ã“ã“ã«è¡¨ç¤º -->
                                </div>
                            </div>
                        </div>

                        <div class="right-panel">
                            <div class="panel-section">
                                <h3>â• æ–°è¦äºˆç´„è¿½åŠ </h3>
                                <form id="appointmentForm" class="appointment-form">
                                    <div class="form-group">
                                        <label>æ‚£è€…å:</label>
                                        <input type="text" id="patientName" placeholder="æ‚£è€…åã‚’å…¥åŠ›" required>
                                    </div>
                                    <div class="form-group">
                                        <label>æ—¥ä»˜:</label>
                                        <input type="date" id="appointmentDate" required>
                                    </div>
                                    <div class="form-group">
                                        <label>æ™‚é–“:</label>
                                        <input type="time" id="appointmentTime" required>
                                    </div>
                                    <div class="form-group">
                                        <label>æ–½è¡“:</label>
                                        <select id="treatmentSelect" required>
                                            <option value="">æ–½è¡“ã‚’é¸æŠ</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>æ‹…å½“çœ‹è­·å¸«:</label>
                                        <select id="nurseSelect" required>
                                            <option value="">çœ‹è­·å¸«ã‚’é¸æŠ</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">äºˆç´„è¿½åŠ </button>
                                </form>
                            </div>

                            <div class="panel-section">
                                <h3>ğŸ§ª åŒæœŸãƒ†ã‚¹ãƒˆ</h3>
                                <div class="test-buttons">
                                    <button onclick="testAddAppointment()" class="btn btn-test">ãƒ†ã‚¹ãƒˆäºˆç´„è¿½åŠ </button>
                                    <button onclick="testSyncData()" class="btn btn-test">æ‰‹å‹•åŒæœŸ</button>
                                    <button onclick="clearAllData()" class="btn btn-danger">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
                                </div>
                                <div class="test-log" id="testLog">
                                    <p>ãƒ†ã‚¹ãƒˆãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <style>
                    .main-app {
                        padding: 20px;
                        max-width: 1200px;
                        margin: 0 auto;
                    }

                    .app-header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding: 20px;
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }

                    .app-header h1 {
                        color: #667eea;
                        margin-bottom: 15px;
                    }

                    .data-stats {
                        display: flex;
                        justify-content: center;
                        gap: 30px;
                        font-size: 16px;
                    }

                    .app-body {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                    }

                    .panel-section {
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin-bottom: 20px;
                    }

                    .panel-section h3 {
                        color: #667eea;
                        margin-bottom: 15px;
                        border-bottom: 2px solid #eee;
                        padding-bottom: 10px;
                    }

                    .appointments-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }

                    .appointment-item {
                        padding: 10px;
                        border: 1px solid #eee;
                        border-radius: 5px;
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .appointment-info {
                        flex-grow: 1;
                    }

                    .appointment-time {
                        font-weight: bold;
                        color: #667eea;
                    }

                    .appointment-patient {
                        font-size: 14px;
                        color: #666;
                    }

                    .appointment-form {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }

                    .form-group {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }

                    .form-group label {
                        font-weight: bold;
                        color: #333;
                    }

                    .form-group input,
                    .form-group select {
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 5px;
                        font-size: 16px;
                    }

                    .btn {
                        padding: 10px 20px;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.2s;
                    }

                    .btn-primary {
                        background: #667eea;
                        color: white;
                    }

                    .btn-primary:hover {
                        background: #5a67d8;
                    }

                    .btn-test {
                        background: #48bb78;
                        color: white;
                        margin: 5px;
                    }

                    .btn-test:hover {
                        background: #38a169;
                    }

                    .btn-danger {
                        background: #f56565;
                        color: white;
                        margin: 5px;
                    }

                    .btn-danger:hover {
                        background: #e53e3e;
                    }

                    .test-buttons {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                        margin-bottom: 15px;
                    }

                    .test-log {
                        background: #f7fafc;
                        padding: 10px;
                        border-radius: 5px;
                        border-left: 4px solid #667eea;
                        max-height: 200px;
                        overflow-y: auto;
                        font-family: monospace;
                        font-size: 12px;
                    }

                    .empty-state {
                        text-align: center;
                        color: #999;
                        padding: 40px 20px;
                    }
                </style>
            `;

            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§UIã‚’æ›´æ–°
            initializeApp();
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        function initializeApp() {
            populateSelects();
            renderAppointments();
            setupEventListeners();
            logMessage('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¾ã—ãŸ');
        }

        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
        function populateSelects() {
            const treatmentSelect = document.getElementById('treatmentSelect');
            const nurseSelect = document.getElementById('nurseSelect');

            // æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
            window.dataManager.treatments.forEach(treatment => {
                const option = document.createElement('option');
                option.value = treatment.name;
                option.textContent = treatment.name;
                treatmentSelect.appendChild(option);
            });

            // çœ‹è­·å¸«ã‚’è¿½åŠ 
            window.dataManager.staff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.name;
                option.textContent = staff.name;
                nurseSelect.appendChild(option);
            });
        }

        // äºˆç´„ä¸€è¦§ã‚’è¡¨ç¤º
        function renderAppointments() {
            const appointmentsList = document.getElementById('appointmentsList');
            
            if (window.dataManager.appointments.length === 0) {
                appointmentsList.innerHTML = '<div class="empty-state">ã¾ã äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            appointmentsList.innerHTML = window.dataManager.appointments
                .sort((a, b) => new Date(a.date + ' ' + a.startTime) - new Date(b.date + ' ' + b.startTime))
                .map(appointment => `
                    <div class="appointment-item">
                        <div class="appointment-info">
                            <div class="appointment-time">${appointment.date} ${appointment.startTime}</div>
                            <div class="appointment-patient">${appointment.patientName} - ${appointment.treatmentType}</div>
                        </div>
                        <button onclick="deleteAppointment('${appointment.id}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">å‰Šé™¤</button>
                    </div>
                `).join('');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            const form = document.getElementById('appointmentForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®å‡¦ç†
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                patientName: document.getElementById('patientName').value,
                date: document.getElementById('appointmentDate').value,
                startTime: document.getElementById('appointmentTime').value,
                treatmentType: document.getElementById('treatmentSelect').value,
                nurse: document.getElementById('nurseSelect').value
            };

            // ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            window.dataManager.appointments.push(formData);
            
            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³åŒæœŸï¼‰
            const success = await window.dataManager.saveAllData();
            
            if (success) {
                logMessage(`âœ… äºˆç´„è¿½åŠ : ${formData.patientName}æ§˜ ${formData.date} ${formData.startTime}`);
                
                // UIã‚’æ›´æ–°
                renderAppointments();
                updateStats();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('appointmentForm').reset();
            } else {
                logMessage('âŒ äºˆç´„ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // äºˆç´„å‰Šé™¤
        async function deleteAppointment(appointmentId) {
            const index = window.dataManager.appointments.findIndex(apt => apt.id === appointmentId);
            if (index !== -1) {
                const appointment = window.dataManager.appointments[index];
                window.dataManager.appointments.splice(index, 1);
                
                const success = await window.dataManager.saveAllData();
                if (success) {
                    logMessage(`ğŸ—‘ï¸ äºˆç´„å‰Šé™¤: ${appointment.patientName}æ§˜`);
                    renderAppointments();
                    updateStats();
                }
            }
        }

        // ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
        function testAddAppointment() {
            const testData = {
                id: Date.now().toString(),
                patientName: 'ãƒ†ã‚¹ãƒˆæ‚£è€…' + Math.floor(Math.random() * 100),
                date: new Date().toISOString().split('T')[0],
                startTime: '10:00',
                treatmentType: window.dataManager.treatments[0]?.name || 'ãƒ†ã‚¹ãƒˆæ–½è¡“',
                nurse: window.dataManager.staff[0]?.name || 'ãƒ†ã‚¹ãƒˆçœ‹è­·å¸«'
            };

            window.dataManager.appointments.push(testData);
            window.dataManager.saveData('appointments');
            renderAppointments();
            updateStats();
            logMessage(`ğŸ§ª ãƒ†ã‚¹ãƒˆäºˆç´„è¿½åŠ : ${testData.patientName}`);
        }

        function testSyncData() {
            logMessage('ğŸ”„ æ‰‹å‹•åŒæœŸã‚’é–‹å§‹...');
            window.dataManager.syncData();
        }

        async function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                window.dataManager.appointments = [];
                await window.dataManager.saveData('appointments');
                renderAppointments();
                updateStats();
                logMessage('ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateStats() {
            document.getElementById('appointmentCount').textContent = window.dataManager.appointments.length;
            document.getElementById('patientCount').textContent = window.dataManager.patients.length;
            document.getElementById('staffCount').textContent = window.dataManager.staff.length;
        }

        // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function logMessage(message) {
            const testLog = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString('ja-JP');
            testLog.innerHTML = `<p>[${time}] ${message}</p>` + testLog.innerHTML;
            
            // æœ€å¤§20è¡Œã¾ã§ä¿æŒ
            const lines = testLog.querySelectorAll('p');
            if (lines.length > 20) {
                lines[lines.length - 1].remove();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸæ™‚ã®UIæ›´æ–°ï¼ˆDataManagerã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
        window.onDataUpdated = function(dataManager) {
            renderAppointments();
            updateStats();
            logMessage('ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¾ã—ãŸ');
        };
    </script>
</body>
</html>