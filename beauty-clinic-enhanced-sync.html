<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美容クリニック施術室管理カレンダー（テーブル版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: #f8fafc;
            color: #2d3748;
            line-height: 1.5;
            overflow: hidden; /* ページ全体のスクロールを無効化 */
            height: 100vh; /* 画面いっぱいに */
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 999; /* モーダルより低い値に設定 */
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn-quick {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .nav-btn-quick:hover {
            background: rgba(255,255,255,0.25);
        }

        .current-date {
            font-size: 1.2rem;
            font-weight: 500;
            min-width: 200px;
            text-align: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
            position: relative;
        }

        .current-date:hover {
            background: rgba(255,255,255,0.1);
        }

        .calendar-icon {
            margin-right: 8px;
        }

        .filters-section {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .filters-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 500;
            color: #4a5568;
            font-size: 14px;
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            color: #4a5568;
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .calendar-container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border-radius: 12px;
        }

        /* テーブル構造のスタイル */
        .schedule-grid {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 0 0 rgba(0,0,0,0);
            margin-bottom: 0;
        }

        /* 固定された上部操作エリア */
        .app-header-fixed {
            flex: none; /* 固定サイズ */
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        /* ヘッダー部分（元のスタイル維持） */
        .header-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* フィルターエリア（元のスタイル維持） */
        .filters-content {
            background: #f8fafc;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* トグルスイッチ */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 40px;
            height: 20px;
            background: #ccc;
            border-radius: 20px;
            transition: background 0.3s;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            background: #667eea;
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 12px;
            color: #4a5568;
            font-weight: 500;
        }

        /* セグメントコントロール */
        .segment-control {
            display: inline-flex;
            background: #e2e8f0;
            border-radius: 6px;
            padding: 2px;
            gap: 2px;
        }

        .segment-button {
            padding: 6px 16px;
            border: none;
            background: transparent;
            color: #4a5568;
            font-size: 12px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            outline: none;
        }

        .segment-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .segment-button.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            font-size: 0.875rem;
            min-width: 120px;
        }
        
        /* 単一スケジュールコンテナ */
        .schedule-container {
            overflow: auto;
            background: white;
            flex: 1; /* 残りのスペースを全て使用 */
            position: relative;
            touch-action: auto; /* タッチアクションを自動に */
            -webkit-overflow-scrolling: touch; /* iOS Safari用 */
            overscroll-behavior: auto; /* オーバースクロールを許可 */
            scroll-behavior: auto; /* スクロール動作を自動に */
        }
        
        .schedule-table {
            width: max-content;
            table-layout: fixed;
            border-collapse: collapse;
            margin: 0;
        }
        
        /* スティッキーヘッダー */
        .schedule-sticky-header {
            position: sticky;
            top: 0;
            z-index: 99; /* モーダルより低い値に変更 */
            background: white;
        }
        
        .schedule-sticky-header th {
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            min-width: 150px;
            width: 150px;
            box-sizing: border-box;
        }
        
        .schedule-sticky-header th:first-child {
            min-width: 80px;
            width: 80px;
            background: #f7fafc;
            color: #2d3748;
        }
        
        /* 固定サマリー行のスタイル */
        .schedule-summary-fixed {
            position: sticky;
            top: 60px; /* ヘッダーの下に配置 */
            z-index: 999;
            background: white;
            overflow-x: auto;
            width: 100%;
            height: 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .schedule-summary-fixed::-webkit-scrollbar {
            display: none;
        }
        
        .schedule-summary-fixed {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* チェックボックス形式フィルター用スタイル */
        .filter-checkbox-container {
            position: relative;
            display: inline-block;
        }
        
        .filter-dropdown-trigger {
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            min-width: 200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .filter-dropdown-trigger:hover {
            border-color: #667eea;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .filter-dropdown-trigger.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .filter-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: white;
            border: 1px solid #cbd5e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* スクロールバーのスタイル（Webkit系ブラウザ用） */
        .filter-dropdown-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .filter-dropdown-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .filter-dropdown-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .filter-dropdown-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f7fafc;
            white-space: nowrap;
            min-width: fit-content;
        }
        
        .checkbox-item:hover {
            background-color: #f7fafc;
        }
        
        .checkbox-item:last-child {
            border-bottom: none;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .checkbox-item span {
            cursor: pointer;
        }
        
        .checkbox-item-main {
            font-weight: 600;
        }
        
        .checkbox-item-sub {
            margin-left: 0.5rem;
            color: #666;
            font-size: 13px;
        }
        
        /* 施術メニュー展開アイコン */
        .treatment-expand-icon {
            display: inline-block;
            width: 12px;
            transition: transform 0.2s;
            margin-right: 4px;
            font-size: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .treatment-expand-icon.expanded {
            /* アイコンのテキストを変更するので回転は不要 */
        }
        
        /* サブ項目コンテナ */
        .treatment-sub-container {
            transition: all 0.2s ease;
        }
        
        /* メイン項目のホバー効果 */
        .checkbox-item-main {
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox-item-main:hover {
            background-color: #f8f9fa;
        }
        
        /* メインラベルのカーソル */
        .treatment-main-label {
            cursor: pointer;
            flex: 1;
        }
        
        
        
        .schedule-grid th {
            padding: 1rem;
            font-weight: 600;
            text-align: center;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            z-index: 100;
        }

        .schedule-grid th:first-child {
            width: 150px;
            background: #f7fafc;
            color: #2d3748;
        }

        .schedule-grid th:not(:first-child) {
            width: 180px;
            font-size: 14px;
            background: #f8fafc;
        }

        .schedule-grid td {
            padding: 0;
            border: 1px solid #e2e8f0;
            position: relative;
            height: 25px;
            vertical-align: top;
        }

        .time-cell {
            background: #f8fafc !important;
            font-weight: 500;
            color: #4a5568;
            text-align: center;
            vertical-align: top !important;
            padding: 1px 4px 10px 4px !important;
            width: 60px;
            min-width: 60px;
            font-size: 11px;
            position: sticky;
            left: 0;
            z-index: 10;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
            border-right: 2px solid #e2e8f0 !important;
            border-top: 1px solid #e2e8f0 !important;
            border-bottom: 1px solid #e2e8f0 !important;
            border-left: 1px solid #e2e8f0 !important;
            margin-bottom: -1px;
            padding-top: 1px;
            padding-bottom: 1px;
        }

        .appointment-cell {
            background: white;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }

        /* 毎正時の行に太い線 */
        .hour-marker td {
            border-top: 2px solid #9ca3af !important;
        }
        
        .hour-marker .time-cell {
            font-weight: 600;
            color: #374151;
        }
        
        /* 30分ごと（11:30, 12:30など）に中間の太さの線 */
        .half-hour-marker td {
            border-top: 1.5px solid #b5bcc5 !important;
        }
        
        .half-hour-marker .time-cell {
            font-weight: 500;
            color: #4b5563;
        }

        /* 休憩時間のスタイル */
        .break-time {
            background-color: #f1f5f9 !important;
        }
        
        .break-time-cell {
            background-color: #e2e8f0 !important;
            color: #64748b !important;
            position: relative;
        }
        
        .break-time-cell::before {
            content: '';
        }
        

        .appointment-cell:hover {
            background: #f0f9ff;
        }

        .appointment {
            position: absolute;
            left: 2px;
            right: 2px;
            top: 0px;
            background: white;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            line-height: 1.3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
            cursor: move;
            z-index: 5;
            overflow: hidden;
        }
        
        /* 過去の予約（完了済み）のスタイル */
        .appointment.past-appointment {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db) !important;
            border-left-color: #6b7280 !important;
            opacity: 0.7;
        }
        
        .appointment.past-appointment .appointment-patient,
        .appointment.past-appointment .appointment-nurse,
        .appointment.past-appointment .appointment-time,
        .appointment.past-appointment .appointment-device {
            color: #4b5563 !important;
        }


        /* 施術タイプ別の色分け */
        .treatment0-appointment {
            border-left-color: #e53e3e;
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
        }

        .treatment1-appointment {
            border-left-color: #3182ce;
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
        }

        .treatment2-appointment {
            border-left-color: #38a169;
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
        }

        .treatment3-appointment {
            border-left-color: #805ad5;
            background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
        }

        .treatment4-appointment {
            border-left-color: #d69e2e;
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
        }

        .treatment5-appointment {
            border-left-color: #dd6b20;
            background: linear-gradient(135deg, #feebc8, #fbd38d);
        }

        .appointment-patient {
            font-weight: 600;
            color: #2d3748;
            font-size: 11px;
        }

        .patient-id {
            background: #667eea;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
        }

        .appointment-nurse {
            color: #718096;
            font-size: 9px;
        }

        .appointment-time {
            color: #4a5568;
            font-size: 9px;
            font-weight: 500;
        }

        /* ドラッグ&ドロップ視覚効果 */


            padding: 2px 4px;
            border-radius: 4px;
            font-size: 9px;
            z-index: 20;
        }

        /* メインコンテンツの表示優先度確保 */
        .calendar-container {
            position: relative;
            z-index: 1;
        }
        
        .header {
            position: relative;
            z-index: 2;
        }
        
        /* カレンダーオーバーレイ（画面全体） */
        .calendar-overlay {
            display: none;
            position: fixed !important;
            top: 0 !important; /* 画面上端から開始 */
            left: 0 !important;
            width: 100% !important;
            height: 100% !important; /* 画面全体をカバー */
            background-color: rgba(0, 0, 0, 0.5) !important;
            z-index: 999998 !important;
            cursor: pointer;
        }
        
        .calendar-overlay.show {
            display: block !important;
        }
        
        /* カレンダーポップアップ（最高優先度） */
        .calendar-popup, .date-picker-content {
            background: white !important;
            border-radius: 12px !important;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
            padding: 2rem !important;
            width: 90% !important;
            max-width: 500px !important;
            position: relative !important;
        }
        
        .calendar-popup {
            display: none;
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 999999 !important;
            margin: 0 !important;
        }

        .date-picker-content {
            margin: 5% auto !important;
        }

        .calendar-popup.show {
            display: block !important;
            animation: fadeInScale 0.2s ease-out;
        }
        
        /* カレンダー内の全要素も高いz-indexを継承 */
        .calendar-popup * {
            position: relative;
            z-index: 999999;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        body.calendar-open {
            overflow: hidden;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-month-nav {
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-month-nav:hover {
            background: #e2e8f0;
            border-color: #a0aec0;
            color: #2d3748;
            transform: scale(1.05);
        }
        
        /* 6ヶ月移動ボタン専用スタイル */
        .calendar-month-nav.calendar-6month {
            background: none;
            border-color: #e2e8f0;
            color: #4a5568;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -1px; /* 文字間隔を狭くして見栄えを良く */
        }
        
        .calendar-month-nav.calendar-6month:hover {
            background: #e2e8f0;
            border-color: #e2e8f0;
            color: #4a5568;
            transform: scale(1.05);
        }

        .calendar-month-nav:active {
            transform: scale(0.95);
            background: #cbd5e0;
        }

        .calendar-month-year {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            color: #718096;
            padding: 8px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .calendar-day {
            text-align: center;
            padding: 12px 8px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #e3f2fd;
            color: #1976d2;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            color: #cccccc;
            font-weight: 300;
        }

        .calendar-day.other-month:hover {
            background: #f5f5f5;
            color: #999999;
        }

        .calendar-day.today {
            background: #e53e3e;
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .calendar-day.today:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        .calendar-day.selected:hover {
            background: linear-gradient(135deg, #38a169, #2f855a) !important;
        }

        .calendar-day.today.selected {
            background: #e53e3e;
            color: white;
            font-weight: 700;
            box-shadow: 0 3px 12px rgba(229, 62, 62, 0.4);
        }

        /* 期間選択の範囲表示 */
        .calendar-day.period-range {
            background: rgba(72, 187, 120, 0.2);
            color: #2d3748;
        }

        .calendar-day.period-range:hover {
            background: rgba(72, 187, 120, 0.3);
        }

        /* 選択された日付は期間表示より優先 */
        .calendar-day.selected {
            background: linear-gradient(135deg, #48bb78, #38a169) !important;
            color: white !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3) !important;
        }

        /* 休診日のスタイル */
        .calendar-day.closed-day {
            background-color: #f1f5f9 !important;
            color: #94a3b8 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
            position: relative;
        }

        .calendar-day.closed-day:hover {
            background-color: #f1f5f9 !important;
            color: #94a3b8 !important;
            transform: none !important;
        }

        .calendar-day.closed-day::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 1px;
            background-color: #94a3b8;
            transform: translateY(-50%);
        }

        /* 土曜祝日（営業日）のスタイル */
        .calendar-day.saturday-holiday {
            background-color: #ecfdf5 !important;
            color: #059669 !important;
            border: 1px solid #10b981;
        }

        .calendar-day.saturday-holiday:hover {
            background-color: #d1fae5 !important;
            color: #047857 !important;
        }

        /* 営業時間外警告モーダル */
        .warning-message {
            text-align: center;
            padding: 20px;
        }

        .warning-message p {
            font-size: 16px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 20px;
        }

        .business-hours-info {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            text-align: left;
        }

        .business-hours-info h3 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .business-hours-info p {
            color: #4b5563 !important;
            font-size: 13px;
            font-weight: normal !important;
            margin: 5px 0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #991b1b, #7f1d1d);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }








        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 5000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        #appointmentModal {
            z-index: 7000;
        }

        /* 統合された施術メニュー選択UI */
        .treatment-selector {
            position: relative;
        }

        .treatment-selector .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 16px;
            color: #2d3748;
            background-color: white;
        }

        .treatment-selector .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* プレースホルダーとデフォルトオプションの色統一 */
        .form-input::placeholder,
        .form-control::placeholder,
        .treatment-selector .form-control::placeholder {
            color: #a0aec0;
        }
        
        /* readonlyの入力欄でもプレースホルダーを表示 */
        .form-input[readonly]::placeholder {
            color: #a0aec0;
            opacity: 1;
        }
        
        /* 予約日入力欄の空の状態の色 */
        #appointmentDate:placeholder-shown {
            color: #a0aec0;
        }


        /* selectのデフォルトオプション（「選択してください」「時」「分」）の色 */
        .form-select option[value=""] {
            color: #a0aec0 !important;
        }
        
        /* selectが未選択状態の時の色 */
        .form-select:invalid {
            color: #a0aec0;
        }
        
        /* selectが選択済みの時の色 */
        .form-select:valid {
            color: #000;
        }

        /* 実際の選択肢は黒色に */
        .form-select option:not([value=""]) {
            color: #2d3748 !important;
        }

        /* selectが未選択時の色 */
        .form-select:invalid,
        .form-select[value=""],
        .form-select:not([value]):not(:focus) {
            color: #a0aec0;
        }

        .form-select:valid {
            color: #2d3748;
        }

        /* 看護師施術メニュー設定用チェックボックス */
        .treatment-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .treatment-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .treatment-checkbox:hover {
            background-color: #f8f9fa;
        }

        .treatment-checkbox input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .treatment-checkbox input[type="checkbox"]:checked + span {
            font-weight: 500;
            color: #007bff;
        }

        /* 看護師施術管理モーダル用スタイル */
        .nurse-treatment-container {
            padding: 20px 0;
        }

        .current-nurse-info {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .current-nurse-info h3 {
            margin: 0 0 8px 0;
            color: #2d3748;
            font-size: 1.3em;
        }

        .nurse-treatment-subtitle {
            margin: 0;
            color: #6b7280;
            font-size: 0.9em;
        }

        .treatment-selection-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 20px;
        }

        .treatment-selection-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            background: white;
        }

        .treatment-selection-item:hover {
            border-color: #cbd5e0;
            background-color: #f8f9fa;
        }

        .treatment-selection-item.selected {
            border-color: #007bff;
            background-color: #eff6ff;
        }

        .treatment-selection-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .treatment-selection-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }

        .treatment-selection-item.selected label {
            color: #007bff;
        }

        .treatment-selection-item.sub-item {
            margin-left: 20px;
            border-left: 3px solid #e2e8f0;
            background-color: #f8f9fa;
        }

        .treatment-selection-item.sub-item.selected {
            border-left-color: #007bff;
            background-color: #e7f3ff;
        }

        .treatment-selection-item.sub-item {
            display: none;
        }

        .treatment-selection-item.sub-item.visible {
            display: flex;
        }

        .treatment-selection-item.expandable {
            cursor: default;
        }
        
        .treatment-selection-item.expandable > div {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .treatment-selection-item.expandable span::after {
            content: "▶";
            margin-left: auto;
            font-size: 0.8em;
            color: #6c757d;
            transition: transform 0.2s;
            display: inline-block;
        }

        .treatment-selection-item.expandable.expanded span::after {
            transform: rotate(90deg);
        }

        /* 看護師管理の注射器アイコン */
        .btn-icon.manage-treatments {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }

        .btn-icon.manage-treatments:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .treatment-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .treatment-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }

        .treatment-option:hover {
            background-color: #f8f9fa;
        }

        .treatment-option.main-treatment {
            font-weight: 500;
            color: #495057;
        }

        .treatment-option.sub-treatment {
            padding-left: 35px;
            font-size: 0.9em;
            color: #6c757d;
            background-color: #f8f9fa;
        }

        .treatment-option.sub-treatment:hover {
            background-color: #e9ecef;
        }

        .treatment-option.selected {
            background-color: #007bff;
            color: white;
        }

        .treatment-has-subs::after {
            content: "▶";
            float: right;
            font-size: 0.8em;
            color: #6c757d;
            transition: transform 0.2s;
        }

        .treatment-has-subs.expanded::after {
            transform: rotate(90deg);
        }

        #datePickerModal {
            z-index: 5000; /* 動的管理に任せる */
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0,0,0,0.5) !important;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #718096;
        }

        .close:hover {
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        /* 星印（*）を赤色にする */
        .form-label .required-star {
            color: #dc2626;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #2d3748;
        }
        
        /* selectのデフォルト状態（未選択時）の色 */
        .form-select[value=""], .form-select:not([value]) {
            color: #a0aec0;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 患者名入力フィールド専用スタイル */
        .patient-name-input {
            font-family: monospace;
        }

        .calendar-icon-btn:hover {
            color: #4b5563;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .calendar-icon-btn:focus {
            outline: none;
        }

        .calendar-icon-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .patient-select-container {
            position: relative;
        }

        .patient-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .patient-suggestion {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s;
        }

        .patient-suggestion:hover {
            background-color: #f7fafc;
        }

        .patient-suggestion:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #2d3748;
        }

        .suggestion-id {
            font-size: 14px;
            color: #718096;
            margin-top: 2px;
        }

        .time-inputs {
            display: flex;
            gap: 1rem;
        }

        .time-inputs .form-select {
            flex: 1;
        }

        .form-error {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 0.5rem;
            display: none;
        }

        .error {
            border-color: #e53e3e;
        }

        .success-message {
            position: fixed;
            top: 80px;  /* ヘッダーの下に配置 */
            right: 20px;  /* 右側に配置 */
            background: #38a169;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 999999;  /* 最前面表示のため非常に高い値に設定 */
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 管理モーダルの改善スタイル */
        .modal-large {
            max-width: 900px;
            width: 90%;
        }
        
        /* 患者履歴モーダル専用スタイル */
        #patientHistoryModal {
            display: none;
            position: fixed;
            z-index: 5000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        #patientHistoryModal .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-confirm {
            max-width: 700px;
        }

        /* z-indexは動的管理に統一（CSS固定値を削除） */

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .manage-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0;
        }

        .manage-tab {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .manage-tab:hover {
            color: #2d3748;
        }

        .manage-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .manage-content {
            display: none;
        }

        .manage-content.active {
            display: block;
        }

        .manage-header {
            margin-bottom: 2rem;
        }

        .add-item-form {
            display: flex;
            gap: 1rem;
        }

        .add-item-form .form-input {
            flex: 1;
        }

        .btn-add {
            background: linear-gradient(135deg, #48bb78, #38a169);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon {
            font-size: 20px;
            font-weight: bold;
        }

        /* テーブルスタイル */
        .manage-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .manage-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            border-spacing: 0;
        }

        .manage-table thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .manage-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            vertical-align: middle;
            box-sizing: border-box;
        }
        
        .manage-table th:first-child {
            text-align: left;
            padding-left: 12px;
        }

        .manage-table td {
            padding: 12px 8px !important;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle !important;
            text-align: center !important;
            box-sizing: border-box;
            min-height: 60px;
        }
        
        .manage-table td:first-child {
            text-align: left !important;
            padding-left: 12px !important;
        }
        
        .manage-table .treatment-actions {
            text-align: right !important;
            padding: 8px !important;
            vertical-align: middle !important;
            min-height: 60px;
        }
        
        .manage-table .btn-icon {
            padding: 5px 10px !important;
            font-size: 12px !important;
            margin-left: 4px !important;
        }

        table.manage-table button.btn-add-simple,
        .manage-table-container button.btn-add-simple,
        #treatmentsList button.btn-add-simple,
        button[onclick*="addSubItem"].btn-add-simple {
            background: #22c55e !important;
            color: white !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 5px 8px !important;
            font-size: 12px !important;
            margin-left: 4px !important;
            width: auto !important;
            min-width: auto !important;
            max-width: none !important;
            text-align: center !important;
        }

        table.manage-table button.btn-add-simple:hover,
        .manage-table-container button.btn-add-simple:hover,
        #treatmentsList button.btn-add-simple:hover,
        button[onclick*="addSubItem"].btn-add-simple:hover {
            background: #16a34a !important;
        }
        
        .manage-table .btn-add-sub {
            background: #22c55e !important;
            color: white !important;
            border: none !important;
            padding: 5px 8px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 11px !important;
            margin-right: 3px !important;
            font-weight: 500 !important;
            width: auto !important;
            text-align: center !important;
            display: inline-block !important;
        }
        
        .manage-table .btn-add-sub:hover {
            background: #16a34a !important;
            transform: scale(1.1);
        }
        
        .manage-table .btn-spacer-duration {
            background: transparent !important;
            color: transparent !important;
            border: none !important;
            padding: 5px 8px !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            margin-left: 2px !important;
            cursor: default !important;
            display: inline-block !important;
            visibility: hidden !important;
            box-sizing: border-box !important;
            width: auto !important;
            height: auto !important;
            vertical-align: middle !important;
        }
        
        /* 最強優先度でボタンスタイルを適用 */
        table.manage-table button.btn-add-sub,
        .manage-table-container button.btn-add-sub,
        #treatmentsList button.btn-add-sub,
        button[onclick*="addSubItem"] {
            background-color: #22c55e !important;
            background: #22c55e !important;
            color: #ffffff !important;
            border: 0px solid transparent !important;
            border-style: none !important;
            padding: 5px 8px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 11px !important;
            margin-right: 3px !important;
            font-weight: 500 !important;
            width: auto !important;
            height: auto !important;
            text-align: center !important;
            display: inline-block !important;
            vertical-align: middle !important;
            box-sizing: border-box !important;
            text-decoration: none !important;
        }

        .manage-table tbody tr:hover {
            background: #f0f9ff;
        }
        
        /* サブ項目の階層表示 */
        .sub-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 30px;
        }
        
        .sub-item-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .sub-item-name {
            color: #000;
            font-size: 14px;
        }

        /* インライン編集 */
        .editable {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .editable:hover {
            background: #edf2f7;
        }

        .edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: 14px;
        }

        /* バッジ */
        .count-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
        }

        .count-badge.active {
            background: #bee3f8;
            color: #2c5282;
        }

        .count-badge.zero {
            background: #e2e8f0;
            color: #718096;
        }
        
        /* 看護師数表示のスタイル */
        .nurse-count-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: help;
            position: relative;
            transition: transform 0.2s;
            overflow: visible;
            z-index: 1 !important;
        }
        
        /* 管理タブのテーブルのみオーバーフローを許可（モーダル内は除外） */
        .tab-content .manage-table-container {
            overflow: visible !important;
        }
        
        .tab-content .manage-table td {
            overflow: visible !important;
        }
        
        .tab-content .nurse-count-badge {
            z-index: 1 !important;
        }
        
        /* 患者タブ専用：テーブルコンテナの高さを画面に応じて調整 */
        #patientsContent .manage-table-container {
            max-height: calc(75vh - 120px) !important;
            min-height: 400px !important;
            overflow-y: auto !important;
        }
        
        /* 患者タブ全体の高さ制限 */
        #patientsContent {
            max-height: calc(90vh - 80px) !important;
            overflow: hidden !important;
        }
        
        /* 施術メニュータブ専用：テーブルコンテナの高さ制限 */
        #treatmentsContent .manage-table-container {
            max-height: calc(75vh - 120px) !important;
            min-height: 400px !important;
            overflow-y: auto !important;
        }
        
        /* 施術メニュータブ全体の高さ制限 */
        #treatmentsContent {
            max-height: calc(90vh - 80px) !important;
            overflow: hidden !important;
        }
        
        /* 看護師タブとデバイスタブも同様に制限 */
        #nursesContent .manage-table-container,
        #devicesContent .manage-table-container {
            max-height: calc(75vh - 120px) !important;
            overflow-y: auto !important;
        }
        
        #nursesContent,
        #devicesContent {
            max-height: calc(90vh - 80px) !important;
            overflow: hidden !important;
        }
        
        /* 管理モーダル専用のスタイル */
        #manageModal {
            overflow: hidden !important;
        }
        
        /* モーダル全体の高さを施術メニュータブに統一 */
        #manageModal .modal-content {
            height: 95vh !important;
            max-height: 95vh !important;
            overflow: hidden !important;
            margin: 2% auto !important;
        }
        
        .manage-table tbody tr {
            position: relative;
            z-index: 1;
        }
        
        /* モーダル内のテーブルは適切にオーバーフローを制御 */
        .modal-content .manage-table-container {
            max-height: 400px;
            overflow-x: auto;
            overflow-y: auto;
            border-radius: 8px;
            position: relative;
        }
        
        .modal-content .manage-table {
            width: 100%;
            position: relative;
        }
        
        .modal-content .manage-table td {
            overflow: visible;
            position: relative;
        }
        
        .modal-content .nurse-count-badge {
            position: relative;
            z-index: 1;
        }
        
        .modal-content .nurse-count-badge:hover {
            z-index: 999999;
        }
        
        .nurse-count-badge.active {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .nurse-count-badge.zero {
            background: #e2e8f0;
            color: #718096;
        }
        
        .nurse-count-tooltip {
            position: fixed !important;
            background: #f9fafb !important;
            color: #374151 !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            white-space: nowrap !important;
            opacity: 0;
            pointer-events: none;
            z-index: 999999 !important;
            max-width: 300px !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;
            border: 1px solid #e5e7eb !important;
            display: none;
            visibility: hidden;
        }
        
        .nurse-count-tooltip.show {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .nurse-count-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #f9fafb;
        }
        
        
        /* ツールチップ位置調整用 */
        .tooltip-above {
            bottom: 100% !important;
            top: auto !important;
            margin-bottom: 8px !important;
            margin-top: 0 !important;
        }
        
        .tooltip-above::after {
            top: 100% !important;
            bottom: auto !important;
            border-bottom-color: transparent !important;
            border-top-color: #f9fafb !important;
        }
        
        .tooltip-below {
            top: 100% !important;
            bottom: auto !important;
            margin-top: 8px !important;
            margin-bottom: 0 !important;
        }
        
        .tooltip-below::after {
            bottom: 100% !important;
            top: auto !important;
            border-top-color: transparent !important;
            border-bottom-color: #f9fafb !important;
        }
        
        .nurse-list-in-tooltip {
            font-size: 12px;
            font-weight: 500;
        }

        /* 操作ボタン */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #4299e1;
            color: white;
        }

        .btn-edit:hover {
            background: #3182ce;
        }

        .btn-delete {
            background: #fc8181;
            color: white;
        }

        .btn-delete:hover {
            background: #f56565;
        }

        /* 削除確認モーダル */
        .modal-title-danger {
            color: #e53e3e;
            margin-bottom: 1rem;
        }

        .warning-text {
            font-size: 16px;
            color: #2d3748;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #fed7d7;
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }
        
        .conflict-details {
            margin: 1.5rem 0;
            background: #fef2f2;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .conflict-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #ef4444;
        }
        
        .conflict-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            color: #ef4444;
        }
        
        .conflict-info {
            flex: 1;
        }
        
        .conflict-resource {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }
        
        .conflict-appointment {
            font-size: 14px;
            color: #6b7280;
        }

        .affected-section {
            margin: 2rem 0;
        }

        .affected-title {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .affected-appointments-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .appointments-table {
            width: 100%;
            border-collapse: collapse;
        }

        .appointments-table thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
        }

        .appointments-table th,
        .appointments-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .appointments-table tbody tr:hover {
            background: #f0f9ff;
        }

        .warning-note {
            padding: 12px;
            background: #fef5e7;
            border-radius: 6px;
            color: #744210;
            font-size: 14px;
            border-left: 4px solid #f6ad55;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* 患者管理スタイル */
        .patient-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .patient-search-box {
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding-left: 2.5rem;
        }

        .patient-results-info {
            padding: 1rem;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 14px;
            color: #4a5568;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .page-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 患者詳細モーダル */
        .patient-detail-header {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }

        .patient-basic-info {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
        }

        .info-item {
            display: flex;
            gap: 0.5rem;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .patient-history-section {
            margin-top: 2rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .history-filter {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            position: relative;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .history-table thead {
            background: #f7fafc;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .history-table th,
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
        }

        /* 日付列の特別設定 */
        .history-table th:nth-child(1),
        .history-table td:nth-child(1) {
            white-space: nowrap;
            overflow: hidden;
            padding: 10px;
            vertical-align: middle;
        }

        /* 日付列内のステータス表示 */
        .history-table .status-icon {
            margin-right: 4px;
        }

        .history-table .status-label {
            font-size: 11px;
            background: #f0f9ff;
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            display: inline-block;
            font-weight: 500;
        }

        /* 各列の最適化された幅設定 */
        .history-table th:nth-child(1),
        .history-table td:nth-child(1) {
            width: 190px; /* 日付 */
            max-width: 190px;
        }

        .history-table th:nth-child(2),
        .history-table td:nth-child(2) {
            width: 180px; /* 時間 */
            max-width: 180px;
        }

        .history-table th:nth-child(3),
        .history-table td:nth-child(3) {
            width: 200px; /* 施術内容 */
            max-width: 200px;
        }

        .history-table th:nth-child(4),
        .history-table td:nth-child(4) {
            width: 120px; /* 担当看護師 */
            max-width: 120px;
        }

        .history-table th:nth-child(5),
        .history-table td:nth-child(5) {
            width: 140px; /* 使用デバイス */
            max-width: 140px;
        }

        .history-table th:nth-child(6),
        .history-table td:nth-child(6) {
            width: 100px; /* 操作 */
            max-width: 100px;
            text-align: center;
            white-space: normal;
        }

        .history-table tbody tr:hover {
            background: #f0f9ff;
        }
        

        /* 操作ボタンのスタイル調整 */
        .history-table .btn-icon {
            position: relative;
            z-index: 10;
            margin: 0 2px;
            display: inline-block;
            min-width: 30px;
            box-sizing: border-box;
        }

        /* 履歴テーブル専用の操作ボタンスタイル */
        .history-table .btn-icon {
            padding: 6px 10px !important;
            font-size: 14px !important;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .history-table .btn-icon.edit {
            background: #4299e1;
        }
        
        .history-table .btn-icon.edit:hover {
            background: #3182ce;
        }

        /* 時間枠検索機能のスタイル */
        .search-suggestion-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            background: #f7fafc;
        }

        .search-controls {
            align-items: center;
        }

        .search-results {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e2e8f0;
        }

        .search-tabs {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        .search-tab {
            transition: all 0.2s;
        }

        .search-tab:hover {
            background: #f7fafc !important;
        }

        .search-tab.active:hover {
            background: #667eea !important;
        }

        .search-result-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .search-result-card:hover {
            border-color: #667eea;
            background: #f0f9ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .result-date {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .result-time {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .result-details {
            font-size: 12px;
            color: #4a5568;
        }

        .available-nurses .label {
            font-weight: 500;
        }

        .nurse-count {
            background: #38a169;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin: 0 4px;
        }

        .nurse-names {
            color: #6b7280;
        }

        /* 日付グループ化スタイル */
        .date-group {
            margin-bottom: 20px;
        }
        
        .date-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 8px;
        }
        
        .date-text {
            font-weight: 600;
            color: #2d3748;
            font-size: 15px;
        }
        
        .slot-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .time-slots {
            margin-left: 12px;
        }
        
        .time-slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 4px;
            background: white;
            border: 1px solid #93c5fd;  /* やや薄い青色の枠線 */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-slot-item:hover {
            border-color: #667eea;
            background: #f0f9ff;
            transform: translateX(4px);
        }
        
        .slot-time {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        .slot-nurses {
            font-size: 12px;
            color: #4a5568;
        }

        /* 時間範囲グループスタイル */
        .time-range-group {
            margin-bottom: 6px;
        }
        
        .time-range-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-range-header:hover {
            border-color: #667eea;
            background: #f0f9ff;
            transform: translateX(2px);
        }
        
        .range-time {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        .range-count {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .expand-icon {
            color: #667eea;
            font-size: 12px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .time-range-details {
            margin-top: 4px;
            margin-left: 16px;
            padding-left: 12px;
            border-left: 2px solid #e2e8f0;
        }
        
        .time-slot-item.expanded {
            background: #fafafa;
            border-color: #d1d5db;
            padding: 6px 10px;
            margin-bottom: 2px;
        }
        
        .time-slot-item.expanded:hover {
            background: #f0f9ff;
            border-color: #667eea;
            transform: translateX(2px);
        }

        .no-results {
            text-align: center;
            padding: 32px;
            color: #6b7280;
            font-style: italic;
        }

        .button-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .history-table .btn-icon.delete {
            background: #e53e3e !important;
        }
        
        .history-table .btn-icon.delete:hover {
            background: #c53030 !important;
        }


        /* 操作列の内容が確実に見えるよう調整 */
        .history-table td:nth-child(6) {
            overflow: visible;
            white-space: nowrap;
            padding: 6px 4px;
        }

        /* 履歴ヘッダーのレイアウト調整 */
        .history-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 40px;
        }

        .history-title-section h3 {
            margin: 0;
            color: #2d3748;
        }

        .history-title-section .btn {
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .history-title-section .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* スクロール可能な予約表ボディ */
        
        /* フローティングサマリー表示（11:00の行内） */
        .floating-summary-container {
            /* スタイルはJavaScriptで動的に設定 */
        }
        
        .floating-summary-item {
            pointer-events: auto; /* サマリー要素自体はクリック可能 */
            margin-right: 4px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            font-weight: 500;
            position: absolute;
            top: 0; /* コンテナ内での上下位置 */
            height: 25px;
            line-height: 25px;
            padding: 0 8px;
        }

        .schedule-scroll-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .schedule-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .schedule-scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .schedule-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }


        .schedule-table th,
        .schedule-table td {
            min-width: 150px;
            width: 150px;
            max-width: 150px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: top;
            word-wrap: break-word;
            box-sizing: border-box;
        }

        .schedule-grid th:first-child,
        .schedule-grid td:first-child {
            min-width: 80px;
            width: 80px;
            max-width: 80px;
            position: sticky;
            left: 0;
            background: #f8fafc;
            z-index: 10;
            border-right: 2px solid #cbd5e0;
        }



        .bottom-legend-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
        }

        .bottom-legend-table td {
            min-width: 150px;
            width: 150px;
            max-width: 150px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .bottom-legend-table td:first-child {
            min-width: 80px;
            width: 80px;
            max-width: 80px;
            position: sticky;
            left: 0;
            background: #f8fafc;
            z-index: 10;
            border-right: 2px solid #cbd5e0;
        }

        /* 重複確認モーダルのスタイル */
        #conflictModal {
            z-index: 9000;
        }

        #conflictModal .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #conflictModal .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #conflictModal .btn-danger:hover {
            background: #b91c1c !important;
        }

        #conflictModal .btn-primary:hover {
            background: #1d4ed8 !important;
        }

        #conflictModal .btn-warning:hover {
            background: #b45309 !important;
        }

        .patient-name-display {
            font-weight: 600;
            color: #2d3748;
        }

        .patient-id-display {
            font-size: 11px;
            color: #718096;
        }

        /* 患者検索メッセージスタイル */
        .patient-initial-message,
        .patient-loading-message,
        .patient-no-results-message {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            padding: 2rem;
        }

        .message-content {
            text-align: center;
            color: #718096;
        }

        .message-content .message-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }

        .message-content p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .message-content small {
            font-size: 0.9rem;
            color: #a0aec0;
        }

        .loading-spinner {
            font-size: 2rem;
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 患者操作ボタンスタイル */
        .btn-icon.view {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .btn-icon.view:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .btn-icon.edit {
            background: #4299e1;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }

        .btn-icon.edit:hover {
            background: #3182ce;
            transform: scale(1.1);
        }
        
        /* プラスアイコン（サブ項目追加用）専用スタイル */
        .btn-icon.add-sub {
            background: #22c55e;
            color: white;
            border: none;
            padding: 30px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-left: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-icon.add-sub:hover {
            background: #16a34a;
            transform: scale(1.1);
        }

        /* 鉛筆アイコン（名称変更用）専用スタイル */
        .btn-icon.rename {
            background: #ecc94b;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-icon.rename:hover {
            background: #d69e2e;
            transform: scale(1.1);
        }
        
        /* 時計アイコン（標準時間編集用）専用スタイル */
        .btn-icon.duration {
            background: #06b6d4;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-icon.duration:hover {
            background: #0891b2;
            transform: scale(1.1);
        }

        .btn-icon.delete {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
            position: relative;
        }


        .btn-icon.delete:hover {
            background: #c53030;
            transform: scale(1.1);
        }
        
        /* クリック可能な設定項目のスタイル */
        .clickable-setting {
            transition: all 0.2s ease;
            border-radius: 3px;
            padding: 2px 4px;
        }
        
        .clickable-setting:hover {
            background: #f3f4f6;
            transform: scale(1.05);
            text-decoration: underline;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 4px;
            transition: background-color 0.2s;
        }

        .btn-icon.delete:hover {
            background: #c53030;
        }
        
        /* サブ項目追加ボタン */
        button.btn-add-sub {
            background: #22c55e !important;
            color: white !important;
            border: none !important;
            padding: 5px 8px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            font-size: 11px !important;
            margin-right: 3px !important;
            transition: background-color 0.2s !important;
            font-weight: 500 !important;
            width: auto !important;
            text-align: center !important;
            white-space: nowrap !important;
            display: inline-block !important;
            box-sizing: border-box !important;
            outline: none !important;
        }
        
        button.btn-add-sub:hover {
            background: #16a34a !important;
            transform: scale(1.1);
        }
        
        /* ボタン位置揃えのためのスペーサー */
        .btn-spacer {
            display: inline-block;
            width: auto; /* サブ項目追加ボタンのauto幅に合わせる */
            margin-right: 3px;
        }

        /* 標準時間編集ボタン用スペーサー - 実際のボタンと完全に同じサイズ */
        .btn-spacer-duration {
            background: transparent !important;
            color: transparent !important;
            border: none !important;
            padding: 5px 8px !important;
            border-radius: 4px !important;
            font-size: 12px !important;
            margin-left: 2px !important;
            cursor: default !important;
            display: inline-block !important;
            width: auto !important;
            height: auto !important;
            visibility: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* 治療アクション列の統一スタイル */
        .treatment-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            white-space: nowrap;
            padding: 8px 12px;
            gap: 0; /* ボタン間の間隔を統一 */
        }
        
        
        /* 並び順変更ボタン */
        .btn-icon.move-up, .btn-icon.move-down {
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-icon.move-up:hover:not(:disabled), 
        .btn-icon.move-down:hover:not(:disabled) {
            background: #2d3748;
        }
        
        .btn-icon.move-up:disabled, 
        .btn-icon.move-down:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* ドラッグ中のヘッダースタイル */
        .schedule-grid th.dragging {
            opacity: 0.5;
        }
        
        .schedule-grid th.drag-over {
            border-left: 4px solid #10b981 !important;
        }
        
        
        /* 履歴表示のスタイル */
        .history-past {
            opacity: 0.7;
            background-color: #f9fafb;
        }
        
        .history-today {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .history-future {
            background-color: #ecfdf5;
            border-left: 4px solid #10b981;
        }
        
        .status-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }
        
        .status-label {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .history-past .status-label {
            background-color: #d1d5db;
            color: #374151;
        }
        
        .history-today .status-label {
            background-color: #f59e0b;
            color: white;
        }
        
        .history-future .status-label {
            background-color: #10b981;
            color: white;
        }
        
        .history-actions {
            text-align: center;
        }

        /* 履歴フィルターボタン */
        .filter-btn {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #edf2f7;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* 履歴テーブルのスタイル */
        /* パフォーマンス最適化のための追加スタイル */
        .history-table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .history-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .history-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .history-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .history-table-container {
                max-height: 300px;
            }
            
            .history-table {
                min-width: 600px;
                font-size: 14px;
            }
            
            .history-table th,
            .history-table td {
                padding: 8px;
            }
            
            .history-table .btn-icon {
                font-size: 12px;
                padding: 4px 6px;
            }
        }

        .no-history {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
        }

        .no-history p {
            font-size: 1.1rem;
            margin: 0;
        }

        /* iPad横向き対応 */
        @media (min-width: 768px) and (max-width: 1200px) {
            .calendar-container {
                padding: 1rem;
                overflow-x: auto;
            }
            
            
            .schedule-grid {
                min-width: 1200px;
            }
            
            .schedule-grid th:first-child {
                width: 120px;
            }
            
            .schedule-grid th:not(:first-child) {
                width: 160px;
            }
            
            .schedule-grid td {
                height: 25px;
            }
            
            .appointment {
                font-size: 10px;
                padding: 3px 4px;
            }
            
            .appointment-patient {
                font-size: 10px;
            }
            
            .appointment-nurse, .appointment-time {
                font-size: 8px;
            }
        }

        /* モバイル対応 */
        @media (max-width: 767px) {
            .calendar-container {
                padding: 0.5rem;
                overflow-x: auto;
            }
            
            
            .schedule-grid {
                min-width: 1000px;
            }
            
            .schedule-grid th:first-child {
                width: 100px;
            }
            
            .schedule-grid th:not(:first-child) {
                width: 140px;
            }
            
            .schedule-grid td {
                height: 20px;
            }
            
            .appointment {
                font-size: 9px;
                padding: 2px 3px;
            }
            
            .appointment-patient {
                font-size: 9px;
            }
            
            .appointment-nurse, .appointment-time {
                font-size: 7px;
            }
            
            .nav-controls {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-btn, .nav-btn-quick {
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .current-date {
                font-size: 1rem;
                min-width: 150px;
            }
        }

        /* 2段構造ヘッダーの基本スタイル */
        .two-tier-header {
            position: relative;
        }
        
    </style>
    
    <!-- 印刷用スタイルシート -->
    <style media="print" id="printStyles">
        @page {
            size: A4 landscape;
            margin: 10mm;
        }
        
        /* 印刷時に非表示にする要素 */
        .app-header-fixed,
        .header,
        .controls,
        .nav-controls,
        .header-controls,
        .modal,
        .modal-overlay,
        .treatment-selector,
        .filter-controls,
        #floatingSummaryContainer,
        .floating-summary-container,
        .floating-summary-item,
        .container > .controls {
            display: none !important;
        }
        
        /* 印刷用の基本スタイル */
        body {
            background: white !important;
            color: black !important;
            overflow: visible !important;
            height: auto !important;
            display: block !important;
            flex-direction: unset !important;
        }
        
        .container {
            display: none !important;
        }
        
        .schedule-container {
            display: block !important;
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
            position: static !important;
            flex: none !important;
        }
        
        /* 印刷用の日付タイトル */
        .print-date-header {
            display: none !important; /* 別ページにならないように非表示 */
        }
        
        /* テーブルの上部に日付を表示 */
        .schedule-table thead::before {
            content: attr(data-print-date);
            display: block;
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        
        .schedule-table {
            position: relative;
            margin-top: 30px;
        }
        
        /* テーブルのスタイル調整 */
        .schedule-table {
            width: 100% !important;
            font-size: var(--print-font-size, 10px) !important;
            border-collapse: separate !important;
            border-spacing: 0 !important;
            page-break-inside: avoid;
            transform: scale(var(--print-scale, 1));
            transform-origin: top left;
            /* テーブル全体に境界線 */
            border: 1px solid #333 !important;
        }
        
        .schedule-table th,
        .schedule-table td {
            padding: var(--print-padding, 4px) !important;
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
            font-size: var(--print-cell-font-size, 10px) !important;
            /* 細い境界線を設定 */
            border-top: 0.5px solid #999 !important;
            border-bottom: 0.5px solid #999 !important;
            border-left: 0.5px solid #999 !important;
            border-right: 0.5px solid #999 !important;
            /* WebKit系ブラウザ対応 */
            -webkit-border-horizontal-spacing: 0 !important;
            -webkit-border-vertical-spacing: 0 !important;
        }
        
        /* ヘッダーの背景色を維持 */
        .schedule-sticky-header th {
            background-color: #f0f0f0 !important;
            color: black !important;
            font-weight: bold !important;
            position: static !important;
        }
        
        /* 予約ブロックの印刷時調整 */
        .appointment {
            font-size: var(--print-appointment-font-size, 8px) !important;
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
            border: 1px solid #333 !important;
            position: absolute !important;
            z-index: 10 !important;
        }
        
        /* 印刷時のセル高さを実測値に合わせて固定 */
        .schedule-table td {
            height: 29px !important;
            min-height: 29px !important;
            max-height: 29px !important;
            vertical-align: top !important;
        }
        
        /* 予約ブロックの高さを印刷用に調整（実際のセル高さ29px基準） */
        /* 15分 = 3セル = 87px (29px * 3) */
        .appointment[data-duration="15"] {
            height: 87px !important;
        }
        /* 30分 = 6セル = 174px (29px * 6) */
        .appointment[data-duration="30"] {
            height: 174px !important;
        }
        /* 45分 = 9セル = 261px (29px * 9) */
        .appointment[data-duration="45"] {
            height: 261px !important;
        }
        /* 60分 = 12セル = 348px (29px * 12) */
        .appointment[data-duration="60"] {
            height: 348px !important;
        }
        /* 75分 = 15セル = 435px (29px * 15) */
        .appointment[data-duration="75"] {
            height: 435px !important;
        }
        /* 90分 = 18セル = 522px (29px * 18) */
        .appointment[data-duration="90"] {
            height: 522px !important;
        }
        /* 120分 = 24セル = 696px (29px * 24) */
        .appointment[data-duration="120"] {
            height: 696px !important;
        }
        
        /* 長時間予約のページ分割対策（最小限） */
        .appointment[data-duration="90"],
        .appointment[data-duration="120"] {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
        
        
        
        /* 予約件数表示 */
        .appointment-count {
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
            font-size: var(--print-count-font-size, 9px) !important;
        }
        
        /* ページ破れを防ぐ */
        tr {
            page-break-inside: avoid;
        }
        
        /* 時間セルを確実に表示 */
        .time-cell {
            position: static !important;
            box-shadow: none !important;
            background: #f3f4f6 !important;
            font-weight: 600 !important;
            color: #1f2937 !important;
            text-align: center !important;
            vertical-align: middle !important;
            min-width: 45px !important;
        }
        
        /* スケジュール表印刷時のみ表示 */
        .schedule-table {
            display: table !important;
        }
        
        /* 一覧印刷時はスケジュール表を非表示 */
        body.print-list-mode .schedule-table {
            display: none !important;
        }
        
        /* 一覧印刷時のみ表示される一覧 */
        body.print-list-mode .print-appointment-list {
            display: block !important;
        }
        
        .print-appointment-list {
            display: none;
        }
        
        /* 一覧印刷用スタイル */
        .print-appointment-list {
            width: 100%;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .print-list-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        .print-list-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .print-treatment-group {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        
        .print-treatment-title {
            background-color: #f0f0f0;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #ccc;
            margin-bottom: 2px;
        }
        
        .print-appointment-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        .print-appointment-table th,
        .print-appointment-table td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        
        .print-appointment-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            font-size: 11px;
        }
        
        .print-time-col { width: 60px; }
        .print-patient-col { width: 120px; }
        .print-nurse-col { width: 80px; }
        .print-treatment-col { width: 150px; }
        .print-device-col { width: 80px; }
    }
    </style>
</head>
<body>

    <!-- 固定された上部操作エリア -->
    <div class="app-header-fixed">
        <!-- ヘッダー部分（元のデザイン維持） -->
        <div class="header-content">
            <h1 class="header-title">美容クリニック施術室管理</h1>
            <div class="header-controls">
                <div class="nav-controls">
                    <div class="nav-button-group">
                        <button class="nav-btn-quick" id="prevMonthBtn">先月</button>
                        <button class="nav-btn-quick" id="prevWeekBtn">先週</button>
                        <button class="nav-btn" id="prevBtn">‹</button>
                    </div>
                    
                    <div class="current-date" id="currentDate">
                        <span class="calendar-icon">📅</span>
                        <span id="dateText"></span>
                    </div>
                    
                    <div class="nav-button-group">
                        <button class="nav-btn" id="nextBtn">›</button>
                        <button class="nav-btn-quick" id="nextWeekBtn">来週</button>
                        <button class="nav-btn-quick" id="nextMonthBtn">来月</button>
                    </div>
                    
                    <button class="nav-btn" id="todayBtn">今日</button>
                </div>
                <button class="btn" onclick="calendar.openModal()" style="background: #28a745; border-color: #28a745; color: white;">+ 新規予約</button>
                <button class="btn" onclick="calendar.openManageModal()">管理</button>
                <div style="position: relative; display: inline-block;">
                    <button class="btn" onclick="calendar.togglePrintMenu()" style="background: #6c757d; border-color: #6c757d; color: white;">印刷</button>
                    <div id="printMenuDropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; min-width: 120px;">
                        <button onclick="calendar.printSchedule()" style="display: block; width: 100%; padding: 8px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 14px;">表印刷</button>
                        <button onclick="calendar.printList()" style="display: block; width: 100%; padding: 8px 12px; background: none; border: none; text-align: left; cursor: pointer; font-size: 14px; border-top: 1px solid #eee;">一覧印刷</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- フィルターエリア -->
        <div class="filters-content">
            <div class="filter-group">
                <label class="filter-label">表示:</label>
                <div class="segment-control">
                    <button 
                        class="segment-button" 
                        id="showBookedOnly"
                        onclick="calendar.setTreatmentRowsVisibility(true)"
                    >
                        予約のみ
                    </button>
                    <button 
                        class="segment-button" 
                        id="showAllItems"
                        onclick="calendar.setTreatmentRowsVisibility(false)"
                    >
                        全項目
                    </button>
                </div>
            </div>
            <div class="filter-group">
                <button id="toggleAllSubItems" class="btn" onclick="calendar.toggleAllSubItems()" style="background: #3b82f6; border-color: #3b82f6; color: white; font-size: 12px; padding: 4px 8px;">
                    全て展開
                </button>
            </div>
            <div class="filter-group">
                <label class="filter-label">看護師:</label>
                <div class="filter-checkbox-container">
                    <div class="filter-dropdown-trigger" onclick="toggleFilterDropdown('nurseFilter')">
                        <span id="nurseFilterDisplay">全員</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="filter-dropdown-content" id="nurseFilterDropdown" style="display: none;">
                        <label class="checkbox-item">
                            <input type="checkbox" id="allNurses" checked onchange="calendar.toggleAllNurses(this)">
                            <span>全員</span>
                        </label>
                        <div id="nurseCheckboxes">
                            <!-- 看護師チェックボックスが動的に追加される -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">デバイス:</label>
                <div class="filter-checkbox-container">
                    <div class="filter-dropdown-trigger" onclick="toggleFilterDropdown('deviceFilter')">
                        <span id="deviceFilterDisplay">全て</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="filter-dropdown-content" id="deviceFilterDropdown" style="display: none;">
                        <label class="checkbox-item">
                            <input type="checkbox" id="allDevices" checked onchange="calendar.toggleAllDevices(this)">
                            <span>全て</span>
                        </label>
                        <div id="deviceCheckboxes">
                            <!-- デバイスチェックボックスが動的に追加される -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 単一のスクロール可能エリア -->
    <div class="schedule-container">
        <table class="schedule-table" id="scheduleTable">
            <thead class="schedule-sticky-header">
                <tr id="scheduleHeaderRow">
                    <!-- ヘッダーがJavaScriptで動的に生成される -->
                </tr>
            </thead>
            <tbody id="scheduleBody">
                <!-- 時間帯の行がJavaScriptで生成される -->
            </tbody>
        </table>
        
        <!-- 一覧印刷用のコンテンツ（印刷時のみ表示） -->
        <div class="print-appointment-list" id="printAppointmentList">
            <!-- 一覧がJavaScriptで動的に生成される -->
        </div>
    </div>

    <!-- 予約モーダル -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="calendar.closeModal()">&times;</span>
            <h2 id="modalTitle">新規予約</h2>
            <form id="appointmentForm">
                <div class="form-group">
                    <label class="form-label">患者選択 <span class="required-star">*</span></label>
                    <div class="patient-select-container">
                        <input type="text" class="form-input patient-name-input" id="patientName" placeholder="患者名またはカルテIDで検索..." 
                               autocomplete="off" oninput="calendar.searchPatientsInForm()" required>
                        <input type="hidden" id="patientId">
                        <div class="patient-suggestions" id="patientSuggestions"></div>
                    </div>
                    <button type="button" class="btn btn-secondary" id="showHistoryBtn" onclick="calendar.showHistoryFromEdit()" style="margin-top: 8px; display: none;">
                        施術履歴を表示
                    </button>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">施術メニュー <span class="required-star">*</span></label>
                    <div class="treatment-selector">
                        <input type="text" 
                               class="form-control" 
                               id="treatmentDisplay" 
                               placeholder="施術メニューを選択してください" 
                               readonly 
                               required 
                               onclick="calendar.toggleTreatmentDropdown()">
                        <div class="treatment-dropdown" id="treatmentDropdown" style="display: none;">
                            <!-- 動的に生成される -->
                        </div>
                        <input type="hidden" id="treatmentType" name="treatmentType">
                        <input type="hidden" id="subItem" name="subItem">
                    </div>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">デバイス <span class="required-star">*</span></label>
                    <select class="form-select" id="device" required>
                        <option value="">選択してください</option>
                        <option value="なし">なし</option>
                    </select>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">所要時間 <span class="required-star">*</span></label>
                    <select class="form-select" id="duration" required>
                        <!-- JavaScriptで動的生成 -->
                    </select>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">担当看護師 *</label>
                    <select class="form-select" id="nurse" required>
                        <option value="">選択してください</option>
                    </select>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">予約日 *</label>
                    <div class="date-input-wrapper" style="position: relative;">
                        <input type="text" class="form-input" id="appointmentDate" readonly required 
                               placeholder="選択してください"
                               onclick="calendar.openDatePicker()"
                               style="cursor: pointer; background: white; padding-right: 40px;">
                        <button type="button" class="calendar-icon-btn" onclick="calendar.openDatePicker()" 
                                style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; padding: 5px; 
                                       color: #6b7280; font-size: 20px;">
                            📅
                        </button>
                    </div>
                    <div class="form-error"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">開始時間 *</label>
                    <div class="time-inputs">
                        <select class="form-select" id="startHour" required>
                            <option value="">選択してください</option>
                        </select>
                        <select class="form-select" id="startMinute" required>
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div class="form-error"></div>
                </div>

                
                <div class="form-group">
                    <label class="form-label">コメント（内部メモ）</label>
                    <textarea class="form-input" id="appointmentComment" rows="3" 
                              placeholder="前処置有無や注意事項など"
                              style="resize: vertical; min-height: 60px; font-size: 14px;"></textarea>
                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px; text-align: right;">
                        <span id="commentCharCount">0</span>文字
                    </div>
                </div>

                <div class="form-group">
                    <!-- 間隔表示エリア -->
                    <div id="intervalInfo" style="display: none; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3182ce;">
                        <div id="intervalInfoContent" style="font-size: 14px; color: #4a5568;"></div>
                    </div>
                    
                    <!-- 時間枠検索コンテナを元の位置に戻す -->
                    <div class="search-suggestion-container" id="searchSuggestionContainer" style="display: none; margin-bottom: 16px;">
                        <div class="search-controls" style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
                            <label class="form-label" style="margin-bottom: 0; white-space: nowrap;">対象期間</label>
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div class="date-input-wrapper" style="position: relative;">
                                    <input type="text" class="form-input" id="searchStartDate" readonly required 
                                           placeholder="開始日を選択"
                                           onclick="calendar.openSearchDatePicker()"
                                           style="cursor: pointer; background: white; padding-right: 40px; width: 120px; font-size: 12px;">
                                    <button type="button" class="calendar-icon-btn" onclick="calendar.openSearchDatePicker()" 
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                                   background: none; border: none; cursor: pointer; padding: 5px; 
                                                   color: #6b7280; font-size: 16px;">
                                        📅
                                    </button>
                                </div>
                                
                                <span style="color: #6b7280; font-size: 12px;">から</span>
                                
                                <div class="date-input-wrapper" style="position: relative;">
                                    <input type="text" class="form-input" id="searchEndDate" readonly required 
                                           placeholder="終了日を選択"
                                           onclick="calendar.openSearchDatePicker()"
                                           style="cursor: pointer; background: white; padding-right: 40px; width: 120px; font-size: 12px;">
                                    <button type="button" class="calendar-icon-btn" onclick="calendar.openSearchDatePicker()" 
                                            style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                                   background: none; border: none; cursor: pointer; padding: 5px; 
                                                   color: #6b7280; font-size: 16px;">
                                        📅
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary" onclick="calendar.setQuickPeriod(7)" 
                                        style="background: #e2e8f0; color: #4a5568; border-color: #e2e8f0; font-size: 11px; padding: 4px 8px;">
                                    1週間
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="calendar.setQuickPeriod(14)" 
                                        style="background: #e2e8f0; color: #4a5568; border-color: #e2e8f0; font-size: 11px; padding: 4px 8px;">
                                    2週間
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="calendar.setQuickPeriod(28)" 
                                        style="background: #e2e8f0; color: #4a5568; border-color: #e2e8f0; font-size: 11px; padding: 4px 8px;">
                                    1ヶ月
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                <label style="font-size: 12px; color: #4a5568; margin-bottom: 0;">施術間隔制限:</label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #4a5568;">
                                    <input type="checkbox" id="ignoreIntervalRestriction" style="margin: 0;">
                                    制限を無視
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn" id="searchSlotsBtn" onclick="calendar.searchAvailableSlots()" style="background: #4299e1; border-color: #4299e1;">
                                    検索
                                </button>
                                <button type="button" class="btn" id="patientViewModeBtn" onclick="calendar.enterPatientViewMode()" style="background: #48bb78; border-color: #48bb78; color: white;">
                                    患者閲覧モード
                                </button>
                            </div>
                        </div>
                        <div class="search-results" id="searchResults" style="display: none;">
                            <div class="search-tabs" style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">
                                <button class="search-tab active" data-sort="earliest" onclick="calendar.switchSearchTab('earliest', event)" 
                                        style="padding: 8px 16px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer;">
                                    最も早い時間順
                                </button>
                                <button class="search-tab" data-sort="available" onclick="calendar.switchSearchTab('available', event)" 
                                        style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 4px; cursor: pointer;">
                                    空き枠が多い順
                                </button>
                                <div class="search-nurse-filter" id="searchNurseFilter" style="display: none; margin-left: 16px;">
                                    <div style="display: flex; align-items: center;">
                                        <label style="font-size: 14px; color: #4a5568; margin-right: 8px; white-space: nowrap;">看護師:</label>
                                        <div class="search-nurse-dropdown" style="position: relative; display: inline-block;">
                                            <button id="searchNurseDropdownBtn" class="dropdown-btn" onclick="calendar.toggleSearchNurseDropdown(event)" 
                                                    style="padding: 6px 12px; border: 1px solid #e2e8f0; background: white; border-radius: 4px; cursor: pointer; font-size: 13px; min-width: 120px; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                                                <span>全員</span>
                                                <span class="dropdown-arrow" style="margin-left: 8px; transition: transform 0.2s ease;">▼</span>
                                            </button>
                                            <div id="searchNurseDropdownMenu" class="dropdown-menu" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #e2e8f0; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; min-width: 120px; max-height: 200px; overflow-y: auto;">
                                                <!-- JavaScriptで生成 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="search-results-list" id="searchResultsList" style="max-height: 300px; overflow-y: auto;">
                                <!-- 検索結果がここに表示される -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 時間枠検索についての説明 -->
                    <div id="searchInstructionText" style="margin: 10px 0; padding: 8px 12px; background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 4px; font-size: 12px; color: #0050b3; display: none;">
                        時間枠検索を行うには、「患者」「施術メニュー」「デバイス」「所要時間」を選択してください
                    </div>
                    
                    <div class="button-group" style="display: flex; gap: 12px; align-items: center;">
                        <button type="submit" class="btn" id="saveBtn">保存</button>
                        <button type="button" class="btn" id="showSearchBtn" onclick="calendar.toggleSearchSuggestion()" 
                                style="background: #38a169; border-color: #38a169; color: white; display: none;">
                            時間枠検索
                        </button>
                        <button type="button" class="btn" id="deleteBtn" onclick="calendar.confirmDeleteAppointment()" style="background: #e53e3e; display: none;">削除</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理モーダル -->
    <div id="manageModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="calendar.closeManageModal()">&times;</span>
            <h2>データ管理</h2>
            <div class="manage-tabs">
                <button class="manage-tab active" data-tab="nurses" onclick="calendar.switchManageTab('nurses')">
                    看護師
                </button>
                <button class="manage-tab" data-tab="treatments" onclick="calendar.switchManageTab('treatments')">
                    施術メニュー
                </button>
                <button class="manage-tab" data-tab="devices" onclick="calendar.switchManageTab('devices')">
                    デバイス
                </button>
                <button class="manage-tab" data-tab="patients" onclick="calendar.switchManageTab('patients')">
                    患者
                </button>
                <button class="manage-tab" data-tab="others" onclick="calendar.switchManageTab('others')">
                    その他
                </button>
            </div>
            
            <!-- 看護師タブ -->
            <div id="nursesContent" class="manage-content active">
                <div class="manage-header">
                    <div class="add-item-form">
                        <input type="text" class="form-input" id="newNurseName" placeholder="新しい看護師名を入力">
                        <button class="btn btn-add" onclick="calendar.addNurse()">
                            <span class="btn-icon">+</span> 追加
                        </button>
                    </div>
                </div>
                <div class="manage-table-container">
                    <table class="manage-table">
                        <thead>
                            <tr>
                                <th width="50%">看護師名</th>
                                <th width="25%">予約件数</th>
                                <th width="25%"></th>
                            </tr>
                        </thead>
                        <tbody id="nursesList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 施術メニュータブ -->
            <div id="treatmentsContent" class="manage-content">
                <div class="manage-header">
                    <div class="add-item-form">
                        <input type="text" class="form-input" id="newTreatmentName" placeholder="新しい施術メニュー名を入力">
                        <button class="btn btn-add" onclick="calendar.addTreatment()">
                            <span class="btn-icon">+</span> 追加
                        </button>
                        <button class="btn btn-secondary" onclick="calendar.openDurationManageModal()" style="margin-left: 10px;">
                            所要時間編集
                        </button>
                    </div>
                </div>
                <div class="manage-table-container">
                    <table class="manage-table">
                        <thead>
                            <tr>
                                <th style="width: 20%;">施術メニュー名</th>
                                <th style="width: 9%;">看護師</th>
                                <th style="width: 12%;">標準時間</th>
                                <th style="width: 14%;">間隔制限</th>
                                <th style="width: 14%;">日時制限</th>
                                <th style="width: 31%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="treatmentsList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- デバイスタブ -->
            <div id="devicesContent" class="manage-content">
                <div class="manage-header">
                    <div class="add-item-form">
                        <input type="text" class="form-input" id="newDeviceName" placeholder="新しいデバイス名を入力">
                        <button class="btn btn-add" onclick="calendar.addDevice()">
                            <span class="btn-icon">+</span> 追加
                        </button>
                    </div>
                </div>
                <div class="manage-table-container">
                    <table class="manage-table">
                        <thead>
                            <tr>
                                <th width="50%">デバイス名</th>
                                <th width="25%">使用件数</th>
                                <th width="25%"></th>
                            </tr>
                        </thead>
                        <tbody id="devicesList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 患者タブ -->
            <div id="patientsContent" class="manage-content">
                <div class="manage-header">
                    <div class="patient-controls">
                        <div class="patient-search-box">
                            <input type="text" class="form-input search-input" id="patientSearch" 
                                   placeholder="🔍 患者名またはカルテIDを入力してください（2文字以上）" 
                                   oninput="calendar.searchPatients()">
                        </div>
                        <button class="btn btn-add" onclick="calendar.openNewPatientModal()">
                            <span class="btn-icon">+</span> 新規患者登録
                        </button>
                    </div>
                </div>
                
                <!-- 初期メッセージ -->
                <div id="patientInitialMessage" class="patient-initial-message">
                    <div class="message-content">
                        <span class="message-icon">🔍</span>
                        <p>患者名またはカルテIDを入力してください</p>
                        <small>2文字以上入力すると検索が開始されます</small>
                    </div>
                </div>
                
                <!-- 検索中メッセージ -->
                <div id="patientLoadingMessage" class="patient-loading-message" style="display: none;">
                    <div class="message-content">
                        <span class="loading-spinner">🔄</span>
                        <p>検索中...</p>
                    </div>
                </div>
                
                <!-- 検索結果なしメッセージ -->
                <div id="patientNoResultsMessage" class="patient-no-results-message" style="display: none;">
                    <div class="message-content">
                        <span class="message-icon">❌</span>
                        <p>該当患者が見つかりません</p>
                        <small>検索条件を変更してお試しください</small>
                    </div>
                </div>
                
                <!-- 検索結果エリア -->
                <div id="patientResultsArea" style="display: none;">
                    <div class="manage-table-container">
                        <table class="manage-table">
                            <thead>
                                <tr>
                                    <th width="25%">カルテID</th>
                                    <th width="35%">患者名</th>
                                    <th width="20%">来院回数</th>
                                    <th width="20%"></th>
                                </tr>
                            </thead>
                            <tbody id="patientsList">
                                <!-- JavaScriptで生成 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="patientPagination">
                        <!-- ページネーションがJavaScriptで生成される -->
                    </div>
                </div>
            </div>
            
            <!-- その他タブ -->
            <div id="othersContent" class="manage-content">
                <div class="manage-header">
                    <h3 style="margin: 0; color: #2d3748; font-size: 1.2em;">システム設定</h3>
                </div>
                
                <!-- セキュリティ設定セクション -->
                <div class="settings-section" style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 20px 0; color: #4a5568; font-size: 1.1em; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
                        🔐 セキュリティ設定
                    </h4>
                    
                    <div class="password-setting">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <label style="font-weight: 500; color: #2d3748; width: 120px;">現在のパスワード:</label>
                            <input type="password" id="currentPassword" class="form-input" placeholder="現在のパスワードを入力" style="width: 150px;">
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <label style="font-weight: 500; color: #2d3748; width: 120px;">新しいパスワード:</label>
                            <input type="text" id="newPassword" class="form-input" placeholder="4桁の数字" maxlength="4" pattern="[0-9]{4}" style="width: 150px;">
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <label style="font-weight: 500; color: #2d3748; width: 120px;">パスワード確認:</label>
                            <input type="text" id="confirmPassword" class="form-input" placeholder="4桁の数字" maxlength="4" pattern="[0-9]{4}" style="width: 150px;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="calendar.changePassword()" style="background: #4299e1; border-color: #4299e1;">
                                パスワード変更
                            </button>
                            <button class="btn btn-secondary" onclick="calendar.clearPasswordFields()" style="background: #6b7280; border-color: #6b7280;">
                                クリア
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 4px; border-left: 4px solid #4299e1;">
                            <small style="color: #4a5568;">
                                ※ パスワードは4桁の数字のみ使用可能です<br>
                                ※ 患者閲覧モードの終了とスタッフ画面復帰時に使用されます
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- 営業日設定セクション（今後実装予定） -->
                <div class="settings-section" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 20px 0; color: #4a5568; font-size: 1.1em; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
                        📅 営業日設定
                    </h4>
                    
                    <div style="padding: 20px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 6px; border: 2px dashed #d1d5db;">
                        <div style="font-size: 2em; margin-bottom: 10px;">🚧</div>
                        <p style="margin: 0; font-size: 1.1em; font-weight: 500;">今後実装予定</p>
                        <small>特例の休診日・営業日の設定機能を追加予定です</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 患者名編集モーダル -->
    <div id="editPatientModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="calendar.closeEditPatientModal()">&times;</span>
            <h2>患者名編集</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editPatientName">患者名（漢字）:</label>
                    <input type="text" id="editPatientName" class="form-input" placeholder="患者名を入力">
                </div>
                <div class="form-group">
                    <label for="editPatientHiragana">読み方（ひらがな）:</label>
                    <input type="text" id="editPatientHiragana" class="form-input" placeholder="読み方をひらがなで入力">
                </div>
                
                <div class="form-group">
                    <label>患者マーク:</label>
                    <div id="editPatientMarks" style="margin-top: 8px;">
                        <!-- マークチェックボックスがJavaScriptで生成される -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="calendar.savePatientNameEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 看護師名編集モーダル -->
    <div id="editNurseModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="calendar.closeEditNurseModal()">&times;</span>
            <h2>看護師名編集</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editNurseName">看護師名:</label>
                    <input type="text" id="editNurseName" class="form-input" placeholder="看護師名を入力">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="calendar.saveNurseNameEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 施術メニュー名編集モーダル -->
    <div id="editTreatmentModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="calendar.closeEditTreatmentModal()">&times;</span>
            <h2>施術メニュー名編集</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTreatmentName">施術メニュー名:</label>
                    <input type="text" id="editTreatmentName" class="form-input" placeholder="施術メニュー名を入力">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="calendar.saveTreatmentNameEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- デバイス名編集モーダル -->
    <div id="editDeviceModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="calendar.closeEditDeviceModal()">&times;</span>
            <h2>デバイス名編集</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editDeviceName">デバイス名:</label>
                    <input type="text" id="editDeviceName" class="form-input" placeholder="デバイス名を入力">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="calendar.saveDeviceNameEdit()">保存</button>
            </div>
        </div>
    </div>

    <!-- 看護師施術管理モーダル -->
    <div id="nurseTreatmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="calendar.closeNurseTreatmentModal()">&times;</span>
            <h2 id="nurseTreatmentModalTitle">可能施術管理</h2>
            <div class="modal-body">
                <div class="nurse-treatment-container">
                    <div class="current-nurse-info">
                        <h3 id="currentNurseName"></h3>
                        <p class="nurse-treatment-subtitle">対応可能な施術メニューを選択してください</p>
                    </div>
                    <div class="treatment-selection-grid">
                        <!-- JavaScriptで生成 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="calendar.saveNurseTreatmentSettings()">保存</button>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content modal-confirm">
            <span class="close" onclick="calendar.closeDeleteConfirmationModal()">&times;</span>
            <h2 class="modal-title-danger">⚠️ 削除確認</h2>
            <div id="deleteWarningText" class="warning-text"></div>
            
            <div id="affectedAppointmentsSection" class="affected-section">
                <h3 class="affected-title">影響を受ける予約一覧</h3>
                <div class="affected-appointments-table">
                    <table class="appointments-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>時間</th>
                                <th>患者名</th>
                                <th>施術内容</th>
                            </tr>
                        </thead>
                        <tbody id="affectedAppointmentsList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
                <div class="warning-note" id="deleteWarningMessage">
                    ⚠️ 削除すると、上記の予約の該当項目が「未設定」に変更されます。
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    削除を実行
                </button>
                <button class="btn btn-secondary" onclick="calendar.closeDeleteConfirmationModal()">
                    キャンセル
                </button>
            </div>
        </div>
    </div>

    <!-- 重複エラーモーダル -->
    <div id="resourceConflictModal" class="modal">
        <div class="modal-content modal-confirm">
            <span class="close" onclick="calendar.closeResourceConflictModal()">&times;</span>
            <h2 class="modal-title-danger">⚠️ 予約の重複が検出されました</h2>
            <div class="warning-text">
                指定した時間に以下のリソースが既に使用されています：
            </div>
            
            <div class="conflict-details" id="conflictDetailsList">
                <!-- JavaScriptで重複詳細を表示 -->
            </div>
            
            <div class="warning-note">
                ⚠️ 別の時間、看護師、またはデバイスを選択してください。
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="calendar.closeResourceConflictModal()">
                    予約内容を修正する
                </button>
            </div>
        </div>
    </div>

    <!-- 新規患者登録モーダル -->
    <div id="newPatientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="calendar.closeNewPatientModal()">&times;</span>
            <h2>新規患者登録</h2>
            <form id="newPatientForm">
                <div class="form-group">
                    <label class="form-label">カルテID *</label>
                    <input type="text" class="form-input" id="newPatientId" required>
                    <div class="form-error" id="patientIdError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">患者名（漢字） *</label>
                    <input type="text" class="form-input" id="newPatientName" required>
                    <div class="form-error"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">患者名（ひらがな） *</label>
                    <input type="text" class="form-input" id="newPatientHiragana" required>
                    <div class="form-error"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">患者マーク</label>
                    <div id="newPatientMarks" style="margin-top: 8px;">
                        <!-- マークチェックボックスがJavaScriptで生成される -->
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">登録</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 患者詳細モーダル -->
    <div id="patientDetailModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="calendar.closePatientDetailModal()">&times;</span>
            <div class="patient-detail-header">
                <h2 id="patientDetailTitle">患者詳細</h2>
                <div class="patient-basic-info">
                    <div class="info-item">
                        <span class="info-label">カルテID:</span>
                        <span id="detailPatientId"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">患者名:</span>
                        <span id="detailPatientName"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">登録日:</span>
                        <span id="detailPatientRegistered"></span>
                    </div>
                </div>
            </div>
            
            <div class="patient-history-section">
                <div class="history-header">
                    <h3>施術履歴</h3>
                    <div class="history-filter">
                        <button class="filter-btn active" data-period="30" onclick="calendar.filterPatientHistory(30)">過去30日</button>
                        <button class="filter-btn" data-period="90" onclick="calendar.filterPatientHistory(90)">過去3ヶ月</button>
                        <button class="filter-btn" data-period="all" onclick="calendar.filterPatientHistory('all')">全期間</button>
                    </div>
                </div>
                
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th width="15%">日付</th>
                                <th width="20%">時間</th>
                                <th width="25%">施術内容</th>
                                <th width="20%">担当看護師</th>
                                <th width="15%">使用デバイス</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="patientHistoryList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 患者履歴表示モーダル -->
    <div id="patientHistoryModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="calendar.closePatientHistoryModal()">&times;</span>
            <div class="patient-detail-header">
                <h2 id="historyModalTitle">施術履歴</h2>
                <div class="patient-basic-info">
                    <div class="info-item">
                        <span class="info-label">カルテID:</span>
                        <span id="historyPatientId"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">患者名:</span>
                        <span id="historyPatientName"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">総来院回数:</span>
                        <span id="historyPatientVisits"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">最終来院:</span>
                        <span id="historyPatientLastVisit"></span>
                    </div>
                </div>
            </div>
            
            <div class="patient-history-section">
                <div class="history-header">
                    <div class="history-title-section">
                        <h3>施術履歴一覧</h3>
                        <button class="btn btn-primary" onclick="calendar.addNewAppointmentFromHistory()" style="background: #28a745; border-color: #28a745;">
                            + 新規予約
                        </button>
                    </div>
                    <div class="history-filter">
                        <button class="btn filter-btn active" onclick="calendar.filterHistoryDisplay('all')">全期間</button>
                        <button class="btn filter-btn" onclick="calendar.filterHistoryDisplay('30days')">30日以内</button>
                        <button class="btn filter-btn" onclick="calendar.filterHistoryDisplay('3months')">3ヶ月以内</button>
                        <button class="btn filter-btn" onclick="calendar.filterHistoryDisplay('future')">未来のみ</button>
                        <button class="btn filter-btn" onclick="calendar.filterHistoryDisplay('past')">過去のみ</button>
                    </div>
                    
                    <!-- 施術メニューフィルター -->
                    <div class="history-treatment-filter" id="historyTreatmentFilter" style="display: none; margin-top: 1rem;">
                        <div class="filter-group">
                            <label class="filter-label">施術メニュー:</label>
                            <div class="filter-checkbox-container">
                                <div class="filter-dropdown-trigger" onclick="toggleHistoryTreatmentFilter()">
                                    <span id="treatmentFilterDisplay">全て</span>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                                <div class="filter-dropdown-content" id="treatmentFilterDropdown" style="display: none;">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="allTreatments" checked onchange="calendar.toggleAllTreatments(this)">
                                        <span>全て</span>
                                    </label>
                                    <div id="treatmentCheckboxes">
                                        <!-- 施術メニューチェックボックスが動的に追加される -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>時間</th>
                                <th>施術内容</th>
                                <th>担当看護師</th>
                                <th>使用デバイス</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="historyModalList">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="historyNoData" class="no-history" style="display: none;">
                    <p>指定期間内の施術履歴がありません</p>
                </div>
            </div>
        </div>
    </div>

    <!-- カレンダーオーバーレイ（全体の外に配置） -->
    <div class="calendar-overlay" id="calendarOverlay"></div>
    
    <!-- カレンダーポップアップ（独立したモーダル要素） -->
    <div class="calendar-popup" id="calendarPopup">
        <span class="close" onclick="hideCalendarPopup()">&times;</span>
        <h2 style="margin-bottom: 20px;">日付を選択</h2>
        
        <div class="calendar">
            <div class="calendar-header">
                <button class="calendar-month-nav calendar-6month" id="calendarPrev6Month">‹‹</button>
                <button class="calendar-month-nav" id="calendarPrevMonth">‹</button>
                <div class="calendar-month-year" id="calendarMonthYear"></div>
                <button class="calendar-month-nav" id="calendarNextMonth">›</button>
                <button class="calendar-month-nav calendar-6month" id="calendarNext6Month">››</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        
        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button type="button" class="btn btn-primary" onclick="navigateToToday()">今日</button>
        </div>
    </div>
    
    <div class="success-message" id="successMessage"></div>

    <!-- 日付選択カレンダーモーダル -->
    <div id="datePickerModal" class="modal">
        <div class="modal-content date-picker-content">
            <span class="close" onclick="calendar.closeDatePicker()">&times;</span>
            <h2 style="margin-bottom: 20px;">日付を選択</h2>
            
            <div class="calendar">
                <div class="calendar-header">
                    <button class="calendar-month-nav calendar-6month" onclick="calendar.navigateDatePicker(-6)">‹‹</button>
                    <button class="calendar-month-nav" onclick="calendar.navigateDatePicker(-1)">‹</button>
                    <div class="calendar-month-year" id="datePickerMonthYear"></div>
                    <button class="calendar-month-nav" onclick="calendar.navigateDatePicker(1)">›</button>
                    <button class="calendar-month-nav calendar-6month" onclick="calendar.navigateDatePicker(6)">››</button>
                </div>
                <div class="calendar-grid" id="datePickerGrid"></div>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button type="button" class="btn btn-primary" onclick="calendar.selectToday()">今日</button>
                <button id="confirmPeriodBtn" type="button" class="btn btn-success" onclick="calendar.confirmPeriodSelection()" style="display: none;">決定</button>
            </div>
        </div>
    </div>
    

    <!-- 営業時間外警告モーダル -->
    <div id="businessHoursWarningModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeBusinessHoursWarning()">&times;</span>
            <h2>⚠️ 営業時間外の予約です</h2>
            <div class="modal-body">
                <div class="warning-message">
                    <p id="warningReason"></p>
                    <div class="business-hours-info">
                        <h3>営業時間</h3>
                        <p><strong>平日・土曜:</strong> 11:00～14:30 / 16:00～20:30</p>
                        <p><strong>休診日:</strong> 日曜・月曜・祝日（土曜祝日は営業）</p>
                        <p><strong>昼休み:</strong> 14:30～16:00</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBusinessHoursWarning()">戻る</button>
                <button class="btn btn-danger" onclick="forceCreateAppointment()">強制的に登録</button>
            </div>
        </div>
    </div>

    <script>
        // データ管理クラス（マルチ端末同期対応）
        class DataManager {
            constructor() {
                this.lastSyncTime = null;
                this.lastModified = null;
                this.syncInterval = 5000; // 5秒ごとに同期
                this.syncTimer = null;
                this.clientId = this.generateClientId();
                
                // JSONBin.io設定
                this.binId = '68ba4a4a43b1c97be9373a5f';
                this.apiKey = '$2a$10$rUJlLkq4wOYmc5W3nJ7I1epb3PqfDqG7TIy6mcdtkZKcuxUiKO46m';
                this.baseUrl = 'https://api.jsonbin.io/v3/b/';
                
                // デバッグモード
                this.debugMode = true;
            }

            // クライアントID生成
            generateClientId() {
                return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // オンラインからデータを読み込み
            async loadFromOnline() {
                try {
                    const response = await fetch(`${this.baseUrl}${this.binId}/latest`, {
                        headers: {
                            'X-Master-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('📡 オンラインデータ取得成功（Enhanced版）');
                        return result.record;
                    }
                    return null;
                } catch (error) {
                    console.warn('⚠️ オンライン接続エラー:', error);
                    return null;
                }
            }

            // 全データを統合してオンライン保存
            async saveAllData() {
                try {
                    const allData = {
                        appointments: appointments,
                        patients: patients,
                        treatments: treatments,
                        staff: staff,
                        settings: settings,
                        devices: devices,
                        lastModified: new Date().toISOString(),
                        clientId: this.clientId
                    };
                    
                    const response = await fetch(`${this.baseUrl}${this.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.apiKey,
                            'X-Bin-Name': 'clinic-data-enhanced'
                        },
                        body: JSON.stringify(allData)
                    });

                    if (response.ok) {
                        this.lastModified = allData.lastModified;
                        console.log('💾 全データをオンラインに保存しました（Enhanced版）');
                        showNotification('データを同期しました', 'success');
                        return true;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('❌ オンライン保存エラー:', error);
                    showNotification('同期エラー（オフラインモード）', 'error');
                    return false;
                }
            }

            // リアルタイム同期の開始
            startSync() {
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                }
                
                this.syncTimer = setInterval(async () => {
                    await this.checkForUpdates();
                }, this.syncInterval);
                
                console.log(`🔄 リアルタイム同期開始 (${this.syncInterval/1000}秒間隔)`);
                showNotification('同期機能を開始しました', 'info');
            }
            
            // 更新確認
            async checkForUpdates() {
                try {
                    const onlineData = await this.loadFromOnline();
                    if (onlineData && onlineData.lastModified !== this.lastModified) {
                        // データが更新されている場合
                        if (onlineData.clientId !== this.clientId) {
                            console.log('🔄 他の端末からの更新を検出');
                            
                            // グローバル変数を更新
                            appointments = onlineData.appointments || appointments;
                            patients = onlineData.patients || patients;
                            treatments = onlineData.treatments || treatments;
                            staff = onlineData.staff || staff;
                            settings = onlineData.settings || settings;
                            devices = onlineData.devices || devices;
                            this.lastModified = onlineData.lastModified;
                            
                            // UIを更新
                            renderCalendar();
                            updateStatistics();
                            
                            console.log('✨ データを他の端末の更新で同期しました');
                            showNotification('他の端末からの更新を反映しました', 'info');
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ 同期確認エラー:', error);
                }
            }

            // リアルタイム同期の停止
            stopSync() {
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                    this.syncTimer = null;
                    console.log('⏸️ リアルタイム同期停止');
                }
            }
        }

        // データマネージャーのインスタンス
        let dataManager = new DataManager();

        // グローバルz-index管理
        let globalMaxZIndex = 10000; // モーダル用に十分高い初期値
        
        function getNextZIndex() {
            globalMaxZIndex += 100; // より大きな間隔で確実に分離
            return globalMaxZIndex;
        }
        
        function bringToFront(element) {
            if (element) {
                const newZIndex = getNextZIndex();
                element.style.zIndex = newZIndex;
                console.log(`🔼 モーダルz-index設定: ${element.id || element.className} → ${newZIndex}`);
            }
        }
        
        // 営業時間外警告モーダル関連の変数
        let pendingAppointmentData = null;
        
        // 営業時間外警告モーダルを表示
        function showBusinessHoursWarning(reason, appointmentData) {
            const modal = document.getElementById('businessHoursWarningModal');
            const reasonElement = document.getElementById('warningReason');
            
            reasonElement.textContent = reason;
            pendingAppointmentData = appointmentData;
            
            modal.style.display = 'block';
            bringToFront(modal);
        }
        
        // 営業時間外警告モーダルを閉じる
        function closeBusinessHoursWarning() {
            const modal = document.getElementById('businessHoursWarningModal');
            modal.style.display = 'none';
            pendingAppointmentData = null;
        }
        
        // 強制的に予約を作成
        function forceCreateAppointment() {
            if (pendingAppointmentData) {
                // 強制フラグを追加して予約を作成
                calendar.createAppointmentForce(pendingAppointmentData);
                closeBusinessHoursWarning();
            }
        }
        
        class BeautyClinicScheduleManager {
            constructor() {
                console.log('🚀 BeautyClinicScheduleManager初期化開始');
                
                // LocalStorageの確認
                const savedAppointments = localStorage.getItem('appointments');
                if (savedAppointments) {
                    console.log('💾 LocalStorageから予約データを発見:', savedAppointments.length, '文字');
                } else {
                    console.log('💾 LocalStorageに予約データなし');
                }
                
                this.currentDate = new Date();
                this.appointments = [];
                this.completedAppointments = []; // 完了済み予約のスナップショット
                this.isDragging = false;
                
                // 患者マーク定義
                this.patientMarks = {
                    circle: { symbol: '●', color: '#dc2626', name: '要注意' },
                    triangle: { symbol: '▲', color: '#f59e0b', name: '警告' },
                    diamond: { symbol: '◆', color: '#2563eb', name: 'VIP' }
                };
                
                // 所要時間データの初期化
                this.initializeDurations();
                
                // 祝日リスト（2025年）- 土曜日の祝日は営業日
                this.holidays = [
                    '2025-01-01', // 元日（水）
                    '2025-01-13', // 成人の日（月）
                    '2025-02-11', // 建国記念の日（火）
                    '2025-02-23', // 天皇誕生日（日）
                    '2025-03-20', // 春分の日（木）
                    '2025-04-29', // 昭和の日（火）
                    '2025-05-03', // 憲法記念日（土）※営業日
                    '2025-05-04', // みどりの日（日）
                    '2025-05-05', // こどもの日（月）
                    '2025-07-21', // 海の日（月）
                    '2025-08-11', // 山の日（月）
                    '2025-09-15', // 敬老の日（月）
                    '2025-09-23', // 秋分の日（火）
                    '2025-10-13', // スポーツの日（月）
                    '2025-11-03', // 文化の日（月）
                    '2025-11-23', // 勤労感謝の日（日）
                    '2025-12-23'  // 天皇誕生日（火）
                ];
                this.draggedIndex = null;
                this.showOnlyBookedTreatments = true; // デフォルトで予約のみ表示
                // 施術メニューをオブジェクト形式で管理（カラー情報含む）
                this.treatmentMenus = [
                    { id: 1, name: 'ﾎﾞﾄ', color: '#fee2e2', borderColor: '#ef4444', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 2, name: 'ﾋｱﾙ', color: '#dbeafe', borderColor: '#3b82f6', defaultDuration: null, intervalMin: 21, intervalMax: 42, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 3, name: '水光(院)', color: '#dcfce7', borderColor: '#22c55e', defaultDuration: null, intervalMin: 21, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 4, name: 'QR', color: '#f3e8ff', borderColor: '#a855f7', defaultDuration: null, intervalMin: 21, intervalMax: 42, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 5, name: 'CO2', color: '#fef3c7', borderColor: '#f59e0b', defaultDuration: null, intervalMin: 21, intervalMax: 42, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 6, name: '糸ﾘﾌﾄ', color: '#fed7aa', borderColor: '#fb923c', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 7, name: 'ﾌﾗｸ', color: '#fce7f3', borderColor: '#ec4899', defaultDuration: null, intervalMin: 21, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 8, name: 'ｻﾌﾞｼ', color: '#f0f9ff', borderColor: '#0ea5e9', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 9, name: 'ｼﾞｭﾍﾞﾙｯｸ', color: '#f0fdf4', borderColor: '#16a34a', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false, restrictions: { blockedDays: [], startTimeLimit: null } },
                    { id: 10, name: 'BNLS', color: '#fffbeb', borderColor: '#d97706', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 11, name: 'ﾆｰﾄﾞﾙ', color: '#fdf2f8', borderColor: '#e879f9', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 12, name: 'ﾌﾞﾙｰﾚｰｻﾞｰ', color: '#f0f4ff', borderColor: '#6366f1', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 13, name: 'ｿﾉｲｵﾝ', color: '#f7fee7', borderColor: '#65a30d', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 14, name: 'ﾏｯP1カ所', color: '#fef7ff', borderColor: '#c084fc', defaultDuration: 30, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 15, name: 'ﾏｯP2カ所', color: '#f1f5f9', borderColor: '#64748b', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 16, name: 'ﾄｰﾆﾝｸﾞ', color: '#fefce8', borderColor: '#eab308', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 17, name: 'ﾋﾟｺﾌﾗｸ全顔', color: '#fff7ed', borderColor: '#ea580c', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 18, name: 'ﾋﾟｺﾌﾗｸ鼻', color: '#f8fafc', borderColor: '#475569', defaultDuration: 30, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 19, name: 'ｼﾙﾌｧｰﾑ', color: '#ecfeff', borderColor: '#06b6d4', defaultDuration: 90, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { 
                        id: 20, 
                        name: 'ｳﾙｾﾗ', 
                        color: '#f5f3ff', 
                        borderColor: '#8b5cf6',
                        defaultDuration: 120,
                        subItems: [
                            { name: '全顔', defaultDuration: 120 },
                            { name: '下顎', defaultDuration: 120 },
                            { name: '全顔下顎', defaultDuration: 180 },
                            { name: '頬', defaultDuration: 100 },
                            { name: '目・額', defaultDuration: 90 }
                        ],
                        isExpanded: false
                    },
                    { 
                        id: 21, 
                        name: 'ｸﾗﾂｰ', 
                        color: '#fef2f2', 
                        borderColor: '#dc2626',
                        defaultDuration: 70,
                        subItems: [
                            { name: '顎下', defaultDuration: 70 },
                            { name: '大腿', defaultDuration: 80 },
                            { name: '腹部', defaultDuration: 70 },
                            { name: '二の腕', defaultDuration: 50 }
                        ],
                        isExpanded: false
                    },
                    { id: 22, name: 'ｱｲｺﾝ', color: '#f0fdfa', borderColor: '#0f766e', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 23, name: 'ﾉｰﾘｽ', color: '#fefbff', borderColor: '#a21caf', defaultDuration: 60, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { 
                        id: 24, 
                        name: 'ﾊｲﾄﾞﾗ', 
                        color: '#f9fafb', 
                        borderColor: '#374151',
                        defaultDuration: 40,
                        subItems: [
                            { name: '全顔', defaultDuration: 40 },
                            { name: 'Tｿﾞｰﾝ', defaultDuration: 30 },
                            { name: '鼻頬', defaultDuration: 30 }
                        ],
                        isExpanded: false
                    },
                    { id: 25, name: 'NS水光', color: '#f8fafc', borderColor: '#0f172a', defaultDuration: 60, intervalMin: 21, intervalMax: null, subItems: [], isExpanded: false },
                    { 
                        id: 26, 
                        name: 'ﾍﾞﾙﾍﾞｯﾄ', 
                        color: '#fef3c7', 
                        borderColor: '#d97706',
                        defaultDuration: 75,
                        subItems: [
                            { name: '全顔', defaultDuration: 75, intervalMin: 21, intervalMax: null },
                            { name: '鼻頬', defaultDuration: 65, intervalMin: 21, intervalMax: null }
                        ],
                        isExpanded: false
                    },
                    { 
                        id: 27, 
                        name: 'ﾀﾞｰﾏ', 
                        color: '#ecfdf5', 
                        borderColor: '#059669',
                        defaultDuration: 60,
                        subItems: [
                            { name: '全顔', defaultDuration: 60, intervalMin: 21, intervalMax: null },
                            { name: '鼻', defaultDuration: 40, intervalMin: 21, intervalMax: null },
                            { name: '広範囲', defaultDuration: 45, intervalMin: 21, intervalMax: null }
                        ],
                        isExpanded: false
                    },
                    { id: 28, name: 'Vｶｰﾎﾞﾝ', color: '#f1f5f9', borderColor: '#475569', defaultDuration: 30, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 29, name: 'ｼｬﾜｰ(AC)', color: '#fdf4ff', borderColor: '#c026d3', defaultDuration: 30, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 30, name: 'ｼｬﾜｰ(顔)', color: '#f0f9ff', borderColor: '#0284c7', defaultDuration: 40, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 31, name: 'ﾌｪｲｼｬﾙ', color: '#f7fee7', borderColor: '#84cc16', defaultDuration: 40, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { 
                        id: 32, 
                        name: '脱毛', 
                        color: '#fff1f2', 
                        borderColor: '#be185d',
                        defaultDuration: 40,
                        subItems: [
                            { name: '全顔', defaultDuration: 40 },
                            { name: '鼻下口周り', defaultDuration: 30 },
                            { name: '男性髭', defaultDuration: 60 },
                            { name: 'うなじ', defaultDuration: 30 },
                            { name: '胸', defaultDuration: 30 },
                            { name: '腹部', defaultDuration: 30 },
                            { name: '背部', defaultDuration: 40 },
                            { name: '臀部', defaultDuration: 30 },
                            { name: '脇', defaultDuration: 30 },
                            { name: '肘下', defaultDuration: 30 },
                            { name: '肘上', defaultDuration: 40 },
                            { name: '手', defaultDuration: 30 },
                            { name: '膝下', defaultDuration: 40 },
                            { name: '大腿', defaultDuration: 60 },
                            { name: '足', defaultDuration: 30 },
                            { name: 'V', defaultDuration: 30 },
                            { name: 'I', defaultDuration: 30 },
                            { name: 'O', defaultDuration: 30 },
                            { name: 'VIO', defaultDuration: 60 },
                            { name: '男性VIO', defaultDuration: 90 },
                            { name: 'ｾｯﾄ', defaultDuration: 90 },
                            { name: '男性ｾｯﾄ', defaultDuration: 80 },
                            { name: '上肢ｾｯﾄ', defaultDuration: 90 }
                        ],
                        isExpanded: false
                    },
                    { id: 33, name: 'ｱｰﾄﾒｲｸ', color: '#fffbeb', borderColor: '#f59e0b', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 34, name: 'ﾌﾟﾙﾘｱﾙ', color: '#f0fdf4', borderColor: '#22c55e', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 35, name: 'ﾘｯﾌﾟ', color: '#fdf2f8', borderColor: '#f472b6', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 36, name: 'NMN', color: '#f0f9ff', borderColor: '#0ea5e9', defaultDuration: 40, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 37, name: 'VC点滴', color: '#f7fee7', borderColor: '#65a30d', defaultDuration: 40, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false },
                    { id: 38, name: '白玉点滴', color: '#fafafa', borderColor: '#71717a', defaultDuration: null, intervalMin: null, intervalMax: null, subItems: [], isExpanded: false }
                ];
                
                // 後方互換性のため treatments 配列も維持
                this.treatments = this.treatmentMenus.map(t => t.name);
                
                // カラーパレット（新規メニュー用）
                this.colorPalette = [
                    { color: '#fce7f3', borderColor: '#ec4899' }, // ピンク
                    { color: '#e0e7ff', borderColor: '#6366f1' }, // インディゴ
                    { color: '#f0fdf4', borderColor: '#16a34a' }, // ライムグリーン
                    { color: '#fdf2f8', borderColor: '#d946ef' }, // マゼンタ
                    { color: '#fffbeb', borderColor: '#d97706' }, // アンバー
                    { color: '#f0fdfa', borderColor: '#0d9488' }, // ティール
                    { color: '#fafafa', borderColor: '#525252' }, // グレー
                    { color: '#ecfdf5', borderColor: '#059669' }  // エメラルド
                ];
                
                this.nextTreatmentId = 8; // 次のIDカウンタ
                // 看護師データを施術メニュー対応情報付きで初期化
                this.nurses = [
                    { 
                        name: '田中看護師', 
                        treatmentTypes: [
                            'ﾎﾞﾄ', 'ﾋｱﾙ', 'QR', 'CO2', 'ﾌﾗｸ', 'ｻﾌﾞｼ', 'ｼﾞｭﾍﾞﾙｯｸ', 'BNLS',
                            'ﾆｰﾄﾞﾙ', 'ﾏｯP1カ所', 'ﾏｯP2カ所', 'ﾄｰﾆﾝｸﾞ', 'ﾋﾟｺﾌﾗｸ全顔', 'ﾋﾟｺﾌﾗｸ鼻',
                            'ｼﾙﾌｧｰﾑ', 'ｳﾙｾﾗ - 全顔', 'ｳﾙｾﾗ - 下顎', 'ｳﾙｾﾗ - 頬', 
                            'ｸﾗﾂｰ - 顎下', 'ｸﾗﾂｰ - 代替', 'ｸﾗﾂｰ - 二の腕',  // ｸﾗﾂｰ - 二の腕を追加
                            'ｱｲｺﾝ', 'ﾉｰﾘｽ', 'ﾊｲﾄﾞﾗ - 全顔', 'ﾊｲﾄﾞﾗ - Tｿﾞｰﾝ', 'NS水光', 'ﾍﾞﾙﾍﾞｯﾄ - 全顔',
                            'ﾀﾞｰﾏ - 全顔', 'ﾀﾞｰﾏ - 鼻', 'Vｶｰﾎﾞﾝ', 'ｼｬﾜｰ(AC)', 'ｼｬﾜｰ(顔)', 'ﾌｪｲｼｬﾙ',
                            '脱毛 - 全顔', '脱毛 - 鼻下口周り', '脱毛 - うなじ', '脱毛 - 脇', '脱毛 - 肘下', '脱毛 - 手',
                            '脱毛 - 胸',  // 脱毛 - 胸を追加
                            'ｱｰﾄﾒｲｸ', 'ﾌﾟﾙﾘｱﾙ', 'ﾘｯﾌﾟ'
                        ] 
                    },
                    { 
                        name: '佐藤看護師', 
                        treatmentTypes: [
                            'ﾎﾞﾄ', 'ﾋｱﾙ', '水光(院)', 'QR', 'CO2', '糸ﾘﾌﾄ', 'ﾌﾗｸ', 'ｻﾌﾞｼ',
                            'ｼﾞｭﾍﾞﾙｯｸ', 'BNLS', 'ﾆｰﾄﾞﾙ', 'ﾌﾞﾙｰﾚｰｻﾞｰ', 'ｿﾉｲｵﾝ', 'ﾏｯP1カ所', 'ﾏｯP2カ所',
                            'ﾄｰﾆﾝｸﾞ', 'ﾋﾟｺﾌﾗｸ全顔', 'ﾋﾟｺﾌﾗｸ鼻', 'ｼﾙﾌｧｰﾑ',
                            'ｳﾙｾﾗ - 下顎',  // ｳﾙｾﾗ - 下顎を追加
                            'ﾊｲﾄﾞﾗ - 鼻頬',  // ﾊｲﾄﾞﾗ - 鼻頬を追加
                            'ﾀﾞｰﾏ - 全顔', 'ﾀﾞｰﾏ - 広範囲',  // ﾀﾞｰﾏ関連を追加
                            'ｱｲｺﾝ', 'ﾉｰﾘｽ', 'NS水光',
                            'Vｶｰﾎﾞﾝ', 'ｼｬﾜｰ(AC)', 'ｼｬﾜｰ(顔)', 'ﾌｪｲｼｬﾙ',
                            'ｱｰﾄﾒｲｸ', 'ﾌﾟﾙﾘｱﾙ', 'ﾘｯﾌﾟ', 'NMN', 'VC点滴', '白玉点滴'
                        ] 
                    },
                    { 
                        name: '山田看護師', 
                        treatmentTypes: [
                            'ﾎﾞﾄ',  // ﾎﾞﾄを追加
                            '水光(院)', 'QR', 'CO2', '糸ﾘﾌﾄ', 'ﾌﾗｸ', 'ｻﾌﾞｼ', 'ｼﾞｭﾍﾞﾙｯｸ', 'BNLS',
                            'ﾆｰﾄﾞﾙ', 'ﾌﾞﾙｰﾚｰｻﾞｰ', 'ｿﾉｲｵﾝ', 'ﾏｯP1カ所', 'ﾏｯP2カ所', 'ﾄｰﾆﾝｸﾞ',
                            'ﾋﾟｺﾌﾗｸ全顔', 'ﾋﾟｺﾌﾗｸ鼻', 'ｼﾙﾌｧｰﾑ', 'ｱｲｺﾝ', 'ﾉｰﾘｽ', 'NS水光',
                            'ﾍﾞﾙﾍﾞｯﾄ - 鼻頬',  // ﾍﾞﾙﾍﾞｯﾄ - 鼻頬を追加
                            'Vｶｰﾎﾞﾝ', 'ｼｬﾜｰ(AC)', 'ｼｬﾜｰ(顔)', 'ﾌｪｲｼｬﾙ',
                            '脱毛 - 全顔', '脱毛 - 鼻下口周り', '脱毛 - 男性髭', '脱毛 - うなじ', '脱毛 - 胸',
                            '脱毛 - 腹部', '脱毛 - 背部', '脱毛 - 臀部', '脱毛 - 脇', '脱毛 - 肘下', '脱毛 - 肘上',
                            '脱毛 - 手', '脱毛 - 膝下', '脱毛 - 代替', '脱毛 - 足', '脱毛 - V', '脱毛 - I', '脱毛 - O',
                            '脱毛 - VIO', '脱毛 - 男性VIO', '脱毛 - ｾｯﾄ', '脱毛 - 男性ｾｯﾄ', '脱毛 - 上肢ｾｯﾄ',
                            'ｱｰﾄﾒｲｸ', 'ﾌﾟﾙﾘｱﾙ', 'ﾘｯﾌﾟ', 'NMN', 'VC点滴', '白玉点滴'
                        ] 
                    },
                    { 
                        name: '鈴木看護師', 
                        treatmentTypes: [
                            'ﾎﾞﾄ', 'ﾋｱﾙ', '水光(院)', 'QR', 'CO2', '糸ﾘﾌﾄ', 'ﾌﾗｸ', 'ｻﾌﾞｼ',
                            'ｼﾞｭﾍﾞﾙｯｸ', 'BNLS', 'ﾆｰﾄﾞﾙ', 'ﾌﾞﾙｰﾚｰｻﾞｰ', 'ｿﾉｲｵﾝ', 'ﾏｯP1カ所', 'ﾏｯP2カ所',
                            'ﾄｰﾆﾝｸﾞ', 'ﾋﾟｺﾌﾗｸ全顔', 'ﾋﾟｺﾌﾗｸ鼻', 'ｼﾙﾌｧｰﾑ', 'ｳﾙｾﾗ - 全顔', 'ｳﾙｾﾗ - 下顎',
                            'ｳﾙｾﾗ - 全顔下顎', 'ｳﾙｾﾗ - 頬', 'ｳﾙｾﾗ - 目・額', 'ｸﾗﾂｰ - 顎下', 'ｸﾗﾂｰ - 代替',
                            'ｸﾗﾂｰ - 腹部', 'ｸﾗﾂｰ - 二の腕', 'ｱｲｺﾝ', 'ﾉｰﾘｽ', 'ﾊｲﾄﾞﾗ - 全顔', 'ﾊｲﾄﾞﾗ - Tｿﾞｰﾝ',
                            'ﾊｲﾄﾞﾗ - 鼻頬', 'NS水光', 'ﾍﾞﾙﾍﾞｯﾄ - 全顔', 'ﾍﾞﾙﾍﾞｯﾄ - 鼻頬', 'ﾀﾞｰﾏ - 全顔',
                            'ﾀﾞｰﾏ - 鼻', 'ﾀﾞｰﾏ - 広範囲', 'Vｶｰﾎﾞﾝ', 'ｼｬﾜｰ(AC)', 'ｼｬﾜｰ(顔)', 'ﾌｪｲｼｬﾙ',
                            '脱毛 - 全顔', '脱毛 - 鼻下口周り', '脱毛 - うなじ', '脱毛 - 胸', '脱毛 - 腹部',
                            '脱毛 - 脇', '脱毛 - 肘下', '脱毛 - 肘上', '脱毛 - 手', '脱毛 - 膝下', '脱毛 - 代替',
                            '脱毛 - 足', '脱毛 - V', '脱毛 - I', '脱毛 - O', '脱毛 - VIO', '脱毛 - ｾｯﾄ', '脱毛 - 上肢ｾｯﾄ',
                            'ｱｰﾄﾒｲｸ', 'ﾌﾟﾙﾘｱﾙ', 'ﾘｯﾌﾟ', 'NMN', 'VC点滴', '白玉点滴'
                        ] 
                    }
                ];
                this.devices = ['レーザー機器A', 'レーザー機器B', 'ウルトラサウンド', 'RF機器'];
                this.currentEditingId = null;
                this.currentPatientPage = 1;
                this.patientsPerPage = 50;

                this.init();
            }

            // 休診日判定メソッド
            isClosedDay(date) {
                let dayOfWeek, dateStr;
                
                if (date instanceof Date) {
                    dayOfWeek = date.getDay(); // 0=日曜, 1=月曜, ...
                    dateStr = date.toISOString().split('T')[0];
                } else {
                    dateStr = date;
                    dayOfWeek = new Date(dateStr + 'T00:00:00').getDay();
                }
                
                // 日曜日（0）と月曜日（1）は休診
                if (dayOfWeek === 0 || dayOfWeek === 1) {
                    return true;
                }
                
                // 祝日チェック
                if (this.holidays.includes(dateStr)) {
                    // 土曜日の祝日は営業日
                    if (dayOfWeek === 6) {
                        return false;
                    }
                    return true;
                }
                
                return false;
            }

            // 営業時間チェックメソッド
            isWithinBusinessHours(date, time) {
                // 日付が休診日かチェック
                if (this.isClosedDay(date)) {
                    return false;
                }
                
                const timeValue = parseInt(time.replace(':', ''));
                
                // 営業時間: 11:00-14:30, 16:00-20:30
                const morningStart = 1100;
                const morningEnd = 1430;
                const eveningStart = 1600;
                const eveningEnd = 2030;
                
                return (timeValue >= morningStart && timeValue <= morningEnd) ||
                       (timeValue >= eveningStart && timeValue <= eveningEnd);
            }

            // 予約時間が営業時間内に収まるかチェック
            isAppointmentWithinBusinessHours(date, startTime, durationMinutes) {
                if (this.isClosedDay(date)) {
                    return { valid: false, reason: '休診日です' };
                }
                
                if (!this.isWithinBusinessHours(date, startTime)) {
                    return { valid: false, reason: '開始時刻が営業時間外です' };
                }
                
                // 終了時刻を計算
                const [hours, minutes] = startTime.split(':').map(Number);
                const startMinutes = hours * 60 + minutes;
                const endMinutes = startMinutes + durationMinutes;
                const endHours = Math.floor(endMinutes / 60);
                const endMins = endMinutes % 60;
                const endTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
                
                if (!this.isWithinBusinessHours(date, endTime)) {
                    return { valid: false, reason: '終了時刻が営業時間外です' };
                }
                
                // 昼休み（14:30-16:00）にかかるかチェック
                const lunchStart = 1430;
                const lunchEnd = 1600;
                const startTimeValue = parseInt(startTime.replace(':', ''));
                const endTimeValue = parseInt(endTime.replace(':', ''));
                
                if (startTimeValue < lunchEnd && endTimeValue > lunchStart) {
                    return { valid: false, reason: '昼休み時間にかかっています' };
                }
                
                return { valid: true };
            }

            // 強制的に予約を作成（営業時間外でも）
            createAppointmentForce(formData) {
                // 重複チェックと施術制限と間隔制限チェックのみ実行（営業時間チェックはスキップ）
                const allConflicts = this.checkAllConflicts(formData, this.currentEditingId);
                if (allConflicts.length > 0) {
                    this.showResourceConflictModal(allConflicts);
                    return;
                }

                // 施術制限チェック（営業時間外でも曜日・時間制限は適用）
                const restrictionViolation = this.checkTreatmentRestrictions(formData);
                if (restrictionViolation) {
                    alert(restrictionViolation);
                    return;
                }

                const intervalViolation = this.checkIntervalRestriction(formData);
                if (intervalViolation) {
                    this.showIntervalWarningModal(intervalViolation, formData);
                    return;
                }

                // 予約作成処理（営業時間チェックなし）
                this.executeAppointmentCreation(formData);
            }

            // 予約作成の実行処理を分離
            executeAppointmentCreation(formData) {
                if (this.currentEditingId) {
                    const appointment = this.appointments.find(apt => apt.id === this.currentEditingId);
                    Object.assign(appointment, formData);
                    
                    // 編集時も患者がマスターに存在しない場合は自動登録
                    if (formData.patientId && formData.patientName) {
                        const existingPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                        if (!existingPatient) {
                            console.log(`🆕 編集時に新規患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                            
                            const nameHiragana = formData.patientName.toLowerCase().replace(/[　\s]+/g, ' ');
                            
                            const newPatient = {
                                id: formData.patientId,
                                name: formData.patientName,
                                nameHiragana: nameHiragana,
                                appointmentCount: 1
                            };
                            this.patients.push(newPatient);
                        }
                    }
                } else {
                    const newId = Math.max(0, ...this.appointments.map(apt => apt.id)) + 1;
                    const newAppointment = Object.assign({ id: newId }, formData);
                    this.appointments.push(newAppointment);
                    
                    // オンライン同期
                    dataManager.saveAllData();
                    
                    // 新規予約時も患者がマスターに存在しない場合は自動登録
                    if (formData.patientId && formData.patientName) {
                        const existingPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                        if (!existingPatient) {
                            console.log(`🆕 新規予約時に患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                            
                            const nameHiragana = formData.patientName.toLowerCase().replace(/[　\s]+/g, ' ');
                            
                            const newPatient = {
                                id: formData.patientId,
                                name: formData.patientName,
                                nameHiragana: nameHiragana,
                                appointmentCount: 1
                            };
                            this.patients.push(newPatient);
                        }
                    }
                }
                
                this.render();
                this.closeModal();
                this.currentEditingId = null;
            }

            init() {
                this.setupTimeOptions();
                this.updateSelectOptions();
                
                // 展開状態を復元
                this.restoreExpansionState();
                
                this.render();
                this.setupEventListeners();
                
                // 初期状態のボタン設定
                setTimeout(() => {
                    const bookedButton = document.getElementById('showBookedOnly');
                    const allButton = document.getElementById('showAllItems');
                    
                    if (bookedButton && allButton) {
                        if (this.showOnlyBookedTreatments) {
                            bookedButton.classList.add('active');
                            allButton.classList.remove('active');
                        } else {
                            bookedButton.classList.remove('active');
                            allButton.classList.add('active');
                        }
                    }
                }, 100);
                
                // サンプルデータ
                this.loadSampleData();
                this.updateSelectOptions();
                
                // フィルター初期化を遅延実行（DOMが構築された後）
                setTimeout(() => {
                    this.initializeFilters();
                }, 50);
                
                // 【重要】既存予約の位置を新しい計算式で強制更新
                setTimeout(() => {
                    console.log('🚀 初回起動時の予約位置修正を実行');
                    this.forceUpdateAllAppointmentPositions();
                }, 100); // DOMが完全に構築されるのを待つ
                
                // フローティングサマリーの初期化を遅延実行
                setTimeout(() => {
                    try {
                        console.log('フローティングサマリー初期化開始');
                        this.initFloatingSummary();
                        // updateFloatingSummaryは呼ばない（renderDailySummaryで処理される）
                        console.log('フローティングサマリー初期化完了');
                    } catch (error) {
                        console.error('フローティングサマリー初期化エラー:', error);
                    }
                }, 1000);
                
                // トラックパッドスクロール修正
                setTimeout(() => {
                    this.fixTrackpadScrolling();
                }, 1100);
            }

            loadSampleData() {
                console.log('🔍 loadSampleData開始 - 初期データをセット中...');
                
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                console.log(`📅 日付設定: 今日 = ${todayStr}`);
                
                // 過去と未来の日付を生成
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                const dayAfterTomorrow = new Date(today);
                dayAfterTomorrow.setDate(today.getDate() + 2);
                const dayAfterTomorrowStr = dayAfterTomorrow.toISOString().split('T')[0];
                
                // 火曜日（休診日の振替用）
                const tuesday = new Date(today);
                tuesday.setDate(today.getDate() + 4); // 9/2（火曜日）
                const tuesdayStr = tuesday.toISOString().split('T')[0];
                
                console.log('サンプルデータの日付設定:', {
                    昨日: yesterdayStr,
                    今日: todayStr,
                    明日: tomorrowStr,
                    明後日: dayAfterTomorrowStr,
                    火曜日: tuesdayStr
                });
                
                // 患者データのサンプル
                console.log('🏥 Initializing patients data...');
                this.patients = [
                    {
                        id: 'P001',
                        name: '田中 花子',
                        nameHiragana: 'たなか はなこ',
                        registrationDate: '2024-01-15',
                        totalVisits: 8,
                        lastVisit: '2024-03-10',
                        marks: [], // 患者マーク（例: ['circle', 'triangle']）
                        history: []
                    },
                    {
                        id: 'P002',
                        name: '山田 美咲',
                        nameHiragana: 'やまだ みさき',
                        registrationDate: '2024-02-01',
                        totalVisits: 3,
                        lastVisit: '2024-03-08',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P003',
                        name: '佐藤 恵子',
                        nameHiragana: 'さとう けいこ',
                        registrationDate: '2024-01-20',
                        totalVisits: 12,
                        lastVisit: '2024-03-12',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P004',
                        name: '鈴木 麻里',
                        nameHiragana: 'すずき まり',
                        registrationDate: '2024-02-10',
                        totalVisits: 5,
                        lastVisit: '2024-03-05',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P005',
                        name: '高橋 由美',
                        nameHiragana: 'たかはし ゆみ',
                        registrationDate: '2024-01-05',
                        totalVisits: 15,
                        lastVisit: '2024-03-01',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P006',
                        name: '中村 愛子',
                        nameHiragana: 'なかむら あいこ',
                        registrationDate: '2024-03-01',
                        totalVisits: 1,
                        lastVisit: '2024-03-01',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P007',
                        name: '佐々木 美咲',
                        nameHiragana: 'ささき みさき',
                        registrationDate: '2024-02-20',
                        totalVisits: 2,
                        lastVisit: '2024-03-15',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P008',
                        name: '木村 恵子',
                        nameHiragana: 'きむら けいこ',
                        registrationDate: '2024-02-25',
                        totalVisits: 3,
                        lastVisit: '2024-03-20',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P009',
                        name: '林 真由美',
                        nameHiragana: 'はやし まゆみ',
                        registrationDate: '2024-03-01',
                        totalVisits: 1,
                        lastVisit: '2024-03-01',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P010',
                        name: '橋本 洋子',
                        nameHiragana: 'はしもと ようこ',
                        registrationDate: '2024-02-15',
                        totalVisits: 4,
                        lastVisit: '2024-03-10',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P011',
                        name: '石井 智子',
                        nameHiragana: 'いしい ともこ',
                        registrationDate: '2024-01-30',
                        totalVisits: 6,
                        lastVisit: '2024-03-12',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P012',
                        name: '松本 千代',
                        nameHiragana: 'まつもと ちよ',
                        registrationDate: '2024-02-10',
                        totalVisits: 5,
                        lastVisit: '2024-03-18',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P013',
                        name: '前田 さくら',
                        nameHiragana: 'まえだ さくら',
                        registrationDate: '2024-01-25',
                        totalVisits: 8,
                        lastVisit: '2024-03-22',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P014',
                        name: '清水 美香',
                        nameHiragana: 'しみず みか',
                        registrationDate: '2024-02-05',
                        totalVisits: 3,
                        lastVisit: '2024-03-08',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P015',
                        name: '野村 里奈',
                        nameHiragana: 'のむら りな',
                        registrationDate: '2024-03-05',
                        totalVisits: 2,
                        lastVisit: '2024-03-15',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P016',
                        name: '池田 幸子',
                        nameHiragana: 'いけだ さちこ',
                        registrationDate: '2024-01-20',
                        totalVisits: 7,
                        lastVisit: '2024-03-20',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P017',
                        name: '宮崎 優子',
                        nameHiragana: 'みやざき ゆうこ',
                        registrationDate: '2024-02-28',
                        totalVisits: 1,
                        lastVisit: '2024-02-28',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P018',
                        name: '西田 香織',
                        nameHiragana: 'にしだ かおり',
                        registrationDate: '2024-01-15',
                        totalVisits: 9,
                        lastVisit: '2024-03-25',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P019',
                        name: '福田 麻衣',
                        nameHiragana: 'ふくだ まい',
                        registrationDate: '2024-02-12',
                        totalVisits: 4,
                        lastVisit: '2024-03-14',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P020',
                        name: '小林 由佳',
                        nameHiragana: 'こばやし ゆか',
                        registrationDate: '2024-01-08',
                        totalVisits: 11,
                        lastVisit: '2024-03-28',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P021',
                        name: '遠藤 理恵',
                        nameHiragana: 'えんどう りえ',
                        registrationDate: '2024-02-18',
                        totalVisits: 3,
                        lastVisit: '2024-03-05',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P022',
                        name: '加藤 雅美',
                        nameHiragana: 'かとう まさみ',
                        registrationDate: '2024-01-12',
                        totalVisits: 8,
                        lastVisit: '2024-03-30',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P023',
                        name: '山下 亜紀',
                        nameHiragana: 'やました あき',
                        registrationDate: '2024-02-22',
                        totalVisits: 2,
                        lastVisit: '2024-03-12',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P024',
                        name: '井上 春美',
                        nameHiragana: 'いのうえ はるみ',
                        registrationDate: '2024-01-28',
                        totalVisits: 6,
                        lastVisit: '2024-03-18',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P025',
                        name: '渡辺 純子',
                        nameHiragana: 'わたなべ じゅんこ',
                        registrationDate: '2024-02-08',
                        totalVisits: 4,
                        lastVisit: '2024-03-22',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P026',
                        name: '大野 直美',
                        nameHiragana: 'おおの なおみ',
                        registrationDate: '2024-01-18',
                        totalVisits: 7,
                        lastVisit: '2024-03-25',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P027',
                        name: '藤田 友子',
                        nameHiragana: 'ふじた ともこ',
                        registrationDate: '2024-02-15',
                        totalVisits: 3,
                        lastVisit: '2024-03-08',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P028',
                        name: '中島 綾子',
                        nameHiragana: 'なかじま あやこ',
                        registrationDate: '2024-01-22',
                        totalVisits: 9,
                        lastVisit: '2024-03-28',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P029',
                        name: '長谷川 美穂',
                        nameHiragana: 'はせがわ みほ',
                        registrationDate: '2024-02-25',
                        totalVisits: 2,
                        lastVisit: '2024-03-15',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P030',
                        name: '岡田 京子',
                        nameHiragana: 'おかだ きょうこ',
                        registrationDate: '2024-01-05',
                        totalVisits: 12,
                        lastVisit: '2024-03-30',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P034',
                        name: '渡辺 さくら',
                        nameHiragana: 'わたなべ さくら',
                        registrationDate: '2024-02-12',
                        totalVisits: 4,
                        lastVisit: '2024-03-20',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P035',
                        name: '伊藤 美香',
                        nameHiragana: 'いとう みか',
                        registrationDate: '2024-01-15',
                        totalVisits: 8,
                        lastVisit: '2024-03-25',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P036',
                        name: '松本 真由美',
                        nameHiragana: 'まつもと まゆみ',
                        registrationDate: '2024-02-28',
                        totalVisits: 1,
                        lastVisit: '2024-02-28',
                        marks: [],
                        history: []
                    },
                    {
                        id: 'P037',
                        name: '小林 愛',
                        nameHiragana: 'こばやし あい',
                        registrationDate: '2024-01-08',
                        totalVisits: 10,
                        lastVisit: '2024-03-22',
                        marks: [],
                        history: []
                    }
                ];
                console.log('✅ Patients data initialized:', this.patients.length, 'patients');
                console.log('👥 Patient names:', this.patients.map(p => `${p.id}: ${p.name}`));
                
                // クリック式編集対応の予約データ（過去・今日・未来の日付に設定）
                console.log('📝 appointments配列を初期化中...');
                this.appointments = [
                    // 田中花子さん（P001）- 過去の予約
                    {
                        id: 1,
                        patientId: 'P001',
                        patientName: '田中 花子',
                        treatmentType: '脱毛',
                        subItem: '全顔',
                        nurse: '田中看護師',
                        device: 'レーザー機器A',
                        date: yesterdayStr,
                        startTime: '11:00',
                        duration: 40
                    },
                    // 田中花子さん（P001）- 明日の予約
                    {
                        id: 3,
                        patientId: 'P001',
                        patientName: '田中 花子',
                        treatmentType: 'ﾋｱﾙ',
                        subItem: '',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '13:15',
                        duration: 45
                    },
                    // 田中花子さん（P001）- 明後日（8/16）の予約
                    {
                        id: 4,
                        patientId: 'P001',
                        patientName: '田中 花子',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '鈴木看護師',
                        device: 'ウルトラサウンド',
                        date: tuesdayStr,
                        startTime: '17:30',
                        duration: 40
                    },
                    {
                        id: 6,
                        patientId: 'P003',
                        patientName: '佐藤 恵子',
                        treatmentType: 'ﾋｱﾙ',
                        subItem: '',
                        nurse: '鈴木看護師',
                        device: '',
                        date: todayStr,
                        startTime: '16:00',
                        duration: 45
                    },
                    {
                        id: 7,
                        patientId: 'P004',
                        patientName: '鈴木 麻里',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '田中看護師',
                        device: 'ウルトラサウンド',
                        date: todayStr,
                        startTime: '17:30',
                        duration: 40
                    },
                    {
                        id: 8,
                        patientId: 'P005',
                        patientName: '高橋 由美',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '田中看護師',
                        device: '',
                        date: todayStr,
                        startTime: '16:45',
                        duration: 40
                    },
                    {
                        id: 9,
                        patientId: 'P006',
                        patientName: '中村 愛子',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '鈴木看護師',
                        device: '',
                        date: todayStr,
                        startTime: '18:15',
                        duration: 40
                    },
                    
                    // === 昨日の追加予約 ===
                    {
                        id: 11,
                        patientId: 'P008',
                        patientName: '木村 恵子',
                        treatmentType: 'ﾎﾞﾄ',
                        subItem: '',
                        nurse: '佐藤看護師',
                        device: '',
                        date: yesterdayStr,
                        startTime: '16:15',
                        duration: 30
                    },
                    {
                        id: 12,
                        patientId: 'P009',
                        patientName: '林 真由美',
                        treatmentType: 'ﾋｱﾙ',
                        subItem: '',
                        nurse: '佐藤看護師',
                        device: '',
                        date: yesterdayStr,
                        startTime: '16:45',
                        duration: 60
                    },
                    {
                        id: 13,
                        patientId: 'P010',
                        patientName: '橋本 洋子',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '山田看護師',
                        device: 'ウルトラサウンド',
                        date: yesterdayStr,
                        startTime: '18:00',
                        duration: 40
                    },
                    {
                        id: 14,
                        patientId: 'P011',
                        patientName: '石井 智子',
                        treatmentType: '脱毛',
                        subItem: '全顔',
                        nurse: '田中看護師',
                        device: 'レーザー機器B',
                        date: yesterdayStr,
                        startTime: '16:45',
                        duration: 40
                    },
                    
                    // === 今日の追加予約 ===
                    {
                        id: 19,
                        patientId: 'P016',
                        patientName: '池田 幸子',
                        treatmentType: '脱毛',
                        subItem: '腹部',
                        nurse: '山田看護師',
                        device: 'レーザー機器B',
                        date: todayStr,
                        startTime: '14:00',
                        duration: 30
                    },
                    {
                        id: 20,
                        patientId: 'P017',
                        patientName: '宮崎 優子',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '山田看護師',
                        device: 'ウルトラサウンド',
                        date: todayStr,
                        startTime: '11:00',
                        duration: 40
                    },
                    {
                        id: 21,
                        patientId: 'P018',
                        patientName: '西田 香織',
                        treatmentType: 'ﾎﾞﾄ',
                        subItem: '',
                        nurse: '佐藤看護師',
                        device: '',
                        date: todayStr,
                        startTime: '17:15',
                        duration: 30
                    },
                    {
                        id: 22,
                        patientId: 'P019',
                        patientName: '福田 麻衣',
                        treatmentType: '脱毛',
                        subItem: '胸',
                        nurse: '山田看護師',
                        device: 'レーザー機器A',
                        date: todayStr,
                        startTime: '17:45',
                        duration: 30
                    },
                    // ボトックスとヒアルロン酸の予約を追加
                    {
                        id: 34,
                        patientId: 'P034',
                        patientName: '渡辺 さくら',
                        treatmentType: 'ﾎﾞﾄ',
                        subItem: '',
                        nurse: '山田看護師',
                        device: '',
                        date: todayStr,
                        startTime: '12:45',
                        duration: 30
                    },
                    
                    // === 明日の追加予約 ===
                    {
                        id: 24,
                        patientId: 'P021',
                        patientName: '遠藤 理恵',
                        treatmentType: '脱毛',
                        subItem: '全顔',
                        nurse: '田中看護師',
                        device: 'レーザー機器A',
                        date: tomorrowStr,
                        startTime: '11:00',
                        duration: 40
                    },
                    {
                        id: 27,
                        patientId: 'P024',
                        patientName: '井上 春美',
                        treatmentType: 'ﾌｪｲｼｬﾙ',
                        subItem: '',
                        nurse: '田中看護師',
                        device: 'ウルトラサウンド',
                        date: tomorrowStr,
                        startTime: '16:00',
                        duration: 40
                    },
                    {
                        id: 28,
                        patientId: 'P025',
                        patientName: '渡辺 純子',
                        treatmentType: '脱毛',
                        subItem: '胸',
                        nurse: '田中看護師',
                        device: 'レーザー機器B',
                        date: tomorrowStr,
                        startTime: '17:15',
                        duration: 30
                    },
                    
                    {
                        id: 38,
                        patientId: 'P035',
                        patientName: '伊藤 美香',
                        treatmentType: 'ﾀﾞｰﾏ',
                        subItem: '全顔',
                        nurse: '佐藤看護師',
                        device: '',
                        date: todayStr,
                        startTime: '16:00',
                        duration: 60
                    },
                    {
                        id: 40,
                        patientId: 'P037',
                        patientName: '小林 愛',
                        treatmentType: 'ﾌﾗｸ',
                        nurse: '山田看護師',
                        device: 'レーザー機器B',
                        date: todayStr,
                        startTime: '19:00',
                        duration: 45
                    },
                    {
                        id: 41,
                        patientId: 'P038',
                        patientName: '岩田 京子',
                        treatmentType: 'ｻﾌﾞｼ',
                        nurse: '田中看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '12:45',
                        duration: 30
                    },
                    {
                        id: 44,
                        patientId: 'P041',
                        patientName: '大野 理恵',
                        treatmentType: 'ﾆｰﾄﾞﾙ',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '11:00',
                        duration: 45
                    },
                    {
                        id: 45,
                        patientId: 'P042',
                        patientName: '坂本 千恵',
                        treatmentType: 'ﾌﾞﾙｰﾚｰｻﾞｰ',
                        nurse: '山田看護師',
                        device: 'レーザー機器A',
                        date: tomorrowStr,
                        startTime: '12:45',
                        duration: 60
                    },
                    {
                        id: 47,
                        patientId: 'P044',
                        patientName: '菊地 祐子',
                        treatmentType: 'ﾏｯP1カ所',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '13:30',
                        duration: 30
                    },
                    {
                        id: 48,
                        patientId: 'P045',
                        patientName: '和田 みどり',
                        treatmentType: 'ﾏｯP2カ所',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '16:30',
                        duration: 60
                    },
                    {
                        id: 49,
                        patientId: 'P046',
                        patientName: '神田 純子',
                        treatmentType: 'ﾄｰﾆﾝｸﾞ',
                        nurse: '山田看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '16:00',
                        duration: 60
                    },
                    {
                        id: 50,
                        patientId: 'P047',
                        patientName: '長野 恵子',
                        treatmentType: 'ﾋﾟｺﾌﾗｸ全顔',
                        nurse: '佐藤看護師',
                        device: 'レーザー機器B',
                        date: tomorrowStr,
                        startTime: '16:30',
                        duration: 60
                    },
                    {
                        id: 53,
                        patientId: 'P050',
                        patientName: '三浦 智子',
                        treatmentType: 'ｱｲｺﾝ',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '17:30',
                        duration: 60
                    },
                    {
                        id: 54,
                        patientId: 'P051',
                        patientName: '岡本 雅美',
                        treatmentType: 'ﾉｰﾘｽ',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '18:00',
                        duration: 60
                    },
                    {
                        id: 55,
                        patientId: 'P052',
                        patientName: '黒田 美奈子',
                        treatmentType: 'NS水光',
                        nurse: '山田看護師',
                        device: '',
                        date: tomorrowStr,
                        startTime: '18:45',
                        duration: 60
                    },
                    {
                        id: 57,
                        patientId: 'P054',
                        patientName: '小林 千春',
                        treatmentType: 'ｼｬﾜｰ(AC)',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '11:00',
                        duration: 30
                    },
                    {
                        id: 58,
                        patientId: 'P055',
                        patientName: '野口 真由美',
                        treatmentType: 'ｼｬﾜｰ(顔)',
                        nurse: '田中看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '11:30',
                        duration: 40
                    },
                    {
                        id: 59,
                        patientId: 'P056',
                        patientName: '平野 京子',
                        treatmentType: 'ｱｰﾄﾒｲｸ',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '12:00',
                        duration: 45
                    },
                    {
                        id: 60,
                        patientId: 'P057',
                        patientName: '新井 亜希子',
                        treatmentType: 'ﾌﾟﾙﾘｱﾙ',
                        nurse: '山田看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '13:45',
                        duration: 30
                    },
                    {
                        id: 61,
                        patientId: 'P058',
                        patientName: '大塚 美恵子',
                        treatmentType: 'ﾘｯﾌﾟ',
                        nurse: '鈴木看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '11:45',
                        duration: 45
                    },
                    {
                        id: 62,
                        patientId: 'P059',
                        patientName: '清野 由香',
                        treatmentType: 'NMN',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '12:45',
                        duration: 40
                    },
                    {
                        id: 63,
                        patientId: 'P060',
                        patientName: '山中 恵理',
                        treatmentType: 'VC点滴',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '18:00',
                        duration: 40
                    },
                    {
                        id: 64,
                        patientId: 'P061',
                        patientName: '吉田 智恵',
                        treatmentType: '白玉点滴',
                        nurse: '山田看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '16:45',
                        duration: 30
                    },
                    {
                        id: 65,
                        patientId: 'P062',
                        patientName: '竹内 優子',
                        treatmentType: 'ｳﾙｾﾗ',
                        subItem: '下顎',
                        nurse: '佐藤看護師',
                        device: 'ウルトラサウンド',
                        date: tuesdayStr,
                        startTime: '16:30',
                        duration: 120
                    },
                    {
                        id: 68,
                        patientId: 'P065',
                        patientName: '高野 博子',
                        treatmentType: 'ｸﾗﾂｰ',
                        subItem: '二の腕',
                        nurse: '田中看護師',
                        device: 'RF機器',
                        date: tuesdayStr,
                        startTime: '18:15',
                        duration: 50
                    },
                    {
                        id: 70,
                        patientId: 'P067',
                        patientName: '阿部 美樹',
                        treatmentType: 'ﾊｲﾄﾞﾗ',
                        subItem: '鼻頬',
                        nurse: '佐藤看護師',
                        device: '',
                        date: tuesdayStr,
                        startTime: '19:30',
                        duration: 30
                    },
                    {
                        id: 71,
                        patientId: 'P068',
                        patientName: '青山 優香',
                        treatmentType: 'ﾍﾞﾙﾍﾞｯﾄ',
                        subItem: '鼻頬',
                        nurse: '山田看護師',
                        device: '',
                        date: yesterdayStr,
                        startTime: '11:00',
                        duration: 65
                    },
                    {
                        id: 73,
                        patientId: 'P070',
                        patientName: '内田 美紀',
                        treatmentType: 'ﾀﾞｰﾏ',
                        subItem: '広範囲',
                        nurse: '佐藤看護師',
                        device: '',
                        date: yesterdayStr,
                        startTime: '12:00',
                        duration: 45
                    },
                    {
                        id: 74,
                        patientId: 'P071',
                        patientName: '宮崎 洋子',
                        treatmentType: '脱毛',
                        subItem: '鼻下口周り',
                        nurse: '山田看護師',
                        device: 'レーザー機器A',
                        date: yesterdayStr,
                        startTime: '12:30',
                        duration: 30
                    },
                    {
                        id: 78,
                        patientId: 'P075',
                        patientName: '浅野 佳子',
                        treatmentType: '脱毛',
                        subItem: '肘下',
                        nurse: '山田看護師',
                        device: 'レーザー機器B',
                        date: yesterdayStr,
                        startTime: '13:45',
                        duration: 30
                    },
                    {
                        id: 79,
                        patientId: 'P076',
                        patientName: '島田 礼子',
                        treatmentType: '脱毛',
                        subItem: 'VIO',
                        nurse: '鈴木看護師',
                        device: 'レーザー機器A',
                        date: yesterdayStr,
                        startTime: '17:00',
                        duration: 60
                    },
                ];
                
                this.nextId = 81; // 次のIDを設定
                
                // 予約データから患者マスターに未登録の患者を自動追加
                this.syncPatientsFromAppointments();
                
                // サンプルデータの重複チェックと修正を無効化（手動運用に変更）
                // this.fixSampleDataConflicts();
                
                // 最終的なデータの確認
                console.log(`📈 最終的な予約データ数: ${this.appointments.length}件`);
                
                // 鈴木麻里と山田美咲のデータをログ出力
                const suzukiMari = this.appointments.find(apt => apt.patientName === '鈴木 麻里');
                const yamadaMisaki = this.appointments.find(apt => apt.patientName === '山田 美咲');
                
                console.log('👤 鈴木 麻里のデータ:', suzukiMari || 'データなし');
                console.log('👤 山田 美咲のデータ:', yamadaMisaki || 'データなし');
                
                // 全予約のルール違反チェック
                console.log('🚫 ルール違反予約をチェック中...');
                let ruleViolations = 0;
                this.appointments.forEach(appointment => {
                    const conflicts = this.checkAllConflicts(appointment, appointment.id);
                    if (conflicts.length > 0) {
                        ruleViolations++;
                        console.warn(`⚠️ ルール違反: ${appointment.patientName} (${appointment.startTime}, ${appointment.treatmentType})`);
                        conflicts.forEach(conflict => {
                            console.warn(`  - ${conflict.type}重複: ${conflict.resource || conflict.appointment?.patientName}`);
                        });
                    }
                });
                console.log(`📊 ルール違反予約: ${ruleViolations}件`);
                
                console.log('📝 loadSampleData 完了');
                
                this.render();
            }
            
            // 予約データから患者マスターに未登録の患者を自動的に追加
            syncPatientsFromAppointments() {
                console.log('🔄 予約データから患者マスターを同期開始...');
                let addedCount = 0;
                
                // 予約データから全ての患者IDと名前を収集
                const patientsInAppointments = new Map();
                this.appointments.forEach(apt => {
                    if (apt.patientId && apt.patientName) {
                        patientsInAppointments.set(apt.patientId, apt.patientName);
                    }
                });
                
                // 患者マスターに存在しない患者を追加
                patientsInAppointments.forEach((patientName, patientId) => {
                    const exists = this.patients.find(p => String(p.id) === String(patientId));
                    if (!exists) {
                        // ひらがな名を簡易生成（姓と名の間にスペースを入れる）
                        const nameHiragana = patientName.toLowerCase()
                            .replace(/[　\s]+/g, ' ')
                            .split(' ')
                            .map(part => part.replace(/./g, char => {
                                // 簡単なカタカナ→ひらがな変換
                                const code = char.charCodeAt(0);
                                if (code >= 0x30A1 && code <= 0x30F6) {
                                    return String.fromCharCode(code - 0x60);
                                }
                                return char;
                            }))
                            .join(' ');
                        
                        const newPatient = {
                            id: patientId,
                            name: patientName,
                            nameHiragana: nameHiragana,
                            registrationDate: '2024-01-01', // デフォルト登録日
                            totalVisits: 0,
                            lastVisit: '',
                            history: []
                        };
                        
                        this.patients.push(newPatient);
                        addedCount++;
                        console.log(`✅ 患者追加: ${patientId} - ${patientName}`);
                    }
                });
                
                // 患者IDでソート
                this.patients.sort((a, b) => {
                    const aNum = parseInt(a.id.replace(/[^\d]/g, ''));
                    const bNum = parseInt(b.id.replace(/[^\d]/g, ''));
                    return aNum - bNum;
                });
                
                // 全患者の来院回数と最終来院日を予約データから更新
                this.patients.forEach(patient => {
                    const patientAppointments = this.appointments.filter(apt => String(apt.patientId) === String(patient.id));
                    patient.totalVisits = patientAppointments.length;
                    
                    if (patientAppointments.length > 0) {
                        const latestDate = patientAppointments
                            .map(apt => new Date(apt.date))
                            .sort((a, b) => b - a)[0];
                        patient.lastVisit = latestDate.toISOString().split('T')[0];
                    }
                });
                
                console.log(`✅ 患者マスター同期完了: ${addedCount}名追加, 合計${this.patients.length}名`);
            }

            // サンプルデータの重複修正（強化版）
            fixSampleDataConflicts() {
                console.log('🔧 サンプルデータの重複チェック開始...');
                
                let conflictsFixed = 0;
                const conflictLog = [];
                
                // 複数回のパスで重複を解決（時間調整により新たな重複が生じる可能性があるため）
                for (let pass = 1; pass <= 3; pass++) {
                    console.log(`パス ${pass}: 重複チェック中...`);
                    let passFixed = 0;
                    
                    // 各予約について全ての重複をチェック
                    this.appointments.forEach((appointment, index) => {
                        // 全ての重複をチェック
                        const allConflicts = this.checkAllConflicts(appointment, appointment.id);
                        
                        if (allConflicts.length > 0) {
                            allConflicts.forEach(conflict => {
                                const conflictDesc = this.getConflictDescription(conflict, appointment);
                                conflictLog.push(`パス${pass}: ID ${appointment.id} (${appointment.patientName}): ${conflictDesc}`);
                                
                                // 重複の種類に応じて修正
                                if (conflict.type === 'time') {
                                    // 同じ施術メニューでの時間重複 - 時間をずらす
                                    const newTime = this.findAvailableTimeForTreatment(appointment);
                                    if (newTime) {
                                        appointment.startTime = newTime;
                                        conflictsFixed++;
                                        passFixed++;
                                        console.log(`⏰ 時間重複修正: ${appointment.patientName} を ${newTime} に変更`);
                                    }
                                } else if (conflict.type === 'nurse') {
                                    // 看護師の重複を修正
                                    const availableNurse = this.findAvailableNurse(appointment, conflict.appointment);
                                    if (availableNurse) {
                                        appointment.nurse = availableNurse;
                                        conflictsFixed++;
                                        passFixed++;
                                        console.log(`👩‍⚕️ 看護師変更: ${appointment.patientName} を ${conflict.resource} から ${availableNurse} に変更`);
                                    }
                                } else if (conflict.type === 'device') {
                                    // デバイスの重複を修正
                                    const availableDevice = this.findAvailableDevice(appointment, conflict.appointment);
                                    if (availableDevice) {
                                        appointment.device = availableDevice;
                                        conflictsFixed++;
                                        passFixed++;
                                        console.log(`🔧 デバイス変更: ${appointment.patientName} を ${conflict.resource} から ${availableDevice} に変更`);
                                    }
                                } else if (conflict.type === 'patient') {
                                    // 患者の重複を修正
                                    const newTime = this.findAvailableTimeForPatient(appointment);
                                    if (newTime) {
                                        appointment.startTime = newTime;
                                        conflictsFixed++;
                                        passFixed++;
                                        console.log(`👤 患者重複修正: ${appointment.patientName} を ${newTime} に変更`);
                                    }
                                }
                            });
                        }
                    });
                    
                    console.log(`パス ${pass} 完了: ${passFixed}件修正`);
                    if (passFixed === 0) {
                        console.log('重複がなくなったため早期終了');
                        break;
                    }
                }
                
                if (conflictsFixed > 0) {
                    console.log(`✅ サンプルデータの重複修正完了: 合計${conflictsFixed}件修正`);
                    console.log('修正詳細:', conflictLog);
                } else {
                    console.log('✅ サンプルデータに重複はありませんでした');
                }
            }
            
            // 重複の説明文を生成
            getConflictDescription(conflict, appointment) {
                const endTime = this.minutesToTime(this.timeToMinutes(conflict.appointment.startTime) + conflict.appointment.duration);
                
                switch (conflict.type) {
                    case 'time':
                        return `時間重複 - ${conflict.appointment.patientName}様 (${conflict.appointment.startTime}-${endTime}) と同じ施術メニューで重複`;
                    case 'nurse':
                        return `看護師「${conflict.resource}」が重複 - ${conflict.appointment.patientName}様 (${conflict.appointment.startTime}-${endTime}) で使用中`;
                    case 'device':
                        return `デバイス「${conflict.resource}」が重複 - ${conflict.appointment.patientName}様 (${conflict.appointment.startTime}-${endTime}) で使用中`;
                    case 'patient':
                        return `患者「${conflict.resource}」が重複 - ${conflict.appointment.startTime}-${endTime} に既存予約あり`;
                    default:
                        return `未知の重複タイプ: ${conflict.type}`;
                }
            }
            
            // 利用可能な看護師を見つける
            findAvailableNurse(newAppointment, conflictAppointment) {
                const treatmentType = newAppointment.treatmentType;
                const subItemName = newAppointment.subItem;
                const treatmentName = subItemName ? `${treatmentType}-${subItemName}` : treatmentType;
                
                // 施術可能な看護師を取得
                const capableNurses = this.nurses.filter(nurse => 
                    nurse.treatmentTypes.includes(treatmentName) || nurse.treatmentTypes.includes(treatmentType)
                ).map(nurse => nurse.name);
                
                // 同じ時間帯に空いている看護師を見つける
                const newStartTime = this.timeToMinutes(newAppointment.startTime);
                const newEndTime = newStartTime + newAppointment.duration;
                
                return capableNurses.find(nurseName => {
                    // この看護師が同じ時間帯に他の予約を持っているかチェック
                    const hasConflict = this.appointments.some(apt => {
                        if (apt.id === newAppointment.id || apt.date !== newAppointment.date) return false;
                        
                        const aptStartTime = this.timeToMinutes(apt.startTime);
                        const aptEndTime = aptStartTime + apt.duration;
                        
                        return apt.nurse === nurseName && 
                               newStartTime < aptEndTime && newEndTime > aptStartTime;
                    });
                    
                    return !hasConflict;
                });
            }
            
            // 利用可能なデバイスを見つける
            findAvailableDevice(newAppointment, conflictAppointment) {
                // 同じ時間帯に空いているデバイスを見つける
                const newStartTime = this.timeToMinutes(newAppointment.startTime);
                const newEndTime = newStartTime + newAppointment.duration;
                
                return this.devices.find(deviceName => {
                    if (deviceName === 'なし') return false; // 「なし」は除外
                    
                    // このデバイスが同じ時間帯に他の予約で使用されているかチェック
                    const hasConflict = this.appointments.some(apt => {
                        if (apt.id === newAppointment.id || apt.date !== newAppointment.date) return false;
                        if (!apt.device || apt.device === 'なし') return false;
                        
                        const aptStartTime = this.timeToMinutes(apt.startTime);
                        const aptEndTime = aptStartTime + apt.duration;
                        
                        return apt.device === deviceName && 
                               newStartTime < aptEndTime && newEndTime > aptStartTime;
                    });
                    
                    return !hasConflict;
                }) || 'なし'; // 利用可能なデバイスがない場合は「なし」
            }
            
            // 患者の重複を避けるための利用可能な時間を見つける
            findAvailableTimeForPatient(appointment) {
                const originalStart = this.timeToMinutes(appointment.startTime);
                const duration = appointment.duration;
                
                // 30分前後で空きを探す
                for (let offset = 30; offset <= 180; offset += 30) {
                    // 後の時間を試す
                    const laterTime = originalStart + offset;
                    if (laterTime + duration <= 20 * 60 + 30) { // 20:30まで
                        const laterTimeString = this.minutesToTime(laterTime);
                        if (this.isTimeSlotAvailableForPatient(appointment, laterTimeString)) {
                            return laterTimeString;
                        }
                    }
                    
                    // 前の時間を試す
                    const earlierTime = originalStart - offset;
                    if (earlierTime >= 11 * 60) { // 11:00から
                        const earlierTimeString = this.minutesToTime(earlierTime);
                        if (this.isTimeSlotAvailableForPatient(appointment, earlierTimeString)) {
                            return earlierTimeString;
                        }
                    }
                }
                
                return null; // 適切な時間が見つからない
            }
            
            // 指定した時間がその患者にとって利用可能かチェック
            isTimeSlotAvailableForPatient(appointment, newStartTime) {
                const newStart = this.timeToMinutes(newStartTime);
                const newEnd = newStart + appointment.duration;
                
                return !this.appointments.some(apt => {
                    if (apt.id === appointment.id || apt.date !== appointment.date) return false;
                    
                    // 同じ患者かチェック
                    const isSamePatient = (appointment.patientId && apt.patientId && 
                                          appointment.patientId === apt.patientId) ||
                                         (!appointment.patientId && !apt.patientId && 
                                          appointment.patientName === apt.patientName);
                    
                    if (!isSamePatient) return false;
                    
                    const aptStart = this.timeToMinutes(apt.startTime);
                    const aptEnd = aptStart + apt.duration;
                    
                    return newStart < aptEnd && newEnd > aptStart;
                });
            }
            
            // 同じ施術メニューでの時間重複を避けるための利用可能な時間を見つける
            findAvailableTimeForTreatment(appointment) {
                const originalStart = this.timeToMinutes(appointment.startTime);
                const duration = appointment.duration;
                
                // 11:00から20:00まで5分刻みで空いている時間を探す
                for (let hour = 11; hour <= 19; hour++) {
                    for (let minute = 0; minute < 60; minute += 5) {
                        if (hour === 20 && minute > 0) break;
                        
                        const testStart = hour * 60 + minute;
                        const testEnd = testStart + duration;
                        
                        // 20:00を超える場合はスキップ
                        if (testEnd > 20 * 60) continue;
                        
                        // 元の時間と同じ場合はスキップ
                        if (testStart === originalStart) continue;
                        
                        // この時間帯で全ての重複をチェック
                        const testAppointment = {
                            ...appointment,
                            startTime: this.minutesToTime(testStart)
                        };
                        
                        const allConflicts = this.checkAllConflicts(testAppointment, appointment.id);
                        if (allConflicts.length === 0) {
                            return this.minutesToTime(testStart);
                        }
                    }
                }
                
                return null; // 空きがない場合
            }

            setupTimeOptions() {
                const hourSelect = document.getElementById('startHour');
                const minuteSelect = document.getElementById('startMinute');
                
                // 既存のオプションをクリア
                hourSelect.innerHTML = '';
                minuteSelect.innerHTML = '';
                
                // 営業時間に基づく時間選択肢を作成
                // 午前: 11:00-14:30 (14時30分まで)
                // 午後: 16:00-20:30 (20時30分まで)
                const businessHours = [
                    // 午前の部
                    { start: 11, end: 14, includeHalfHour: true }, // 11:00-14:30
                    // 午後の部
                    { start: 16, end: 20, includeHalfHour: true }  // 16:00-20:30
                ];
                
                // 時間選択肢に「選択してください」を追加してから時間を追加
                const defaultHourOption = document.createElement('option');
                defaultHourOption.value = '';
                defaultHourOption.textContent = '選択してください';
                hourSelect.appendChild(defaultHourOption);
                
                businessHours.forEach(period => {
                    for (let hour = period.start; hour <= period.end; hour++) {
                        const option = document.createElement('option');
                        option.value = hour.toString().padStart(2, '0');
                        option.textContent = hour + '時';
                        hourSelect.appendChild(option);
                    }
                });
                
                // 分選択肢に「選択してください」を追加してから分を追加
                const defaultMinuteOption = document.createElement('option');
                defaultMinuteOption.value = '';
                defaultMinuteOption.textContent = '選択してください';
                minuteSelect.appendChild(defaultMinuteOption);
                
                // 分（5分刻み：00, 05, 10...55分）
                for (let minute = 0; minute < 60; minute += 5) {
                    const option = document.createElement('option');
                    option.value = minute.toString().padStart(2, '0');
                    option.textContent = minute.toString().padStart(2, '0') + '分';
                    minuteSelect.appendChild(option);
                }
                
                // 時間選択変更時の動的制限を追加
                hourSelect.addEventListener('change', () => {
                    this.updateMinuteOptionsBasedOnHour();
                });
            }

            // 選択した時間に基づいて分の選択肢を更新
            updateMinuteOptionsBasedOnHour() {
                const hourSelect = document.getElementById('startHour');
                const minuteSelect = document.getElementById('startMinute');
                const selectedHour = parseInt(hourSelect.value);
                
                // 現在選択されている分を保持
                const currentMinute = minuteSelect.value;
                
                // 分のオプションをクリア
                minuteSelect.innerHTML = '';
                
                // 時間が未選択の場合は「選択してください」を表示
                if (!selectedHour) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '選択してください';
                    minuteSelect.appendChild(defaultOption);
                    return;
                }
                
                // まず「選択してください」オプションを追加
                const selectOption = document.createElement('option');
                selectOption.value = '';
                selectOption.textContent = '選択してください';
                minuteSelect.appendChild(selectOption);
                
                // 14時の場合は30分まで、20時の場合は30分まで、15時は選択不可（昼休み）
                if (selectedHour === 14) {
                    // 14時は30分まで（14:30まで）
                    for (let minute = 0; minute <= 30; minute += 5) {
                        const option = document.createElement('option');
                        option.value = minute.toString().padStart(2, '0');
                        option.textContent = minute.toString().padStart(2, '0') + '分';
                        minuteSelect.appendChild(option);
                    }
                } else if (selectedHour === 20) {
                    // 20時は30分まで（20:30まで）
                    for (let minute = 0; minute <= 30; minute += 5) {
                        const option = document.createElement('option');
                        option.value = minute.toString().padStart(2, '0');
                        option.textContent = minute.toString().padStart(2, '0') + '分';
                        minuteSelect.appendChild(option);
                    }
                } else if (selectedHour === 15) {
                    // 15時は昼休み時間のため選択不可（この時間は時間選択肢にないはず）
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '休憩時間';
                    option.disabled = true;
                    minuteSelect.appendChild(option);
                } else {
                    // その他の時間は00-55分まで
                    for (let minute = 0; minute < 60; minute += 5) {
                        const option = document.createElement('option');
                        option.value = minute.toString().padStart(2, '0');
                        option.textContent = minute.toString().padStart(2, '0') + '分';
                        minuteSelect.appendChild(option);
                    }
                }
                
                // 以前選択されていた分が有効な範囲にあれば復元
                if (currentMinute && minuteSelect.querySelector(`option[value="${currentMinute}"]`)) {
                    minuteSelect.value = currentMinute;
                }
            }

            updateSelectOptions() {
                this.updateTreatmentOptions();
                this.updateNurseOptions();
                this.updateDeviceOptions();
                // 凡例はヘッダーに統合済み
            }

            updateTreatmentOptions() {
                const treatmentSelect = document.getElementById('treatmentType');
                const currentValue = treatmentSelect.value;
                
                treatmentSelect.innerHTML = '<option value="">選択してください</option>';
                
                this.treatments.forEach(treatment => {
                    const option = document.createElement('option');
                    option.value = treatment;
                    option.textContent = treatment;
                    treatmentSelect.appendChild(option);
                });
                
                if (currentValue && this.treatments.includes(currentValue)) {
                    treatmentSelect.value = currentValue;
                }
                
                // サブ項目オプションも更新
                this.updateSubItemOptions();
            }

            // 統合された施術メニュー選択UI用の関数
            toggleTreatmentDropdown() {
                const dropdown = document.getElementById('treatmentDropdown');
                if (dropdown.style.display === 'none') {
                    this.showTreatmentDropdown();
                } else {
                    this.hideTreatmentDropdown();
                }
            }

            showTreatmentDropdown() {
                const dropdown = document.getElementById('treatmentDropdown');
                this.buildTreatmentDropdown();
                dropdown.style.display = 'block';
                
                // ドキュメントクリックで閉じるイベントを追加
                setTimeout(() => {
                    document.addEventListener('click', this.handleDocumentClick.bind(this), { once: true });
                }, 0);
            }

            hideTreatmentDropdown() {
                const dropdown = document.getElementById('treatmentDropdown');
                dropdown.style.display = 'none';
            }

            handleDocumentClick(event) {
                const dropdown = document.getElementById('treatmentDropdown');
                const selector = document.querySelector('.treatment-selector');
                
                // クリックがセレクター外の場合はドロップダウンを閉じる
                if (!selector.contains(event.target)) {
                    this.hideTreatmentDropdown();
                }
            }

            buildTreatmentDropdown() {
                const dropdown = document.getElementById('treatmentDropdown');
                dropdown.innerHTML = '';

                this.treatmentMenus.forEach(treatment => {
                    // メイン項目を追加
                    const mainOption = document.createElement('div');
                    mainOption.className = 'treatment-option main-treatment';
                    if (treatment.subItems && treatment.subItems.length > 0) {
                        mainOption.className += ' treatment-has-subs';
                        // サブ項目がある場合はクリックで展開/収納
                        mainOption.onclick = (e) => {
                            e.stopPropagation();
                            this.toggleSubItems(treatment.name);
                        };
                    } else {
                        // サブ項目がない場合は直接選択
                        mainOption.onclick = () => this.selectTreatment(treatment.name, null);
                    }
                    mainOption.textContent = treatment.name;
                    
                    dropdown.appendChild(mainOption);

                    // サブ項目を追加（初期は非表示）
                    if (treatment.subItems && treatment.subItems.length > 0) {
                        treatment.subItems.forEach(subItem => {
                            const subOption = document.createElement('div');
                            subOption.className = 'treatment-option sub-treatment';
                            subOption.style.display = 'none';
                            subOption.textContent = subItem.name;
                            subOption.dataset.parent = treatment.name;
                            subOption.onclick = () => this.selectTreatment(treatment.name, subItem.name);
                            dropdown.appendChild(subOption);
                        });
                    }
                });
            }

            toggleSubItems(treatmentName) {
                const subItems = document.querySelectorAll(`.sub-treatment[data-parent="${treatmentName}"]`);
                const mainOption = document.querySelector(`.main-treatment.treatment-has-subs`);
                
                // 現在の表示状態をチェック
                const isCurrentlyVisible = subItems.length > 0 && subItems[0].style.display !== 'none';
                
                // 他のサブ項目を全て隠す
                document.querySelectorAll('.sub-treatment').forEach(item => {
                    item.style.display = 'none';
                });
                
                // 矢印を全てリセット
                document.querySelectorAll('.treatment-has-subs').forEach(item => {
                    item.classList.remove('expanded');
                });
                
                // 対象のサブ項目の表示を切り替え
                if (!isCurrentlyVisible) {
                    subItems.forEach(item => {
                        item.style.display = 'block';
                    });
                    // 展開状態を示すクラスを追加
                    const targetMain = [...document.querySelectorAll('.main-treatment')].find(el => 
                        el.textContent === treatmentName && el.classList.contains('treatment-has-subs')
                    );
                    if (targetMain) {
                        targetMain.classList.add('expanded');
                    }
                }
            }

            showSubItems(treatmentName) {
                const subItems = document.querySelectorAll(`.sub-treatment[data-parent="${treatmentName}"]`);
                subItems.forEach(item => {
                    item.style.display = 'block';
                });
            }

            hideSubItems(treatmentName) {
                const subItems = document.querySelectorAll(`.sub-treatment[data-parent="${treatmentName}"]`);
                subItems.forEach(item => {
                    item.style.display = 'none';
                });
            }

            selectTreatment(treatmentName, subItemName = null) {
                const treatmentType = document.getElementById('treatmentType');
                const subItem = document.getElementById('subItem');
                const display = document.getElementById('treatmentDisplay');
                
                // 施術メニューの設定を確認
                const treatmentMenu = this.treatmentMenus.find(menu => menu.name === treatmentName);
                const hasSubItems = treatmentMenu && treatmentMenu.subItems && treatmentMenu.subItems.length > 0;
                
                treatmentType.value = treatmentName;
                
                // サブ項目が存在しない施術の場合はサブ項目をクリア
                if (!hasSubItems) {
                    subItem.value = '';
                    display.value = treatmentName;
                    console.log(`⚠️ ${treatmentName}はサブ項目がないためサブ項目をクリアしました`);
                } else {
                    // サブ項目がある場合のみサブ項目を設定
                    const validSubItem = subItemName && treatmentMenu.subItems.some(item => item.name === subItemName) ? subItemName : '';
                    subItem.value = validSubItem;
                    
                    if (validSubItem) {
                        display.value = `${treatmentName} - ${validSubItem}`;
                    } else {
                        display.value = treatmentName;
                    }
                }

                this.hideTreatmentDropdown();
                
                // バリデーション状態をクリア
                const formGroup = display.closest('.form-group');
                const errorDiv = formGroup.querySelector('.form-error');
                if (errorDiv) {
                    errorDiv.textContent = '';
                }
                formGroup.classList.remove('error');
                
                // 標準所要時間を自動入力
                this.setDefaultDuration(treatmentName, subItemName);
                
                // 施術選択後に看護師選択肢を更新
                this.updateNurseOptionsForTreatment(treatmentName);
                
                // 間隔設定に基づく自動期間計算を実行
                this.calculateRecommendedDateRange();
            }
            
            // 間隔設定に基づく推奨期間の自動計算
            calculateRecommendedDateRange() {
                const patientId = document.getElementById('patientId').value;
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value;
                
                console.log('📊 自動日付計算 - フィールド値チェック:', {
                    patientId: patientId || '未設定',
                    treatmentType: treatmentType || '未設定',
                    subItem: subItem || 'なし',
                    必要条件満たす: !!(patientId && treatmentType)
                });
                
                // 必要な情報が揃っていない場合は処理しない
                if (!patientId || !treatmentType) {
                    console.log('⚠️ 必要な情報が不足しています（患者IDまたは施術メニュー）');
                    return;
                }
                
                // 検索エリアが表示されていない場合は処理しない
                const searchContainer = document.getElementById('searchSuggestionContainer');
                if (!searchContainer || searchContainer.style.display === 'none') {
                    return;
                }
                
                console.log('🔄 推奨期間の自動計算開始:', {
                    patientId,
                    treatmentType,
                    subItem
                });
                
                // 選択された施術メニューの間隔設定を取得
                const selectedTreatment = this.treatmentMenus.find(t => t.name === treatmentType);
                if (!selectedTreatment) {
                    console.log('❌ 施術メニューが見つかりません');
                    return;
                }
                
                const intervalMin = selectedTreatment.intervalMin;
                const intervalMax = selectedTreatment.intervalMax;
                
                console.log('📋 間隔設定:', {
                    intervalMin,
                    intervalMax
                });
                
                // 間隔設定がない場合はデフォルトの2週間を設定
                if (!intervalMin) {
                    console.log('⚙️ 間隔設定なし - デフォルト2週間を設定');
                    this.setQuickPeriod(14);
                    this.clearRecommendationMessage();
                    return;
                }
                
                // 患者の最後の同一施術を検索
                const lastAppointment = this.findLastAppointmentForTreatment(patientId, treatmentType, subItem);
                
                if (!lastAppointment) {
                    // 初回施術の場合
                    console.log('🎯 初回施術です');
                    this.showInitialTreatmentMessage(treatmentType);
                    this.setQuickPeriod(14); // デフォルト2週間
                    return;
                }
                
                // 最後の施術日から推奨期間を計算
                const lastDate = new Date(lastAppointment.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // 時刻をリセットして日付のみで比較
                lastDate.setHours(0, 0, 0, 0);
                
                const recommendedStart = new Date(lastDate);
                recommendedStart.setDate(recommendedStart.getDate() + intervalMin);
                
                let recommendedEnd = null;
                let useAutoEndDate = false; // 自動終了日設定のフラグ
                
                if (intervalMax) {
                    // 最大間隔が設定されている場合は従来通り自動で終了日も設定
                    recommendedEnd = new Date(lastDate);
                    recommendedEnd.setDate(recommendedEnd.getDate() + intervalMax);
                    useAutoEndDate = true;
                } else {
                    // 最小間隔のみの場合は終了日は手動選択
                    useAutoEndDate = false;
                }
                
                const formatDateForLog = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                console.log('📅 計算結果:', {
                    lastDate: formatDateForLog(lastDate),
                    lastAppointmentTime: lastAppointment.startTime,
                    recommendedStart: formatDateForLog(recommendedStart),
                    recommendedEnd: recommendedEnd ? formatDateForLog(recommendedEnd) : '手動選択',
                    today: formatDateForLog(today),
                    '最後の施術が未来': lastDate >= today ? 'はい' : 'いいえ'
                });
                
                // 日付設定（最大間隔の有無で分ける）
                if (useAutoEndDate) {
                    // 最大間隔が設定されている場合は両方自動設定
                    this.setCalculatedDateRange(recommendedStart, recommendedEnd);
                } else {
                    // 最小間隔のみの場合は開始日のみ設定
                    this.setCalculatedStartDate(recommendedStart);
                }
                
                // メッセージ表示（最後の施術が未来の場合も考慮）
                const formatDate = (date) => `${date.getMonth() + 1}月${date.getDate()}日`;
                
                // メッセージは間隔制限の説明のみ（最大間隔の有無で分ける）
                const treatmentName = `${lastAppointment.treatmentType}${lastAppointment.subItem ? ' - ' + lastAppointment.subItem : ''}`;
                
                if (intervalMax) {
                    // 最大間隔が設定されている場合
                    this.showRecommendationMessage(
                        `📅 ${formatDate(lastDate)}の${treatmentName}から${intervalMin}～${intervalMax}日後が対象期間です`,
                        '#3b82f6'
                    );
                } else {
                    // 最小間隔のみ設定されている場合
                    this.showRecommendationMessage(
                        `📅 ${formatDate(lastDate)}の${treatmentName}から${intervalMin}日以降が対象です`,
                        '#3b82f6'
                    );
                }
            }
            
            // 最後の同一施術を検索（今日と未来の予約も含む）
            findLastAppointmentForTreatment(patientId, treatmentType, subItem) {
                // statusプロパティのチェックを削除し、すべての予約を対象にする
                return this.appointments
                    .filter(apt => 
                        String(apt.patientId) === String(patientId) && 
                        apt.treatmentType === treatmentType && 
                        (subItem ? apt.subItem === subItem : !apt.subItem)
                    )
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            }
            
            // 計算された開始日のみを設定（終了日は手動選択）
            setCalculatedStartDate(startDate) {
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                };
                
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                const startInput = document.getElementById('searchStartDate');
                const endInput = document.getElementById('searchEndDate');
                
                if (startInput) {
                    startInput.value = formatDisplay(startDate);
                    startInput.dataset.dateValue = formatDate(startDate);
                    startInput.style.color = '#2d3748';
                }
                
                // 終了日はクリア（手動選択のため）
                if (endInput) {
                    endInput.value = '';
                    endInput.dataset.dateValue = '';
                    endInput.style.color = '#a0aec0';
                }
            }

            // 計算された日付範囲を設定（既存関数は保持）
            setCalculatedDateRange(startDate, endDate) {
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                };
                
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                const startInput = document.getElementById('searchStartDate');
                const endInput = document.getElementById('searchEndDate');
                
                if (startInput && endInput) {
                    startInput.value = formatDisplay(startDate);
                    startInput.dataset.dateValue = formatDate(startDate);
                    startInput.style.color = '#2d3748';
                    
                    endInput.value = formatDisplay(endDate);
                    endInput.dataset.dateValue = formatDate(endDate);
                    endInput.style.color = '#2d3748';
                }
            }
            
            // 初回施術メッセージ表示
            showInitialTreatmentMessage(treatmentType) {
                this.showRecommendationMessage(
                    `🎯 これが初回の${treatmentType}施術です`,
                    '#10b981'
                );
            }
            
            // 推奨期間内メッセージ表示
            showInRangeMessage(startDate, endDate) {
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}月${date.getDate()}日`;
                };
                
                this.showRecommendationMessage(
                    `✅ 推奨期間（${formatDisplay(startDate)}～${formatDisplay(endDate)}）内です`,
                    '#10b981'
                );
            }
            
            // 推奨期間未到来メッセージ表示
            showFutureMessage(startDate, endDate) {
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}月${date.getDate()}日`;
                };
                
                this.showRecommendationMessage(
                    `⏰ 推奨期間は${formatDisplay(startDate)}～${formatDisplay(endDate)}です`,
                    '#f59e0b'
                );
            }
            
            // 推奨期間経過メッセージ表示
            showOverdueMessage(startDate, endDate) {
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}月${date.getDate()}日`;
                };
                
                this.showRecommendationMessage(
                    `⚠️ 推奨期間（${formatDisplay(startDate)}～${formatDisplay(endDate)}）は過ぎています`,
                    '#ef4444'
                );
            }
            
            // 推奨メッセージ表示
            showRecommendationMessage(message, color) {
                let messageDiv = document.getElementById('recommendationMessage');
                if (!messageDiv) {
                    // メッセージ表示エリアを作成
                    const searchContainer = document.getElementById('searchSuggestionContainer');
                    if (searchContainer) {
                        messageDiv = document.createElement('div');
                        messageDiv.id = 'recommendationMessage';
                        messageDiv.style.cssText = `
                            padding: 12px;
                            margin: 8px 0;
                            border-radius: 6px;
                            font-weight: bold;
                            text-align: center;
                            border: 2px solid;
                        `;
                        searchContainer.insertBefore(messageDiv, searchContainer.firstChild);
                    }
                }
                
                if (messageDiv) {
                    messageDiv.textContent = message;
                    messageDiv.style.color = color;
                    messageDiv.style.borderColor = color;
                    messageDiv.style.backgroundColor = color + '15'; // 半透明背景
                }
            }
            
            // 推奨メッセージクリア
            clearRecommendationMessage() {
                const messageDiv = document.getElementById('recommendationMessage');
                if (messageDiv) {
                    messageDiv.remove();
                }
            }
            
            // 標準所要時間を設定
            setDefaultDuration(treatmentName, subItemName = null) {
                const durationSelect = document.getElementById('duration');
                if (!durationSelect) return;
                
                // 施術メニューから標準所要時間を取得
                const treatmentMenu = this.treatmentMenus.find(t => t.name === treatmentName);
                if (!treatmentMenu) return;
                
                let defaultDuration;
                
                if (subItemName && treatmentMenu.subItems) {
                    // サブ項目の標準所要時間を使用
                    const subItem = treatmentMenu.subItems.find(s => s.name === subItemName);
                    defaultDuration = subItem ? subItem.defaultDuration : null;
                } else if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                    // サブ項目があるメイン項目は標準時間を設定しない
                    defaultDuration = null;
                } else {
                    // サブ項目がないメイン項目の標準所要時間を使用
                    defaultDuration = treatmentMenu.defaultDuration;
                }
                
                if (defaultDuration) {
                    // 所要時間のセレクトボックスで該当する値を選択
                    const option = Array.from(durationSelect.options).find(opt => opt.value == defaultDuration);
                    if (option) {
                        durationSelect.value = defaultDuration;
                        // 値が設定されたので文字色を黒にする
                        durationSelect.style.color = '#2d3748';
                        console.log(`標準所要時間を設定: ${treatmentName}${subItemName ? ' - ' + subItemName : ''} → ${defaultDuration}分`);
                        
                        // バリデーション状態をクリア
                        const formGroup = durationSelect.closest('.form-group');
                        if (formGroup) {
                            const errorDiv = formGroup.querySelector('.form-error');
                            if (errorDiv) {
                                errorDiv.textContent = '';
                            }
                            formGroup.classList.remove('error');
                        }
                    }
                }
            }

            // 互換性のために残す（既存コードが呼び出す可能性があるため）
            updateSubItemOptions() {
                // 新しいUIでは不要だが、既存コードとの互換性のために空の関数として残す
            }

            // 選択された施術に対応可能な看護師のみを表示
            updateNurseOptionsForTreatment(treatmentName) {
                const nurseSelect = document.getElementById('nurse');
                if (!nurseSelect) return;
                
                const currentValue = nurseSelect.value;
                nurseSelect.innerHTML = '<option value="">選択してください</option>';
                
                this.nurses.forEach(nurse => {
                    const nurseName = typeof nurse === 'string' ? nurse : nurse.name;
                    const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                    const option = document.createElement('option');
                    option.value = nurseName;
                    
                    if (treatmentTypes.includes(treatmentName)) {
                        // 対応可能な看護師
                        option.textContent = nurseName;
                        option.style.color = '#2d3748';
                    } else {
                        // 対応不可能な看護師
                        option.textContent = `${nurseName} (選択できません)`;
                        option.style.color = '#a0aec0';
                        option.disabled = true;
                    }
                    
                    nurseSelect.appendChild(option);
                });
                
                // 以前の選択を復元（可能な場合）
                const nurseNames = this.nurses.map(n => typeof n === 'string' ? n : n.name);
                if (currentValue && nurseNames.includes(currentValue)) {
                    const selectedNurse = this.nurses.find(n => 
                        (typeof n === 'string' ? n : n.name) === currentValue
                    );
                    const treatmentTypes = typeof selectedNurse === 'string' ? [] : selectedNurse.treatmentTypes;
                    
                    if (treatmentTypes.includes(treatmentName)) {
                        nurseSelect.value = currentValue;
                    }
                }
            }

            // 選択された看護師に対応可能な施術のみを表示
            updateTreatmentOptionsForNurse(nurseName) {
                const nurse = this.nurses.find(n => (typeof n === 'string' ? n : n.name) === nurseName);
                if (!nurse) return;
                
                const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                
                // 現在の施術選択をクリア（対応不可能な場合）
                const currentTreatment = document.getElementById('treatmentType').value;
                if (currentTreatment && !treatmentTypes.includes(currentTreatment)) {
                    document.getElementById('treatmentType').value = '';
                    document.getElementById('subItem').value = '';
                    document.getElementById('treatmentDisplay').value = '';
                }
                
                // ドロップダウンが開いている場合は更新
                const dropdown = document.getElementById('treatmentDropdown');
                if (dropdown && dropdown.style.display === 'block') {
                    this.buildTreatmentDropdownForNurse(treatmentTypes);
                }
            }

            buildTreatmentDropdownForNurse(allowedTreatments) {
                const dropdown = document.getElementById('treatmentDropdown');
                dropdown.innerHTML = '';

                this.treatmentMenus.forEach(treatment => {
                    // メイン項目を追加
                    const mainOption = document.createElement('div');
                    mainOption.className = 'treatment-option main-treatment';
                    
                    if (allowedTreatments.includes(treatment.name)) {
                        // 対応可能な施術
                        mainOption.textContent = treatment.name;
                        mainOption.style.color = '#2d3748';
                        
                        if (treatment.subItems && treatment.subItems.length > 0) {
                            mainOption.className += ' treatment-has-subs';
                            mainOption.onclick = (e) => {
                                e.stopPropagation();
                                this.toggleSubItems(treatment.name);
                            };
                        } else {
                            mainOption.onclick = () => this.selectTreatment(treatment.name, null);
                        }
                    } else {
                        // 対応不可能な施術
                        mainOption.textContent = `${treatment.name} (選択できません)`;
                        mainOption.style.color = '#a0aec0';
                        mainOption.style.cursor = 'not-allowed';
                        mainOption.onclick = () => {}; // 無効化
                    }
                    
                    dropdown.appendChild(mainOption);

                    // サブ項目を追加（許可されている場合のみ）
                    if (treatment.subItems && treatment.subItems.length > 0 && allowedTreatments.includes(treatment.name)) {
                        treatment.subItems.forEach(subItem => {
                            const subOption = document.createElement('div');
                            subOption.className = 'treatment-option sub-treatment';
                            subOption.style.display = 'none';
                            subOption.textContent = subItem.name;
                            subOption.dataset.parent = treatment.name;
                            subOption.onclick = () => this.selectTreatment(treatment.name, subItem.name);
                            dropdown.appendChild(subOption);
                        });
                    }
                });
            }
            
            updateDeviceOptions() {
                const deviceSelect = document.getElementById('device');
                
                // 予約フォームのセレクトボックスを更新
                if (deviceSelect) {
                    const currentValue = deviceSelect.value;
                    deviceSelect.innerHTML = '<option value="">選択してください</option>';
                    
                    const noneOption = document.createElement('option');
                    noneOption.value = 'なし';
                    noneOption.textContent = 'なし';
                    deviceSelect.appendChild(noneOption);
                    
                    this.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device;
                        option.textContent = device;
                        deviceSelect.appendChild(option);
                    });
                    
                    if (currentValue && (this.devices.includes(currentValue) || currentValue === 'なし')) {
                        deviceSelect.value = currentValue;
                    }
                }
                
                // フィルター用チェックボックスを更新
                this.updateDeviceCheckboxes();
            }
            
            updateDeviceCheckboxes() {
                const deviceCheckboxes = document.getElementById('deviceCheckboxes');
                if (!deviceCheckboxes) return;
                
                // 既存のチェック状態を保存
                const checkedDevices = [];
                deviceCheckboxes.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    checkedDevices.push(checkbox.value);
                });
                
                deviceCheckboxes.innerHTML = '';
                
                // デバイス一覧にデバイスを追加
                const allDevices = [...this.devices, 'なし']; // 「なし」も選択肢に含める
                
                allDevices.forEach(device => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = device;
                    checkbox.checked = checkedDevices.includes(device);
                    checkbox.onchange = () => this.updateDeviceFilter();
                    
                    const span = document.createElement('span');
                    span.textContent = device;
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    deviceCheckboxes.appendChild(label);
                });
                
                this.updateDeviceFilterDisplay();
            }

            updateNurseOptions() {
                const nurseSelect = document.getElementById('nurse');
                
                // 予約フォームのセレクトボックスを更新
                if (nurseSelect) {
                    const currentValue = nurseSelect.value;
                    nurseSelect.innerHTML = '<option value="">選択してください</option>';
                    
                    this.nurses.forEach(nurse => {
                        const nurseName = typeof nurse === 'string' ? nurse : nurse.name;
                        const option = document.createElement('option');
                        option.value = nurseName;
                        option.textContent = nurseName;
                        nurseSelect.appendChild(option);
                    });
                    
                    const nurseNames = this.nurses.map(n => typeof n === 'string' ? n : n.name);
                    if (currentValue && nurseNames.includes(currentValue)) {
                        nurseSelect.value = currentValue;
                    }
                }
                
                // フィルター用チェックボックスを更新
                this.updateNurseCheckboxes();
            }
            
            updateNurseCheckboxes() {
                const nurseCheckboxes = document.getElementById('nurseCheckboxes');
                if (!nurseCheckboxes) return;
                
                // 既存のチェック状態を保存
                const checkedNurses = [];
                nurseCheckboxes.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    checkedNurses.push(checkbox.value);
                });
                
                nurseCheckboxes.innerHTML = '';
                
                this.nurses.forEach(nurse => {
                    const nurseName = typeof nurse === 'string' ? nurse : nurse.name;
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = nurseName;
                    checkbox.checked = checkedNurses.includes(nurseName);
                    checkbox.onchange = () => this.updateNurseFilter();
                    
                    const span = document.createElement('span');
                    span.textContent = nurseName;
                    
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    nurseCheckboxes.appendChild(label);
                });
                
                this.updateNurseFilterDisplay();
            }
            
            // チェックボックス関連の関数を追加
            updateNurseFilter() {
                const allNurses = document.getElementById('allNurses');
                const nurseCheckboxes = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]');
                const checkedNurses = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]:checked');
                
                // 全ての個別項目がチェックされている場合のみ「全員」をチェック
                if (checkedNurses.length === nurseCheckboxes.length && nurseCheckboxes.length > 0) {
                    allNurses.checked = true;
                } else {
                    allNurses.checked = false;
                }
                
                this.updateNurseFilterDisplay();
                this.updateFloatingSummary(); // 予約件数表示をクリア
                this.render(); // 予約表示を更新
            }
            
            updateDeviceFilter() {
                const allDevices = document.getElementById('allDevices');
                const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]');
                const checkedDevices = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked');
                
                // 全ての個別項目がチェックされている場合のみ「全て」をチェック
                if (checkedDevices.length === deviceCheckboxes.length && deviceCheckboxes.length > 0) {
                    allDevices.checked = true;
                } else {
                    allDevices.checked = false;
                }
                
                this.updateDeviceFilterDisplay();
                this.updateFloatingSummary(); // 予約件数表示をクリア
                this.render(); // 予約表示を更新
            }
            
            updateNurseFilterDisplay() {
                const display = document.getElementById('nurseFilterDisplay');
                const allNurses = document.getElementById('allNurses');
                
                if (allNurses.checked) {
                    display.textContent = '全員';
                } else {
                    const checkedNurses = [];
                    document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                        checkedNurses.push(checkbox.nextSibling.textContent);
                    });
                    
                    if (checkedNurses.length === 0) {
                        display.textContent = '選択なし';
                    } else if (checkedNurses.length === 1) {
                        display.textContent = checkedNurses[0];
                    } else {
                        display.textContent = `${checkedNurses.length}名選択`;
                    }
                }
            }
            
            updateDeviceFilterDisplay() {
                const display = document.getElementById('deviceFilterDisplay');
                const allDevices = document.getElementById('allDevices');
                
                if (allDevices.checked) {
                    display.textContent = '全て';
                } else {
                    const checkedDevices = [];
                    document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                        checkedDevices.push(checkbox.nextSibling.textContent);
                    });
                    
                    if (checkedDevices.length === 0) {
                        display.textContent = '選択なし';
                    } else if (checkedDevices.length === 1) {
                        display.textContent = checkedDevices[0];
                    } else {
                        display.textContent = `${checkedDevices.length}個選択`;
                    }
                }
            }
            
            toggleAllNurses(checkbox) {
                const nurseCheckboxes = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]');
                const isChecked = checkbox.checked;
                
                // 全ての個別チェックボックスを同じ状態にする
                nurseCheckboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
                
                this.updateNurseFilterDisplay();
                this.updateFloatingSummary(); // 予約件数表示をクリア
                this.render(); // 予約表示を更新
            }
            
            toggleAllDevices(checkbox) {
                const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]');
                const isChecked = checkbox.checked;
                
                // 全ての個別チェックボックスを同じ状態にする
                deviceCheckboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
                
                this.updateDeviceFilterDisplay();
                this.updateFloatingSummary(); // 予約件数表示をクリア
                this.render(); // 予約表示を更新
            }
            
            // フィルター初期化
            initializeFilters() {
                console.log('🔧 フィルター初期化開始');
                
                // 初期状態では「全員」「全て」と全ての個別項目をチェック
                const allNurses = document.getElementById('allNurses');
                const allDevices = document.getElementById('allDevices');
                
                if (allNurses) {
                    allNurses.checked = true;
                    // 全ての看護師もチェック
                    const nurseCheckboxes = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]');
                    nurseCheckboxes.forEach(cb => {
                        cb.checked = true;
                    });
                    console.log('「全員」チェックボックス初期化完了');
                }
                
                if (allDevices) {
                    allDevices.checked = true;
                    // 全てのデバイスもチェック
                    const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]');
                    deviceCheckboxes.forEach(cb => {
                        cb.checked = true;
                    });
                    console.log('「全て」チェックボックス初期化完了');
                }
                
                // 表示更新
                this.updateNurseFilterDisplay();
                this.updateDeviceFilterDisplay();
                
                console.log('🔧 フィルター初期化完了');
            }


            

            setupEventListeners() {
                // フォーム送信
                document.getElementById('appointmentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveAppointment();
                });

                // 患者登録フォーム送信
                document.getElementById('newPatientForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveNewPatient();
                });

                // コメント文字数カウンター
                const commentField = document.getElementById('appointmentComment');
                if (commentField) {
                    commentField.addEventListener('input', () => {
                        this.updateCommentCharCount();
                    });
                }
                
                // 患者欄のキーボードイベント（Delete/Backspace で一括クリア）
                const patientNameField = document.getElementById('patientName');
                if (patientNameField) {
                    patientNameField.addEventListener('keydown', (e) => {
                        if ((e.key === 'Delete' || e.key === 'Backspace') && patientNameField.readOnly) {
                            e.preventDefault();
                            this.clearPatientSelection();
                        }
                    });
                }
                
                // 時間枠検索の日付入力フィールドに曜日表示機能を追加
                this.setupDateInputWithDayOfWeek('searchStartDate');
                this.setupDateInputWithDayOfWeek('searchEndDate');
                this.setupDateInputWithDayOfWeek('patientSearchStartDate');
                this.setupDateInputWithDayOfWeek('patientSearchEndDate');
                // 予約日入力欄にも曜日表示機能を追加
                this.setupDateInputWithDayOfWeek('appointmentDate');
                
                // 間隔表示用イベントリスナーを追加
                const patientIdField = document.getElementById('patientId');
                const treatmentTypeField = document.getElementById('treatmentType');
                const subItemField = document.getElementById('subItem');
                const appointmentDateField = document.getElementById('appointmentDate');
                
                console.log('🎯 イベントリスナー設定中:', {
                    patientIdField: !!patientIdField,
                    treatmentTypeField: !!treatmentTypeField,
                    subItemField: !!subItemField,
                    appointmentDateField: !!appointmentDateField
                });
                
                if (patientIdField) {
                    patientIdField.addEventListener('input', () => {
                        console.log('📋 patientId入力イベント');
                        this.updateIntervalInfo();
                    });
                }
                if (treatmentTypeField) {
                    treatmentTypeField.addEventListener('change', () => {
                        console.log('📋 treatmentType変更イベント');
                        this.updateIntervalInfo();
                    });
                }
                if (subItemField) {
                    subItemField.addEventListener('change', () => {
                        console.log('📋 subItem変更イベント');
                        this.updateIntervalInfo();
                    });
                }
                if (appointmentDateField) {
                    appointmentDateField.addEventListener('change', () => {
                        console.log('📋 appointmentDate変更イベント');
                        this.updateIntervalInfo();
                    });
                }
                
                // フィルター用のドロップダウン外クリックイベントを追加
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.filter-checkbox-container')) {
                        document.querySelectorAll('.filter-dropdown-content').forEach(content => {
                            content.style.display = 'none';
                            if (content.previousElementSibling) {
                                content.previousElementSibling.classList.remove('open');
                            }
                        });
                    }
                });
            }

            navigate(days) {
                console.log('📍 navigate呼び出し:', {
                    '移動前の日付': this.currentDate.toISOString(),
                    '移動日数': days
                });
                
                this.currentDate.setDate(this.currentDate.getDate() + days);
                
                console.log('📍 navigate後の日付:', this.currentDate.toISOString());
                this.render();
            }

            render() {
                console.log('レンダリング開始');
                
                // 自動スナップショット作成を実行
                this.createAutomaticSnapshots();
                
                // レンダー開始時のサブ項目順序をデバッグ
                const clusterMenu = this.treatmentMenus.find(m => m.name === 'ｸﾗﾂｰ');
                if (clusterMenu && clusterMenu.subItems) {
                    console.log('🔍 レンダー開始時のｸﾗﾂｰサブ項目:', clusterMenu.subItems.map(s => s.name));
                }
                console.log('🔍 render時のcurrentDate:', {
                    'Date object': this.currentDate,
                    'ISO String': this.currentDate.toISOString(),
                    'Local String': this.currentDate.toLocaleDateString('ja-JP'),
                    'getDate()': this.currentDate.getDate(),
                    'getMonth()': this.currentDate.getMonth() + 1,
                    'getFullYear()': this.currentDate.getFullYear()
                });
                
                // 日付変更時は予約件数表示を完全にクリア
                this.updateFloatingSummary();
                
                this.updateCurrentDateDisplay();
                this.renderScheduleTable();
                console.log('レンダリング完了');
                
                // 【追加】レンダリング後に位置を強制修正
                setTimeout(() => {
                    this.forceUpdateAllAppointmentPositions();
                    // 予約件数表示は renderAppointments で自動的に更新される
                }, 50);
            }

            updateCurrentDateDisplay() {
                const dateText = document.getElementById('dateText');
                if (!dateText) {
                    console.error('dateText要素が見つかりません');
                    return;
                }

                // シンプルな日付形式: 2025/9/1(月)
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth() + 1;
                const day = this.currentDate.getDate();
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                const weekday = weekdays[this.currentDate.getDay()];
                
                const formattedDate = `${year}/${month}/${day}(${weekday})`;
                dateText.textContent = formattedDate;
                
                // 印刷用にテーブルのヘッダーに日付を設定
                const scheduleTable = document.getElementById('scheduleTable');
                if (scheduleTable) {
                    const thead = scheduleTable.querySelector('thead');
                    if (thead) {
                        thead.setAttribute('data-print-date', `スケジュール表 - ${formattedDate}`);
                    }
                }
                console.log('日付表示を更新しました:', formattedDate);
            }

            // 日付から曜日を取得する関数
            getDayOfWeek(dateString) {
                const date = new Date(dateString);
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                return days[date.getDay()];
            }

            // 予約日入力欄の曜日表示を更新する関数
            updateAppointmentDateDayOfWeek(dateValue = null) {
                const appointmentDateInput = document.getElementById('appointmentDate');
                
                if (!appointmentDateInput) return;
                
                // dateValueが指定されていない場合は、dataset.dateValueから取得
                const actualDateValue = dateValue || appointmentDateInput.dataset.dateValue;
                
                if (actualDateValue && actualDateValue !== '') {
                    const date = new Date(actualDateValue + 'T00:00:00');
                    if (!isNaN(date.getTime())) {
                        const displayValue = this.formatDateWithDayOfWeek(date);
                        appointmentDateInput.value = displayValue;
                        appointmentDateInput.dataset.dateValue = actualDateValue;
                        appointmentDateInput.style.color = '#2d3748';
                    }
                } else {
                    appointmentDateInput.value = '';
                    appointmentDateInput.dataset.dateValue = '';
                    appointmentDateInput.style.color = '#a0aec0';
                }
            }

            // 入力欄から日付のみを取得する関数（dataset.dateValueを使用）
            getDateOnlyFromInput() {
                const appointmentDateInput = document.getElementById('appointmentDate');
                if (!appointmentDateInput) return '';
                
                return appointmentDateInput.dataset.dateValue || '';
            }

            renderScheduleTable() {
                console.log('🔧 renderScheduleTable開始');
                
                // ヘッダーを動的に生成（フィルタリングを適用）
                this.renderScheduleHeader();
                
                const tbody = document.getElementById('scheduleBody');
                if (!tbody) {
                    console.error('scheduleBody要素が見つかりません');
                    return;
                }
                
                tbody.innerHTML = '';
                console.log('✅ tbody cleared');
                
                // 11:00から20:30まで5分刻みで時間軸を生成
                for (let hour = 11; hour <= 20; hour++) {
                    for (let minute = 0; minute < 60; minute += 5) {
                        // 20:30で終了
                        if (hour === 20 && minute > 30) break;
                        
                        const row = document.createElement('tr');
                        
                        // 11:00の行を特定
                        if (hour === 11 && minute === 0) {
                            row.id = 'row-11-00';
                            row.style.position = 'relative';
                        }
                        
                        // 休憩時間の判定（14:30-16:00）
                        // 16:00は休憩時間に含めない（午後診療開始時刻）
                        const currentMinutes = hour * 60 + minute;
                        const isBreakTime = currentMinutes >= (14 * 60 + 30) && currentMinutes < (16 * 60);
                        
                        // 毎正時（XX:00）の行に特別なクラスを追加
                        if (minute === 0) {
                            row.className = 'hour-marker';
                        }
                        // 30分（XX:30）の行に特別なクラスを追加
                        else if (minute === 30) {
                            row.className = 'half-hour-marker';
                        }
                        
                        // 休憩時間の行にクラスを追加
                        if (isBreakTime) {
                            row.className = (row.className ? row.className + ' break-time' : 'break-time');
                        }
                        
                        // 時間セル（左側の時間表示）
                        const timeCell = document.createElement('td');
                        timeCell.className = 'time-cell';
                        if (isBreakTime) {
                            timeCell.className += ' break-time-cell';
                        }
                        timeCell.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        timeCell.style.width = '60px';
                        timeCell.style.minWidth = '60px';
                        timeCell.style.maxWidth = '60px';
                        
                        
                        row.appendChild(timeCell);
                        
                        // 各施術タイプのセル（サブ項目展開対応、フィルタリング適用）
                        const filteredTreatments = this.showOnlyBookedTreatments 
                            ? this.treatmentMenus.filter(treatment => this.hasTodayAppointments(treatment.name))
                            : this.treatmentMenus;
                        
                        filteredTreatments.forEach((treatmentMenu) => {
                            const cell = document.createElement('td');
                            cell.className = 'appointment-cell';
                            // 休憩時間のセルにはクラスを追加
                            if (isBreakTime) {
                                cell.className += ' break-time-cell';
                            }
                            cell.dataset.treatment = treatmentMenu.name;
                            cell.dataset.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            // ローカル日付を使用
                            const year = this.currentDate.getFullYear();
                            const month = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                            const day = this.currentDate.getDate().toString().padStart(2, '0');
                            cell.dataset.date = `${year}-${month}-${day}`;
                            cell.style.position = 'relative';
                            cell.style.height = '25px';
                            cell.style.minWidth = '100px';
                            cell.style.width = '100px';
                            
                            // サブ項目がある場合、閉じている時は薄いグレー背景
                            if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0 && !treatmentMenu.isExpanded) {
                                cell.style.backgroundColor = '#f5f5f5'; // 薄いグレー
                                cell.style.borderColor = '#f5f5f5'; // ボーダーも同じ色
                            }
                            
                            // サブ項目がある場合はクリックで展開・折り畳み可能にする
                            if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                                cell.style.cursor = 'pointer';
                                cell.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const treatmentIndex = this.treatmentMenus.findIndex(menu => menu.name === treatmentMenu.name);
                                    this.toggleScheduleTreatmentExpansion(treatmentIndex);
                                });
                            }
                            
                            // ダブルクリックで新規予約
                            cell.addEventListener('dblclick', () => {
                                this.openModal(
                                    this.currentDate, 
                                    `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`, 
                                    treatmentMenu.name
                                );
                            });
                            
                            // 展開されていない場合のみメインセルを追加
                            if (!treatmentMenu.isExpanded || !treatmentMenu.subItems || treatmentMenu.subItems.length === 0) {
                                row.appendChild(cell);
                            }
                            
                            // サブ項目が展開されている場合、サブ項目のセルを追加
                            if (treatmentMenu.isExpanded && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                                try {
                                    // 予約のみ表示モードの場合、予約があるサブ項目のみをフィルタリング
                                    const filteredSubItems = this.showOnlyBookedTreatments 
                                        ? treatmentMenu.subItems.filter(subItem => 
                                            this.hasTodaySubItemAppointments(treatmentMenu.name, subItem.name))
                                        : treatmentMenu.subItems;
                                    
                                    filteredSubItems.forEach((subItem, subIndex) => {
                                        if (!subItem || !subItem.name) {
                                            console.warn('無効なサブ項目:', subItem);
                                            return;
                                        }
                                        
                                        const subCell = document.createElement('td');
                                        subCell.className = 'appointment-cell sub-item-cell';
                                        // 休憩時間のセルにはクラスを追加
                                        if (isBreakTime) {
                                            subCell.className += ' break-time-cell';
                                        }
                                        subCell.dataset.treatment = treatmentMenu.name;
                                        subCell.dataset.subItem = subItem.name;
                                        subCell.dataset.time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                                        subCell.dataset.date = `${year}-${month}-${day}`;
                                        subCell.style.position = 'relative';
                                        subCell.style.height = '25px';
                                        subCell.style.minWidth = '80px';
                                        subCell.style.width = '80px';
                                        
                                        // borderColorのフォールバック処理
                                        const borderColor = subItem.borderColor || treatmentMenu.borderColor || '#9ca3af';
                                        subCell.style.borderLeft = `2px solid ${borderColor}`;
                                        
                                        // ダブルクリックで新規予約（サブ項目指定）
                                        subCell.addEventListener('dblclick', () => {
                                            this.openModal(
                                                this.currentDate, 
                                                `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`, 
                                                treatmentMenu.name,
                                                subItem.name
                                            );
                                        });
                                        
                                        row.appendChild(subCell);
                                    });
                                } catch (error) {
                                    console.error('❌ サブ項目セル生成エラー:', error);
                                }
                            }
                        });
                        
                        tbody.appendChild(row);
                    }
                }
                
                
                // 横スクロール同期を設定
                this.setupHeaderScrollSync();
                
                // サブ項目展開時のセル背景色を適用
                this.updateExpandedCellStyles();
                
                this.renderAppointments();
            }

            // 当日に予約が入っているかチェックする関数
            hasTodayAppointments(treatmentName) {
                const year = this.currentDate.getFullYear();
                const month = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                const day = this.currentDate.getDate().toString().padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                
                return this.appointments.some(appointment => {
                    return appointment.date === todayString && appointment.treatmentType === treatmentName;
                });
            }

            // 当日に指定されたサブ項目の予約が入っているかチェックする関数
            hasTodaySubItemAppointments(treatmentName, subItemName) {
                const year = this.currentDate.getFullYear();
                const month = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                const day = this.currentDate.getDate().toString().padStart(2, '0');
                const todayString = `${year}-${month}-${day}`;
                
                return this.appointments.some(appointment => {
                    return appointment.date === todayString && 
                           appointment.treatmentType === treatmentName && 
                           appointment.subItem === subItemName;
                });
            }

            // 施術項目行の表示設定を変更する関数
            setTreatmentRowsVisibility(showOnlyBooked) {
                this.showOnlyBookedTreatments = showOnlyBooked;
                
                // ボタンのアクティブ状態を更新
                const bookedButton = document.getElementById('showBookedOnly');
                const allButton = document.getElementById('showAllItems');
                
                if (bookedButton && allButton) {
                    if (showOnlyBooked) {
                        bookedButton.classList.add('active');
                        allButton.classList.remove('active');
                    } else {
                        bookedButton.classList.remove('active');
                        allButton.classList.add('active');
                    }
                }
                
                // テーブルを再描画
                this.renderScheduleTable();
            }

            // 全てのサブ項目を展開・収納する関数
            toggleAllSubItems() {
                // サブ項目を持つ施術メニューのみを対象
                const subItemMenus = this.treatmentMenus.filter(menu => menu.subItems && menu.subItems.length > 0);
                
                if (subItemMenus.length === 0) {
                    console.log('サブ項目を持つ施術メニューがありません');
                    return;
                }
                
                // 全て展開されているかチェック
                const allExpanded = subItemMenus.every(menu => menu.isExpanded);
                
                // ボタンテキスト用の状態
                let targetState;
                
                if (allExpanded) {
                    // 全て展開されている → 全て収納
                    targetState = false;
                } else {
                    // 一部または全て収納されている → 全て展開
                    targetState = true;
                }
                
                // 状態を変更
                subItemMenus.forEach(menu => {
                    menu.isExpanded = targetState;
                });
                
                // ボタンテキストを更新
                const button = document.getElementById('toggleAllSubItems');
                if (button) {
                    button.textContent = targetState ? '全て収納' : '全て展開';
                }
                
                // 予約件数表示をクリア（展開状態が変わるため）
                this.updateFloatingSummary();
                
                // テーブルを再描画
                this.renderScheduleTable();
                
                console.log(`全てのサブ項目を${targetState ? '展開' : '収納'}しました`);
            }
            
            // スクロール同期は不要（単一テーブル構造のため）
            setupHeaderScrollSync() {
                // 単一テーブル構造では不要
                console.log('✅ 単一テーブル構造のためスクロール同期不要');
                
                // 予約件数表示の横スクロール同期を設定
                this.setupSummaryScrollSync();
            }
            
            // 予約件数表示の横スクロール同期を設定
            setupSummaryScrollSync() {
                const scheduleContainer = document.querySelector('.schedule-container');
                if (!scheduleContainer) return;
                
                scheduleContainer.addEventListener('scroll', () => {
                    this.updateSummaryHorizontalPosition();
                });
                
                console.log('✅ 予約件数表示の横スクロール同期設定完了');
            }
            
            // 予約件数表示の横位置のみを更新
            updateSummaryHorizontalPosition() {
                const summaryContainer = document.getElementById('floatingSummaryContainer');
                if (!summaryContainer) return;
                
                const scheduleContainer = document.querySelector('.schedule-container');
                if (!scheduleContainer) return;
                
                // スクロール量に応じて左位置を調整
                const scrollLeft = scheduleContainer.scrollLeft;
                summaryContainer.style.transform = `translateX(-${scrollLeft}px)`;
            }
            
            // トラックパッドスクロール修正
            fixTrackpadScrolling() {
                const scheduleContainer = document.querySelector('.schedule-container');
                if (!scheduleContainer) return;
                
                // wheel イベントを明示的に処理（passive: false で preventDefault可能）
                scheduleContainer.addEventListener('wheel', (e) => {
                    // 縦横スクロールを手動制御
                    const scrollSpeed = 1.5; // スクロール速度調整
                    
                    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                        // 横スクロール優先
                        scheduleContainer.scrollLeft += e.deltaX * scrollSpeed;
                    } else {
                        // 縦スクロール
                        scheduleContainer.scrollTop += e.deltaY * scrollSpeed;
                    }
                    
                    // デフォルトのスクロール動作を停止
                    e.preventDefault();
                }, { passive: false });
                
                console.log('✅ トラックパッドスクロール修正完了');
            }
            
            // フローティングサマリーの位置を更新
            updateFloatingSummaryPositions() {
                const floatingSummaryContainer = document.getElementById('floatingSummaryContainer');
                if (!floatingSummaryContainer) return;
                
                const summaryElements = floatingSummaryContainer.querySelectorAll('.floating-summary-item');
                summaryElements.forEach(summaryEl => {
                    const treatmentType = summaryEl.dataset.treatment;
                    if (treatmentType) {
                        this.positionSummaryElement(summaryEl, treatmentType);
                    }
                });
            }

            
            // 【強化版】スケジュールヘッダーを動的に生成（サブ項目展開対応）
            renderScheduleHeader() {
                console.log('🔧 renderScheduleHeader開始');
                
                const headerRow = document.getElementById('scheduleHeaderRow');
                if (!headerRow) {
                    console.error('scheduleHeaderRow要素が見つかりません');
                    return;
                }
                
                headerRow.innerHTML = '';
                
                // 時間列のヘッダー
                const timeHeader = document.createElement('th');
                timeHeader.textContent = '時間';
                timeHeader.style.background = '#f7fafc';
                timeHeader.style.color = '#2d3748';
                timeHeader.style.fontWeight = '600';
                timeHeader.style.fontSize = '14px';
                timeHeader.style.textAlign = 'center';
                timeHeader.style.padding = '16px';
                timeHeader.style.border = '1px solid #e5e7eb';
                timeHeader.style.borderRight = '2px solid #e2e8f0';
                timeHeader.style.minWidth = '60px';
                timeHeader.style.width = '60px';
                timeHeader.style.position = 'sticky';
                timeHeader.style.left = '0';
                timeHeader.style.zIndex = '20';
                timeHeader.style.boxShadow = '2px 0 4px rgba(0, 0, 0, 0.1)';
                headerRow.appendChild(timeHeader);
                
                // 施術項目をフィルタリング（予約のみ表示の場合）
                const filteredTreatments = this.showOnlyBookedTreatments 
                    ? this.treatmentMenus.filter(treatment => this.hasTodayAppointments(treatment.name))
                    : this.treatmentMenus;
                
                // 各施術メニューのヘッダー（サブ項目展開対応）
                filteredTreatments.forEach((treatmentMenu) => {
                    // 元の配列でのインデックスを取得
                    const originalIndex = this.treatmentMenus.findIndex(t => t.name === treatmentMenu.name);
                    
                    // メインのヘッダー
                    const header = document.createElement('th');
                    
                    // サブ項目がある場合は展開ボタンを追加
                    if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        // メイン項目名と予約件数を分けて表示するためのコンテナ
                        const headerContent = document.createElement('div');
                        headerContent.style.cssText = `
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            width: 100%;
                            height: 100%;
                        `;
                        
                        const expandButton = document.createElement('span');
                        expandButton.textContent = treatmentMenu.isExpanded ? '〈' : '〉';
                        expandButton.className = 'expand-button';
                        expandButton.style.cssText = `
                            position: absolute;
                            top: 0;
                            right: 0;
                            height: 100%;
                            width: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 12px;
                            font-weight: 500;
                            color: rgba(255, 255, 255, 0.7);
                            background: rgba(0, 0, 0, 0.15);
                            border-radius: 0;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            backdrop-filter: blur(2px);
                            border: none;
                            border-left: 1px solid rgba(255, 255, 255, 0.2);
                            user-select: none;
                        `;
                        
                        // ホバー効果
                        expandButton.addEventListener('mouseenter', () => {
                            expandButton.style.color = 'white';
                            expandButton.style.background = 'rgba(0, 0, 0, 0.3)';
                            expandButton.style.borderLeftColor = 'rgba(255, 255, 255, 0.4)';
                        });
                        
                        expandButton.addEventListener('mouseleave', () => {
                            expandButton.style.color = 'rgba(255, 255, 255, 0.7)';
                            expandButton.style.background = 'rgba(0, 0, 0, 0.15)';
                            expandButton.style.borderLeftColor = 'rgba(255, 255, 255, 0.2)';
                        });
                        
                        // クリック効果
                        expandButton.addEventListener('mousedown', () => {
                            expandButton.style.background = 'rgba(0, 0, 0, 0.4)';
                        });
                        
                        expandButton.addEventListener('mouseup', () => {
                            expandButton.style.background = 'rgba(0, 0, 0, 0.3)';
                        });
                        
                        header.style.position = 'relative';
                        header.appendChild(expandButton);
                        
                        const nameSpan = document.createElement('div');
                        nameSpan.textContent = treatmentMenu.name;
                        nameSpan.style.cssText = `
                            font-size: 14px;
                            font-weight: 700;
                            margin-bottom: 2px;
                        `;
                        headerContent.appendChild(nameSpan);
                        header.appendChild(headerContent);
                        
                        // クリックで展開/収納
                        header.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`🖱️ ヘッダークリック: ${treatmentMenu.name} (originalIndex: ${originalIndex})`);
                            this.toggleScheduleTreatmentExpansion(originalIndex);
                        });
                        header.style.cursor = 'pointer';
                        
                        // 展開ボタンにもクリックイベントを追加
                        expandButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`🔘 展開ボタンクリック: ${treatmentMenu.name} (originalIndex: ${originalIndex})`);
                            this.toggleScheduleTreatmentExpansion(originalIndex);
                        });
                    } else {
                        // サブ項目がない場合もコンテナを作成
                        const headerContent = document.createElement('div');
                        headerContent.style.cssText = `
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            width: 100%;
                            height: 100%;
                        `;
                        
                        const nameSpan = document.createElement('div');
                        nameSpan.textContent = treatmentMenu.name;
                        nameSpan.style.cssText = `
                            font-size: 14px;
                            font-weight: 700;
                            margin-bottom: 2px;
                        `;
                        headerContent.appendChild(nameSpan);
                        header.appendChild(headerContent);
                        header.draggable = true;
                        
                        // サブ項目がないメイン項目のドラッグイベント
                        header.addEventListener('dragstart', (e) => this.handleMainDragStart(e, originalIndex));
                        header.addEventListener('dragover', (e) => this.handleMainDragOver(e));
                        header.addEventListener('drop', (e) => this.handleMainDrop(e, originalIndex));
                        header.addEventListener('dragend', (e) => this.handleDragEnd(e));
                        header.style.cursor = 'move';
                    }
                    
                    // サブ項目があるメイン項目もドラッグ可能にする
                    if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        header.draggable = true;
                        header.addEventListener('dragstart', (e) => {
                            // 展開ボタンクリックとの競合を避ける
                            if (e.target.className === 'expand-button') {
                                e.preventDefault();
                                return;
                            }
                            this.handleMainDragStart(e, originalIndex);
                        });
                        header.addEventListener('dragover', (e) => this.handleMainDragOver(e));
                        header.addEventListener('drop', (e) => this.handleMainDrop(e, originalIndex));
                        header.addEventListener('dragend', (e) => this.handleDragEnd(e));
                        // クリック可能であることを示しつつドラッグ可能も示す
                        header.style.cursor = 'pointer';
                        header.addEventListener('mousedown', (e) => {
                            // マウスダウン時にドラッグカーソルに変更
                            if (e.target.className !== 'expand-button') {
                                header.style.cursor = 'move';
                            }
                        });
                        header.addEventListener('mouseup', () => {
                            header.style.cursor = 'pointer';
                        });
                    }
                    
                    header.dataset.treatmentIndex = originalIndex;
                    header.dataset.treatment = treatmentMenu.name;
                    
                    // カラー表示と文字の視認性を向上
                    // メイン項目の色の彩度を上げる
                    const saturatedColor = this.saturateColor(treatmentMenu.color, 1.0);
                    
                    // サブ項目が展開されている場合も閉じている場合も彩度の高い色を使用
                    if (treatmentMenu.isExpanded && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        header.style.backgroundColor = saturatedColor;
                        header.style.color = this.getContrastColor(saturatedColor);
                    } else {
                        header.style.backgroundColor = saturatedColor;
                        header.style.color = this.getContrastColor(saturatedColor);
                    }
                    header.style.border = '1px solid #e5e7eb';
                    header.style.fontSize = '14px';
                    header.style.fontWeight = '700';
                    header.style.textAlign = 'center';
                    header.style.padding = '16px 8px';
                    header.style.textShadow = '0 1px 2px rgba(0,0,0,0.1)';
                    header.style.position = 'relative';
                    header.style.userSelect = 'none';
                    header.style.minWidth = '100px';
                    header.style.width = '100px';
                    
                    // 展開されていない場合のみメインヘッダーを追加
                    if (!treatmentMenu.isExpanded || !treatmentMenu.subItems || treatmentMenu.subItems.length === 0) {
                        headerRow.appendChild(header);
                    }
                    
                    // サブ項目が展開されている場合、サブ項目のヘッダーを追加
                    if (treatmentMenu.isExpanded && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        try {
                            // 予約のみ表示モードの場合、予約があるサブ項目のみをフィルタリング
                            // 重要：ドラッグで変更された順序を保持するため、treatmentMenu.subItemsの順序でフィルター
                            const filteredSubItems = this.showOnlyBookedTreatments 
                                ? treatmentMenu.subItems.filter(subItem => 
                                    this.hasTodaySubItemAppointments(treatmentMenu.name, subItem.name))
                                : treatmentMenu.subItems;
                            
                            // サブ項目ヘッダー（2段構造）
                            treatmentMenu.subItems.forEach((subItem, actualSubIndex) => {
                                // フィルタリングされた結果にないサブ項目はスキップ
                                if (!filteredSubItems.some(fi => fi.name === subItem.name)) {
                                    return;
                                }
                                
                                if (!subItem || !subItem.name) {
                                    console.warn('無効なサブ項目ヘッダー:', subItem);
                                    return;
                                }
                                
                                const subHeader = document.createElement('th');
                                subHeader.className = 'sub-item-header two-tier-header';
                                subHeader.style.padding = '0';
                                subHeader.style.position = 'relative';
                                subHeader.style.height = '64px'; // 2段分の高さ
                                subHeader.dataset.mainTreatment = treatmentMenu.name; // 同じメイン項目を識別
                                
                                // 2段構造のコンテナ
                                const container = document.createElement('div');
                                container.style.display = 'flex';
                                container.style.flexDirection = 'column';
                                container.style.height = '100%';
                                
                                // 上段：メイン項目名（濃い色に変更）
                                const topPart = document.createElement('div');
                                topPart.className = 'main-part-unified';
                                topPart.textContent = treatmentMenu.name;
                                // メイン項目の色の彩度を上げる
                                const saturatedColor = this.saturateColor(treatmentMenu.color, 1.0);
                                topPart.style.backgroundColor = saturatedColor;
                                topPart.style.color = this.getContrastColor(saturatedColor);
                                topPart.style.fontSize = '11px';
                                topPart.style.fontWeight = '600';
                                topPart.style.textAlign = 'center';
                                topPart.style.padding = '6px 2px';
                                topPart.style.cursor = 'pointer';
                                topPart.style.userSelect = 'none';
                                topPart.style.transition = 'all 0.2s ease';
                                topPart.style.flex = '1';
                                topPart.style.display = 'flex';
                                topPart.style.alignItems = 'center';
                                topPart.style.justifyContent = 'center';
                                
                                // 上段の境界を完全に削除して統合感を演出
                                topPart.style.border = 'none';
                                topPart.style.borderBottom = '1px solid #e5e7eb'; // 下段との境界のみ
                                
                                // 下段：サブ項目名（同じメイン項目は同色）
                                const bottomPart = document.createElement('div');
                                bottomPart.className = 'sub-part-individual';
                                bottomPart.textContent = subItem.name;
                                // サブ項目はメイン項目の色に統一
                                const bgColor = treatmentMenu.color || '#f3f4f6';
                                bottomPart.style.backgroundColor = bgColor;
                                bottomPart.style.color = this.getContrastColor(bgColor);
                                bottomPart.style.fontSize = '10px';
                                bottomPart.style.fontWeight = '500';
                                bottomPart.style.textAlign = 'center';
                                bottomPart.style.padding = '6px 2px';
                                bottomPart.style.userSelect = 'none';
                                bottomPart.style.flex = '1';
                                bottomPart.style.display = 'flex';
                                bottomPart.style.alignItems = 'center';
                                bottomPart.style.justifyContent = 'center';
                                bottomPart.style.borderTop = '1px solid #e5e7eb';
                                
                                // ホバー効果（上段のみ）
                                topPart.addEventListener('mouseenter', () => {
                                    topPart.style.transform = 'translateY(-1px)';
                                    topPart.style.boxShadow = '0 2px 4px rgba(0,0,0,0.15)';
                                    topPart.style.zIndex = '10';
                                });
                                
                                topPart.addEventListener('mouseleave', () => {
                                    topPart.style.transform = 'translateY(0)';
                                    topPart.style.boxShadow = 'none';
                                    topPart.style.zIndex = 'auto';
                                });
                                
                                // クリックで収納（上段のみ）
                                topPart.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    this.toggleScheduleTreatmentExpansion(originalIndex);
                                });
                                
                                // 上段にメイン項目のドラッグ機能を追加
                                topPart.draggable = true;
                                topPart.addEventListener('dragstart', (e) => {
                                    e.stopPropagation();
                                    this.handleMainDragStart(e, originalIndex);
                                });
                                topPart.addEventListener('dragover', (e) => this.handleMainDragOver(e));
                                topPart.addEventListener('drop', (e) => {
                                    this.handleMainDrop(e, originalIndex);
                                });
                                topPart.addEventListener('dragend', (e) => this.handleDragEnd(e));
                                
                                // マウスダウン時にドラッグカーソルに変更
                                topPart.addEventListener('mousedown', (e) => {
                                    topPart.style.cursor = 'move';
                                });
                                topPart.addEventListener('mouseup', () => {
                                    topPart.style.cursor = 'pointer';
                                });
                                topPart.addEventListener('mouseleave', () => {
                                    topPart.style.cursor = 'pointer';
                                });
                                
                                container.appendChild(topPart);
                                container.appendChild(bottomPart);
                                subHeader.appendChild(container);
                                subHeader.dataset.treatmentIndex = originalIndex;
                                subHeader.dataset.subItemIndex = actualSubIndex;
                                subHeader.dataset.treatment = treatmentMenu.name;
                                subHeader.dataset.subItem = subItem.name;
                                subHeader.dataset.isSubItem = 'true';
                                
                                // サブ項目ヘッダーのスタイル
                                subHeader.style.border = '1px solid #e5e7eb';
                                subHeader.style.minWidth = '80px';
                                subHeader.style.width = '80px';
                                subHeader.style.userSelect = 'none';
                                subHeader.style.overflow = 'hidden'; // 統合効果のため
                                
                                // サブ項目のデータ属性を下段にも設定
                                bottomPart.dataset.treatmentIndex = originalIndex;
                                bottomPart.dataset.subItemIndex = actualSubIndex;
                                bottomPart.dataset.treatment = treatmentMenu.name;
                                bottomPart.dataset.subItem = subItem.name;
                                bottomPart.dataset.isSubItem = 'true';
                                
                                // サブ項目のドラッグアンドドロップイベント（下段のみでドラッグ可能）
                                bottomPart.draggable = true;
                                bottomPart.style.cursor = 'move';
                                bottomPart.addEventListener('dragstart', (e) => {
                                    console.log('🔥 ドラッグ開始イベント発生:', subItem.name);
                                    e.stopPropagation();
                                    this.handleSubDragStart(e);
                                });
                                bottomPart.addEventListener('dragover', (e) => this.handleSubDragOver(e));
                                bottomPart.addEventListener('drop', (e) => this.handleSubDrop(e));
                                bottomPart.addEventListener('dragend', (e) => this.handleSubDragEnd(e));
                                
                                // サブヘッダー全体でもイベント受け取り
                                subHeader.addEventListener('dragover', (e) => this.handleSubDragOver(e));
                                subHeader.addEventListener('drop', (e) => this.handleSubDrop(e));
                                
                                headerRow.appendChild(subHeader);
                            });
                        } catch (error) {
                            console.error('❌ サブ項目ヘッダー生成エラー:', error);
                        }
                    }
                });
                
                // サブ項目の2段構造は各セル内で実装済み
                
                // 幅同期を実行
                this.syncHeaderAndBodyWidths();
                
                console.log('✅ スケジュールヘッダー強化版生成完了 - サブ項目展開対応');
            }
            
            
            // テーブル幅の簡単な同期
            syncHeaderAndBodyWidths() {
                // CSSのtable-layoutとwidthで自動的に同期されるため、
                // 複雑な手動調整は不要
                console.log('✅ テーブル幅同期（自動）');
            }
            
            // スケジュールでのサブ項目の展開・収納をトグル
            toggleScheduleTreatmentExpansion(treatmentIndex) {
                console.log(`🔄 toggleTreatmentExpansion 呼び出し: index=${treatmentIndex}`);
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                console.log(`🔄 treatmentMenu:`, treatmentMenu);
                
                if (!treatmentMenu || !treatmentMenu.subItems || treatmentMenu.subItems.length === 0) {
                    console.log(`❌ 展開できません: treatmentMenu=${!!treatmentMenu}, subItems=${treatmentMenu?.subItems?.length || 0}`);
                    return;
                }
                
                treatmentMenu.isExpanded = !treatmentMenu.isExpanded;
                
                console.log(`🔄 ${treatmentMenu.name} を${treatmentMenu.isExpanded ? '展開' : '収納'}しました`);
                
                // 予約件数表示は展開状態に関係なく常に維持する
                
                // 展開状態をローカルストレージに保存
                this.saveExpansionState();
                
                // ヘッダーとテーブルを再描画
                this.render();
                
                // 幅同期を再実行
                this.syncHeaderAndBodyWidths();
                
                // サブ項目展開時のセル背景色を適用
                this.updateExpandedCellStyles();
                
                // 予約を再描画（これにより予約件数表示も更新される）
                this.renderAppointments();
            }
            
            // サブ項目展開時のセル背景色を更新
            updateExpandedCellStyles() {
                // 全てのセルを一度リセット
                document.querySelectorAll('.appointment-cell').forEach(cell => {
                    cell.style.backgroundColor = 'white';
                    cell.style.borderColor = '#ddd'; // デフォルトの枠線色
                });
                
                // 各メイン項目のセル背景色を設定
                this.treatmentMenus.forEach((treatmentMenu, index) => {
                    if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        // メイン項目のセル列のみを選択（サブ項目は除外）
                        const mainCells = document.querySelectorAll(`[data-treatment="${treatmentMenu.name}"]:not([data-sub-item])`);
                        mainCells.forEach(cell => {
                            if (cell.classList.contains('appointment-cell')) {
                                if (treatmentMenu.isExpanded) {
                                    // 展開時：メイン項目セルは削除されているため、何もしない
                                } else {
                                    // 閉じている時：薄いグレー
                                    cell.style.backgroundColor = '#f5f5f5';
                                    cell.style.borderColor = '#f5f5f5';  // ボーダーも同じ色にして目立たなくする
                                }
                            }
                        });
                        console.log(`🎨 ${treatmentMenu.name} のメイン項目セル列を${treatmentMenu.isExpanded ? '濃いグレー' : '薄いグレー'}に変更しました`);
                    }
                });
            }
            
            // 特定の施術の予約件数表示を削除
            removeFloatingSummaryForTreatment(treatmentType) {
                const summaryContainer = document.getElementById('floatingSummaryContainer');
                if (summaryContainer) {
                    const existingSummary = summaryContainer.querySelector(`[data-treatment="${treatmentType}"]`);
                    if (existingSummary) {
                        console.log('💡 展開時に予約件数表示を削除:', treatmentType);
                        existingSummary.remove();
                    }
                }
            }
            
            // 展開状態を保存
            saveExpansionState() {
                const expansionState = {};
                this.treatmentMenus.forEach(menu => {
                    if (menu.subItems && menu.subItems.length > 0) {
                        expansionState[menu.name] = menu.isExpanded;
                    }
                });
                localStorage.setItem('treatmentExpansionState', JSON.stringify(expansionState));
            }
            
            // 展開状態を復元
            restoreExpansionState() {
                try {
                    const saved = localStorage.getItem('treatmentExpansionState');
                    if (saved) {
                        const expansionState = JSON.parse(saved);
                        this.treatmentMenus.forEach(menu => {
                            if (menu.subItems && menu.subItems.length > 0 && expansionState.hasOwnProperty(menu.name)) {
                                menu.isExpanded = expansionState[menu.name];
                            }
                        });
                        console.log('🔄 展開状態を復元しました:', expansionState);
                    }
                } catch (error) {
                    console.warn('展開状態の復元に失敗:', error);
                }
            }
            
            // サブ項目の縦線と同じ色を取得
            getVividColor(treatmentIndex) {
                // 施術タイプ別の縦線色（CSSのborder-left-colorと同じ）
                const borderColors = [
                    '#e53e3e', // treatment0 - 赤
                    '#3182ce', // treatment1 - 青
                    '#38a169', // treatment2 - 緑
                    '#805ad5', // treatment3 - 紫
                    '#d69e2e', // treatment4 - 黄
                    '#dd6b20'  // treatment5 - オレンジ
                ];
                
                return borderColors[treatmentIndex % borderColors.length];
            }
            
            // 【新規追加】背景色に対して最適な文字色を計算
            getContrastColor(hexColor) {
                // HEXカラーからRGB値を取得
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                
                // 輝度を計算
                const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                
                // 輝度に基づいて黒または白を返す
                return luminance > 0.6 ? '#1a202c' : '#ffffff';
            }

            // 色を暗くする関数
            darkenColor(hexColor, factor = 0.2) {
                // HEXカラーからRGB値を取得
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                
                // 色を暗くする
                const newR = Math.max(0, Math.floor(r * (1 - factor)));
                const newG = Math.max(0, Math.floor(g * (1 - factor)));
                const newB = Math.max(0, Math.floor(b * (1 - factor)));
                
                // HEXカラーに変換して返す
                return '#' + [newR, newG, newB].map(x => x.toString(16).padStart(2, '0')).join('');
            }
            
            // 色の彩度を上げる関数
            saturateColor(hexColor, factor) {
                console.log('saturateColor入力:', hexColor, factor);
                
                // RGB値を取得
                const r = parseInt(hexColor.slice(1, 3), 16) / 255;
                const g = parseInt(hexColor.slice(3, 5), 16) / 255;
                const b = parseInt(hexColor.slice(5, 7), 16) / 255;
                console.log('RGB値:', r, g, b);
                
                // RGBをHSLに変換
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                
                if (max === min) {
                    h = s = 0; // グレースケール
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                console.log('元のHSL:', h, s, l);
                
                // 彩度が既に最大の場合は明度を下げて鮮やかにする
                const originalS = s;
                const originalL = l;
                if (s >= 0.9) {
                    // 彩度が高い場合は明度を少し下げる
                    l = Math.max(0.5, l * (1 - factor * 0.15));
                    console.log('明度変更（彩度が高いため）:', originalL, '->', l);
                } else {
                    // 彩度が低い場合は彩度を上げる
                    s = Math.min(1, s + factor * 0.5);
                    console.log('彩度変更:', originalS, '->', s);
                }
                
                // HSLをRGBに変換
                function hue2rgb(p, q, t) {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                }
                
                let newR, newG, newB;
                if (s === 0) {
                    newR = newG = newB = l; // グレースケール
                } else {
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    newR = hue2rgb(p, q, h + 1/3);
                    newG = hue2rgb(p, q, h);
                    newB = hue2rgb(p, q, h - 1/3);
                }
                
                // 0-255の範囲に戻してHEXに変換
                const hexR = Math.round(newR * 255).toString(16).padStart(2, '0');
                const hexG = Math.round(newG * 255).toString(16).padStart(2, '0');
                const hexB = Math.round(newB * 255).toString(16).padStart(2, '0');
                
                const result = `#${hexR}${hexG}${hexB}`;
                console.log('結果:', result);
                return result;
            }

            renderAppointments() {
                // 既存の予約要素をクリア
                document.querySelectorAll('.appointment').forEach(el => el.remove());
                
                // フローティングサマリーコンテナはクリアしない（別の関数で管理）
                // updateFloatingSummary()で適切に更新される
                
                const filteredAppointments = this.getFilteredAppointments();
                // ローカル日付を使用（タイムゾーン問題を回避）
                const year = this.currentDate.getFullYear();
                const month = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                const day = this.currentDate.getDate().toString().padStart(2, '0');
                const currentDateStr = `${year}-${month}-${day}`;
                
                const todayAppointments = filteredAppointments.filter(apt => 
                    apt.date === currentDateStr
                );
                
                // デバッグログ追加
                console.log('📅 予約表示デバッグ:', {
                    '現在の日付': currentDateStr,
                    'フィルター済み予約数': filteredAppointments.length,
                    '今日の予約数': todayAppointments.length,
                    '全予約データ': this.appointments.length,
                    '今日の予約': todayAppointments
                });
                
                // 予約を時間順にソート
                todayAppointments.sort((a, b) => {
                    const timeA = a.startTime.split(':').map(Number);
                    const timeB = b.startTime.split(':').map(Number);
                    return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                });
                
                // 統合表示のために時間帯とメイン項目でグループ化
                const appointmentGroups = this.groupAppointmentsForIntegratedDisplay(todayAppointments);
                
                // グループごとに描画
                appointmentGroups.forEach(group => {
                    this.renderAppointmentGroup(group);
                });
                
                // 予約の描画が完了
                console.log('🎯 予約描画完了');
                // updateFloatingSummary()は呼ばない - renderDailySummaryで予約件数表示は既に作成済み
            }

            // 統合表示のための予約グループ化
            groupAppointmentsForIntegratedDisplay(appointments) {
                const groups = new Map();
                
                appointments.forEach(appointment => {
                    const treatmentMenu = this.treatmentMenus.find(t => t.name === appointment.treatmentType);
                    if (!treatmentMenu) return;
                    
                    if (treatmentMenu.isExpanded) {
                        // 展開状態：時間帯でグループ化
                        const [hour, minute] = appointment.startTime.split(':').map(Number);
                        const roundedMinute = Math.floor(minute / 5) * 5;
                        const timeKey = `${hour.toString().padStart(2, '0')}:${roundedMinute.toString().padStart(2, '0')}`;
                        const groupKey = `${timeKey}_${appointment.treatmentType}_expanded`;
                        
                        if (!groups.has(groupKey)) {
                            groups.set(groupKey, {
                                timeKey,
                                treatmentType: appointment.treatmentType,
                                treatmentMenu,
                                isExpanded: true,
                                appointments: []
                            });
                        }
                        
                        groups.get(groupKey).appointments.push(appointment);
                    } else {
                        // 閉じた状態：メイン項目全体で1つのグループ（1日の総量）
                        const groupKey = `daily_${appointment.treatmentType}`;
                        
                        if (!groups.has(groupKey)) {
                            groups.set(groupKey, {
                                timeKey: null, // 時間帯指定なし
                                treatmentType: appointment.treatmentType,
                                treatmentMenu,
                                isExpanded: false,
                                appointments: []
                            });
                        }
                        
                        groups.get(groupKey).appointments.push(appointment);
                    }
                });
                
                return Array.from(groups.values());
            }

            // グループごとの予約描画
            renderAppointmentGroup(group) {
                if (group.isExpanded) {
                    // 展開状態：個別のサブ項目セルに描画
                    group.appointments.forEach(appointment => {
                        this.renderAppointment(appointment);
                    });
                } else {
                    // 閉じた状態の処理
                    // サブ項目が存在しない場合は普通の表示、存在する場合はサマリー表示
                    if (!group.treatmentMenu.subItems || group.treatmentMenu.subItems.length === 0) {
                        // サブ項目がない場合：普通の予約表示 + 予約件数表示も追加
                        group.appointments.forEach(appointment => {
                            this.renderAppointment(appointment);
                        });
                        // サブ項目がなくても予約件数表示を作成
                        this.renderDailySummary(group);
                    } else {
                        // サブ項目がある場合：サマリー表示
                        this.renderIntegratedAppointment(group);
                    }
                }
            }

            // 統合表示での予約レンダリング
            renderIntegratedAppointment(group) {
                if (group.timeKey) {
                    // 時間帯指定ありの場合（展開状態での統合表示）
                    const [hour, minute] = group.timeKey.split(':').map(Number);
                    const currentDateStr = `${this.currentDate.getFullYear()}-${(this.currentDate.getMonth() + 1).toString().padStart(2, '0')}-${this.currentDate.getDate().toString().padStart(2, '0')}`;
                    
                    const mainCells = document.querySelectorAll(`.appointment-cell[data-treatment="${group.treatmentType}"][data-time="${group.timeKey}"][data-date="${currentDateStr}"]`);
                    let startCell = null;
                    
                    for (let cell of mainCells) {
                        if (!cell.classList.contains('sub-item-cell')) {
                            startCell = cell;
                            break;
                        }
                    }
                    
                    if (!startCell) {
                        console.warn('統合表示用のセルが見つかりません:', group);
                        return;
                    }
                    
                    // 複数の予約を統合表示
                    if (group.appointments.length === 1) {
                        // 1件の場合は通常表示
                        this.renderSingleAppointmentInCell(group.appointments[0], startCell);
                    } else {
                        // 複数件の場合は統合表示
                        this.renderMultipleAppointmentsInCell(group.appointments, startCell, group.treatmentMenu);
                    }
                } else {
                    // 時間帯指定なしの場合（1日の総量表示）
                    this.renderDailySummary(group);
                }
            }

            // 1日の総量表示（固定サマリー行に移動）
            renderDailySummary(group) {
                console.log('📊 renderDailySummary呼び出し:', group.treatmentType, '予約数:', group.appointments.length, '展開状態:', group.isExpanded);
                
                // 予約件数表示は展開状態に関係なく常に作成
                // これにより、ページ更新時やフィルター適用時に予約件数が確実に表示される
                this.addToFixedSummary(group);
            }
            
            // フローティングサマリーに追加（重複のため削除 - 4646行目の実装を使用）
            /*
            addToFixedSummary(group) {
                // この関数は使用されません - 4646行目の完全な実装を使用
            }
            */
            
            // ページ読み込み時の初期化（メインコンテナは作成しない）
            initFloatingSummary() {
                console.log('⚡ initFloatingSummary開始');
                // メインコンテナは作成せず、updateFloatingSummaryで必要に応じて作成される
                console.log('⚡ initFloatingSummary完了 - 実際の表示はupdateFloatingSummaryで行います');
            }
            
            // 予約件数表示を更新（ヘッダー内の予約件数をクリーンアップ）
            updateFloatingSummary() {
                console.log('🔄 予約件数表示を更新（ヘッダー内クリーンアップ）');
                
                // ヘッダー内の既存の予約件数表示を削除
                const existingCounts = document.querySelectorAll('.appointment-count');
                existingCounts.forEach(count => {
                    console.log('削除する予約件数表示:', count.textContent);
                    count.remove();
                });
                
                // 古いフローティングコンテナも削除（互換性のため）
                const idBasedContainers = document.querySelectorAll('[id^="floatingSummaryContainer"]');
                idBasedContainers.forEach(container => {
                    container.remove();
                });
                
                const classBasedContainers = document.querySelectorAll('.floating-summary-item, .floating-summary-container');
                classBasedContainers.forEach(container => {
                    container.remove();
                });
                
                console.log('✅ 予約件数表示のクリーンアップ完了');
                // 実際の作成はrenderDailySummary → renderAppointmentGroup → addToFixedSummaryで行われる
            }
            
            // 予約一覧を新しいウィンドウで表示（看護師絵文字版）
            showAppointmentList(treatmentType, date) {
                // 該当する予約を取得（フィルター適用）
                const filteredAppointments = this.getFilteredAppointments();
                const appointments = filteredAppointments.filter(app => 
                    app.treatmentType === treatmentType && 
                    app.date === date
                );
                
                if (appointments.length === 0) {
                    alert('👩‍⚕️ 該当する予約が見つかりません。');
                    return;
                }

                // 看護師絵文字配列
                const nurseEmojis = ['👩‍⚕️', '👨‍⚕️', '🧑‍⚕️', '👩‍⚕️', '👨‍⚕️'];
                
                // 時間帯による色分け
                const getTimeColor = (time) => {
                    const hour = parseInt(time.split(':')[0]);
                    if (hour < 10) return '#ff6b6b'; // 朝 - 赤系
                    if (hour < 14) return '#4ecdc4'; // 昼 - 青緑系
                    if (hour < 17) return '#45b7d1'; // 午後 - 青系
                    return '#96ceb4'; // 夕方 - 緑系
                };

                // HTML内容を生成
                const html = `
                    <!DOCTYPE html>
                    <html lang="ja">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>👩‍⚕️ ${treatmentType} - 予約一覧 (${date})</title>
                        <style>
                            body {
                                font-family: 'Segoe UI', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
                                margin: 0;
                                padding: 20px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                min-height: 100vh;
                            }
                            .container {
                                max-width: 900px;
                                margin: 0 auto;
                            }
                            .header {
                                background: white;
                                padding: 25px;
                                border-radius: 15px;
                                margin-bottom: 20px;
                                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                                text-align: center;
                                position: relative;
                                overflow: hidden;
                            }
                            .header::before {
                                content: '';
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                height: 5px;
                                background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
                            }
                            .header-title {
                                font-size: 24px;
                                font-weight: bold;
                                color: #2d3748;
                                margin: 0 0 10px 0;
                            }
                            .header-subtitle {
                                color: #718096;
                                font-size: 16px;
                                margin: 0 0 15px 0;
                            }
                            .total-count {
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                padding: 12px 24px;
                                border-radius: 25px;
                                font-weight: bold;
                                font-size: 18px;
                                display: inline-block;
                                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                            }
                            .appointment-grid {
                                display: grid;
                                gap: 15px;
                                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                            }
                            .appointment-card {
                                background: white;
                                padding: 20px;
                                border-radius: 15px;
                                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                                border-left: 5px solid;
                                transition: transform 0.2s, box-shadow 0.2s;
                                position: relative;
                                overflow: hidden;
                            }
                            .appointment-card:hover {
                                transform: translateY(-3px);
                                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                            }
                            .card-header {
                                display: flex;
                                align-items: center;
                                margin-bottom: 15px;
                            }
                            .nurse-emoji {
                                font-size: 28px;
                                margin-right: 12px;
                                animation: bounce 2s infinite;
                            }
                            @keyframes bounce {
                                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                                40% { transform: translateY(-5px); }
                                60% { transform: translateY(-3px); }
                            }
                            .patient-name {
                                font-size: 20px;
                                font-weight: bold;
                                color: #2d3748;
                                margin: 0;
                            }
                            .time-badge {
                                background: linear-gradient(135deg, var(--time-color), color-mix(in srgb, var(--time-color) 80%, white));
                                color: white;
                                padding: 8px 16px;
                                border-radius: 20px;
                                font-weight: bold;
                                font-size: 16px;
                                margin-left: auto;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                            }
                            .card-details {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 10px;
                                margin-top: 15px;
                            }
                            .detail-row {
                                display: flex;
                                align-items: center;
                                margin-bottom: 8px;
                                font-size: 14px;
                            }
                            .detail-row:last-child {
                                margin-bottom: 0;
                            }
                            .detail-icon {
                                font-size: 16px;
                                margin-right: 8px;
                                width: 20px;
                            }
                            .detail-text {
                                color: #4a5568;
                            }
                            .sub-treatment {
                                background: #e2e8f0;
                                color: #4a5568;
                                padding: 4px 12px;
                                border-radius: 15px;
                                font-size: 12px;
                                font-weight: 500;
                                margin-left: 8px;
                            }
                            .memo-section {
                                background: #fff3cd;
                                border: 1px solid #ffeaa7;
                                border-radius: 8px;
                                padding: 10px;
                                margin-top: 10px;
                                font-size: 13px;
                                color: #856404;
                            }
                            .floating-emojis {
                                position: absolute;
                                top: 10px;
                                right: 15px;
                                opacity: 0.1;
                                font-size: 40px;
                                pointer-events: none;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="header">
                                <h1 class="header-title">👩‍⚕️ ${treatmentType} - 予約一覧</h1>
                                <p class="header-subtitle">📅 ${date} の予約状況</p>
                                <div class="total-count">🎯 合計 ${appointments.length}件の予約</div>
                            </div>
                            
                            <div class="appointment-grid">
                                ${appointments.map((app, index) => {
                                    const timeColor = getTimeColor(app.startTime);
                                    const nurseEmoji = nurseEmojis[index % nurseEmojis.length];
                                    return `
                                    <div class="appointment-card" style="border-left-color: ${timeColor};">
                                        <div class="floating-emojis">💊</div>
                                        <div class="card-header">
                                            <span class="nurse-emoji">${nurseEmoji}</span>
                                            <h3 class="patient-name">${app.patientName}様</h3>
                                            <div class="time-badge" style="--time-color: ${timeColor};">
                                                ⏰ ${app.startTime}${app.endTime ? ` - ${app.endTime}` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="card-details">
                                            ${app.patientId ? `
                                            <div class="detail-row">
                                                <span class="detail-icon">🆔</span>
                                                <span class="detail-text">カルテID: ${app.patientId}</span>
                                            </div>
                                            ` : ''}
                                            
                                            ${app.duration ? `
                                            <div class="detail-row">
                                                <span class="detail-icon">⏱️</span>
                                                <span class="detail-text">施術時間: ${app.duration}分</span>
                                            </div>
                                            ` : ''}
                                            
                                            ${app.subTreatmentType ? `
                                            <div class="detail-row">
                                                <span class="detail-icon">🔸</span>
                                                <span class="detail-text">サブ項目</span>
                                                <span class="sub-treatment">${app.subTreatmentType}</span>
                                            </div>
                                            ` : ''}
                                            
                                            ${app.memo ? `
                                            <div class="memo-section">
                                                <strong>📝 メモ:</strong> ${app.memo}
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                // 新しいウィンドウを開く
                const newWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                if (newWindow) {
                    newWindow.document.write(html);
                    newWindow.document.close();
                } else {
                    alert('👩‍⚕️ ポップアップがブロックされました。ブラウザの設定を確認してください。');
                }
            }
            
            // ヘッダー内に予約件数を追加
            addToFixedSummary(group) {
                console.log('addToFixedSummary 呼び出し:', group);
                
                // 対応するヘッダー要素を探す
                const headers = document.querySelectorAll('#scheduleHeaderRow th');
                let targetHeader = null;
                
                for (let header of headers) {
                    if (header.dataset.treatment === group.treatmentType) {
                        targetHeader = header;
                        break;
                    }
                }
                
                if (!targetHeader) {
                    console.warn('対応するヘッダーが見つかりません:', group.treatmentType);
                    return;
                }
                
                // ヘッダー内のコンテナを探す（施術名の下に追加するため）
                const headerContent = targetHeader.querySelector('div[style*="flex-direction: column"]');
                if (!headerContent) {
                    console.warn('ヘッダーコンテナが見つかりません:', group.treatmentType);
                    return;
                }
                
                // 既存の予約件数表示を削除
                const existingCount = headerContent.querySelector('.appointment-count');
                if (existingCount) {
                    existingCount.remove();
                }
                
                // 予約件数表示要素を作成
                const countEl = document.createElement('div');
                countEl.className = 'appointment-count';
                countEl.style.cssText = `
                    background: white;
                    border: 1px solid ${group.treatmentMenu.borderColor};
                    border-radius: 4px;
                    padding: 2px 6px;
                    font-size: 11px;
                    font-weight: 600;
                    color: ${group.treatmentMenu.borderColor};
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: inline-block;
                    margin-top: 2px;
                `;
                
                // HTMLを使用して数字部分を太字にする
                countEl.innerHTML = `<strong>${group.appointments.length}</strong>件`;
                console.log('予約件数要素を作成:', countEl, 'テキスト:', countEl.textContent);
                
                // ホバー効果
                countEl.addEventListener('mouseenter', () => {
                    countEl.style.background = group.treatmentMenu.borderColor;
                    countEl.style.color = 'white';
                    countEl.style.transform = 'scale(1.05)';
                });
                
                countEl.addEventListener('mouseleave', () => {
                    countEl.style.background = 'white';
                    countEl.style.color = group.treatmentMenu.borderColor;
                    countEl.style.transform = 'scale(1)';
                });
                
                // クリックで予約一覧を表示
                countEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.showDailyAppointmentsList(group);
                });
                
                // データを保存
                countEl._appointmentGroup = group;
                
                // ヘッダーコンテナに追加（施術名の下）
                headerContent.appendChild(countEl);
                console.log('予約件数要素をヘッダーコンテナに追加:', headerContent);
            }
            
            // 削除予定の関数（使用されなくなる）
            positionSummaryElement_DEPRECATED(summaryEl, treatmentType) {
                try {
                    // ヘッダーから対応する列の位置を取得
                    const headerCells = document.querySelectorAll('#scheduleHeaderRow th');
                    let targetHeaderIndex = -1;
                    
                    // 施術タイプに対応するヘッダーのインデックスを探す
                    headerCells.forEach((header, index) => {
                        if (header.dataset.treatment === treatmentType) {
                            targetHeaderIndex = index;
                        }
                    });
                    
                    if (targetHeaderIndex >= 0 && targetHeaderIndex < headerCells.length) {
                        const headerCell = headerCells[targetHeaderIndex];
                        
                        // ヘッダーセルの中央に配置
                        const headerOffsetLeft = headerCell.offsetLeft;
                        const headerWidth = headerCell.offsetWidth;
                        const summaryWidth = 95; // 予約件数表示の幅
                        
                        // ヘッダーの中央に配置するため、左端から中央位置を計算
                        const centerPosition = headerOffsetLeft + (headerWidth - summaryWidth) / 2;
                        
                        summaryEl.style.position = 'absolute';
                        summaryEl.style.left = `${centerPosition}px`;
                        summaryEl.style.width = `${summaryWidth}px`;
                        summaryEl.style.top = '5px';
                        summaryEl.style.textAlign = 'center';
                        summaryEl.style.whiteSpace = 'nowrap';
                        summaryEl.style.overflow = 'hidden';
                        summaryEl.style.textOverflow = 'ellipsis';
                        summaryEl.style.zIndex = '60';
                    }
                } catch (error) {
                    console.error('サマリー位置計算エラー:', error);
                }
            }

            // 単一予約の描画
            renderSingleAppointmentInCell(appointment, startCell) {
                const appointmentEl = document.createElement('div');
                appointmentEl.className = 'appointment';
                appointmentEl.dataset.appointmentId = appointment.id;
                appointmentEl.dataset.treatment = appointment.treatmentType;
                appointmentEl.dataset.date = appointment.date;
                appointmentEl.dataset.duration = appointment.duration; // 印刷用CSS用に追加
                
                // 過去の予約かどうかを判定
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const appointmentDate = new Date(appointment.date);
                appointmentDate.setHours(0, 0, 0, 0);
                
                if (appointmentDate < today) {
                    appointmentEl.classList.add('past-appointment');
                }
                
                const position = this.calculateExactPosition(appointment);
                const treatmentMenu = this.treatmentMenus.find(t => t.name === appointment.treatmentType);
                const colors = treatmentMenu 
                    ? { bg: treatmentMenu.color, border: treatmentMenu.borderColor }
                    : { bg: '#f3f4f6', border: '#9ca3af' };
                
                // スタイル設定
                Object.assign(appointmentEl.style, {
                    position: 'absolute',
                    top: `${position.top}px`,
                    height: `${position.height}px`,
                    left: '2px',
                    right: '2px',
                    backgroundColor: colors.bg,
                    borderLeft: `4px solid ${colors.border}`,
                    borderRadius: '4px',
                    padding: '2px 4px',
                    cursor: 'pointer',
                    overflow: 'hidden',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                    zIndex: '5'
                });
                
                const endTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                
                // 患者名のみ表示（サブ項目は表示しない・完了予約は削除済みサフィックス対応）
                let displayName = this.getCompletedAppointmentDisplayName(appointment);
                
                
                // 患者マークを取得
                const patientMarks = this.getPatientMarks(appointment.patientId);
                const marksHtml = this.generatePatientMarksHtml(patientMarks);
                
                appointmentEl.innerHTML = `
                    ${appointment.patientId ? `<div style="font-size: 12px; color: #6b7280; text-align: left; margin-bottom: 2px;">
                        <span style="background: ${colors.border}; color: white; padding: 1px 4px; border-radius: 2px; font-size: 11px;">${appointment.patientId}</span>
                        ${marksHtml}
                    </div>` : ''}
                    <div style="font-weight: 600; font-size: 14px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left;">
                        ${displayName}
                    </div>
                    <div style="font-size: 12px; color: #6b7280; text-align: left; margin-top: 1px;">${appointment.nurse}</div>
                    <div style="font-size: 12px; color: #6b7280; text-align: left;">${appointment.startTime}-${endTime}</div>
                    <div style="font-size: 11px; color: #9ca3af; text-align: left;">(${appointment.duration}分)</div>
                    ${appointment.device && appointment.device !== 'なし' ? `<div style="font-size: 11px; color: #6b7280; text-align: left;">${appointment.device}</div>` : ''}
                    ${appointment.comment ? `<div style="font-size: 11px; color: #2563eb; text-align: left; margin-top: 2px; line-height: 1.3;">
                        <span style="margin-right: 2px;">📝</span>${appointment.comment}
                    </div>` : ''}
                `;
                
                // クリックイベント
                appointmentEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openModal(null, null, null, null, appointment);
                });
                
                startCell.appendChild(appointmentEl);
            }

            // 複数予約のサマリー表示
            renderMultipleAppointmentsInCell(appointments, startCell, treatmentMenu) {
                // 最も早い開始時間と最も遅い終了時間を計算
                const startTimes = appointments.map(apt => apt.startTime);
                const endTimes = appointments.map(apt => this.calculateEndTime(apt.startTime, apt.duration));
                
                const earliestStart = startTimes.reduce((earliest, current) => {
                    return current < earliest ? current : earliest;
                });
                
                const latestEnd = endTimes.reduce((latest, current) => {
                    return current > latest ? current : latest;
                });
                
                // 基本的な高さ（サマリー表示用）
                const minHeight = 50;
                
                const appointmentEl = document.createElement('div');
                appointmentEl.className = 'appointment summary';
                appointmentEl.dataset.appointmentCount = appointments.length;
                appointmentEl.dataset.expanded = 'false';
                appointmentEl.dataset.treatment = group.treatmentType;
                appointmentEl.dataset.date = appointments[0]?.date || '';
                
                // 過去の予約かどうかを判定（最初の予約の日付で判定）
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const appointmentDate = new Date(appointments[0].date);
                appointmentDate.setHours(0, 0, 0, 0);
                
                if (appointmentDate < today) {
                    appointmentEl.classList.add('past-appointment');
                }
                
                const firstAppointment = appointments[0];
                const position = this.calculateExactPosition(firstAppointment);
                const colors = { bg: treatmentMenu.color, border: treatmentMenu.borderColor };
                
                // スタイル設定（サマリー表示）
                Object.assign(appointmentEl.style, {
                    position: 'absolute',
                    top: `${position.top}px`,
                    height: `${minHeight}px`,
                    left: '2px',
                    right: '2px',
                    backgroundColor: colors.bg,
                    borderLeft: `4px solid ${colors.border}`,
                    borderRadius: '4px',
                    padding: '6px',
                    cursor: 'pointer',
                    overflow: 'hidden',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.15)',
                    transition: 'all 0.3s ease',
                    zIndex: '5',
                    border: '1px solid rgba(0,0,0,0.1)'
                });
                
                // サマリー表示のコンテンツ
                const summaryHtml = `
                    <div style="display: flex; align-items: center; justify-content: space-between; height: 100%;">
                        <div>
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 2px;">
                                📋 ${appointments.length}件の予約
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${earliestStart} - ${latestEnd} | クリックで詳細表示
                            </div>
                        </div>
                        <div style="font-size: 18px; color: #9ca3af;">
                            ▼
                        </div>
                    </div>
                `;
                
                appointmentEl.innerHTML = summaryHtml;
                
                // 詳細表示用のデータを保存
                appointmentEl._appointments = appointments;
                appointmentEl._colors = colors;
                appointmentEl._earliestStart = earliestStart;
                appointmentEl._latestEnd = latestEnd;
                appointmentEl._treatmentMenu = treatmentMenu;
                
                // クリックイベント（詳細表示切り替え）
                appointmentEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleSummaryDetail(appointmentEl);
                });
                
                startCell.appendChild(appointmentEl);
            }

            // サマリー表示の詳細切り替え
            toggleSummaryDetail(summaryEl) {
                const isExpanded = summaryEl.dataset.expanded === 'true';
                const appointments = summaryEl._appointments;
                const colors = summaryEl._colors;
                const earliestStart = summaryEl._earliestStart;
                const latestEnd = summaryEl._latestEnd;
                
                // 他の展開されているサマリーを閉じる
                if (!isExpanded) {
                    document.querySelectorAll('.appointment.summary[data-expanded="true"]').forEach(otherSummary => {
                        if (otherSummary !== summaryEl) {
                            this.toggleSummaryDetail(otherSummary);
                        }
                    });
                }
                
                if (isExpanded) {
                    // 詳細表示から要約表示に戻す
                    summaryEl.dataset.expanded = 'false';
                    summaryEl.style.height = '50px';
                    summaryEl.style.zIndex = '10';
                    
                    const summaryHtml = `
                        <div style="display: flex; align-items: center; justify-content: space-between; height: 100%;">
                            <div>
                                <div style="font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 2px;">
                                    📋 ${appointments.length}件の予約
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${earliestStart} - ${latestEnd} | クリックで詳細表示
                                </div>
                            </div>
                            <div style="font-size: 18px; color: #9ca3af;">
                                ▼
                            </div>
                        </div>
                    `;
                    summaryEl.innerHTML = summaryHtml;
                } else {
                    // 要約表示から詳細表示に展開
                    summaryEl.dataset.expanded = 'true';
                    
                    // 高さを調整
                    const detailHeight = Math.max(appointments.length * 20 + 40, 80);
                    summaryEl.style.height = `${detailHeight}px`;
                    summaryEl.style.zIndex = '50'; // 他の要素より前面に
                    
                    // 詳細表示のコンテンツ
                    let detailHtml = `
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px;">
                            <div style="font-weight: 600; font-size: 14px; color: #1f2937;">
                                📋 ${appointments.length}件の予約詳細
                            </div>
                            <div style="font-size: 18px; color: #9ca3af; cursor: pointer;">
                                ▲
                            </div>
                        </div>
                    `;
                    
                    appointments.forEach((appointment, index) => {
                        const endTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                        let displayName = this.getCompletedAppointmentDisplayName(appointment);
                        
                        detailHtml += `
                            <div style="font-size: 11px; color: #374151; margin-bottom: 2px; padding: 2px 0; cursor: pointer; border-radius: 2px; transition: background 0.2s;" 
                                 onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'" 
                                 onmouseout="this.style.backgroundColor='transparent'"
                                 onclick="event.stopPropagation(); calendar.openModal(null, null, null, null, calendar.findAppointmentById(${appointment.id}))">
                                ${appointment.patientId ? `<span style="background: ${colors.border}; color: white; padding: 1px 3px; border-radius: 2px; font-size: 10px; margin-right: 4px;">${appointment.patientId}</span>` : ''}
                                <strong>${displayName}</strong> 
                                <span style="color: #6b7280;">${appointment.startTime}-${endTime}</span>
                                <span style="color: #9ca3af;">(${appointment.nurse})</span>
                                ${appointment.device && appointment.device !== 'なし' ? `<span style="color: #6b7280; margin-left: 4px;">${appointment.device}</span>` : ''}
                            </div>
                        `;
                    });
                    
                    summaryEl.innerHTML = detailHtml;
                }
            }

            // 色を明るくするヘルパー関数
            lightenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }
            
            // モーダルを閉じる関数
            closeDailyAppointmentsModal() {
                const modal = document.getElementById('dailyAppointmentsModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // 予約件数表示は常に表示されているため復活処理は不要
            }
            
            // 1日の予約一覧を表示
            showDailyAppointmentsList(group) {
                // モーダルの作成（改善版）
                let modal = document.getElementById('dailyAppointmentsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'dailyAppointmentsModal';
                    modal.className = 'modal enhanced-modal';
                    modal.style.cssText = `
                        display: none;
                        position: fixed;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0, 0, 0, 0.6);
                        backdrop-filter: blur(3px);
                        animation: fadeIn 0.2s ease-out;
                    `;
                    
                    // 背景クリックでモーダルを閉じる
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeDailyAppointmentsModal();
                        }
                    });
                    
                    // ESCキーでモーダルを閉じる
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.style.display === 'block') {
                            this.closeDailyAppointmentsModal();
                        }
                    });
                    
                    document.body.appendChild(modal);
                }
                
                // 予約を時間順にソート
                const sortedAppointments = [...group.appointments].sort((a, b) => {
                    const timeA = a.startTime.split(':').map(Number);
                    const timeB = b.startTime.split(':').map(Number);
                    return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                });
                
                // モーダルコンテンツの作成（大幅改善版）
                modal.innerHTML = `
                    <div class="modal-content-enhanced" style="
                        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                        margin: 3% auto;
                        padding: 0;
                        border-radius: 20px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow: hidden;
                        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.2);
                        transform: translateY(-10px);
                        animation: modalSlideIn 0.3s ease-out forwards;
                        border: 2px solid ${group.treatmentMenu.borderColor}20;
                    ">
                        <!-- ヘッダー部分 -->
                        <div style="
                            background: linear-gradient(135deg, ${group.treatmentMenu.borderColor}, ${this.lightenColor(group.treatmentMenu.borderColor, 20)});
                            color: white;
                            padding: 20px 30px;
                            border-radius: 18px 18px 0 0;
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="position: absolute; top: -50%; right: -10%; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: none;"></div>
                            <div style="position: relative; z-index: 2;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 20px;">
                                        <h2 style="margin: 0; font-size: 24px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            ${group.treatmentType}
                                        </h2>
                                        <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                            📅 ${this.currentDate.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' })}
                                        </span>
                                        <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                            ${group.appointments.length}件の予約
                                        </span>
                                    </div>
                                    <button style="
                                        background: rgba(255, 255, 255, 0.2);
                                        border: 1px solid rgba(255, 255, 255, 0.3);
                                        color: white;
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        font-size: 18px;
                                        cursor: pointer;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: all 0.2s ease;
                                        backdrop-filter: blur(10px);
                                    " 
                                    onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'"
                                    onclick="calendar.closeDailyAppointmentsModal()">&times;</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- コンテンツ部分 -->
                        <div style="padding: 0; max-height: calc(90vh - 160px); overflow-y: auto; background: white;">
                            <div style="padding: 25px 30px;">
                                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">患者ID</th>
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">患者名</th>
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">サブ項目</th>
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">時間</th>
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">担当看護師</th>
                                            <th style="padding: 12px 8px; text-align: left; font-weight: 600; font-size: 14px; color: #374151;">デバイス</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedAppointments.map((appointment, index) => {
                                            const endTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                                            
                                            return `
                                                <tr style="
                                                    border-bottom: 1px solid #e2e8f0;
                                                    cursor: pointer;
                                                    transition: background-color 0.2s ease;
                                                " 
                                                onmouseover="this.style.backgroundColor='#f0f9ff'"
                                                onmouseout="this.style.backgroundColor='transparent'"
                                                onclick="calendar.openModal(null, null, null, null, calendar.findAppointmentById(${appointment.id})); calendar.closeDailyAppointmentsModal()">
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #374151;">
                                                        ${appointment.patientId || '-'}
                                                    </td>
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #374151; font-weight: 500;">
                                                        ${appointment.patientName}
                                                    </td>
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #6b7280;">
                                                        ${appointment.subItem || '-'}
                                                    </td>
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #374151;">
                                                        ${appointment.startTime} - ${endTime}(${appointment.duration}分)
                                                    </td>
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #374151;">
                                                        ${appointment.nurse || '-'}
                                                    </td>
                                                    <td style="padding: 12px 8px; font-size: 14px; color: #6b7280;">
                                                        ${appointment.device || '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                // アニメーション用CSSを追加（初回のみ）
                if (!document.getElementById('modalAnimationStyles')) {
                    const styleSheet = document.createElement('style');
                    styleSheet.id = 'modalAnimationStyles';
                    styleSheet.textContent = `
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes modalSlideIn {
                            from { 
                                opacity: 0;
                                transform: translateY(-30px) scale(0.95);
                            }
                            to { 
                                opacity: 1;
                                transform: translateY(-10px) scale(1);
                            }
                        }
                    `;
                    document.head.appendChild(styleSheet);
                }
                
                // 予約件数表示はモーダル表示時も表示し続ける
                
                // モーダルを表示
                modal.style.display = 'block';
                bringToFront(modal);
                
                // 背景クリックで閉じる
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            renderAppointment(appointment) {
                if (!appointment || !appointment.treatmentType || !appointment.date || !appointment.startTime) {
                    console.warn('無効な予約データ:', appointment);
                    return;
                }

                // 施術メニューのインデックスを取得（現在の並び順を反映）
                const treatmentIndex = this.treatmentMenus.findIndex(t => t.name === appointment.treatmentType);
                if (treatmentIndex === -1) {
                    console.warn('施術メニューが見つかりません:', appointment.treatmentType);
                    return;
                }

                // 開始時間に対応するセルを取得（サブ項目対応）
                let startCell = null;
                const [hour, minute] = appointment.startTime.split(':').map(Number);
                const roundedMinute = Math.floor(minute / 5) * 5;
                const roundedTime = `${hour.toString().padStart(2, '0')}:${roundedMinute.toString().padStart(2, '0')}`;
                
                const selectedTreatmentMenu = this.treatmentMenus[treatmentIndex];
                
                // サブ項目がある場合の処理
                if (appointment.subItem && selectedTreatmentMenu.isExpanded && selectedTreatmentMenu.subItems) {
                    // サブ項目のセルを探す
                    const subItemCells = document.querySelectorAll(`.sub-item-cell[data-treatment="${appointment.treatmentType}"][data-sub-item="${appointment.subItem}"][data-time="${roundedTime}"][data-date="${appointment.date}"]`);
                    if (subItemCells.length > 0) {
                        startCell = subItemCells[0];
                        console.log(`✅ サブ項目セル見つかりました: ${appointment.treatmentType} - ${appointment.subItem}`);
                    } else {
                        console.warn(`❌ サブ項目セルが見つかりません: ${appointment.treatmentType} - ${appointment.subItem} at ${roundedTime}`);
                        // フィルタリングモードの場合、セルが存在しない可能性があるのでメインセルにフォールバック
                    }
                }
                
                // サブ項目セルが見つからない場合、メインセルを使用
                if (!startCell) {
                    const timeRows = document.querySelectorAll(`.appointment-cell[data-treatment="${appointment.treatmentType}"][data-time="${roundedTime}"][data-date="${appointment.date}"]`);
                    // メインセル（sub-item-cellクラスがないもの）を探す
                    for (let cell of timeRows) {
                        if (!cell.classList.contains('sub-item-cell')) {
                            startCell = cell;
                            break;
                        }
                    }
                }
                
                if (!startCell) {
                    console.warn('セルが見つかりません:', appointment);
                    return;
                }

                const appointmentEl = document.createElement('div');
                appointmentEl.className = `appointment`;
                appointmentEl.dataset.appointmentId = appointment.id;
                appointmentEl.dataset.treatment = appointment.treatmentType;
                appointmentEl.dataset.date = appointment.date;
                appointmentEl.dataset.duration = appointment.duration; // 印刷用CSS用に追加
                
                // 過去の予約かどうかを判定
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const appointmentDate = new Date(appointment.date);
                appointmentDate.setHours(0, 0, 0, 0);
                
                if (appointmentDate < today) {
                    appointmentEl.classList.add('past-appointment');
                }
                
                // 位置とサイズ計算
                const position = this.calculateExactPosition(appointment);
                
                // 【改良版】動的カラー設定（現在の並び順を反映）
                const treatmentMenu = this.treatmentMenus.find(t => t.name === appointment.treatmentType);
                const colors = treatmentMenu 
                    ? { bg: treatmentMenu.color, border: treatmentMenu.borderColor }
                    : { bg: '#f3f4f6', border: '#9ca3af' }; // デフォルトカラー
                
                // スタイル設定
                Object.assign(appointmentEl.style, {
                    position: 'absolute',
                    top: `${position.top}px`,
                    height: `${position.height}px`,
                    left: '2px',
                    right: '2px',
                    backgroundColor: colors.bg,
                    borderLeft: `4px solid ${colors.border}`,
                    borderRadius: '4px',
                    padding: '2px 4px',
                    cursor: 'pointer',
                    overflow: 'hidden',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                    zIndex: '5'
                });
                
                // ホバー効果
                appointmentEl.addEventListener('mouseenter', () => {
                    appointmentEl.style.transform = 'translateX(2px)';
                    appointmentEl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
                });
                
                appointmentEl.addEventListener('mouseleave', () => {
                    appointmentEl.style.transform = 'translateX(0)';
                    appointmentEl.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                });

                const endTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                
                
                // コンテンツ設定（サブ項目対応 - 患者ID・氏名を別行表示）
                let contentHtml = '';
                
                // 患者マークを取得
                const patientMarks = this.getPatientMarks(appointment.patientId);
                const marksHtml = this.generatePatientMarksHtml(patientMarks);
                
                // 患者IDと患者名を別行で表示
                contentHtml = `
                    ${appointment.patientId ? `<div style="font-size: 12px; color: #6b7280; text-align: left; margin-bottom: 2px;">
                        <span style="background: ${colors.border}; color: white; padding: 1px 4px; border-radius: 2px; font-size: 11px;">${appointment.patientId}</span>
                        ${marksHtml}
                    </div>` : ''}
                    <div style="font-weight: 600; font-size: 15px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left;">
                        ${appointment.patientName}
                    </div>`;
                
                appointmentEl.innerHTML = contentHtml + `
                    <div style="font-size: 12px; color: #6b7280; text-align: left; margin-top: 1px;">${appointment.nurse}</div>
                    <div style="font-size: 12px; color: #6b7280; text-align: left;">${appointment.startTime}-${endTime}</div>
                    <div style="font-size: 11px; color: #9ca3af; text-align: left;">(${appointment.duration}分)</div>
                    ${appointment.device && appointment.device !== 'なし' ? `<div style="font-size: 11px; color: #6b7280; text-align: left;">${appointment.device}</div>` : ''}
                    ${appointment.comment ? `<div style="font-size: 11px; color: #2563eb; text-align: left; margin-top: 2px; line-height: 1.3;">
                        <span style="margin-right: 2px;">📝</span>${appointment.comment}
                    </div>` : ''}
                `;

                // クリックイベント
                appointmentEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.openModal(null, null, null, null, appointment);
                });

                // セルに追加
                startCell.appendChild(appointmentEl);
            }

            calculateExactPosition(appointment) {
                // 【デバッグ強化版】予約位置と高さの詳細ログ
                
                console.log('🔍 予約詳細分析開始:', appointment.patientName, appointment.startTime, appointment.duration + '分');
                
                // 時間軸データと同じ方法でピクセル/分を取得
                const timeAxisData = this.calculateTimeAxisData();
                const pixelsPerMinute = timeAxisData.pixelsPerMinute;
                
                // 予約開始時間の5分単位への丸め（セル特定用）
                const [hour, minute] = appointment.startTime.split(':').map(Number);
                const roundedMinute = Math.floor(minute / 5) * 5;
                
                // セル内でのオフセット計算
                const minuteOffsetInCell = minute - roundedMinute;
                const pixelOffsetInCell = minuteOffsetInCell * pixelsPerMinute;
                
                // 高さ計算（実際のDOM配置と同じ測定方法を使用）
                const height = appointment.duration * pixelsPerMinute;
                
                // 視認性向上のため、予約ブロックの下辺を2px高い位置で終わらせる
                const finalHeight = Math.max(Math.round(height) - 2, 20);
                
                console.log('📊 計算結果詳細:', {
                    '開始時間': `${hour}:${minute.toString().padStart(2, '0')}`,
                    '丸められた時間': `${hour}:${roundedMinute.toString().padStart(2, '0')}`,
                    'セル内オフセット': minuteOffsetInCell + '分',
                    'ピクセル/分': pixelsPerMinute + 'px',
                    'セル内位置': pixelOffsetInCell + 'px',
                    '所要時間': appointment.duration + '分',
                    '生の計算高さ': height + 'px',
                    '丸め後高さ': Math.round(height) + 'px',
                    '最終高さ': finalHeight + 'px',
                    '期待される終了時間': `${hour}:${(minute + appointment.duration) % 60 < 10 ? '0' : ''}${(minute + appointment.duration) % 60}`
                });
                
                // 実際のセル高さも測定
                const targetCellTime = `${hour}:${roundedMinute.toString().padStart(2, '0')}`;
                const targetCell = document.querySelector(`[data-time="${targetCellTime}"]`);
                if (targetCell) {
                    const cellRect = targetCell.getBoundingClientRect();
                    console.log('🎯 対象セル測定:', {
                        'セル時間': targetCellTime,
                        'セル高さ': cellRect.height + 'px',
                        'セルtop': cellRect.top + 'px'
                    });
                }
                
                return {
                    top: Math.round(pixelOffsetInCell),
                    height: finalHeight
                };
            }
            
            // 【視覚的位置統一版】getBoundingClientRectで測定
            calculateTimeAxisData() {
                try {
                    // 11:00と14:00セルの画面上の位置を使用（180分=3時間）
                    const cell1100 = document.querySelector('[data-time="11:00"]');
                    const cell1400 = document.querySelector('[data-time="14:00"]');
                    
                    if (!cell1100 || !cell1400) {
                        console.warn('基準セルが見つかりません - デフォルト値使用');
                        return { baseOffset: 0, pixelsPerMinute: 6 };
                    }
                    
                    // 画面上での視覚的距離を測定
                    const rect1100 = cell1100.getBoundingClientRect();
                    const rect1400 = cell1400.getBoundingClientRect();
                    const actualDistance = rect1400.top - rect1100.top;
                    const minutesBetween = 180; // 11:00から14:00まで180分
                    const pixelsPerMinute = actualDistance / minutesBetween;
                    
                    console.log('📏 視覚的位置統一版測定結果:', {
                        '11:00の画面位置': rect1100.top + 'px',
                        '14:00の画面位置': rect1400.top + 'px',
                        '視覚的距離': actualDistance + 'px',
                        '分数': minutesBetween + '分',
                        '視覚的ピクセル/分': pixelsPerMinute + 'px'
                    });
                    
                    return {
                        baseOffset: rect1100.top,
                        pixelsPerMinute: pixelsPerMinute
                    };
                    
                } catch (error) {
                    console.error('時間軸測定エラー:', error);
                    return { baseOffset: 0, pixelsPerMinute: 6 };
                }
            }
            
            generateTimeSlots() {
                // 時間軸生成と同じロジックで時間スロットを生成
                const timeSlots = [];
                for (let hour = 11; hour <= 20; hour++) {
                    for (let minute = 0; minute < 60; minute += 5) {
                        if (hour === 20 && minute > 0) break;
                        timeSlots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                    }
                }
                return timeSlots;
            }
            
            // 【新規追加】既存予約ブロックの位置を強制的に更新
            forceUpdateAllAppointmentPositions() {
                console.log('🔄 === 既存予約の位置を強制更新開始 ===');
                
                // 現在表示されているすべての予約ブロックを取得
                const appointmentElements = document.querySelectorAll('.appointment');
                
                if (appointmentElements.length === 0) {
                    console.log('⚠️ 表示されている予約がありません');
                    return;
                }
                
                console.log(`📊 ${appointmentElements.length}個の予約を更新します`);
                
                // 各予約ブロックの位置を更新
                appointmentElements.forEach(element => {
                    const appointmentId = parseInt(element.dataset.appointmentId);
                    const appointment = this.appointments.find(apt => apt.id === appointmentId);
                    
                    if (appointment) {
                        // 新しい計算式で位置を再計算
                        const newPosition = this.calculateExactPosition(appointment);
                        const oldTop = element.style.top;
                        
                        // DOM要素の位置を直接更新
                        element.style.top = `${newPosition.top}px`;
                        element.style.height = `${newPosition.height}px`;
                        
                        // デバッグ情報を出力
                        console.log(`✅ ${appointment.patientName}: ${appointment.startTime}`, {
                            '旧位置': oldTop,
                            '新位置': `${newPosition.top}px`,
                            '移動量': `${newPosition.top - parseInt(oldTop)}px`,
                            '予約時間': `${appointment.startTime} (${appointment.duration}分)`,
                            '計算詳細': {
                                '基準時間からの分数': ((parseInt(appointment.startTime.split(':')[0]) - 11) * 60 + parseInt(appointment.startTime.split(':')[1])),
                                '1分あたりのピクセル': 6,
                                '計算結果': newPosition.top
                            }
                        });
                    } else {
                        console.warn(`⚠️ 予約ID ${appointmentId} のデータが見つかりません`);
                    }
                });
                
                console.log('🎉 === 強制更新完了 ===');
                
                // 位置更新後の検証
                this.validateAllAppointmentPositions();
            }
            
            // 【新規追加】全予約の位置を検証
            validateAllAppointmentPositions() {
                console.log('🔍 === 予約位置の検証開始 ===');
                
                const errors = [];
                this.appointments.forEach(appointment => {
                    if (appointment.date === this.currentDate.toISOString().split('T')[0]) {
                        const element = document.querySelector(`[data-appointment-id="${appointment.id}"]`);
                        if (element) {
                            const expectedPosition = this.calculateExactPosition(appointment);
                            const actualTop = parseInt(element.style.top);
                            
                            if (actualTop !== expectedPosition.top) {
                                errors.push({
                                    患者名: appointment.patientName,
                                    予約時間: appointment.startTime,
                                    期待位置: expectedPosition.top,
                                    実際位置: actualTop,
                                    差分: actualTop - expectedPosition.top
                                });
                            }
                        }
                    }
                });
                
                if (errors.length > 0) {
                    console.error('❌ 位置エラーが見つかりました:', errors);
                } else {
                    console.log('✅ すべての予約が正しい位置に配置されています');
                }
                
                console.log('🔍 === 検証完了 ===');
            }
            

            synchronizedRender(context = '', appointmentId = null) {
                // 時間と表示位置を完全に同期し、予約消失を防ぐ安全な再描画
                try {
                    console.log('🔄 同期再描画開始:', context, appointmentId ? `(ID: ${appointmentId})` : '');
                    
                    // 予約消失防止の準備
                    const lossProtection = this.preventAppointmentLoss();
                    
                    // 特定の予約がある場合、その予約の整合性を確認
                    if (appointmentId) {
                        const appointment = this.appointments.find(apt => apt.id === appointmentId);
                        if (appointment) {
                            const endTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                            console.log('📋 予約データ確認:', {
                                ID: appointmentId,
                                患者名: appointment.patientName,
                                開始時間: appointment.startTime,
                                終了時間: endTime,
                                施術タイプ: appointment.treatmentType,
                                施術時間: appointment.duration + '分'
                            });
                        } else {
                            console.warn('⚠️ 指定された予約が見つかりません:', appointmentId);
                        }
                    }
                    
                    // 全体を再描画
                    this.render();
                    
                    // 予約消失チェック
                    if (!lossProtection.validateAfterRender()) {
                        console.error('🚨 再描画で予約が消失しました - 復旧を試行');
                        // 必要に応じて復旧処理を追加
                    }
                    
                    // 再描画後の検証
                    if (appointmentId) {
                        setTimeout(() => {
                            const renderedElement = document.querySelector(`[data-appointment-id="${appointmentId}"]`);
                            if (renderedElement) {
                                const appointment = this.appointments.find(apt => apt.id === appointmentId);
                                if (appointment) {
                                    const calculatedPosition = this.calculateExactPosition(appointment);
                                    const positionMatch = renderedElement.style.top === calculatedPosition.top + 'px';
                                    console.log('✅ 再描画後検証:', {
                                        予約ID: appointmentId,
                                        DOM位置: renderedElement.style.top,
                                        計算位置: calculatedPosition.top + 'px',
                                        表示時間: appointment.startTime,
                                        位置一致: positionMatch
                                    });
                                    
                                    // 【強化】位置が不一致の場合、即座に修正
                                    if (!positionMatch) {
                                        console.log('🔧 位置不一致を検出 - 即座に修正中...');
                                        renderedElement.style.top = calculatedPosition.top + 'px';
                                        renderedElement.style.height = calculatedPosition.height + 'px';
                                        
                                        // 修正後の検証
                                        const correctedMatch = renderedElement.style.top === calculatedPosition.top + 'px';
                                        console.log('✅ 位置修正完了:', correctedMatch ? '成功' : '失敗');
                                    }
                                }
                            } else {
                                console.error('❌ 再描画後に要素が見つからない:', appointmentId);
                                // 要素が見つからない場合の復旧処理
                                const appointment = this.appointments.find(apt => apt.id === appointmentId);
                                if (appointment) {
                                    console.log('🔧 要素復旧を試行中...');
                                    this.renderAppointments();
                                }
                            }
                        }, 50); // 短時間待機してDOMが更新されるのを待つ
                    }
                    
                    console.log('✅ 同期再描画完了:', context);
                } catch (error) {
                    console.error('💥 同期再描画エラー:', context, error);
                    // フォールバック: 最小限の描画
                    try {
                        this.renderAppointments();
                        console.log('🔧 フォールバック描画完了');
                    } catch (fallbackError) {
                        console.error('💀 フォールバック描画も失敗:', fallbackError);
                    }
                }
            }
            

            calculateEndTime(startTime, duration) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + duration;
                const endHours = Math.floor(totalMinutes / 60);
                const endMinutes = totalMinutes % 60;
                return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
            }

            getFilteredAppointments() {
                // チェックボックスから選択された看護師を取得
                const selectedNurses = [];
                const nurseCheckboxes = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]:checked');
                nurseCheckboxes.forEach(checkbox => {
                    selectedNurses.push(checkbox.value);
                });
                
                // チェックボックスから選択されたデバイスを取得
                const selectedDevices = [];
                const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked');
                deviceCheckboxes.forEach(checkbox => {
                    selectedDevices.push(checkbox.value);
                });
                
                // 「全員」「全て」がチェックされている場合はフィルターしない
                const allNursesElement = document.getElementById('allNurses');
                const allDevicesElement = document.getElementById('allDevices');
                const allNursesChecked = allNursesElement ? allNursesElement.checked : true;
                const allDevicesChecked = allDevicesElement ? allDevicesElement.checked : true;

                // デバッグログ
                console.log('🔍 フィルター状態:', {
                    '選択された看護師': selectedNurses,
                    '選択されたデバイス': selectedDevices,
                    '全員チェック': allNursesChecked,
                    '全てチェック': allDevicesChecked
                });

                // アクティブ予約のみを使用（完了済み予約も含まれている）
                // completedAppointmentsはスナップショット用で、重複表示を避ける
                
                return this.appointments.filter(appointment => {
                    // 看護師フィルタリング: 「全員」がチェックされているか、選択された看護師に含まれる場合のみ表示
                    let nurseMatch;
                    if (allNursesChecked) {
                        nurseMatch = true;
                    } else if (selectedNurses.length === 0) {
                        // 何も選択されていない場合は何も表示しない
                        nurseMatch = false;
                    } else {
                        nurseMatch = selectedNurses.includes(appointment.nurse || '');
                    }
                    
                    // デバイスフィルタリング: 「全て」がチェックされているか、選択されたデバイスに含まれる場合のみ表示
                    let deviceMatch;
                    if (allDevicesChecked) {
                        deviceMatch = true;
                    } else if (selectedDevices.length === 0) {
                        // 何も選択されていない場合は何も表示しない
                        deviceMatch = false;
                    } else {
                        const appointmentDevice = appointment.device || '';
                        // 予約にデバイスが設定されている場合は直接マッチング
                        if (appointmentDevice) {
                            deviceMatch = selectedDevices.includes(appointmentDevice);
                        } else {
                            // 予約にデバイスが設定されていない場合は「なし」が選択されているかチェック
                            deviceMatch = selectedDevices.includes('なし');
                        }
                    }
                    
                    return nurseMatch && deviceMatch;
                });
            }


            
            
            safeUpdateAppointment(appointment, newData) {
                // 予約データの安全な更新と時間同期検証
                try {
                    if (!appointment || !appointment.id) {
                        return { success: false, error: '予約オブジェクトが無効です' };
                    }
                    
                    // データ検証
                    if (!newData.treatmentType || !newData.startTime || !newData.date) {
                        return { success: false, error: '更新データが不完全です' };
                    }
                    
                    // 施術タイプの検証
                    if (!this.treatments.includes(newData.treatmentType)) {
                        return { success: false, error: '無効な施術タイプです: ' + newData.treatmentType };
                    }
                    
                    // 時間形式の検証
                    const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
                    if (!timeRegex.test(newData.startTime)) {
                        return { success: false, error: '無効な時間形式です: ' + newData.startTime };
                    }
                    
                    // 時間範囲の検証（営業時間内）
                    const [hour, minute] = newData.startTime.split(':').map(Number);
                    const timeInMinutes = hour * 60 + minute;
                    const startTime = 11 * 60; // 11:00
                    const endTime = 20 * 60;   // 20:00
                    
                    if (timeInMinutes < startTime || timeInMinutes >= endTime) {
                        return { success: false, error: `営業時間外です (11:00-20:00): ${newData.startTime}` };
                    }
                    
                    // 終了時間が営業時間を超えないかチェック
                    const endTimeInMinutes = timeInMinutes + appointment.duration;
                    if (endTimeInMinutes > endTime) {
                        return { success: false, error: `施術終了時間が営業時間を超えます` };
                    }
                    
                    // 更新前の状態を記録
                    const oldData = {
                        treatmentType: appointment.treatmentType,
                        startTime: appointment.startTime,
                        date: appointment.date
                    };
                    
                    // データ更新実行
                    appointment.treatmentType = newData.treatmentType;
                    appointment.startTime = newData.startTime;
                    appointment.date = newData.date;
                    
                    // 終了時間の計算と検証
                    const calculatedEndTime = this.calculateEndTime(appointment.startTime, appointment.duration);
                    
                    console.log('📝 予約データ更新完了:', {
                        ID: appointment.id,
                        患者名: appointment.patientName,
                        更新前: oldData,
                        更新後: newData,
                        終了時間: calculatedEndTime,
                        施術時間: appointment.duration + '分'
                    });
                    
                    return { success: true, oldData: oldData };
                    
                } catch (error) {
                    console.error('予約データ更新エラー:', error);
                    return { success: false, error: error.message };
                }
            }
            
            restoreAppointmentState(appointment, originalState) {
                // 予約の状態を元に戻す
                try {
                    appointment.treatmentType = originalState.treatmentType;
                    appointment.startTime = originalState.startTime;
                    appointment.date = originalState.date;
                    
                    console.log('🔄 予約状態復元完了:', {
                        ID: appointment.id,
                        復元データ: originalState
                    });
                } catch (error) {
                    console.error('予約状態復元エラー:', error);
                }
            }
            
            
            safeRender(context = '') {
                // 安全な再描画処理（後方互換性のため保持）
                try {
                    console.log('🔄 安全な再描画開始:', context);
                    this.render();
                    console.log('✅ 再描画完了:', context);
                } catch (error) {
                    console.error('💥 再描画エラー:', context, error);
                    // 再描画に失敗した場合は最低限の表示復旧を試行
                    try {
                        this.renderAppointments();
                        console.log('🔧 最小限の表示復旧完了');
                    } catch (fallbackError) {
                        console.error('💀 表示復旧も失敗:', fallbackError);
                    }
                }
            }

            preventAppointmentLoss() {
                // 予約消失を防ぐ保護機能
                const beforeRenderIds = new Set(this.appointments.map(apt => apt.id));
                
                return {
                    beforeRender: beforeRenderIds,
                    validateAfterRender: () => {
                        const afterRenderIds = new Set(this.appointments.map(apt => apt.id));
                        const lostIds = [...beforeRenderIds].filter(id => !afterRenderIds.has(id));
                        
                        if (lostIds.length > 0) {
                            console.error('🚨 予約消失検出:', lostIds);
                            return false;
                        }
                        return true;
                    }
                }
            }

            createDropTransaction(appointment, newData) {
                // ドロップ処理のトランザクション管理
                const transactionId = Date.now() + '_' + appointment.id;
                const originalState = {
                    treatmentType: appointment.treatmentType,
                    startTime: appointment.startTime,
                    date: appointment.date,
                    id: appointment.id
                };
                
                console.log('💾 ドロップトランザクション開始:', {
                    トランザクションID: transactionId,
                    予約ID: appointment.id,
                    患者名: appointment.patientName,
                    元の状態: originalState,
                    新しい状態: newData
                });
                
                return {
                    transactionId,
                    originalState,
                    commit: (callback) => {
                        try {
                            const result = callback();
                            if (result.success) {
                                console.log('✅ トランザクション成功:', transactionId);
                                return { success: true, result };
                            } else {
                                console.log('❌ トランザクション失敗 - ロールバック:', transactionId);
                                this.restoreAppointmentState(appointment, originalState);
                                return { success: false, error: result.error };
                            }
                        } catch (error) {
                            console.error('💥 トランザクションエラー - ロールバック:', transactionId, error);
                            this.restoreAppointmentState(appointment, originalState);
                            return { success: false, error: error.message };
                        }
                    }
                };
            }

            validateDropTarget(cell, appointment) {
                // ドロップ先の妥当性を総合的に検証
                const targetTreatment = cell.dataset.treatment;
                const targetDate = cell.dataset.date;
                
                console.log('🔍 ドロップ先検証:', {
                    予約ID: appointment.id,
                    対象施術タイプ: targetTreatment,
                    対象日付: targetDate
                });
                
                // 基本データの存在確認
                if (!targetTreatment || !targetDate) {
                    return { 
                        valid: false, 
                        error: 'ドロップ先のデータが不完全です',
                        details: { targetTreatment, targetDate }
                    };
                }
                
                // 施術タイプの妥当性確認
                if (!this.treatments.includes(targetTreatment)) {
                    return { 
                        valid: false, 
                        error: '無効な施術タイプです: ' + targetTreatment,
                        details: { targetTreatment }
                    };
                }
                
                // 日付の妥当性確認
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!dateRegex.test(targetDate)) {
                    return { 
                        valid: false, 
                        error: '無効な日付形式です: ' + targetDate,
                        details: { targetDate }
                    };
                }
                
                console.log('✅ ドロップ先検証通過');
                return { 
                    valid: true, 
                    targetTreatment, 
                    targetDate 
                };
            }

            debugDropOperation(phase, data) {
                // デバッグ情報の詳細出力
                const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
                const debugInfo = {
                    タイムスタンプ: timestamp,
                    フェーズ: phase,
                    データ: data,
                    予約総数: this.appointments.length,
                    DOM要素数: document.querySelectorAll('.appointment').length
                };
                
                console.log(`🐛 [${phase}] デバッグ情報:`, debugInfo);
                
                // 重要なフェーズでは追加の検証
                if (phase === 'ドロップ完了' || phase === 'エラー発生') {
                    this.validateSystemIntegrity();
                }
                
                return debugInfo;
            }

            validateSystemIntegrity() {
                // システム整合性の検証
                try {
                    const appointmentIds = this.appointments.map(apt => apt.id);
                    const domElements = document.querySelectorAll('.appointment');
                    const domIds = Array.from(domElements).map(el => parseInt(el.dataset.appointmentId));
                    
                    const missingInDom = appointmentIds.filter(id => !domIds.includes(id));
                    const extraInDom = domIds.filter(id => !appointmentIds.includes(id));
                    
                    const integrityReport = {
                        予約データ数: appointmentIds.length,
                        DOM要素数: domIds.length,
                        DOM未表示予約: missingInDom,
                        余分なDOM要素: extraInDom,
                        整合性: missingInDom.length === 0 && extraInDom.length === 0
                    };
                    
                    console.log('🔍 システム整合性検証:', integrityReport);
                    
                    if (!integrityReport.整合性) {
                        console.warn('⚠️ システム整合性に問題があります:', integrityReport);
                    }
                    
                    return integrityReport;
                } catch (error) {
                    console.error('💥 整合性検証エラー:', error);
                    return { error: error.message };
                }
            }

            trackDropFailure(reason, context) {
                // ドロップ失敗の追跡
                const failureInfo = {
                    時刻: new Date().toISOString(),
                    理由: reason,
                    コンテキスト: context,
                    予約状態: this.appointments.map(apt => ({
                        id: apt.id,
                        患者名: apt.patientName,
                        時間: apt.startTime,
                        施術: apt.treatmentType
                    }))
                };
                
                console.error('🚫 ドロップ失敗追跡:', failureInfo);
                
                // 失敗パターンの分析（実装されている場合）
                this.analyzeFailurePattern(failureInfo);
                
                return failureInfo;
            }

            analyzeFailurePattern(failureInfo) {
                // 失敗パターンの分析（基本実装）
                if (!this.failureHistory) {
                    this.failureHistory = [];
                }
                
                this.failureHistory.push(failureInfo);
                
                // 最新5件の失敗を保持
                if (this.failureHistory.length > 5) {
                    this.failureHistory = this.failureHistory.slice(-5);
                }
                
                console.log('📊 失敗履歴分析:', {
                    総失敗回数: this.failureHistory.length,
                    最新の失敗理由: this.failureHistory.map(f => f.理由)
                });
            }

            // ====================
            // 🎮 コンソール制御機能
            // ====================
            
            enableDebugMode() {
                this.debugMode = true;
                console.log('🐛 デバッグモード: 有効');
                window.debugDrop = true;
            }
            
            disableDebugMode() {
                this.debugMode = false;
                console.log('🔇 デバッグモード: 無効');
                window.debugDrop = false;
            }
            
            showDropStatistics() {
                // ドロップ統計情報を表示
                console.log('📊 ドロップ統計:', {
                    予約総数: this.appointments.length,
                    失敗履歴数: this.failureHistory.length,
                    デバッグモード: this.debugMode,
                    DOM整合性: this.validateSystemIntegrity()
                });
            }
            
            testDropIntegrity() {
                // ドロップ機能の整合性テスト
                console.log('🧪 ドロップ機能テスト開始...');
                const integrity = this.validateSystemIntegrity();
                console.log('✅ テスト完了:', integrity);
                return integrity;
            }

            forceRender() {
                // 【緊急修正】強制的な表示処理
                console.log('🔥 強制表示開始');
                try {
                    // DOM要素の存在確認
                    const scheduleBody = document.getElementById('scheduleBody');
                    const dateText = document.getElementById('dateText');
                    
                    if (!scheduleBody) {
                        throw new Error('scheduleBody要素が見つかりません');
                    }
                    if (!dateText) {
                        throw new Error('dateText要素が見つかりません');
                    }
                    
                    console.log('✓ 必要なDOM要素を確認');
                    
                    // 日付表示の強制更新
                    this.updateCurrentDateDisplay();
                    console.log('✓ 日付表示更新完了');
                    
                    // 時間軸の強制生成
                    this.renderScheduleTable();
                    console.log('✓ スケジュールテーブル生成完了');
                    
                    // 予約データの強制表示
                    this.renderAppointments();
                    console.log('✓ 予約データ表示完了');
                    
                    // 表示確認
                    const rowCount = scheduleBody.children.length;
                    const appointmentCount = document.querySelectorAll('.appointment').length;
                    
                    console.log('📊 表示結果:', {
                        時間行数: rowCount,
                        予約表示数: appointmentCount,
                        予約データ数: this.appointments.length
                    });
                    
                    if (rowCount === 0) {
                        throw new Error('時間行が生成されていません');
                    }
                    
                    console.log('🎉 強制表示成功！');
                    
                } catch (error) {
                    console.error('💥 強制表示失敗:', error);
                    this.emergencyFallback();
                }
            }

            emergencyFallback() {
                // 緊急時のフォールバック処理
                console.log('🆘 緊急フォールバック実行');
                const scheduleBody = document.getElementById('scheduleBody');
                
                if (scheduleBody) {
                    // 最低限の時間軸を直接HTML挿入
                    let htmlContent = '';
                    for (let hour = 11; hour <= 20; hour++) {
                        for (let minute = 0; minute < 60; minute += 5) {
                            if (hour === 20 && minute > 0) break;
                            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                            htmlContent += `
                                <tr>
                                    <td class="time-cell">${timeString}</td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                    <td class="appointment-cell" style="height:30px;border:1px solid #ddd;position:relative;"></td>
                                </tr>
                            `;
                        }
                    }
                    scheduleBody.innerHTML = htmlContent;
                    console.log('✅ 緊急時間軸生成完了');
                }
            }

            checkTimeConflict(appointmentId, treatmentType, date, startTime, duration, subItem = null) {
                const otherAppointments = this.appointments.filter(apt => apt.id !== appointmentId);
                
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const startTotalMinutes = startHour * 60 + startMinute;
                const endTotalMinutes = startTotalMinutes + duration;
                
                return otherAppointments.filter(apt => {
                    if (apt.treatmentType !== treatmentType || apt.date !== date) {
                        return false;
                    }
                    
                    // サブ項目が異なる場合は重複を許可
                    if (apt.subItem !== subItem) {
                        return false;
                    }
                    
                    const [aptStartHour, aptStartMinute] = apt.startTime.split(':').map(Number);
                    const aptStartTotalMinutes = aptStartHour * 60 + aptStartMinute;
                    const aptEndTotalMinutes = aptStartTotalMinutes + apt.duration;
                    
                    return !(endTotalMinutes <= aptStartTotalMinutes || startTotalMinutes >= aptEndTotalMinutes);
                });
            }

            showConflictMessage(conflicts) {
                const conflictNames = conflicts.map(apt => 
                    `${apt.patientName} (${apt.startTime}-${this.calculateEndTime(apt.startTime, apt.duration)})`
                ).join(', ');
                
                alert(`この時間帯は他の予約と重複しています:\n${conflictNames}`);
            }

            // 完了済み予約かどうかを判定する関数（昨日以前は完了扱い）
            isCompletedAppointment(appointmentDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const apptDate = new Date(appointmentDate);
                apptDate.setHours(0, 0, 0, 0);
                return apptDate < today;
            }

            // 予約IDで予約を検索する関数（完了予約も含む）
            findAppointmentById(appointmentId) {
                // アクティブ予約から検索
                let appointment = this.appointments.find(apt => apt.id === appointmentId);
                if (appointment) return appointment;
                
                // 完了予約から検索
                appointment = this.completedAppointments.find(apt => apt.id === appointmentId || apt.originalId === appointmentId);
                return appointment;
            }

            // 完了予約の表示名を取得する関数（削除済みマスターデータに対応）
            getCompletedAppointmentDisplayName(appointment) {
                let displayName = appointment.patientName;
                
                // 完了予約（スナップショット）の場合のみ削除済みチェックを実行
                if (appointment.snapshotDate) {
                    // 看護師マスターデータが削除されているかチェック
                    const nurseExists = appointment.nurse && this.nurses.some(nurse => nurse.name === appointment.nurse);
                    if (appointment.nurse && !nurseExists) {
                        displayName += " (削除済)";
                    }
                    
                    // 施術メニューマスターデータが削除されているかチェック
                    const treatmentExists = appointment.treatmentType && 
                        this.treatmentMenus.some(menu => menu.name === appointment.treatmentType);
                    if (appointment.treatmentType && !treatmentExists) {
                        displayName += " (削除済)";
                    }
                    
                    // デバイスマスターデータが削除されているかチェック
                    const deviceExists = appointment.device && this.devices.includes(appointment.device);
                    if (appointment.device && !deviceExists) {
                        displayName += " (削除済)";
                    }
                }
                
                return displayName;
            }

            // 自動スナップショット作成機能
            createAutomaticSnapshots() {
                console.log('🔄 自動スナップショット作成開始');
                
                const completedAppointments = this.appointments.filter(apt => 
                    this.isCompletedAppointment(apt.date)
                );
                
                if (completedAppointments.length === 0) {
                    console.log('📄 完了済み予約なし - スナップショット作成不要');
                    return;
                }
                
                console.log(`📄 ${completedAppointments.length}件の完了済み予約を発見`);
                
                // 完了済み予約をスナップショットに保存（削除はしない）
                completedAppointments.forEach(appointment => {
                    // スナップショット作成時の情報を記録
                    const snapshot = {
                        ...appointment,
                        snapshotDate: new Date().toISOString(),
                        originalId: appointment.id
                    };
                    
                    // 既にスナップショットに存在しないか確認
                    const exists = this.completedAppointments.some(snap => 
                        snap.originalId === appointment.id
                    );
                    
                    if (!exists) {
                        this.completedAppointments.push(snapshot);
                        console.log(`📸 スナップショット作成: ${appointment.patientName} (${appointment.date})`);
                    }
                });
                
                // 注意：完了済み予約はアクティブリストから削除しない（過去日付の表示のため）
                
                console.log('✅ 自動スナップショット作成完了');
            }

            openModal(date = null, time = null, treatment = null, subItem = null, appointment = null) {
                // 予約件数表示はモーダル表示時も表示し続ける
                
                const modal = document.getElementById('appointmentModal');
                bringToFront(modal); // モーダルを最前面に
                const modalTitle = document.getElementById('modalTitle');
                const deleteBtn = document.getElementById('deleteBtn');
                const saveBtn = document.getElementById('saveBtn');
                const showSearchBtn = document.getElementById('showSearchBtn');
                const searchSuggestionContainer = document.getElementById('searchSuggestionContainer');
                
                if (appointment) {
                    // 予約編集モード - クリック式編集対応
                    modalTitle.textContent = `予約編集 - ${appointment.patientName}`;
                    deleteBtn.style.display = 'inline-block';
                    showSearchBtn.style.display = 'none'; // 編集時は検索ボタンを隠す
                    searchSuggestionContainer.style.display = 'none'; // 編集時は検索コンテナを隠す
                    document.getElementById('searchInstructionText').style.display = 'none'; // 編集時は時間枠検索の説明テキストを隠す
                    this.currentEditingId = appointment.id;
                    
                    // 完了済み予約の判定（スナップショット化も考慮）
                    const isCompleted = this.isCompletedAppointment(appointment.date) || appointment.snapshotDate;
                    saveBtn.style.display = isCompleted ? 'none' : 'inline-block';
                    
                    if (isCompleted) {
                        const displayName = this.getCompletedAppointmentDisplayName(appointment);
                        modalTitle.textContent = `施術履歴 - ${displayName} (完了済み)`;
                    }
                    
                    // 完了済み予約の場合は間隔表示を非表示
                    const intervalInfo = document.getElementById('intervalInfo');
                    if (intervalInfo) {
                        intervalInfo.style.display = isCompleted ? 'none' : 'block';
                    }
                    
                    this.populateForm(appointment, isCompleted);
                    
                    // 編集時の追加情報表示
                    console.log('📝 クリック編集開始:', {
                        患者名: appointment.patientName,
                        現在時間: appointment.startTime,
                        現在施術: appointment.treatmentType,
                        現在看護師: appointment.nurse
                    });
                } else {
                    // 新規予約モード
                    modalTitle.textContent = '新規予約';
                    deleteBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                    showSearchBtn.style.display = 'inline-block'; // 新規予約時は検索ボタンを表示
                    searchSuggestionContainer.style.display = 'none'; // 初期状態では検索コンテナは隠す
                    document.getElementById('searchInstructionText').style.display = 'none'; // 新規予約時は時間枠検索の説明テキストを非表示
                    this.currentEditingId = null;
                    
                    // 新規予約では間隔表示を表示
                    const intervalInfo = document.getElementById('intervalInfo');
                    if (intervalInfo) {
                        intervalInfo.style.display = 'block';
                    }
                    
                    // フィールドを有効化（完了予約編集後の遷移対応）
                    this.enableFormFields();
                    
                    this.clearForm();
                    
                    if (date) {
                        // 曜日表示を更新
                        this.updateAppointmentDateDayOfWeek(date.toISOString().split('T')[0]);
                    }
                    if (time) {
                        const [hour, minute] = time.split(':');
                        const startHour = document.getElementById('startHour');
                        const startMinute = document.getElementById('startMinute');
                        startHour.value = hour;
                        startMinute.value = minute;
                        // 値が設定された場合は黒色にする
                        startHour.style.color = '#2d3748';
                        startMinute.style.color = '#2d3748';
                    }
                    if (treatment) {
                        this.selectTreatment(treatment, subItem || null);
                    }
                }
                
                modal.style.display = 'block';
                bringToFront(modal); // 表示時も最前面を確保
                
                // モーダル表示後に間隔情報を更新とイベントリスナー再設定
                setTimeout(() => {
                    this.setupIntervalEventListeners();
                    this.updateIntervalInfo();
                }, 100);
            }
            
            // 間隔表示用イベントリスナーを設定（モーダル表示時に呼び出し）
            setupIntervalEventListeners() {
                console.log('🎯 間隔イベントリスナー設定開始');
                
                // 既存のリスナーを削除して重複を防止
                const patientIdField = document.getElementById('patientId');
                const treatmentTypeField = document.getElementById('treatmentType');
                const subItemField = document.getElementById('subItem');
                const appointmentDateField = document.getElementById('appointmentDate');
                
                // 時間枠検索関連フィールド
                const patientIdForSearch = document.getElementById('patientId');
                const treatmentTypeForSearch = document.getElementById('treatmentType');
                const deviceForSearch = document.getElementById('device');
                const durationForSearch = document.getElementById('duration');
                
                console.log('🗺️ フィールド確認:', {
                    patientIdField: !!patientIdField,
                    treatmentTypeField: !!treatmentTypeField,
                    subItemField: !!subItemField,
                    appointmentDateField: !!appointmentDateField,
                    patientIdForSearch: !!patientIdForSearch,
                    treatmentTypeForSearch: !!treatmentTypeForSearch,
                    deviceForSearch: !!deviceForSearch,
                    durationForSearch: !!durationForSearch
                });
                
                // 時間枠検索要件チェックと非表示処理
                const checkAndHideMessage = () => {
                    if (this.checkSearchRequirements()) {
                        this.showSearchRequirementMessage(false);
                    }
                };
                
                // 現在の値をテスト表示
                console.log('🗺️ 現在の値テスト:', {
                    patientId: patientIdField?.value,
                    treatmentType: treatmentTypeField?.value, 
                    subItem: subItemField?.value,
                    appointmentDate: appointmentDateField?.value
                });
                
                // 直接イベントリスナーを追加（既存のものがあっても上書き）
                if (patientIdField) {
                    patientIdField.oninput = () => {
                        console.log('📋 patientId入力イベント - 値:', patientIdField.value);
                        setTimeout(() => this.updateIntervalInfo(), 10);
                    };
                }
                
                if (treatmentTypeField) {
                    treatmentTypeField.onchange = () => {
                        console.log('📋 treatmentType変更イベント - 値:', treatmentTypeField.value);
                        setTimeout(() => this.updateIntervalInfo(), 10);
                    };
                }
                
                if (subItemField) {
                    subItemField.onchange = () => {
                        console.log('📋 subItem変更イベント - 値:', subItemField.value);
                        setTimeout(() => this.updateIntervalInfo(), 10);
                    };
                }
                
                if (appointmentDateField) {
                    appointmentDateField.onchange = () => {
                        console.log('📋 appointmentDate変更イベント - 値:', appointmentDateField.value);
                        setTimeout(() => this.updateIntervalInfo(), 10);
                    };
                }
                
                // 時間枠検索関連フィールドのイベントリスナー
                if (patientIdForSearch) {
                    // patientIdは患者選択時に自動設定されるhiddenフィールド
                    // 患者名入力フィールドの変更を監視
                    const patientNameField = document.getElementById('patientName');
                    if (patientNameField) {
                        patientNameField.oninput = () => {
                            console.log('📋 patientName変更イベント - 値:', patientNameField.value);
                            // 患者検索機能を実行
                            calendar.searchPatientsInForm();
                            // 間隔制限チェックを実行
                            setTimeout(() => checkAndHideMessage(), 100);
                        };
                    }
                }
                
                if (treatmentTypeForSearch) {
                    treatmentTypeForSearch.onchange = () => {
                        console.log('📋 treatmentType変更イベント - 値:', treatmentTypeForSearch.value);
                        checkAndHideMessage();
                    };
                }
                
                if (deviceForSearch) {
                    deviceForSearch.onchange = () => {
                        console.log('📋 device変更イベント - 値:', deviceForSearch.value);
                        checkAndHideMessage();
                    };
                }
                
                if (durationForSearch) {
                    durationForSearch.onchange = () => {
                        console.log('📋 duration変更イベント - 値:', durationForSearch.value);
                        checkAndHideMessage();
                    };
                }
                
                console.log('✅ 間隔イベントリスナー設定完了');
                
                // 定期的なポーリングで間隔表示を更新
                this.startIntervalPolling();
            }
            
            // 定期的なポーリングで間隔表示を更新
            startIntervalPolling() {
                console.log('🔄 間隔表示ポーリング開始');
                
                // 既存のタイマーをクリア
                if (this.intervalPollingTimer) {
                    clearInterval(this.intervalPollingTimer);
                }
                
                // 前回の値を記録して変更時のみ更新
                let lastValues = {
                    patientId: '',
                    treatmentType: '',
                    subItem: '',
                    appointmentDate: ''
                };
                
                // 500msごとにチェック
                this.intervalPollingTimer = setInterval(() => {
                    const currentValues = {
                        patientId: document.getElementById('patientId')?.value?.trim() || '',
                        treatmentType: document.getElementById('treatmentType')?.value || '',
                        subItem: document.getElementById('subItem')?.value || '',
                        appointmentDate: document.getElementById('appointmentDate')?.value || ''
                    };
                    
                    // 値が変更されたかチェック
                    const hasChanged = 
                        currentValues.patientId !== lastValues.patientId ||
                        currentValues.treatmentType !== lastValues.treatmentType ||
                        currentValues.subItem !== lastValues.subItem ||
                        currentValues.appointmentDate !== lastValues.appointmentDate;
                    
                    if (hasChanged) {
                        console.log('🔄 値の変更を検出:', currentValues);
                        lastValues = { ...currentValues };
                        this.updateIntervalInfo();
                    }
                }, 500);
            }
            
            // ポーリング停止
            stopIntervalPolling() {
                if (this.intervalPollingTimer) {
                    console.log('🛑 間隔表示ポーリング停止');
                    clearInterval(this.intervalPollingTimer);
                    this.intervalPollingTimer = null;
                }
            }

            closeModal() {
                const appointmentModal = document.getElementById('appointmentModal');
                appointmentModal.style.display = 'none';
                // z-indexは動的管理のため戻さない
                
                // フィールドを有効化してリセット（完了予約編集後の状態をクリア）
                this.enableFormFields();
                this.clearForm();
                this.currentEditingId = null;
                
                // 時間枠検索の説明テキストを表示状態に戻す（デフォルト状態）
                document.getElementById('searchInstructionText').style.display = 'block';
                
                // 間隔表示ポーリングを停止
                this.stopIntervalPolling();
                
                // 予約件数表示を再表示
                const floatingSummaries = document.querySelectorAll('[id^="floatingSummaryContainer"]');
                floatingSummaries.forEach(summary => {
                    // 元のdisplay値に戻す（floatingSummaryContainer_数字はflex、メインコンテナもflex）
                    if (summary.id.includes('_')) {
                        summary.style.display = 'flex';
                    } else {
                        summary.style.display = 'flex';
                    }
                });
            }

            // フィールドを無効化する関数
            disableFormFields() {
                // 各フィールドを無効化し、スタイルを変更
                const fields = ['patientName', 'patientId', 'nurse', 'device', 'appointmentDate', 'startHour', 'startMinute', 'duration'];
                fields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = true;
                        element.style.backgroundColor = '#f9fafb';
                        element.style.color = '#6b7280';
                        element.style.cursor = 'not-allowed';
                    }
                });
                
                // 施術メニュー欄を無効化
                const treatmentDisplay = document.getElementById('treatmentDisplay');
                if (treatmentDisplay) {
                    treatmentDisplay.disabled = true;
                    treatmentDisplay.style.backgroundColor = '#f9fafb';
                    treatmentDisplay.style.color = '#6b7280';
                    treatmentDisplay.style.cursor = 'not-allowed';
                }
                
                // 施術メニューのドロップダウンも無効化
                const treatmentDropdown = document.getElementById('treatmentDropdown');
                if (treatmentDropdown) {
                    treatmentDropdown.style.pointerEvents = 'none';
                    treatmentDropdown.style.backgroundColor = '#f9fafb';
                    treatmentDropdown.style.color = '#6b7280';
                    treatmentDropdown.style.cursor = 'not-allowed';
                }
                
                // 施術メニューセレクター全体も無効化
                const treatmentSelector = document.querySelector('.treatment-selector');
                if (treatmentSelector) {
                    treatmentSelector.style.pointerEvents = 'none';
                    treatmentSelector.style.cursor = 'not-allowed';
                }
            }

            // フィールドを有効化する関数
            enableFormFields() {
                const fields = ['patientName', 'patientId', 'nurse', 'device', 'appointmentDate', 'startHour', 'startMinute', 'duration'];
                fields.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = false;
                        element.style.backgroundColor = '';
                        element.style.color = '';
                        element.style.cursor = '';
                    }
                });
                
                // 施術メニュー欄を有効化
                const treatmentDisplay = document.getElementById('treatmentDisplay');
                if (treatmentDisplay) {
                    treatmentDisplay.disabled = false;
                    treatmentDisplay.style.backgroundColor = '';
                    treatmentDisplay.style.color = '';
                    treatmentDisplay.style.cursor = '';
                }
                
                // 施術メニューのドロップダウンも有効化
                const treatmentDropdown = document.getElementById('treatmentDropdown');
                if (treatmentDropdown) {
                    treatmentDropdown.style.pointerEvents = '';
                    treatmentDropdown.style.backgroundColor = '';
                    treatmentDropdown.style.color = '';
                    treatmentDropdown.style.cursor = '';
                }
                
                // 施術メニューセレクター全体も有効化
                const treatmentSelector = document.querySelector('.treatment-selector');
                if (treatmentSelector) {
                    treatmentSelector.style.pointerEvents = '';
                    treatmentSelector.style.cursor = '';
                }
            }

            populateForm(appointment, isCompleted = false) {
                // 患者IDと名前を組み合わせて表示（マーク情報も含める）
                const patientNameField = document.getElementById('patientName');
                let patientDisplay = appointment.patientId ? 
                    `${appointment.patientId}　${appointment.patientName}` : 
                    appointment.patientName;
                
                // 患者のマーク情報を取得して追加
                if (appointment.patientId) {
                    const patient = this.patients.find(p => p.id === appointment.patientId);
                    if (patient && patient.marks && patient.marks.length > 0) {
                        const markSymbols = patient.marks.map(mark => {
                            const markInfo = this.patientMarks[mark];
                            return markInfo.symbol;
                        }).join('');
                        patientDisplay += ` ${markSymbols}`;
                    }
                }
                
                patientNameField.value = patientDisplay;
                
                // 患者IDがある場合は読み取り専用
                if (appointment.patientId) {
                    patientNameField.readOnly = true;
                }
                
                document.getElementById('patientId').value = appointment.patientId || '';
                
                // 新しい統合UIで施術メニューとサブ項目を設定
                this.selectTreatment(appointment.treatmentType, appointment.subItem || null);
                
                document.getElementById('nurse').value = appointment.nurse;
                document.getElementById('device').value = appointment.device || 'なし';
                // 曜日表示を更新
                this.updateAppointmentDateDayOfWeek(appointment.date);
                
                const [hour, minute] = appointment.startTime.split(':');
                document.getElementById('startHour').value = hour;
                document.getElementById('startMinute').value = minute;
                
                document.getElementById('duration').value = appointment.duration;
                
                // コメントを設定
                document.getElementById('appointmentComment').value = appointment.comment || '';
                this.updateCommentCharCount();
                
                // 完了済み予約の場合はフィールドを無効化
                if (isCompleted) {
                    this.disableFormFields();
                } else {
                    this.enableFormFields();
                }
                
                // select要素の色を値に応じて更新
                setTimeout(() => {
                    ['nurse', 'device', 'startHour', 'startMinute', 'duration'].forEach(id => {
                        const select = document.getElementById(id);
                        if (select && select.value && select.value !== '') {
                            select.style.color = isCompleted ? '#6b7280' : '#2d3748';
                        }
                    });
                }, 50);
                
                // 患者検索のサジェスションを非表示
                document.getElementById('patientSuggestions').style.display = 'none';
                
                // 患者が選択されている場合は履歴表示ボタンを表示
                const historyBtn = document.getElementById('showHistoryBtn');
                if (historyBtn && appointment.patientId) {
                    historyBtn.style.display = 'block';
                }
            }
            
            updateCommentCharCount() {
                const commentField = document.getElementById('appointmentComment');
                const charCount = document.getElementById('commentCharCount');
                if (commentField && charCount) {
                    const currentLength = commentField.value.length;
                    charCount.textContent = currentLength;
                    
                    // 文字数による色分け（推奨値の目安）
                    if (currentLength >= 100) {
                        charCount.style.color = '#f59e0b'; // オレンジ色（長文注意）
                    } else if (currentLength >= 50) {
                        charCount.style.color = '#3b82f6'; // 青色（適度な長さ）
                    } else {
                        charCount.style.color = '#6b7280'; // 通常のグレー
                    }
                }
            }
            
            // 患者選択をクリアする
            clearPatientSelection() {
                const patientNameField = document.getElementById('patientName');
                const patientIdField = document.getElementById('patientId');
                const historyBtn = document.getElementById('showHistoryBtn');
                
                // フィールドをクリア
                patientNameField.value = '';
                patientIdField.value = '';
                patientNameField.readOnly = false; // 編集可能に戻す
                
                // 履歴表示ボタンを非表示
                if (historyBtn) {
                    historyBtn.style.display = 'none';
                }
                
                // 間隔表示を更新
                this.updateIntervalInfo();
                
                // フォーカスを患者欄に戻す
                patientNameField.focus();
            }
            
            // 患者マークのHTML生成
            generatePatientMarksHtml(marks) {
                if (!marks || marks.length === 0) return '';
                
                return marks.map(markType => {
                    const mark = this.patientMarks[markType];
                    if (mark) {
                        return `<span style="color: ${mark.color}; font-size: 10px; margin-right: 0px; font-family: monospace; display: inline-block; width: 8px; text-align: center;">${mark.symbol}</span>`;
                    }
                    return '';
                }).join('');
            }
            
            // 患者IDからマークを取得
            getPatientMarks(patientId) {
                const patient = this.patients.find(p => p.id === patientId);
                return patient ? patient.marks || [] : [];
            }
            
            // マークチェックボックスのHTML生成
            generateMarkCheckboxes(selectedMarks = []) {
                return Object.entries(this.patientMarks).map(([key, mark]) => {
                    const checked = selectedMarks.includes(key) ? 'checked' : '';
                    return `
                        <label style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer;">
                            <input type="checkbox" name="patientMarks" value="${key}" ${checked} 
                                   style="margin-right: 8px; width: 16px; height: 16px;">
                            <span style="color: ${mark.color}; font-size: 16px; margin-right: 8px; font-family: monospace; display: inline-block; width: 16px; text-align: center;">${mark.symbol}</span>
                            <span style="font-size: 14px;">${mark.name}</span>
                        </label>
                    `;
                }).join('');
            }

            clearForm() {
                document.getElementById('appointmentForm').reset();
                document.getElementById('patientId').value = '';
                document.getElementById('patientSuggestions').style.display = 'none';
                
                // 患者名フィールドを編集可能に戻す
                const patientNameField = document.getElementById('patientName');
                patientNameField.readOnly = false;
                
                // 予約日入力欄を初期状態に戻す（曜日表示をクリア）
                this.updateAppointmentDateDayOfWeek('');
                
                // 新しい統合UIをクリア
                const display = document.getElementById('treatmentDisplay');
                const treatmentType = document.getElementById('treatmentType');
                const subItem = document.getElementById('subItem');
                
                if (display) display.value = '';
                if (treatmentType) treatmentType.value = '';
                if (subItem) subItem.value = '';
                
                // select要素のスタイルを初期状態（グレー）に戻す
                ['nurse', 'device', 'startHour', 'startMinute', 'duration'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.value = '';
                        select.style.color = '#a0aec0'; // プレースホルダー色に戻す
                    }
                });
                
                // コメント欄をクリア
                document.getElementById('appointmentComment').value = '';
                document.getElementById('commentCharCount').textContent = '0';
                
                // 履歴表示ボタンを非表示
                const historyBtn = document.getElementById('showHistoryBtn');
                if (historyBtn) {
                    historyBtn.style.display = 'none';
                }
                
                // 検索コンテナを非表示にリセット
                const searchContainer = document.getElementById('searchSuggestionContainer');
                if (searchContainer) {
                    searchContainer.style.display = 'none';
                }
                
                // 推奨メッセージをクリア
                this.clearRecommendationMessage();
                const searchResults = document.getElementById('searchResults');
                if (searchResults) {
                    searchResults.style.display = 'none';
                }
                
                // 間隔表示を非表示
                const intervalInfo = document.getElementById('intervalInfo');
                if (intervalInfo) {
                    intervalInfo.style.display = 'none';
                }
                
                // 検索用日付フィールドもクリア
                const searchStartDate = document.getElementById('searchStartDate');
                const searchEndDate = document.getElementById('searchEndDate');
                const ignoreIntervalRestriction = document.getElementById('ignoreIntervalRestriction');
                
                if (searchStartDate) {
                    searchStartDate.value = '';
                    searchStartDate.dataset.dateValue = '';
                    searchStartDate.style.color = '#a0aec0';
                }
                if (searchEndDate) {
                    searchEndDate.value = '';
                    searchEndDate.dataset.dateValue = '';
                    searchEndDate.style.color = '#a0aec0';
                }
                if (ignoreIntervalRestriction) {
                    ignoreIntervalRestriction.checked = false;
                }
                
                document.querySelectorAll('.form-error').forEach(error => {
                    error.style.display = 'none';
                });
                document.querySelectorAll('.error').forEach(field => {
                    field.classList.remove('error');
                });
            }

            validateForm() {
                const requiredFields = [
                    { id: 'patientName', message: '患者名を入力してください' },
                    { id: 'treatmentType', message: '施術メニューを選択してください' },
                    { id: 'nurse', message: '担当看護師を選択してください' },
                    { id: 'device', message: 'デバイスを選択してください' },
                    { id: 'appointmentDate', message: '日付を選択してください' },
                    { id: 'startHour', message: '開始時間を選択してください' },
                    { id: 'startMinute', message: '開始時間を選択してください' },
                    { id: 'duration', message: '所要時間を選択してください' }
                ];
                
                let isValid = true;
                
                document.querySelectorAll('.form-error').forEach(error => {
                    error.style.display = 'none';
                });
                document.querySelectorAll('.error').forEach(field => {
                    field.classList.remove('error');
                });
                
                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    const value = element.value.trim();
                    
                    if (!value) {
                        element.classList.add('error');
                        const errorElement = element.parentNode.querySelector('.form-error');
                        if (errorElement) {
                            errorElement.textContent = field.message;
                            errorElement.style.display = 'block';
                        }
                        isValid = false;
                    }
                });
                
                // サブ項目のバリデーション - メイン項目にサブ項目がある場合は必須かつ有効
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value.trim();
                const selectedTreatment = this.treatmentMenus.find(t => t.name === treatmentType);
                
                if (selectedTreatment && selectedTreatment.subItems && selectedTreatment.subItems.length > 0) {
                    if (!subItem) {
                        // サブ項目が必須なのに未選択
                        const subItemElement = document.getElementById('subItem');
                        subItemElement.classList.add('error');
                        const errorElement = subItemElement.parentNode.querySelector('.form-error');
                        if (errorElement) {
                            errorElement.textContent = `${treatmentType}ではサブ項目の選択が必須です`;
                            errorElement.style.display = 'block';
                        }
                        isValid = false;
                    } else {
                        // サブ項目が選択されているが、実際に存在するか確認
                        const validSubItem = selectedTreatment.subItems.find(si => si.name === subItem);
                        if (!validSubItem) {
                            const subItemElement = document.getElementById('subItem');
                            subItemElement.classList.add('error');
                            const errorElement = subItemElement.parentNode.querySelector('.form-error');
                            if (errorElement) {
                                errorElement.textContent = `「${subItem}」は${treatmentType}の有効なサブ項目ではありません`;
                                errorElement.style.display = 'block';
                            }
                            isValid = false;
                        }
                    }
                } else if (subItem) {
                    // サブ項目がないメイン項目なのにサブ項目が設定されている
                    const subItemElement = document.getElementById('subItem');
                    subItemElement.classList.add('error');
                    const errorElement = subItemElement.parentNode.querySelector('.form-error');
                    if (errorElement) {
                        errorElement.textContent = `${treatmentType}にはサブ項目を設定できません`;
                        errorElement.style.display = 'block';
                    }
                    isValid = false;
                }
                
                return isValid;
            }


            // 看護師・デバイスの重複チェック
            checkResourceConflict(newAppointment, excludeId = null) {
                const newStartTime = this.timeToMinutes(newAppointment.startTime);
                const newEndTime = newStartTime + newAppointment.duration;
                
                const conflicts = [];
                
                // 同じ日付の既存予約をチェック
                this.appointments.forEach(apt => {
                    // 編集中の予約は除外
                    if (excludeId && apt.id === excludeId) return;
                    
                    // 同じ日付のみチェック
                    if (apt.date !== newAppointment.date) return;
                    
                    const existingStartTime = this.timeToMinutes(apt.startTime);
                    const existingEndTime = existingStartTime + apt.duration;
                    
                    // 時間の重複チェック（1分でも重なる場合）
                    if (newStartTime < existingEndTime && newEndTime > existingStartTime) {
                        // 看護師の重複チェック
                        if (apt.nurse === newAppointment.nurse) {
                            conflicts.push({
                                type: 'nurse',
                                resource: newAppointment.nurse,
                                appointment: apt
                            });
                        }
                        
                        // デバイスの重複チェック（「なし」以外の場合のみ）
                        if (newAppointment.device && newAppointment.device !== 'なし' && 
                            apt.device && apt.device !== 'なし' && 
                            apt.device === newAppointment.device) {
                            conflicts.push({
                                type: 'device',
                                resource: newAppointment.device,
                                appointment: apt
                            });
                        }
                    }
                });
                
                return conflicts;
            }

            // 患者の重複チェック
            checkPatientConflict(newAppointment, excludeId = null) {
                if (!newAppointment.patientId && !newAppointment.patientName) {
                    return [];
                }
                
                const conflicts = [];
                const newStartTime = this.timeToMinutes(newAppointment.startTime);
                const newEndTime = newStartTime + newAppointment.duration;
                const newDate = newAppointment.date;
                
                this.appointments.forEach(apt => {
                    // 編集中の予約は除外
                    if (excludeId && apt.id === excludeId) return;
                    
                    // 同じ日付でない場合はスキップ
                    if (apt.date !== newDate) return;
                    
                    // 患者が同じかチェック
                    const isSamePatient = (newAppointment.patientId && apt.patientId && 
                                          newAppointment.patientId === apt.patientId) ||
                                         (!newAppointment.patientId && !apt.patientId && 
                                          newAppointment.patientName === apt.patientName);
                    
                    if (!isSamePatient) return;
                    
                    const existingStartTime = this.timeToMinutes(apt.startTime);
                    const existingEndTime = existingStartTime + apt.duration;
                    
                    // 時間の重複チェック（1分でも重なる場合）
                    if (newStartTime < existingEndTime && newEndTime > existingStartTime) {
                        conflicts.push({
                            type: 'patient',
                            resource: newAppointment.patientName,
                            appointment: apt
                        });
                    }
                });
                
                return conflicts;
            }
            
            // 全ての重複チェックを統合
            checkAllConflicts(newAppointment, excludeId = null) {
                const allConflicts = [];
                
                // 1. 予約時間の重複チェック（既存のcheckAppointmentConflict相当）
                const timeConflicts = this.checkTimeConflicts(newAppointment, excludeId);
                allConflicts.push(...timeConflicts);
                
                // 2. 看護師・デバイスの重複チェック
                const resourceConflicts = this.checkResourceConflict(newAppointment, excludeId);
                allConflicts.push(...resourceConflicts);
                
                // 3. 患者の重複チェック
                const patientConflicts = this.checkPatientConflict(newAppointment, excludeId);
                allConflicts.push(...patientConflicts);
                
                return allConflicts;
            }
            
            // 予約時間の重複チェック（表示位置の重複のみ）
            checkTimeConflicts(newAppointment, excludeId = null) {
                const conflicts = [];
                const newStartTime = this.timeToMinutes(newAppointment.startTime);
                const newEndTime = newStartTime + newAppointment.duration;
                const newDate = newAppointment.date;
                
                this.appointments.forEach(apt => {
                    // 編集中の予約は除外
                    if (excludeId && apt.id === excludeId) return;
                    
                    // 同じ日付でない場合はスキップ
                    if (apt.date !== newDate) return;
                    
                    // 同じ施術メニューかつ同じ表示位置（行）の場合のみチェック
                    if (apt.treatmentType !== newAppointment.treatmentType) return;
                    
                    // subItemの比較（undefinedと空文字列を同じものとして扱う）
                    const existingSubItem = apt.subItem || '';
                    const newSubItem = newAppointment.subItem || '';
                    if (existingSubItem !== newSubItem) return;
                    
                    const existingStartTime = this.timeToMinutes(apt.startTime);
                    const existingEndTime = existingStartTime + apt.duration;
                    
                    // 時間の重複チェック（予約ボックスが重なる場合）
                    if (newStartTime < existingEndTime && newEndTime > existingStartTime) {
                        conflicts.push({
                            type: 'time',
                            resource: `${apt.startTime}-${this.minutesToTime(existingEndTime)}`,
                            appointment: apt
                        });
                    }
                });
                
                return conflicts;
            }

            // 時間文字列を分に変換 (例: "14:30" → 870)
            timeToMinutes(timeString) {
                const [hours, minutes] = timeString.split(':').map(Number);
                return hours * 60 + minutes;
            }
            
            // 分を時間文字列に変換 (例: 870 → "14:30")
            minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            // 重複確認モーダルを閉じる（統合モーダルに移行したため簡略化）
            closeConflictModal() {
                document.getElementById('conflictModal').style.display = 'none';
            }

            saveAppointment() {
                if (!this.validateForm()) {
                    return;
                }
                
                const hour = document.getElementById('startHour').value;
                const minute = document.getElementById('startMinute').value;
                const selectedTime = `${hour}:${minute}`;
                
                // 患者名フィールドからIDと名前を分離
                const patientFieldValue = document.getElementById('patientName').value.trim();
                const patientId = document.getElementById('patientId').value.trim();
                
                // 患者ID必須チェック
                if (!patientId) {
                    alert('患者を選択してください。患者マスターに登録されていない場合は、先に患者登録を行ってください。');
                    return;
                }
                
                // 患者IDが含まれている場合は除去して名前のみ取得
                let patientName = patientFieldValue;
                if (patientId) {
                    // P001　田中 花子 形式を削除
                    if (patientFieldValue.startsWith(patientId)) {
                        patientName = patientFieldValue.substring(patientId.length)
                            .replace(/^　+/, '') // 全角スペースを削除
                            .replace(/^ +/, '') // 半角スペースを削除
                            .trim();
                    }
                }
                
                const formData = {
                    patientId: patientId,
                    patientName: patientName,
                    treatmentType: document.getElementById('treatmentType').value,
                    subItem: document.getElementById('subItem').value,
                    nurse: document.getElementById('nurse').value,
                    device: document.getElementById('device').value === 'なし' ? '' : document.getElementById('device').value,
                    comment: document.getElementById('appointmentComment').value.trim(),
                    date: this.getDateOnlyFromInput(),
                    startTime: selectedTime,
                    duration: parseInt(document.getElementById('duration').value)
                };

                // 全ての重複チェックを一度に実行
                const allConflicts = this.checkAllConflicts(formData, this.currentEditingId);
                if (allConflicts.length > 0) {
                    this.showResourceConflictModal(allConflicts);
                    return;
                }

                // 営業時間チェック
                const businessHoursCheck = this.isAppointmentWithinBusinessHours(
                    formData.date, 
                    formData.startTime, 
                    formData.duration
                );
                if (!businessHoursCheck.valid) {
                    showBusinessHoursWarning(businessHoursCheck.reason, formData);
                    return;
                }

                // 施術制限チェック（曜日・時間）
                const restrictionViolation = this.checkTreatmentRestrictions(formData);
                if (restrictionViolation) {
                    alert(restrictionViolation);
                    return;
                }

                // 間隔制限チェック
                const intervalViolation = this.checkIntervalRestriction(formData);
                if (intervalViolation) {
                    this.showIntervalWarningModal(intervalViolation, formData);
                    return;
                }

                if (this.currentEditingId) {
                    const appointment = this.appointments.find(apt => apt.id === this.currentEditingId);
                    Object.assign(appointment, formData);
                    
                    // 編集時も患者がマスターに存在しない場合は自動登録
                    if (formData.patientId && formData.patientName) {
                        const existingPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                        if (!existingPatient) {
                            console.log(`🆕 編集時に新規患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                            
                            const nameHiragana = formData.patientName.toLowerCase().replace(/[　\s]+/g, ' ');
                            
                            const newPatient = {
                                id: formData.patientId,
                                name: formData.patientName,
                                nameHiragana: nameHiragana,
                                registrationDate: new Date().toISOString().split('T')[0],
                                totalVisits: 0,
                                lastVisit: '',
                                history: []
                            };
                            
                            this.patients.push(newPatient);
                            
                            // 患者IDでソート
                            this.patients.sort((a, b) => {
                                const aNum = parseInt(a.id.replace(/[^\d]/g, ''));
                                const bNum = parseInt(b.id.replace(/[^\d]/g, ''));
                                return aNum - bNum;
                            });
                        }
                    }
                } else {
                    const newId = Math.max(0, ...this.appointments.map(apt => apt.id)) + 1;
                    const appointment = {
                        id: newId,
                        ...formData
                    };
                    
                    this.appointments.push(appointment);

                    // 患者情報を更新（履歴は予約データから動的に生成するため追加しない）
                    let selectedPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                    
                    // 患者がマスターに存在しない場合は自動登録
                    if (!selectedPatient && formData.patientId && formData.patientName) {
                        console.log(`🆕 新規患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                        
                        // ひらがな名を簡易生成
                        const nameHiragana = formData.patientName.toLowerCase()
                            .replace(/[　\s]+/g, ' ');
                        
                        const newPatient = {
                            id: formData.patientId,
                            name: formData.patientName,
                            nameHiragana: nameHiragana,
                            registrationDate: new Date().toISOString().split('T')[0],
                            totalVisits: 0,
                            lastVisit: '',
                            history: []
                        };
                        
                        this.patients.push(newPatient);
                        
                        // 患者IDでソート
                        this.patients.sort((a, b) => {
                            const aNum = parseInt(a.id.replace(/[^\d]/g, ''));
                            const bNum = parseInt(b.id.replace(/[^\d]/g, ''));
                            return aNum - bNum;
                        });
                        
                        selectedPatient = newPatient;
                    }
                    
                    if (selectedPatient) {
                        // 来院回数と最終来院日のみ更新
                        const patientAppointmentCount = this.appointments.filter(apt => String(apt.patientId) === String(selectedPatient.id)).length;
                        selectedPatient.totalVisits = patientAppointmentCount;
                        
                        // 最新の予約日を最終来院日として設定
                        const patientAppointments = this.appointments.filter(apt => String(apt.patientId) === String(selectedPatient.id));
                        const latestDate = patientAppointments
                            .map(apt => new Date(apt.date))
                            .sort((a, b) => b - a)[0];
                        if (latestDate) {
                            selectedPatient.lastVisit = latestDate.toISOString().split('T')[0];
                        }
                    }
                    
                    console.log('予約保存完了:', {
                        予約ID: appointment.id,
                        患者: selectedPatient ? selectedPatient.name : 'なし',
                        総予約数: this.appointments.length
                    });
                }

                // 予約保存後の位置同期確認
                console.log('💾 予約保存完了:', {
                    '予約ID': this.currentEditingId || '新規',
                    '患者名': formData.patientName,
                    '時間': formData.startTime,
                    '施術': formData.treatmentType,
                    '期待位置': this.calculateExactPosition({startTime: formData.startTime, duration: formData.duration})
                });
                
                this.closeModal();
                this.render(); // 同じ位置計算ロジックで再描画
                this.showSuccessMessage('予約が保存されました。');
                
            }

            // データ整合性チェック関数
            verifyPatientDataConsistency() {
                console.log('🔍 患者データ整合性チェック開始...');
                const issues = [];
                
                // 各予約をチェック
                this.appointments.forEach(appointment => {
                    if (appointment.patientId) {
                        // 患者マスターから該当IDを検索
                        const patient = this.patients.find(p => p.id === appointment.patientId);
                        
                        if (!patient) {
                            issues.push({
                                type: 'MISSING_IN_MASTER',
                                appointmentId: appointment.id,
                                patientId: appointment.patientId,
                                patientName: appointment.patientName,
                                date: appointment.date,
                                startTime: appointment.startTime,
                                message: `予約ID ${appointment.id}: 患者ID「${appointment.patientId}」が患者マスターに存在しません`
                            });
                        } else if (patient.name !== appointment.patientName) {
                            issues.push({
                                type: 'NAME_MISMATCH',
                                appointmentId: appointment.id,
                                patientId: appointment.patientId,
                                appointmentName: appointment.patientName,
                                masterName: patient.name,
                                date: appointment.date,
                                startTime: appointment.startTime,
                                message: `予約ID ${appointment.id}: 患者名が不一致 - 予約「${appointment.patientName}」vs マスター「${patient.name}」`
                            });
                        }
                    }
                });
                
                // 結果を表示
                console.log('===== 患者データ整合性チェック結果 =====');
                if (issues.length === 0) {
                    console.log('✅ すべての予約データが患者マスターと一致しています');
                } else {
                    console.log(`❌ ${issues.length}件の不整合が見つかりました：`);
                    issues.forEach((issue, index) => {
                        console.log(`\n${index + 1}. ${issue.message}`);
                        console.log('   詳細:', {
                            予約ID: issue.appointmentId,
                            患者ID: issue.patientId,
                            日付: issue.date,
                            時間: issue.startTime,
                            タイプ: issue.type
                        });
                        if (issue.type === 'NAME_MISMATCH') {
                            console.log('   予約の名前:', issue.appointmentName);
                            console.log('   マスターの名前:', issue.masterName);
                        }
                    });
                }
                console.log('========================================');
                
                return issues;
            }

            // 日付選択カレンダーの制御
            openDatePicker() {
                this.datePickerDate = new Date(this.currentDate);
                this.renderDatePickerCalendar();
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
                
                // 通常の日付選択では決定ボタンを隠す
                const confirmBtn = document.getElementById('confirmPeriodBtn');
                if (confirmBtn) {
                    confirmBtn.style.display = 'none';
                }
                
                // 確実に最前面に表示するため、少し遅延してもう一度実行
                setTimeout(() => {
                    bringToFront(modal);
                    console.log('日付ピッカーを最前面に配置');
                }, 50);
            }

            closeDatePicker() {
                document.getElementById('datePickerModal').style.display = 'none';
            }

            navigateDatePicker(months) {
                this.datePickerDate.setMonth(this.datePickerDate.getMonth() + months);
                this.renderDatePickerCalendar();
            }

            renderDatePickerCalendar() {
                const year = this.datePickerDate.getFullYear();
                const month = this.datePickerDate.getMonth();
                
                // 月年表示を更新
                const monthYearEl = document.getElementById('datePickerMonthYear');
                const options = { year: 'numeric', month: 'long' };
                monthYearEl.textContent = this.datePickerDate.toLocaleDateString('ja-JP', options);
                
                // カレンダーグリッドを生成
                const grid = document.getElementById('datePickerGrid');
                grid.innerHTML = '';
                
                // 曜日ヘッダー
                const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
                weekdays.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-weekday';
                    dayElement.textContent = day;
                    grid.appendChild(dayElement);
                });
                
                // 月の最初の日と最後の日を取得
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                // 6週間分の日付を表示
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.textContent = currentDate.getDate();
                    
                    // 現在の月以外の日付
                    if (currentDate.getMonth() !== month) {
                        dayElement.classList.add('other-month');
                    }
                    
                    // 今日の日付
                    const today = new Date();
                    if (currentDate.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    // 選択中の日付
                    // 期間選択モードの場合（通常モード または 患者モード）
                    if (this.periodSelectionMode || this.patientPeriodSelectionMode) {
                        // 開始日の表示
                        if (this.selectedStartDate && currentDate.toDateString() === this.selectedStartDate.toDateString()) {
                            dayElement.classList.add('selected');
                        }
                        // 終了日の表示
                        if (this.selectedEndDate && currentDate.toDateString() === this.selectedEndDate.toDateString()) {
                            dayElement.classList.add('selected');
                        }
                        // 期間中の日付の表示（開始日・終了日は除く）
                        if (this.selectedStartDate && this.selectedEndDate) {
                            const isStartDate = currentDate.toDateString() === this.selectedStartDate.toDateString();
                            const isEndDate = currentDate.toDateString() === this.selectedEndDate.toDateString();
                            
                            if (currentDate > this.selectedStartDate && currentDate < this.selectedEndDate && !isStartDate && !isEndDate) {
                                dayElement.classList.add('period-range');
                            }
                        }
                    } else {
                        // 通常の日付選択（入力フィールドの値を参照）
                        const appointmentDateInput = document.getElementById('appointmentDate');
                        if (appointmentDateInput && appointmentDateInput.value) {
                            const inputDate = new Date(appointmentDateInput.value);
                            if (currentDate.toDateString() === inputDate.toDateString()) {
                                dayElement.classList.add('selected');
                            }
                        }
                    }
                    
                    // 休診日の判定とスタイル適用
                    const isClosedDay = this.isClosedDay(currentDate);
                    const dayOfWeek = currentDate.getDay();
                    const dateStr2 = currentDate.toISOString().split('T')[0];
                    const isHoliday = this.holidays.includes(dateStr2);
                    const isSaturdayHoliday = isHoliday && dayOfWeek === 6;
                    
                    if (isClosedDay && !isSaturdayHoliday) {
                        dayElement.classList.add('closed-day');
                    } else if (isSaturdayHoliday) {
                        dayElement.classList.add('saturday-holiday');
                    }
                    
                    // クリックイベント
                    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    dayElement.addEventListener('click', () => {
                        // 休診日（土曜祝日以外）は選択不可
                        if (isClosedDay && !isSaturdayHoliday) {
                            console.log('休診日のため選択できません:', currentDate.toLocaleDateString('ja-JP'));
                            return;
                        }
                        this.selectDate(dateStr, currentDate);
                    });
                    
                    grid.appendChild(dayElement);
                }
            }

            selectDate(dateStr, currentDate) {
                // 期間選択モードの場合（通常モード または 患者モード）
                if (this.periodSelectionMode || this.patientPeriodSelectionMode) {
                    const selectedDate = new Date(currentDate);
                    
                    if (this.periodSelectionStep === 1) {
                        // 開始日を選択
                        this.selectedStartDate = selectedDate;
                        this.periodSelectionStep = 2;
                        
                        // タイトルを更新
                        const title = document.querySelector('#datePickerModal h3');
                        if (title) {
                            if (this.patientPeriodSelectionMode) {
                                title.textContent = '希望期間を選択（終了日を選択してください）';
                            } else {
                                title.textContent = '検索期間を選択（終了日を選択してください）';
                            }
                        }
                        
                        // カレンダーを再描画
                        this.renderDatePickerCalendar();
                        
                        // 決定ボタンの状態を更新
                        this.updateConfirmButtonState();
                        
                    } else if (this.periodSelectionStep === 2) {
                        // 終了日を選択
                        if (selectedDate < this.selectedStartDate) {
                            // 終了日が開始日より前の場合は開始日として設定し直す
                            this.selectedStartDate = selectedDate;
                            this.selectedEndDate = null;
                            this.periodSelectionStep = 2;
                            
                            const title = document.querySelector('#datePickerModal h3');
                            if (title) {
                                if (this.patientPeriodSelectionMode) {
                                    title.textContent = '希望期間を選択（終了日を選択してください）';
                                } else {
                                    title.textContent = '検索期間を選択（終了日を選択してください）';
                                }
                            }
                            this.renderDatePickerCalendar();
                        } else {
                            // 正常に終了日を選択
                            this.selectedEndDate = selectedDate;
                            this.periodSelectionStep = 3; // 選択完了状態
                            
                            // カレンダーを再描画（期間表示のため）
                            this.renderDatePickerCalendar();
                            
                            // 決定ボタンの状態を更新
                            this.updateConfirmButtonState();
                        }
                    } else if (this.periodSelectionStep === 3) {
                        // 両方選択済みの状態で再度クリックされた場合はリセット
                        this.selectedStartDate = selectedDate;
                        this.selectedEndDate = null;
                        this.periodSelectionStep = 2;
                        
                        // タイトルを更新
                        const title = document.querySelector('#datePickerModal h3');
                        if (title) {
                            if (this.patientPeriodSelectionMode) {
                                title.textContent = '希望期間を選択（終了日を選択してください）';
                            } else {
                                title.textContent = '検索期間を選択（終了日を選択してください）';
                            }
                        }
                        
                        // カレンダーを再描画
                        this.renderDatePickerCalendar();
                        
                        // 決定ボタンの状態を更新
                        this.updateConfirmButtonState();
                    }
                    return;
                }
                
                // 検索用日付ピッカーの場合（従来の処理）
                if (this.searchDatePickerType) {
                    const targetInput = this.searchDatePickerType === 'start' ? 
                        document.getElementById('searchStartDate') : 
                        document.getElementById('searchEndDate');
                    
                    const date = new Date(dateStr);
                    const displayFormat = `${date.getMonth() + 1}/${date.getDate()}`;
                    
                    targetInput.value = displayFormat;
                    targetInput.dataset.dateValue = dateStr;
                    targetInput.style.color = '#2d3748';
                    
                    // 開始日が設定された場合、終了日の検証
                    if (this.searchDatePickerType === 'start') {
                        const endInput = document.getElementById('searchEndDate');
                        if (endInput.dataset.dateValue && new Date(dateStr) > new Date(endInput.dataset.dateValue)) {
                            // 開始日が終了日より後の場合、終了日をクリア
                            endInput.value = '';
                            endInput.dataset.dateValue = '';
                            endInput.style.color = '#a0aec0';
                        }
                    }
                    
                    // 終了日が設定された場合、開始日の検証
                    if (this.searchDatePickerType === 'end') {
                        const startInput = document.getElementById('searchStartDate');
                        if (startInput.dataset.dateValue && new Date(dateStr) < new Date(startInput.dataset.dateValue)) {
                            // 終了日が開始日より前の場合、開始日をクリア
                            startInput.value = '';
                            startInput.dataset.dateValue = '';
                            startInput.style.color = '#a0aec0';
                        }
                    }
                    
                    this.searchDatePickerType = null; // リセット
                } else {
                    // 通常の予約日付選択の場合
                    const appointmentDateInput = document.getElementById('appointmentDate');
                    // 曜日表示を更新（dateValueパラメータを渡す）
                    this.updateAppointmentDateDayOfWeek(dateStr);
                }
                
                this.closeDatePicker();
            }

            selectToday() {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                // 曜日表示を更新
                this.updateAppointmentDateDayOfWeek(dateStr);
                this.closeDatePicker();
            }

            showSuccessMessage(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                
                // 最前面に表示するため bringToFront を使用
                bringToFront(successDiv);
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }

            // 予約編集画面から削除確認ウィンドウを表示
            confirmDeleteAppointment() {
                if (!this.currentEditingId) {
                    alert('削除対象の予約が特定できません。');
                    return;
                }
                
                const appointment = this.appointments.find(apt => apt.id == this.currentEditingId);
                if (!appointment) {
                    alert('予約が見つかりません。');
                    return;
                }
                
                // 確認モーダルを開く（履歴削除と同じ仕組みを使用）
                this.openDeleteConfirmModal('appointment', appointment, []);
            }

            // 確認後の予約削除実行（executeDeleteから呼ばれる）
            deleteAppointment() {
                if (!this.currentEditingId) {
                    alert('削除対象の予約が特定できません。');
                    return;
                }
                
                this.appointments = this.appointments.filter(apt => apt.id !== this.currentEditingId);
                this.closeModal();
                this.render();
                this.renderAppointments();
                this.showSuccessMessage('予約を削除しました。');
            }

            // 改善された管理機能
            openManageModal() {
                // 予約件数表示はモーダル表示時も表示し続ける
                
                const modal = document.getElementById('manageModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
                this.renderManageLists();
                
                // モーダル表示時は背景のスクロールを無効化
                document.body.style.overflow = 'hidden';
            }

            closeManageModal() {
                document.getElementById('manageModal').style.display = 'none';
                
                // 背景のスクロールを復活
                document.body.style.overflow = '';
                
                // 予約件数表示を再表示
                const floatingSummaries = document.querySelectorAll('[id^="floatingSummaryContainer"]');
                floatingSummaries.forEach(summary => {
                    // 元のdisplay値に戻す（floatingSummaryContainer_数字はflex、メインコンテナもflex）
                    if (summary.id.includes('_')) {
                        summary.style.display = 'flex';
                    } else {
                        summary.style.display = 'flex';
                    }
                });
            }

            switchManageTab(tabName) {
                document.querySelectorAll('.manage-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.manage-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}Content`).classList.add('active');
            }

            // 日付をYYYY-MM-DD形式にフォーマット
            formatDateForId(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 日付をYYYY/M/D形式にフォーマット
            formatDateForDisplay(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}/${month}/${day}`;
            }

            // 管理リストの描画
            renderManageLists() {
                this.renderNursesList();
                this.renderTreatmentsList();
                this.renderDevicesList();
                // 患者検索は初期表示のメッセージを表示するため、リストは呼ばない
                this.initializePatientSearch();
            }

            initializePatientSearch() {
                // 患者検索の初期状態を設定
                this.hideAllPatientMessages();
                document.getElementById('patientInitialMessage').style.display = 'flex';
                document.getElementById('patientSearch').value = '';
            }

            // 看護師リストの描画
            renderNursesList() {
                const tbody = document.getElementById('nursesList');
                tbody.innerHTML = '';
                
                // 現在表示中の日付の文字列を取得（YYYY-MM-DD形式）
                const currentDateString = this.formatDateForId(this.currentDate);
                const displayDate = this.formatDateForDisplay(this.currentDate);
                
                // ヘッダーの日付を更新
                const nursesHeader = document.querySelector('#nursesContent thead th:nth-child(2)');
                if (nursesHeader) {
                    nursesHeader.textContent = `予約件数(${displayDate})`;
                }
                
                this.nurses.forEach(nurse => {
                    const nurseName = typeof nurse === 'string' ? nurse : nurse.name;
                    const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                    // 現在表示中の日付の予約のみをカウント
                    const count = this.appointments.filter(apt => 
                        apt.nurse === nurseName && apt.date === currentDateString
                    ).length;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${nurseName}</td>
                        <td>
                            <span class="count-badge ${count > 0 ? 'active' : 'zero'}">${count}件</span>
                        </td>
                        <td class="nurse-actions">
                            <button class="btn-icon manage-treatments" onclick="calendar.openNurseTreatmentModal('${nurseName}')" title="施術管理">💉</button>
                            <button class="btn-icon rename" onclick="calendar.editNurseName('${nurseName}')" title="編集">✏️</button>
                            <button class="btn-icon delete" onclick="calendar.deleteNurse('${nurseName}')" title="削除">🗑️</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            // 看護師の施術メニュー対応を更新（旧機能：モーダル使用を推奨）
            updateNurseTreatment(nurseName, treatmentName, isChecked) {
                const nurse = this.nurses.find(n => (typeof n === 'string' ? n : n.name) === nurseName);
                if (!nurse) return;
                
                // 文字列形式の場合はオブジェクト形式に変換
                if (typeof nurse === 'string') {
                    const index = this.nurses.indexOf(nurse);
                    this.nurses[index] = { name: nurse, treatmentTypes: [] };
                    nurse = this.nurses[index];
                }
                
                if (isChecked) {
                    // 施術を追加
                    if (!nurse.treatmentTypes.includes(treatmentName)) {
                        nurse.treatmentTypes.push(treatmentName);
                    }
                } else {
                    // 施術を削除
                    nurse.treatmentTypes = nurse.treatmentTypes.filter(t => t !== treatmentName);
                }
                
                console.log(`${nurseName}の施術対応を更新:`, nurse.treatmentTypes);
            }

            // 看護師施術管理モーダルを開く
            openNurseTreatmentModal(nurseName) {
                const nurse = this.nurses.find(n => (typeof n === 'string' ? n : n.name) === nurseName);
                if (!nurse) return;
                
                const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                
                // 現在編集中の看護師を記録
                this.currentEditingNurse = nurseName;
                
                // モーダルのタイトルと看護師名を設定
                document.getElementById('currentNurseName').textContent = nurseName;
                
                // 施術選択グリッドを生成
                const grid = document.querySelector('.treatment-selection-grid');
                grid.innerHTML = '';
                
                this.treatmentMenus.forEach((treatment, treatmentIndex) => {
                    // メイン項目を追加
                    const hasSubItems = treatment.subItems && treatment.subItems.length > 0;
                    const isSelected = treatmentTypes.includes(treatment.name);
                    const item = document.createElement('div');
                    
                    if (hasSubItems) {
                        // サブ項目がある場合は展開可能なアイテムとチェックボックス
                        item.className = 'treatment-selection-item expandable';
                        item.dataset.treatmentName = treatment.name;
                        
                        // メイン項目のチェック状態を判定（全サブ項目がチェックされていればチェック）
                        const allSubItemsChecked = treatment.subItems.every(subItem => 
                            treatmentTypes.includes(`${treatment.name} - ${subItem.name}`)
                        );
                        
                        const escapedName = treatment.name.replace(/'/g, "\\'");
                        // ユニークなIDを生成（treatmentIndexを使用）
                        const uniqueMainId = `treatment_main_${treatmentIndex}`;
                        
                        item.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <input type="checkbox" 
                                       id="${uniqueMainId}" 
                                       data-treatment-name="${treatment.name}"
                                       ${allSubItemsChecked ? 'checked' : ''}
                                       style="cursor: pointer;">
                                <span style="cursor: pointer; flex: 1; padding: 4px;"
                                      data-treatment-name="${treatment.name}"
                                      class="treatment-expand-trigger">
                                    ${treatment.name}
                                </span>
                            </div>
                        `;
                        
                        // イベントリスナーを追加
                        const checkbox = item.querySelector(`#${uniqueMainId}`);
                        if (checkbox) {
                            console.log(`🔗 Setting up main checkbox event listener: ID=${checkbox.id}, treatment=${treatment.name}`);
                            
                            // 同じIDを持つ要素が複数ないかチェック
                            const duplicateCheck = document.querySelectorAll(`#${checkbox.id}`);
                            if (duplicateCheck.length > 1) {
                                console.error(`❌ DUPLICATE ID FOUND: ${checkbox.id} appears ${duplicateCheck.length} times!`);
                            }
                            
                            checkbox.addEventListener('change', (e) => {
                                console.log(`🎯 Main checkbox event triggered: ${treatment.name}, checked=${e.target.checked}`);
                                this.toggleNurseMainTreatment(e.target, treatment.name);
                            });
                        }
                        
                        const expandTrigger = item.querySelector('.treatment-expand-trigger');
                        if (expandTrigger) {
                            expandTrigger.addEventListener('click', () => {
                                this.toggleTreatmentExpansion(treatment.name);
                            });
                        }
                        
                        if (allSubItemsChecked) {
                            item.classList.add('selected');
                        }
                    } else {
                        // サブ項目がない場合は通常のチェックボックス
                        item.className = `treatment-selection-item ${isSelected ? 'selected' : ''}`;
                        const escapedNameSimple = treatment.name.replace(/'/g, "\\'");
                        const safeSimpleId = treatment.name.replace(/[^a-zA-Z0-9_-]/g, '_');
                        item.innerHTML = `
                            <input type="checkbox" 
                                   id="treatment_${safeSimpleId}" 
                                   data-treatment-name="${treatment.name}"
                                   ${isSelected ? 'checked' : ''}>
                            <label for="treatment_${safeSimpleId}">${treatment.name}</label>
                        `;
                        
                        // イベントリスナーを追加
                        const simpleCheckbox = item.querySelector(`#treatment_${safeSimpleId}`);
                        if (simpleCheckbox) {
                            simpleCheckbox.addEventListener('change', (e) => {
                                this.toggleTreatmentSelection(e.target, treatment.name);
                            });
                        }
                    }
                    
                    grid.appendChild(item);
                    
                    // サブ項目を追加（初期は非表示）
                    if (hasSubItems) {
                        treatment.subItems.forEach((subItem, subIndex) => {
                            const subTreatmentName = `${treatment.name} - ${subItem.name}`;
                            const isSubSelected = treatmentTypes.includes(subTreatmentName);
                            const subItemElement = document.createElement('div');
                            subItemElement.className = `treatment-selection-item sub-item ${isSubSelected ? 'selected' : ''}`;
                            subItemElement.dataset.parent = treatment.name;
                            
                            const escapedSubName = subTreatmentName.replace(/'/g, "\\'");
                            // ユニークなIDを生成（メイン項目のインデックス + サブ項目のインデックス）
                            const uniqueId = `treatment_${treatmentIndex}_${subIndex}`;
                            
                            subItemElement.innerHTML = `
                                <input type="checkbox" 
                                       id="${uniqueId}" 
                                       data-treatment-name="${subTreatmentName}"
                                       ${isSubSelected ? 'checked' : ''}>
                                <label for="${uniqueId}">${subTreatmentName}</label>
                            `;
                            
                            // イベントリスナーを追加
                            const subCheckbox = subItemElement.querySelector(`#${uniqueId}`);
                            if (subCheckbox) {
                                console.log(`🔗 Setting up sub checkbox event listener: ID=${uniqueId}, treatment=${subTreatmentName}`);
                                
                                // 同じIDを持つ要素が複数ないかチェック
                                const duplicateCheck = document.querySelectorAll(`#${uniqueId}`);
                                if (duplicateCheck.length > 1) {
                                    console.error(`❌ DUPLICATE SUB ID FOUND: ${uniqueId} appears ${duplicateCheck.length} times!`);
                                }
                                
                                subCheckbox.addEventListener('change', (e) => {
                                    console.log(`🎯 Sub checkbox event triggered: ${subTreatmentName}, checked=${e.target.checked}`);
                                    this.toggleTreatmentSelection(e.target, subTreatmentName);
                                });
                            }
                            
                            grid.appendChild(subItemElement);
                        });
                    }
                });
                
                // 現在編集中の看護師を記録
                this.currentEditingNurse = nurseName;
                
                // モーダルを表示
                const modal = document.getElementById('nurseTreatmentModal');
                modal.style.display = 'block';
                bringToFront(modal);
            }

            // 施術選択の切り替え
            toggleTreatmentSelection(checkbox, treatmentName) {
                console.log('🔧 toggleTreatmentSelection called:', treatmentName, checkbox.checked);
                
                const item = checkbox.closest('.treatment-selection-item');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
                
                // サブ項目の場合、メイン項目のチェック状態を更新
                if (treatmentName.includes(' - ')) {
                    const mainTreatmentName = treatmentName.split(' - ')[0];
                    const mainTreatmentIndex = this.treatmentMenus.findIndex(t => t.name === mainTreatmentName);
                    const uniqueMainId = `treatment_main_${mainTreatmentIndex}`;
                    const mainCheckbox = document.getElementById(uniqueMainId);
                    console.log(`🚨 BEFORE reverse sync - Main checkbox state: ${mainCheckbox ? mainCheckbox.checked : 'NOT FOUND'}`);
                    
                    console.log('🔄 Processing sub-item change for reverse sync');
                    console.log('🎯 Main treatment name:', mainTreatmentName);
                    const treatment = this.treatmentMenus.find(t => t.name === mainTreatmentName);
                    console.log('📋 Found treatment:', treatment);
                    
                    if (treatment && treatment.subItems) {
                        // メイン項目のインデックスを取得
                        const mainTreatmentIndex = this.treatmentMenus.findIndex(t => t.name === mainTreatmentName);
                        console.log('🔢 Main treatment index:', mainTreatmentIndex);
                        
                        // 全サブ項目のチェック状態を確認
                        const allSubItemsChecked = treatment.subItems.every((subItem, subIndex) => {
                            const uniqueId = `treatment_${mainTreatmentIndex}_${subIndex}`;
                            const subCheckbox = document.getElementById(uniqueId);
                            console.log(`📝 Sub item ${subIndex}: ${subItem.name}, ID: ${uniqueId}, found: ${!!subCheckbox}, checked: ${subCheckbox ? subCheckbox.checked : 'N/A'}`);
                            return subCheckbox && subCheckbox.checked;
                        });
                        console.log('✅ All sub items checked result:', allSubItemsChecked);
                        
                        // メイン項目のチェックボックスを更新（treatmentIndexを使用）
                        const uniqueMainId = `treatment_main_${mainTreatmentIndex}`;
                        const mainCheckbox = document.getElementById(uniqueMainId);
                        console.log(`🔍 Looking for main checkbox: ${uniqueMainId}, found: ${!!mainCheckbox}`);
                        
                        if (mainCheckbox) {
                            console.log(`📋 Before update: main checkbox checked = ${mainCheckbox.checked}`);
                            console.log(`📋 Should be checked = ${allSubItemsChecked}`);
                            
                            // メイン項目の状態を更新するのは、実際に変更が必要な場合のみ
                            if (mainCheckbox.checked !== allSubItemsChecked) {
                                console.log('🔄 Main checkbox state needs update');
                                mainCheckbox.checked = allSubItemsChecked;
                                
                                // 視覚的な状態を強制更新
                                const mainItem = mainCheckbox.closest('.treatment-selection-item');
                                if (allSubItemsChecked) {
                                    mainItem.classList.add('selected');
                                    console.log('✅ Added selected class to main item');
                                } else {
                                    mainItem.classList.remove('selected');
                                    console.log('❌ Removed selected class from main item');
                                }
                                
                                console.log(`📋 After update: main checkbox checked = ${mainCheckbox.checked}`);
                            } else {
                                console.log('⚡ No update needed - main checkbox already in correct state');
                            }
                            
                            console.log('🔧 Visual update completed');
                        } else {
                            console.log('❌ Main checkbox not found!');
                        }
                    }
                }
            }

            // 施術メニューの展開/収納
            toggleTreatmentExpansion(treatmentName) {
                // dataset.treatmentNameはdata-treatment-nameとしてHTMLに出力される
                const expandableItems = document.querySelectorAll('.treatment-selection-item.expandable');
                let expandableItem = null;
                
                // 該当するアイテムを検索
                for (let item of expandableItems) {
                    if (item.dataset.treatmentName === treatmentName) {
                        expandableItem = item;
                        break;
                    }
                }
                
                const subItems = document.querySelectorAll(`.treatment-selection-item.sub-item[data-parent="${treatmentName}"]`);
                
                if (expandableItem && expandableItem.classList.contains('expanded')) {
                    // 収納
                    expandableItem.classList.remove('expanded');
                    subItems.forEach(item => {
                        item.classList.remove('visible');
                    });
                } else if (expandableItem) {
                    // 展開
                    expandableItem.classList.add('expanded');
                    subItems.forEach(item => {
                        item.classList.add('visible');
                    });
                }
            }

            // 看護師施術設定を保存
            saveNurseTreatmentSettings() {
                if (!this.currentEditingNurse) return;
                
                const nurse = this.nurses.find(n => (typeof n === 'string' ? n : n.name) === this.currentEditingNurse);
                if (!nurse) return;
                
                // 文字列形式の場合はオブジェクト形式に変換
                if (typeof nurse === 'string') {
                    const index = this.nurses.indexOf(nurse);
                    this.nurses[index] = { name: nurse, treatmentTypes: [] };
                    nurse = this.nurses[index];
                }
                
                // チェックされた施術を取得（メイン項目のチェックボックスは除外）
                const selectedTreatments = [];
                document.querySelectorAll('.treatment-selection-item input[type="checkbox"]:checked').forEach(checkbox => {
                    // メイン項目のチェックボックス（treatment_main_で始まる）は除外
                    if (!checkbox.id.startsWith('treatment_main_')) {
                        const treatmentName = checkbox.getAttribute('data-treatment-name');
                        if (treatmentName) {
                            selectedTreatments.push(treatmentName);
                        }
                    }
                });
                
                // 看護師の施術対応を更新
                nurse.treatmentTypes = selectedTreatments;
                
                console.log(`${this.currentEditingNurse}の施術対応を更新:`, selectedTreatments);
                
                // リストを再描画
                this.renderNursesList();
                this.renderTreatmentsList();
                
                // モーダルを閉じる
                this.closeNurseTreatmentModal();
                
                // 成功メッセージ
                this.showSuccessMessage(`${this.currentEditingNurse}の施術対応を更新しました。`);
            }

            // メイン項目のチェックボックスで全サブ項目を一括チェック/解除（看護師モーダル用）
            toggleNurseMainTreatment(checkbox, treatmentName) {
                console.log('🚀 toggleNurseMainTreatment called:', treatmentName, 'checked:', checkbox.checked);
                
                const treatment = this.treatmentMenus.find(t => t.name === treatmentName);
                
                if (!treatment || !treatment.subItems) {
                    console.log('❌ No treatment or no subItems found');
                    return;
                }
                console.log('✅ Treatment found with', treatment.subItems.length, 'sub items');
                
                const isChecked = checkbox.checked;
                console.log(`📋 Main checkbox state: checked = ${isChecked}`);
                
                const mainItem = checkbox.closest('.treatment-selection-item');
                
                // メイン項目のスタイルを更新
                if (isChecked) {
                    mainItem.classList.add('selected');
                    console.log('✅ Added selected class to main checkbox');
                } else {
                    mainItem.classList.remove('selected');
                    console.log('❌ Removed selected class from main checkbox');
                }
                
                // チェックボックスの状態を確実にする
                console.log(`📋 Confirming main checkbox: ${checkbox.checked}`);
                
                // まず該当するメイン項目のインデックスを取得
                const treatmentIndex = this.treatmentMenus.findIndex(t => t.name === treatmentName);
                console.log('🔢 Treatment index for forward sync:', treatmentIndex);
                
                // 全サブ項目のチェック状態を更新
                treatment.subItems.forEach((subItem, subIndex) => {
                    const uniqueId = `treatment_${treatmentIndex}_${subIndex}`;
                    const subCheckbox = document.getElementById(uniqueId);
                    console.log(`🔄 Updating sub item ${subIndex}: ${subItem.name}, ID: ${uniqueId}, found: ${!!subCheckbox}`);
                    
                    if (subCheckbox) {
                        console.log(`📋 Sub item before: checked = ${subCheckbox.checked}`);
                        subCheckbox.checked = isChecked;
                        console.log(`📋 Sub item after: checked = ${subCheckbox.checked}`);
                        
                        const subItemElement = subCheckbox.closest('.treatment-selection-item');
                        if (isChecked) {
                            subItemElement.classList.add('selected');
                        } else {
                            subItemElement.classList.remove('selected');
                        }
                    } else {
                        console.log(`❌ Sub item checkbox not found: ${uniqueId}`);
                    }
                });
                console.log('🎉 Forward sync completed');
            }
            
            // 看護師施術管理モーダルを閉じる
            closeNurseTreatmentModal() {
                document.getElementById('nurseTreatmentModal').style.display = 'none';
                this.currentEditingNurse = null;
            }
            

            // 施術メニューごとに対応可能な看護師数を計算
            getTreatmentNurseCount(treatmentName, subItemName = null) {
                // デバッグ出力
                if (treatmentName.includes('ｳﾙｾﾗ')) {
                    console.log(`🔍 [${treatmentName}${subItemName ? ' - ' + subItemName : ''}] getTreatmentNurseCount called`);
                }
                
                const result = this.nurses.filter(nurse => {
                    const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                    
                    if (subItemName) {
                        // サブ項目の場合：完全一致のみ
                        const fullSubItemName = `${treatmentName} - ${subItemName}`;
                        return treatmentTypes.includes(fullSubItemName);
                    } else {
                        // メイン項目の場合：サブ項目を持つ施術は全サブ項目に対応している看護師のみ
                        const treatmentMenu = this.treatmentMenus.find(menu => menu.name === treatmentName);
                        if (treatmentMenu && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                            // 全サブ項目に対応しているかチェック
                            return treatmentMenu.subItems.every(subItem => {
                                const fullSubItemName = `${treatmentName} - ${subItem.name}`;
                                return treatmentTypes.includes(fullSubItemName);
                            });
                        } else {
                            // サブ項目がない場合：完全一致のみ
                            return treatmentTypes.includes(treatmentName);
                        }
                    }
                });
                
                if (treatmentName.includes('ｳﾙｾﾗ')) {
                    console.log(`✅ [${treatmentName}${subItemName ? ' - ' + subItemName : ''}] Total nurses:`, result.length, result.map(n => n.name));
                }
                return result.length;
            }
            
            // 施術メニューに対応可能な看護師の名前リストを取得
            getTreatmentNurseNames(treatmentName, subItemName = null) {
                return this.nurses
                    .filter(nurse => {
                        const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                        
                        if (subItemName) {
                            // サブ項目の場合：完全一致のみ
                            const fullSubItemName = `${treatmentName} - ${subItemName}`;
                            return treatmentTypes.includes(fullSubItemName);
                        } else {
                            // メイン項目の場合：サブ項目を持つ施術は全サブ項目に対応している看護師のみ
                            const treatmentMenu = this.treatmentMenus.find(menu => menu.name === treatmentName);
                            if (treatmentMenu && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                                // 全サブ項目に対応しているかチェック
                                return treatmentMenu.subItems.every(subItem => {
                                    const fullSubItemName = `${treatmentName} - ${subItem.name}`;
                                    return treatmentTypes.includes(fullSubItemName);
                                });
                            } else {
                                // サブ項目がない場合：完全一致のみ
                                return treatmentTypes.includes(treatmentName);
                            }
                        }
                    })
                    .map(nurse => typeof nurse === 'string' ? nurse : nurse.name);
            }
            
            // 動的ツールチップの表示・位置調整
            showTooltip(badge, tooltip) {
                const badgeRect = badge.getBoundingClientRect();
                
                // ツールチップを常にbodyに移動（親要素のoverflowに影響されないように）
                if (tooltip.parentElement !== document.body) {
                    document.body.appendChild(tooltip);
                }
                
                // ツールチップを一時的に表示してサイズを取得
                tooltip.style.setProperty('visibility', 'hidden', 'important');
                tooltip.style.setProperty('display', 'block', 'important');
                tooltip.style.setProperty('opacity', '1', 'important');
                tooltip.style.setProperty('position', 'fixed', 'important');
                tooltip.style.setProperty('z-index', '999999', 'important');
                
                const tooltipRect = tooltip.getBoundingClientRect();
                
                // ツールチップを看護師カウントバッジの上部に配置
                const left = badgeRect.left + (badgeRect.width / 2) - (tooltipRect.width / 2);
                const top = badgeRect.top - tooltipRect.height - 10; // 10pxの余白
                
                // 画面端からはみ出る場合の調整
                const adjustedLeft = Math.max(10, Math.min(left, window.innerWidth - tooltipRect.width - 10));
                
                // 位置を設定し、表示する
                tooltip.style.setProperty('left', adjustedLeft + 'px', 'important');
                tooltip.style.setProperty('top', top + 'px', 'important');
                tooltip.style.setProperty('visibility', 'visible', 'important');
                
                // ツールチップ表示時のみバッジのz-indexを上げる
                badge.style.zIndex = '999999';
                
                tooltip.classList.add('show');
                
                // デバッグ: ツールチップの詳細情報
                const computedStyle = window.getComputedStyle(tooltip);
                const finalRect = tooltip.getBoundingClientRect();
                
                const isInModal = badge.closest('.modal-content') !== null;
                
                console.log('Tooltip shown:', {
                    badgeRect,
                    tooltipRect,
                    finalRect,
                    left: adjustedLeft,
                    top,
                    windowHeight: window.innerHeight,
                    windowWidth: window.innerWidth,
                    visible: tooltip.classList.contains('show'),
                    display: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    zIndex: computedStyle.zIndex,
                    position: computedStyle.position,
                    actualLeft: computedStyle.left,
                    actualTop: computedStyle.top,
                    tooltipContent: tooltip.textContent.trim(),
                    parentElement: tooltip.parentElement.tagName,
                    isInModal: isInModal,
                    tooltipInBody: tooltip.parentElement === document.body
                });
            }
            
            hideTooltip(tooltip) {
                // 対応するバッジを探してz-indexをリセット
                const allBadges = document.querySelectorAll('.nurse-count-badge');
                allBadges.forEach(badge => {
                    const badgeTooltip = badge.querySelector('.nurse-count-tooltip');
                    if (badgeTooltip === tooltip) {
                        badge.style.zIndex = '1';
                    }
                });
                
                tooltip.classList.remove('show');
                tooltip.style.setProperty('display', 'none', 'important');
                tooltip.style.setProperty('visibility', 'hidden', 'important');
                tooltip.style.setProperty('opacity', '0', 'important');
                console.log('Tooltip hidden');
            }
            
            // サブ項目追加ボタンのスタイルを強制適用
            forceButtonStyles() {
                // より詳細なデバッグ
                console.log('=== Button Debug Start ===');
                console.log('treatmentsList innerHTML:', document.getElementById('treatmentsList').innerHTML.substring(0, 500) + '...');
                
                const allButtons = document.querySelectorAll('button');
                console.log('All buttons found:', allButtons.length);
                allButtons.forEach((btn, i) => {
                    console.log(`Button ${i}:`, btn.className, btn.textContent);
                });
                
                const buttons = document.querySelectorAll('.btn-add-sub, button[onclick*="addSubItem"]');
                console.log('Found buttons to style:', buttons.length);
                
                const addSubButtons = document.querySelectorAll('button[onclick*="addSubItem"]');
                console.log('Found addSubItem buttons:', addSubButtons.length);
                
                const classButtons = document.querySelectorAll('.btn-add-sub');
                console.log('Found .btn-add-sub buttons:', classButtons.length);
                
                buttons.forEach((button, index) => {
                    console.log(`Styling button ${index}:`, button);
                    button.style.setProperty('background-color', '#22c55e', 'important');
                    button.style.setProperty('background', '#22c55e', 'important');
                    button.style.setProperty('color', '#ffffff', 'important');
                    button.style.setProperty('border', '0px solid transparent', 'important');
                    button.style.setProperty('border-style', 'none', 'important');
                    button.style.setProperty('padding', '5px 10px', 'important');
                    button.style.setProperty('border-radius', '4px', 'important');
                    button.style.setProperty('cursor', 'pointer', 'important');
                    button.style.setProperty('font-size', '11px', 'important');
                    button.style.setProperty('margin-right', '3px', 'important');
                    button.style.setProperty('font-weight', '500', 'important');
                    button.style.setProperty('width', 'auto', 'important');
                    button.style.setProperty('text-align', 'center', 'important');
                    button.style.setProperty('display', 'inline-block', 'important');
                    button.style.setProperty('text-decoration', 'none', 'important');
                });
            }

            // 看護師カウントバッジの初期化
            initializeNurseCountBadges() {
                const badges = document.querySelectorAll('.nurse-count-badge');
                console.log('Found badges:', badges.length);
                
                badges.forEach((badge, index) => {
                    // 全てのバッジのz-indexを明示的にリセット
                    badge.style.zIndex = '1';
                    
                    const tooltip = badge.querySelector('.nurse-count-tooltip');
                    console.log(`Badge ${index}:`, badge, 'Tooltip:', tooltip, 'z-index:', badge.style.zIndex);
                    
                    if (tooltip) {
                        console.log(`Adding event listeners to badge ${index}`);
                        
                        badge.addEventListener('mouseenter', () => {
                            console.log('Mouse enter on badge', index);
                            // ツールチップ表示時のみz-indexを上げる
                            badge.style.transform = 'scale(1.05)';
                            this.showTooltip(badge, tooltip);
                        });
                        
                        badge.addEventListener('mouseleave', () => {
                            console.log('Mouse leave on badge', index);
                            badge.style.transform = 'scale(1)';
                            this.hideTooltip(tooltip);
                        });
                    } else {
                        console.log(`No tooltip found for badge ${index}`);
                    }
                });
            }

            // 施術メニューリストの描画
            renderTreatmentsList() {
                const tbody = document.getElementById('treatmentsList');
                tbody.innerHTML = '';
                
                this.treatmentMenus.forEach((treatmentMenu, index) => {
                    const count = this.appointments.filter(apt => apt.treatmentType === treatmentMenu.name).length;
                    
                    // 間隔制限の表示文字列を作成
                    const getIntervalText = () => {
                        if (!treatmentMenu.intervalMin) {
                            return '<span style="color: #9ca3af;">なし</span>';
                        }
                        if (treatmentMenu.intervalMax) {
                            return `<span style="color: #059669; font-weight: 500;">${treatmentMenu.intervalMin}〜${treatmentMenu.intervalMax}日</span>`;
                        } else {
                            return `<span style="color: #059669; font-weight: 500;">${treatmentMenu.intervalMin}日以上</span>`;
                        }
                    };

                    // 日時制限の表示文字列を作成
                    const getRestrictionText = () => {
                        const restrictions = treatmentMenu.restrictions;
                        if (!restrictions || (!restrictions.blockedDays?.length && !restrictions.startTimeLimit)) {
                            return '<span style="color: #9ca3af;">なし</span>';
                        }
                        
                        const parts = [];
                        
                        // 曜日制限
                        if (restrictions.blockedDays && restrictions.blockedDays.length > 0) {
                            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                            const blockedDayNames = restrictions.blockedDays.map(day => dayNames[day]).join('・');
                            parts.push(`${blockedDayNames}曜除外`);
                        }
                        
                        // 時間制限
                        if (restrictions.startTimeLimit) {
                            parts.push(`${restrictions.startTimeLimit}以降不可`);
                        }
                        
                        return `<span style="color: #dc2626; font-weight: 500; font-size: 12px;">${parts.join('<br>')}</span>`;
                    };
                    
                    // 看護師数とリストを取得
                    const nurseCount = this.getTreatmentNurseCount(treatmentMenu.name);
                    const nurseNames = this.getTreatmentNurseNames(treatmentMenu.name);

                    // メイン項目の行
                    const mainRow = document.createElement('tr');
                    mainRow.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-block; width: 20px; height: 20px; background: ${treatmentMenu.color}; border: 2px solid ${treatmentMenu.borderColor}; border-radius: 4px;"></span>
                                <span style="font-weight: bold;">${treatmentMenu.name}</span>
                            </div>
                        </td>
                        <td style="text-align: center; position: relative; overflow: visible;">
                            ${treatmentMenu.subItems && treatmentMenu.subItems.length > 0 ? 
                                '<span style="color: #9ca3af;">-</span>' :
                                `<span class="nurse-count-badge ${nurseCount > 0 ? 'active' : 'zero'}">
                                    ${nurseCount}名
                                    <span class="nurse-count-tooltip">
                                        <div class="nurse-list-in-tooltip">
                                            ${nurseNames.length > 0 ? 
                                                nurseNames.join('、') :
                                                '<span style="color: #ef4444;">対応可能な看護師がいません</span>'
                                            }
                                        </div>
                                    </span>
                                </span>`
                            }
                        </td>
                        <td style="text-align: center;">
                            ${treatmentMenu.subItems && treatmentMenu.subItems.length > 0 ? 
                                '<span style="color: #9ca3af;">-</span>' : 
                                (treatmentMenu.defaultDuration ? 
                                    `<span class="clickable-setting" onclick="calendar.editTreatmentDuration(${index})" style="color: #059669; font-weight: 500; cursor: pointer;" title="クリックして編集">${treatmentMenu.defaultDuration}分</span>` : 
                                    '<span class="clickable-setting" onclick="calendar.editTreatmentDuration(' + index + ')" style="color: #9ca3af; cursor: pointer;" title="クリックして設定">未設定</span>')
                            }
                        </td>
                        <td style="text-align: center;">
                            ${treatmentMenu.subItems && treatmentMenu.subItems.length > 0 ? 
                                '<span style="color: #9ca3af;">-</span>' : 
                                `<span class="clickable-setting" onclick="calendar.editTreatmentDuration(${index})" style="cursor: pointer;" title="クリックして編集">${getIntervalText()}</span>`
                            }
                        </td>
                        <td style="text-align: center;">
                            ${treatmentMenu.subItems && treatmentMenu.subItems.length > 0 ? 
                                '<span style="color: #9ca3af;">-</span>' : 
                                `<span class="clickable-setting" onclick="calendar.editTreatmentDuration(${index})" style="cursor: pointer;" title="クリックして編集">${getRestrictionText()}</span>`
                            }
                        </td>
                        <td class="treatment-actions">
                            <div style="display: flex; justify-content: flex-end; align-items: center; width: 100%;">
                                <button class="btn-add-sub" onclick="calendar.addSubItem(${index})" title="サブ項目追加">+サブ項目</button>
                                <button class="btn-icon rename" onclick="calendar.editTreatmentName('${treatmentMenu.name}')" title="編集">✏️</button>
                                <button class="btn-icon delete" onclick="calendar.deleteTreatment('${treatmentMenu.name}')" title="削除">🗑️</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(mainRow);
                    
                    // サブ項目の行
                    if (treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                        treatmentMenu.subItems.forEach((subItem, subIndex) => {
                            const subCount = this.appointments.filter(apt => 
                                apt.treatmentType === treatmentMenu.name && apt.subItem === subItem.name
                            ).length;
                            
                            // サブ項目の間隔制限表示（親の設定を継承）
                            const getSubIntervalText = () => {
                                if (!treatmentMenu.intervalMin) {
                                    return '<span style="color: #9ca3af;">なし</span>';
                                }
                                if (treatmentMenu.intervalMax) {
                                    return `<span style="color: #059669; font-weight: 500;">${treatmentMenu.intervalMin}〜${treatmentMenu.intervalMax}日</span>`;
                                } else {
                                    return `<span style="color: #059669; font-weight: 500;">${treatmentMenu.intervalMin}日以上</span>`;
                                }
                            };

                            // サブ項目の日時制限表示
                            const getSubRestrictionText = () => {
                                const restrictions = subItem.restrictions;
                                if (!restrictions || !restrictions.weeklySchedule) {
                                    return '<span style="color: #9ca3af;">なし</span>';
                                }
                                
                                const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                                const parts = [];
                                
                                // 実施不可の曜日
                                const disabledDays = [];
                                [0, 2, 3, 4, 5, 6].forEach(day => {
                                    if (restrictions.weeklySchedule[day] && restrictions.weeklySchedule[day].enabled === false) {
                                        disabledDays.push(dayNames[day]);
                                    }
                                });
                                
                                if (disabledDays.length > 0) {
                                    parts.push(`${disabledDays.join('・')}曜除外`);
                                }
                                
                                // 時間制限がある曜日
                                const timeRestrictions = [];
                                [0, 2, 3, 4, 5, 6].forEach(day => {
                                    const schedule = restrictions.weeklySchedule[day];
                                    if (schedule && schedule.enabled && 
                                        (schedule.startTime !== '10:00' || 
                                         (day !== 6 && schedule.endTime !== '19:00') || 
                                         (day === 6 && schedule.endTime !== '17:00'))) {
                                        timeRestrictions.push(`${dayNames[day]}: ${schedule.startTime}~${schedule.endTime}`);
                                    }
                                });
                                
                                if (timeRestrictions.length > 0) {
                                    parts.push(timeRestrictions.join('<br>'));
                                }
                                
                                if (parts.length === 0) {
                                    return '<span style="color: #9ca3af;">なし</span>';
                                }
                                
                                return `<span style="color: #dc2626; font-weight: 500; font-size: 11px; line-height: 1.3;">${parts.join('<br>')}</span>`;
                            };

                            const subRow = document.createElement('tr');
                            subRow.style.backgroundColor = '#f9f9f9';
                            subRow.innerHTML = `
                                <td style="padding-left: 12px;">
                                    <div class="sub-item-content">
                                        <span class="sub-item-icon" style="background: ${treatmentMenu.color};"></span>
                                        <span class="sub-item-name">${subItem.name}</span>
                                    </div>
                                </td>
                                <td style="text-align: center; position: relative; overflow: visible;">
                                    <span class="nurse-count-badge ${(() => {
                                        const subNurseCount = this.getTreatmentNurseCount(treatmentMenu.name, subItem.name);
                                        return subNurseCount > 0 ? 'active' : 'zero';
                                    })()}">
                                        ${(() => {
                                            const subNurseCount = this.getTreatmentNurseCount(treatmentMenu.name, subItem.name);
                                            const subNurseNames = this.getTreatmentNurseNames(treatmentMenu.name, subItem.name);
                                            return `${subNurseCount}名
                                                <span class="nurse-count-tooltip">
                                                    <div class="nurse-list-in-tooltip">
                                                        ${subNurseNames.length > 0 ? 
                                                            subNurseNames.join('、') :
                                                            '<span style="color: #ef4444;">対応可能な看護師がいません</span>'
                                                        }
                                                    </div>
                                                </span>`;
                                        })()}
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    ${subItem.defaultDuration ? 
                                        `<span class="clickable-setting" onclick="calendar.editSubItemDuration(${index}, ${subIndex})" style="color: #059669; font-weight: 500; cursor: pointer;" title="クリックして編集">${subItem.defaultDuration}分</span>` : 
                                        `<span class="clickable-setting" onclick="calendar.editSubItemDuration(${index}, ${subIndex})" style="color: #9ca3af; cursor: pointer;" title="クリックして設定">未設定</span>`
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <span class="clickable-setting" onclick="calendar.editSubItemDuration(${index}, ${subIndex})" style="cursor: pointer;" title="クリックして編集">
                                        ${getSubIntervalText()}
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <span class="clickable-setting" onclick="calendar.editSubItemDuration(${index}, ${subIndex})" style="cursor: pointer;" title="クリックして編集">
                                        ${getSubRestrictionText()}
                                    </span>
                                </td>
                                <td class="treatment-actions">
                                    <span class="btn-spacer"></span>
                                    <button class="btn-icon rename" onclick="calendar.editSubItemName(${index}, ${subIndex})" title="サブ項目編集">✏️</button>
                                    <button class="btn-icon delete" onclick="calendar.deleteSubItem(${index}, ${subIndex})" title="サブ項目削除">🗑️</button>
                                </td>
                            `;
                            tbody.appendChild(subRow);
                        });
                    }
                });
                
                // 看護師カウントバッジのイベントリスナーを初期化
                setTimeout(() => this.initializeNurseCountBadges(), 100);
                
                // サブ項目追加ボタンのスタイルを強制適用
                setTimeout(() => this.forceButtonStyles(), 150);
            }

            // ドラッグ&ドロップハンドラ
            handleDragStart(e, index) {
                this.isDragging = true;
                this.draggedIndex = index;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.innerHTML);
                e.target.style.opacity = '0.5';
                
                // ドラッグ中の表示を設定
                const dragImage = document.createElement('div');
                dragImage.style.backgroundColor = this.treatmentMenus[index].color;
                dragImage.style.padding = '8px 16px';
                dragImage.style.borderRadius = '4px';
                dragImage.style.border = `2px solid ${this.treatmentMenus[index].borderColor}`;
                dragImage.textContent = this.treatmentMenus[index].name;
                dragImage.style.position = 'absolute';
                dragImage.style.top = '-100px';
                document.body.appendChild(dragImage);
                e.dataTransfer.setDragImage(dragImage, 50, 20);
                setTimeout(() => document.body.removeChild(dragImage), 0);
            }
            
            handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            handleDragEnter(e, index) {
                if (this.isDragging && index !== this.draggedIndex) {
                    e.target.style.border = '3px solid #10b981';
                    e.target.style.borderRadius = '8px';
                    e.target.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    e.target.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.3)';
                    e.target.style.transform = 'scale(1.02)';
                }
            }
            
            handleDragLeave(e) {
                e.target.style.border = '';
                e.target.style.borderRadius = '';
                e.target.style.boxShadow = '';
                e.target.style.transform = '';
                // 背景色を元の色に復元する
                this.resetElementBackgroundColor(e.target);
            }
            
            handleDrop(e, dropIndex) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                // ドロップ先のスタイルをリセット
                e.target.style.border = '';
                e.target.style.borderRadius = '';
                e.target.style.boxShadow = '';
                e.target.style.transform = '';
                // 背景色を正しい色に復元
                this.resetElementBackgroundColor(e.target);
                
                if (this.draggedIndex !== null && this.draggedIndex !== dropIndex) {
                    // 配列の要素を移動
                    const draggedItem = this.treatmentMenus[this.draggedIndex];
                    this.treatmentMenus.splice(this.draggedIndex, 1);
                    this.treatmentMenus.splice(dropIndex, 0, draggedItem);
                    
                    // treatments配列も更新
                    this.treatments = this.treatmentMenus.map(t => t.name);
                    
                    // UIを更新
                    this.renderTreatmentsList();
                    this.renderScheduleTable();
                    this.renderAppointments();
                    
                    // フィルターオプションも更新
                    this.updateTreatmentOptions();
                    
                    this.showSuccessMessage('並び順を変更しました');
                }
                
                // ドロップ完了時のスタイルリセット（上記でhandleDropでも実行済み）
                return false;
            }
            
            handleDragEnd(e) {
                this.isDragging = false;
                this.draggedIndex = null;
                e.target.style.opacity = '';
                
                // すべてのヘッダーのスタイルをリセット
                document.querySelectorAll('#scheduleHeader th').forEach(th => {
                    th.style.border = '';
                    th.style.borderRadius = '';
                    th.style.boxShadow = '';
                    th.style.transform = '';
                    th.style.opacity = '';
                    // 背景色を正しい色に復元
                    this.resetElementBackgroundColor(th);
                });
            }
            
            
            // 要素の背景色を正しい施術メニューの色に復元するメソッド
            resetElementBackgroundColor(element) {
                const elementText = element.textContent.trim();
                const treatmentMenu = this.treatmentMenus.find(menu => menu.name === elementText);
                if (treatmentMenu) {
                    element.style.backgroundColor = treatmentMenu.color;
                }
            }
            
            // 施術メニューの並び順変更
            moveTreatmentUp(index) {
                if (index > 0) {
                    // 配列の要素を入れ替え
                    [this.treatmentMenus[index], this.treatmentMenus[index - 1]] = 
                    [this.treatmentMenus[index - 1], this.treatmentMenus[index]];
                    
                    // treatments配列も更新
                    this.treatments = this.treatmentMenus.map(t => t.name);
                    
                    // UIを更新
                    this.renderTreatmentsList();
                    this.renderScheduleTable();
                    this.renderAppointments();
                    
                    // フィルターオプションも更新
                    this.updateTreatmentOptions();
                    
                    this.showSuccessMessage('並び順を変更しました');
                }
            }
            
            moveTreatmentDown(index) {
                if (index < this.treatmentMenus.length - 1) {
                    // 配列の要素を入れ替え
                    [this.treatmentMenus[index], this.treatmentMenus[index + 1]] = 
                    [this.treatmentMenus[index + 1], this.treatmentMenus[index]];
                    
                    // treatments配列も更新
                    this.treatments = this.treatmentMenus.map(t => t.name);
                    
                    // UIを更新
                    this.renderTreatmentsList();
                    this.renderScheduleTable();
                    this.renderAppointments();
                    
                    // フィルターオプションも更新
                    this.updateTreatmentOptions();
                    
                    this.showSuccessMessage('並び順を変更しました');
                }
            }
            
            // 並び順のリセット
            resetTreatmentOrder() {
                // デフォルトの順序に戻す - 新しい施術メニューをリセット
                // 元のデータ構造を再構築
                this.treatmentMenus = [
                    { id: 1, name: 'ﾎﾞﾄ', color: '#fee2e2', borderColor: '#ef4444', defaultDuration: 30, subItems: [], isExpanded: false },
                    { id: 2, name: 'ﾋｱﾙ', color: '#dbeafe', borderColor: '#3b82f6', defaultDuration: 45, subItems: [], isExpanded: false },
                    { id: 3, name: '水光(院)', color: '#dcfce7', borderColor: '#22c55e', defaultDuration: 60, subItems: [], isExpanded: false },
                    { id: 4, name: 'QR', color: '#f3e8ff', borderColor: '#a855f7', defaultDuration: 45, subItems: [], isExpanded: false },
                    { id: 5, name: 'CO2', color: '#fef3c7', borderColor: '#f59e0b', defaultDuration: 30, subItems: [], isExpanded: false },
                    { id: 6, name: '糸ﾘﾌﾄ', color: '#fed7aa', borderColor: '#fb923c', defaultDuration: 90, subItems: [], isExpanded: false }
                ];
                
                // treatments配列も更新
                this.treatments = this.treatmentMenus.map(t => t.name);
                
                // UIを更新
                this.renderTreatmentsList();
                this.renderScheduleTable();
                this.renderAppointments();
                
                // フィルターオプションも更新
                this.updateTreatmentOptions();
                
                this.showSuccessMessage('並び順をデフォルトにリセットしました');
            }

            // デバイスリストの描画
            renderDevicesList() {
                const tbody = document.getElementById('devicesList');
                tbody.innerHTML = '';
                
                // 現在表示中の日付の文字列を取得（YYYY-MM-DD形式）
                const currentDateString = this.formatDateForId(this.currentDate);
                const displayDate = this.formatDateForDisplay(this.currentDate);
                
                // ヘッダーの日付を更新
                const devicesHeader = document.querySelector('#devicesContent thead th:nth-child(2)');
                if (devicesHeader) {
                    devicesHeader.textContent = `使用件数(${displayDate})`;
                }
                
                this.devices.forEach(device => {
                    // 現在表示中の日付の予約のみをカウント
                    const count = this.appointments.filter(apt => 
                        apt.device === device && apt.date === currentDateString
                    ).length;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${device}</td>
                        <td>
                            <span class="count-badge ${count > 0 ? 'active' : 'zero'}">${count}件</span>
                        </td>
                        <td class="device-actions">
                            <button class="btn-icon rename" onclick="calendar.editDeviceName('${device}')" title="編集">✏️</button>
                            <button class="btn-icon delete" onclick="calendar.deleteDevice('${device}')" title="削除">🗑️</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            // インライン編集開始
            startEdit(type, oldValue) {
                event.stopPropagation();
                const element = event.target;
                
                // 既に編集中の場合は何もしない
                if (element.querySelector('.edit-input')) return;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'edit-input';
                input.value = oldValue;
                
                // エンターキーで保存
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.saveEdit(type, oldValue, input.value);
                    } else if (e.key === 'Escape') {
                        this.cancelEdit(element, oldValue);
                    }
                });
                
                // フォーカスが外れたら保存
                input.addEventListener('blur', () => {
                    this.saveEdit(type, oldValue, input.value);
                });
                
                element.innerHTML = '';
                element.appendChild(input);
                input.focus();
                input.select();
            }

            // 編集をキャンセル
            cancelEdit(element, oldValue) {
                element.innerHTML = oldValue;
            }

            // 編集を保存
            saveEdit(type, oldValue, newValue) {
                newValue = newValue.trim();
                
                if (!newValue || newValue === oldValue) {
                    this.renderManageLists();
                    return;
                }
                
                let array, updateFunction;
                
                switch (type) {
                    case 'nurse':
                        array = this.nurses;
                        updateFunction = () => {
                            this.appointments.forEach(apt => {
                                if (apt.nurse === oldValue) apt.nurse = newValue;
                            });
                            this.updateNurseOptions();
                        };
                        break;
                    case 'treatment':
                        // 施術メニューの名称変更
                        const treatmentMenu = this.treatmentMenus.find(t => t.name === oldValue);
                        if (treatmentMenu) {
                            treatmentMenu.name = newValue;
                        }
                        
                        // 後方互換性配列も更新
                        this.treatments = this.treatmentMenus.map(t => t.name);
                        array = this.treatments;
                        
                        updateFunction = () => {
                            // 既存予約の施術タイプも更新
                            this.appointments.forEach(apt => {
                                if (apt.treatmentType === oldValue) apt.treatmentType = newValue;
                            });
                            
                            // UI全体を更新
                            this.updateTreatmentOptions();
                            this.render(); // ヘッダー含めて再描画
                            
                            console.log(`✅ 施術メニュー名変更: 「${oldValue}」→「${newValue}」`);
                        };
                        break;
                    case 'device':
                        array = this.devices;
                        updateFunction = () => {
                            this.appointments.forEach(apt => {
                                if (apt.device === oldValue) apt.device = newValue;
                            });
                            this.updateDeviceOptions();
                        };
                        break;
                }
                
                // 重複チェック
                if (array.includes(newValue)) {
                    alert(`「${newValue}」は既に存在します。`);
                    this.renderManageLists();
                    return;
                }
                
                // 更新
                const index = array.indexOf(oldValue);
                if (index !== -1) {
                    array[index] = newValue;
                    updateFunction();
                    this.render();
                    this.renderManageLists();
                    this.showSuccessMessage(`「${oldValue}」を「${newValue}」に変更しました。`);
                }
            }

            // 削除確認モーダルを開く
            openDeleteConfirmModal(type, name, affectedAppointments) {
                const modal = document.getElementById('deleteConfirmationModal');
                const warningText = document.getElementById('deleteWarningText');
                const affectedSection = document.getElementById('affectedAppointmentsSection');
                const affectedList = document.getElementById('affectedAppointmentsList');
                
                let typeText = '';
                let warningMessage = '';
                switch (type) {
                    case 'nurse': 
                        typeText = '看護師'; 
                        warningMessage = `<strong>「${name}」</strong>を削除しようとしています。`;
                        break;
                    case 'treatment': 
                        typeText = '施術メニュー'; 
                        warningMessage = `<strong>「${name}」</strong>を削除しようとしています。`;
                        break;
                    case 'device': 
                        typeText = 'デバイス'; 
                        warningMessage = `<strong>「${name}」</strong>を削除しようとしています。`;
                        break;
                    case 'subitem':
                        typeText = 'サブ項目';
                        warningMessage = `<strong>「${name}」</strong>を削除しようとしています。`;
                        break;
                    case 'appointment':
                        typeText = '予約';
                        // 終了時間を計算
                        const endTime = name.startTime && name.duration ? 
                            this.calculateEndTime(name.startTime, name.duration) : '';
                        
                        // 日付をフォーマット
                        const appointmentDate = new Date(name.date);
                        const formattedDate = `${appointmentDate.getFullYear()}年${appointmentDate.getMonth() + 1}月${appointmentDate.getDate()}日`;
                        
                        // 患者IDの表示（存在する場合）
                        const patientIdDisplay = name.patientId ? `（${name.patientId}）` : '';
                        
                        warningMessage = `
                            <div style="text-align: left; line-height: 1.6;">
                                <p style="margin-bottom: 15px; font-weight: bold; color: #dc2626;">以下の予約を削除しようとしています：</p>
                                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                                    <p style="margin: 5px 0;"><strong>◆ 患者:</strong> ${name.patientName}様${patientIdDisplay}</p>
                                    <p style="margin: 5px 0;"><strong>◆ 日時:</strong> ${formattedDate} ${name.startTime}${endTime ? `-${endTime}` : ''}${name.duration ? `（${name.duration}分間）` : ''}</p>
                                    <p style="margin: 5px 0;"><strong>◆ 施術:</strong> ${name.treatmentType || '未設定'}</p>
                                    <p style="margin: 5px 0;"><strong>◆ 担当:</strong> ${name.nurse || '未設定'}</p>
                                    ${name.device ? `<p style="margin: 5px 0;"><strong>◆ デバイス:</strong> ${name.device}</p>` : ''}
                                </div>
                                <p style="margin-top: 15px; font-weight: bold; color: #dc2626;">本当に削除してもよろしいですか？</p>
                                <p style="margin-top: 8px; font-size: 12px; color: #666;">※ 削除後は復元することができません。</p>
                            </div>
                        `;
                        break;
                }
                
                warningText.innerHTML = warningMessage;
                
                if (affectedAppointments.length > 0) {
                    affectedSection.style.display = 'block';
                    
                    // 時系列で昇順ソート（日付→時間の順）
                    const sortedAppointments = affectedAppointments.sort((a, b) => {
                        const dateCompare = new Date(a.date) - new Date(b.date);
                        if (dateCompare !== 0) return dateCompare;
                        
                        // 同じ日付の場合は時間で比較
                        const timeA = a.startTime.split(':').map(Number);
                        const timeB = b.startTime.split(':').map(Number);
                        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                    });
                    
                    affectedList.innerHTML = sortedAppointments.map(apt => `
                        <tr>
                            <td>${apt.date}</td>
                            <td>${apt.startTime}-${this.calculateEndTime(apt.startTime, apt.duration)}</td>
                            <td>${apt.patientName}</td>
                            <td>${apt.treatmentType}</td>
                        </tr>
                    `).join('');
                } else {
                    affectedSection.style.display = 'none';
                }
                
                // 削除実行ボタンの設定
                document.getElementById('confirmDeleteBtn').onclick = () => {
                    this.executeDelete(type, name);
                    this.closeDeleteConfirmationModal();
                };
                
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }

            closeDeleteConfirmationModal() {
                document.getElementById('deleteConfirmationModal').style.display = 'none';
            }

            // 重複エラーモーダルを表示
            showResourceConflictModal(conflicts) {
                const modal = document.getElementById('resourceConflictModal');
                const detailsList = document.getElementById('conflictDetailsList');
                
                // 重複詳細を表示
                detailsList.innerHTML = conflicts.map(conflict => {
                    const endTime = this.minutesToTime(this.timeToMinutes(conflict.appointment.startTime) + conflict.appointment.duration);
                    let icon, resourceType, message;
                    
                    if (conflict.type === 'time') {
                        icon = '⏰';
                        resourceType = '予約時間';
                        message = `${conflict.appointment.startTime}-${endTime} 「${conflict.appointment.patientName}様」の予約と重複`;
                    } else if (conflict.type === 'nurse') {
                        icon = '👩‍⚕️';
                        resourceType = '看護師';
                        message = `${conflict.appointment.startTime}-${endTime} 「${conflict.appointment.patientName}様」の予約で使用中`;
                    } else if (conflict.type === 'device') {
                        icon = '🔧';
                        resourceType = 'デバイス';
                        message = `${conflict.appointment.startTime}-${endTime} 「${conflict.appointment.patientName}様」の予約で使用中`;
                    } else if (conflict.type === 'patient') {
                        icon = '👤';
                        resourceType = '患者様';
                        message = `${conflict.appointment.startTime}-${endTime} 既存の予約があります`;
                    }
                    
                    return `
                        <div class="conflict-item">
                            <div class="conflict-icon">${icon}</div>
                            <div class="conflict-info">
                                <div class="conflict-resource">
                                    ${resourceType}「${conflict.resource}」
                                </div>
                                <div class="conflict-appointment">
                                    ${message}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }
            
            // 重複エラーモーダルを閉じる
            closeResourceConflictModal() {
                document.getElementById('resourceConflictModal').style.display = 'none';
            }

            closeDeleteConfirmModal() {
                document.getElementById('deleteConfirmationModal').style.display = 'none';
            }

            // 削除実行
            executeDelete(type, name) {
                switch (type) {
                    case 'nurse':
                        // 未完了の予約のみ「未設定」に変更（完了済みは保護）
                        this.appointments.forEach(apt => {
                            if (apt.nurse === name && !this.isCompletedAppointment(apt.date)) {
                                apt.nurse = '未設定';
                            }
                        });
                        this.nurses = this.nurses.filter(n => n !== name);
                        this.updateNurseOptions();
                        break;
                    case 'treatment':
                        // 未完了の予約のみ「未設定」に変更（完了済みは保護）
                        this.appointments.forEach(apt => {
                            if (apt.treatmentType === name && !this.isCompletedAppointment(apt.date)) {
                                apt.treatmentType = '未設定';
                                console.log(`予約ID${apt.id}の施術メニューを「未設定」に変更`);
                            }
                        });
                        
                        // 施術メニューを削除
                        this.treatmentMenus = this.treatmentMenus.filter(t => t.name !== name);
                        this.treatments = this.treatmentMenus.map(t => t.name);
                        
                        // UI全体を更新
                        this.updateTreatmentOptions();
                        this.render(); // ヘッダー含めて再描画
                        break;
                    case 'device':
                        // 未完了の予約のみデバイスを削除（完了済みは保護）
                        this.appointments.forEach(apt => {
                            if (apt.device === name && !this.isCompletedAppointment(apt.date)) {
                                apt.device = '';
                            }
                        });
                        this.devices = this.devices.filter(d => d !== name);
                        this.updateDeviceOptions();
                        break;
                    case 'subitem':
                        // サブ項目削除処理
                        if (this.pendingSubItemDelete) {
                            const { treatmentIndex, subIndex } = this.pendingSubItemDelete;
                            const treatmentMenu = this.treatmentMenus[treatmentIndex];
                            const subItem = treatmentMenu.subItems[subIndex];
                            
                            // サブ項目を削除
                            treatmentMenu.subItems.splice(subIndex, 1);
                            
                            // 関連する予約のサブ項目をクリア
                            this.appointments.forEach(apt => {
                                if (apt.treatmentType === treatmentMenu.name && apt.subItem === subItem.name) {
                                    apt.subItem = '';
                                }
                            });
                            
                            // 削除情報をクリア
                            delete this.pendingSubItemDelete;
                            
                            // UI更新
                            this.render();
                            this.renderManageLists();
                            
                            this.showSuccessMessage(`サブ項目「${subItem.name}」を削除しました。`);
                        }
                        break;
                    case 'appointment':
                        // 予約を削除
                        const appointmentIndex = this.appointments.findIndex(apt => 
                            apt.id === name.id || 
                            apt.id === String(name.id) || 
                            String(apt.id) === String(name.id)
                        );
                        
                        if (appointmentIndex !== -1) {
                            this.appointments.splice(appointmentIndex, 1);
                            // オンライン同期
                            dataManager.saveAllData();
                            this.render();
                            this.renderAppointments();
                            
                            // 予約編集モーダルが開いている場合は閉じる
                            const appointmentModal = document.getElementById('appointmentModal');
                            if (appointmentModal && appointmentModal.style.display === 'block') {
                                appointmentModal.style.display = 'none';
                            }
                            
                            // 履歴モーダルが開いている場合は再表示
                            const historyModal = document.getElementById('patientHistoryModal');
                            if (historyModal && historyModal.style.display === 'block') {
                                const currentPatientId = document.getElementById('historyModalTitle').textContent.match(/\(([^)]+)\)/)?.[1];
                                if (currentPatientId) {
                                    this.showPatientHistory(currentPatientId);
                                }
                            }
                        }
                        break;
                }
                
                if (type !== 'appointment') {
                    this.render();
                    this.renderManageLists();
                }
                
                const successMessage = type === 'appointment' ? 
                    `${name.patientName}様の予約を削除しました。` : 
                    `「${name}」を削除しました。`;
                this.showSuccessMessage(successMessage);
            }

            // 各削除メソッド
            deleteNurse(name) {
                // 未完了の予約のみを対象にする
                const affectedAppointments = this.appointments.filter(apt => 
                    apt.nurse === name && !this.isCompletedAppointment(apt.date)
                );
                this.openDeleteConfirmModal('nurse', name, affectedAppointments);
            }

            deleteTreatment(name) {
                // 未完了の予約のみを対象にする
                const affectedAppointments = this.appointments.filter(apt => 
                    apt.treatmentType === name && !this.isCompletedAppointment(apt.date)
                );
                this.openDeleteConfirmModal('treatment', name, affectedAppointments);
            }

            deleteDevice(name) {
                // 未完了の予約のみを対象にする
                const affectedAppointments = this.appointments.filter(apt => 
                    apt.device === name && !this.isCompletedAppointment(apt.date)
                );
                this.openDeleteConfirmModal('device', name, affectedAppointments);
            }

            // 追加メソッド
            addNurse() {
                const input = document.getElementById('newNurseName');
                const name = input.value.trim();
                
                if (!name) {
                    alert('看護師名を入力してください。');
                    return;
                }
                
                if (this.nurses.includes(name)) {
                    alert('この看護師名は既に存在します。');
                    return;
                }
                
                this.nurses.push(name);
                input.value = '';
                this.updateNurseOptions();
                this.renderNursesList();
                this.showSuccessMessage(`看護師「${name}」を追加しました。`);
            }

            // ============ 所要時間管理機能 ============
            
            // 所要時間データの初期化
            initializeDurations() {
                const storedDurations = localStorage.getItem('durations');
                if (storedDurations) {
                    this.durations = JSON.parse(storedDurations);
                } else {
                    // デフォルトの所要時間
                    this.durations = [30, 40, 45, 50, 60, 65, 70, 75, 80, 90, 120, 180];
                    this.saveDurations();
                }
                this.updateDurationOptions();
            }

            // 所要時間データの保存
            saveDurations() {
                localStorage.setItem('durations', JSON.stringify(this.durations));
            }

            // 所要時間管理モーダルを開く
            openDurationManageModal() {
                const modal = document.getElementById('durationManageModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に表示
                this.renderDurationList();
            }

            // 所要時間管理モーダルを閉じる
            closeDurationManageModal() {
                document.getElementById('durationManageModal').style.display = 'none';
            }

            // 所要時間追加
            addDuration() {
                const input = document.getElementById('newDuration');
                const duration = parseInt(input.value);
                
                if (!duration || duration < 5) {
                    alert('5分以上の値を入力してください。');
                    return;
                }
                
                if (duration % 5 !== 0) {
                    alert('5分単位で入力してください。');
                    return;
                }
                
                if (this.durations.includes(duration)) {
                    alert('この所要時間は既に存在します。');
                    return;
                }
                
                this.durations.push(duration);
                this.durations.sort((a, b) => a - b); // 昇順ソート
                this.saveDurations();
                this.updateDurationOptions();
                this.renderDurationList();
                input.value = '';
                this.showSuccessMessage(`所要時間「${duration}分」を追加しました。`);
            }

            // 所要時間削除
            deleteDuration(duration) {
                // 既存予約での使用状況をチェック
                const usageCount = this.getAppointmentCountByDuration(duration);
                
                if (usageCount > 0) {
                    if (!confirm(`この所要時間は${usageCount}件の予約で使用されています。\n削除しても既存の予約には影響しませんが、新規予約では選択できなくなります。\n削除しますか？`)) {
                        return;
                    }
                }
                
                this.durations = this.durations.filter(d => d !== duration);
                this.saveDurations();
                this.updateDurationOptions();
                this.renderDurationList();
                this.showSuccessMessage(`所要時間「${duration}分」を削除しました。`);
            }

            // 特定の所要時間を使用している予約件数を取得
            getAppointmentCountByDuration(duration) {
                return this.appointments.filter(apt => apt.duration === duration).length;
            }

            // 所要時間リストの表示
            renderDurationList() {
                const tbody = document.getElementById('durationList');
                tbody.innerHTML = this.durations.map(duration => {
                    const deleteButton = `<button class="btn-icon delete" onclick="calendar.deleteDuration(${duration})" title="削除">🗑️</button>`;
                    
                    return `
                        <tr>
                            <td>${duration}分</td>
                            <td>${deleteButton}</td>
                        </tr>
                    `;
                }).join('');
            }

            // 所要時間選択肢の更新
            updateDurationOptions() {
                const durationSelect = document.getElementById('duration');
                const durationEditSelect = document.getElementById('durationEditValue');
                
                // 新規予約用のselect（「選択してください」表示）
                if (durationSelect) {
                    const currentValue = durationSelect.value;
                    durationSelect.innerHTML = '<option value="">選択してください</option>' +
                        this.durations.map(duration => 
                            `<option value="${duration}">${duration}分</option>`
                        ).join('');
                    
                    // 以前の選択値を復元（可能な場合）
                    if (currentValue && this.durations.includes(parseInt(currentValue))) {
                        durationSelect.value = currentValue;
                    }
                }
                
                // 標準時間編集用のselect（「未設定」も選択可能）
                if (durationEditSelect) {
                    const currentValue = durationEditSelect.value;
                    durationEditSelect.innerHTML = '<option value="">未設定</option>' +
                        this.durations.map(duration => 
                            `<option value="${duration}">${duration}分</option>`
                        ).join('');
                    
                    // 以前の選択値を復元（可能な場合）
                    if (currentValue === '' || (currentValue && this.durations.includes(parseInt(currentValue)))) {
                        durationEditSelect.value = currentValue;
                    }
                }
            }

            addTreatment() {
                const input = document.getElementById('newTreatmentName');
                const name = input.value.trim();
                
                if (!name) {
                    alert('施術メニュー名を入力してください。');
                    return;
                }
                
                if (this.treatmentMenus.some(t => t.name === name)) {
                    alert('この施術メニューは既に存在します。');
                    return;
                }
                
                // 【新機能】自動カラー割り当て
                const availableColors = this.colorPalette.filter(palette => 
                    !this.treatmentMenus.some(menu => menu.color === palette.color)
                );
                
                const assignedColor = availableColors.length > 0 
                    ? availableColors[0] 
                    : this.colorPalette[this.treatmentMenus.length % this.colorPalette.length];
                
                // 新しい施術メニューを追加
                const newTreatment = {
                    id: this.nextTreatmentId++,
                    name: name,
                    color: assignedColor.color,
                    borderColor: assignedColor.borderColor
                };
                
                this.treatmentMenus.push(newTreatment);
                
                // 後方互換性のための配列も更新
                this.treatments = this.treatmentMenus.map(t => t.name);
                
                input.value = '';
                
                // 【重要】UI全体を更新
                this.updateTreatmentOptions();
                this.render(); // ヘッダーも含めて完全再描画
                this.renderTreatmentsList();
                
                console.log(`✅ 施術メニュー追加完了:`, {
                    名前: name,
                    カラー: assignedColor.color,
                    ボーダー: assignedColor.borderColor
                });
                
                this.showSuccessMessage(`施術メニュー「${name}」を追加しました。`);
            }

            addDevice() {
                const input = document.getElementById('newDeviceName');
                const name = input.value.trim();
                
                if (!name) {
                    alert('デバイス名を入力してください。');
                    return;
                }
                
                if (this.devices.includes(name)) {
                    alert('このデバイスは既に存在します。');
                    return;
                }
                
                this.devices.push(name);
                input.value = '';
                this.updateDeviceOptions();
                this.renderDevicesList();
                this.showSuccessMessage(`デバイス「${name}」を追加しました。`);
            }

            // 患者管理機能
            searchPatients() {
                const searchInput = document.getElementById('patientSearch');
                const searchTerm = searchInput.value.trim();
                
                // 各メッセージエリアの要素を取得
                const initialMessage = document.getElementById('patientInitialMessage');
                const loadingMessage = document.getElementById('patientLoadingMessage');
                const noResultsMessage = document.getElementById('patientNoResultsMessage');
                const resultsArea = document.getElementById('patientResultsArea');
                
                // すべてのメッセージを非表示
                this.hideAllPatientMessages();
                
                // 検索文字数チェック
                if (searchTerm.length === 0) {
                    // 空の場合は初期メッセージを表示
                    initialMessage.style.display = 'flex';
                    this.currentPatientPage = 1;
                    return;
                } else if (searchTerm.length < 2) {
                    // 1文字の場合は初期メッセージを表示
                    initialMessage.style.display = 'flex';
                    return;
                }
                
                // 検索開始 - ローディング表示
                loadingMessage.style.display = 'flex';
                
                // 少し遅延を入れてリアルタイム感を演出
                setTimeout(() => {
                    const filteredPatients = this.patients.filter(patient => 
                        patient.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        patient.nameHiragana.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        patient.id.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    // ローディングを非表示
                    loadingMessage.style.display = 'none';
                    
                    if (filteredPatients.length === 0) {
                        // 検索結果なし
                        noResultsMessage.style.display = 'flex';
                    } else {
                        // 検索結果あり - 結果エリアを表示
                        resultsArea.style.display = 'block';
                        this.currentPatientPage = 1;
                        this.renderPatientsList(filteredPatients);
                    }
                }, 300); // 300ms の遅延
            }
            
            hideAllPatientMessages() {
                document.getElementById('patientInitialMessage').style.display = 'none';
                document.getElementById('patientLoadingMessage').style.display = 'none';
                document.getElementById('patientNoResultsMessage').style.display = 'none';
                document.getElementById('patientResultsArea').style.display = 'none';
            }

            renderPatientsList(patients = this.patients) {
                const tbody = document.getElementById('patientsList');
                const pagination = document.getElementById('patientPagination');
                
                const startIndex = (this.currentPatientPage - 1) * this.patientsPerPage;
                const endIndex = startIndex + this.patientsPerPage;
                const paginatedPatients = patients.slice(startIndex, endIndex);


                // テーブル行の生成（来院回数は予約データから動的に計算）
                tbody.innerHTML = paginatedPatients.map(patient => {
                    // 予約データから実際の来院回数を計算
                    const actualVisitCount = this.appointments.filter(apt => String(apt.patientId) === String(patient.id)).length;
                    
                    const marksHtml = this.generatePatientMarksHtml(patient.marks || []);
                    
                    return `
                    <tr>
                        <td>
                            ${patient.id} ${marksHtml}
                        </td>
                        <td>${patient.name}</td>
                        <td>${actualVisitCount}回</td>
                        <td class="patient-actions">
                            <button class="btn-icon view" onclick="event.stopPropagation(); calendar.openPatientHistoryModal('${patient.id}')" title="履歴表示">📋</button>
                            <button class="btn-icon rename" onclick="calendar.editPatientName('${patient.id}', '${patient.name.replace(/'/g, '\\\'')}')" title="編集">✏️</button>
                            <button class="btn-icon delete" onclick="calendar.deletePatient('${patient.id}')" title="削除">🗑️</button>
                        </td>
                    </tr>
                `}).join('');

                // ページネーションの更新
                const totalPages = Math.ceil(patients.length / this.patientsPerPage);
                pagination.innerHTML = `
                    <span>全${patients.length}件中 ${startIndex + 1}-${Math.min(endIndex, patients.length)}件を表示</span>
                    <div class="pagination-controls">
                        <button onclick="calendar.previousPatientPage()" ${this.currentPatientPage === 1 ? 'disabled' : ''}>前へ</button>
                        <span>ページ ${this.currentPatientPage} / ${totalPages}</span>
                        <button onclick="calendar.nextPatientPage()" ${endIndex >= patients.length ? 'disabled' : ''}>次へ</button>
                    </div>
                `;
            }

            previousPatientPage() {
                if (this.currentPatientPage > 1) {
                    this.currentPatientPage--;
                    this.searchPatients();
                }
            }

            nextPatientPage() {
                const totalPages = Math.ceil(this.patients.length / this.patientsPerPage);
                if (this.currentPatientPage < totalPages) {
                    this.currentPatientPage++;
                    this.searchPatients();
                }
            }

            openNewPatientModal() {
                const modal = document.getElementById('newPatientModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
                document.getElementById('newPatientId').value = this.generatePatientId();
                document.getElementById('newPatientName').value = '';
                document.getElementById('newPatientHiragana').value = '';
                
                // マークチェックボックスを生成
                const marksContainer = document.getElementById('newPatientMarks');
                marksContainer.innerHTML = this.generateMarkCheckboxes([]);
                
                // 予約モーダルのフィールドが無効化されている場合は有効化
                this.enableFormFields();
            }

            generatePatientId() {
                const existingIds = this.patients.map(p => parseInt(p.id.substring(1)));
                const maxId = Math.max(...existingIds, 0);
                return `P${String(maxId + 1).padStart(3, '0')}`;
            }

            saveNewPatient() {
                const id = document.getElementById('newPatientId').value.trim();
                const name = document.getElementById('newPatientName').value.trim();
                const nameHiragana = document.getElementById('newPatientHiragana').value.trim();
                
                // 選択されたマークを取得
                const selectedMarks = [];
                document.querySelectorAll('input[name="patientMarks"]:checked').forEach(checkbox => {
                    selectedMarks.push(checkbox.value);
                });

                if (!id || !name || !nameHiragana) {
                    alert('すべての項目を入力してください。');
                    return;
                }

                if (this.patients.find(p => p.id === id)) {
                    alert('このカルテIDは既に使用されています。');
                    return;
                }

                const newPatient = {
                    id: id,
                    name: name,
                    nameHiragana: nameHiragana,
                    registrationDate: new Date().toISOString().split('T')[0],
                    totalVisits: 0,
                    lastVisit: '',
                    marks: selectedMarks,
                    history: []
                };

                this.patients.push(newPatient);
                this.searchPatients();
                this.closeNewPatientModal();
                this.showSuccessMessage(`患者「${name}」を登録しました。`);
            }

            closeNewPatientModal() {
                document.getElementById('newPatientModal').style.display = 'none';
            }

            openPatientDetailModal(patientId) {
                // 文字列として比較（型の不一致を回避）
                const patient = this.patients.find(p => String(p.id) === String(patientId));
                if (!patient) return;

                document.getElementById('patientDetailId').textContent = patient.id;
                document.getElementById('patientDetailName').textContent = patient.name;
                document.getElementById('patientDetailHiragana').textContent = patient.nameHiragana;
                // 登録日に曜日を追加
                const registrationDisplay = patient.registrationDate 
                    ? this.formatDateWithDayOfWeek(new Date(patient.registrationDate)) 
                    : '';
                document.getElementById('patientDetailRegistration').textContent = registrationDisplay;
                document.getElementById('patientDetailVisits').textContent = patient.totalVisits;
                // 最終来院日に曜日を追加
                const lastVisitDisplay = patient.lastVisit && patient.lastVisit !== '未来院' 
                    ? this.formatDateWithDayOfWeek(new Date(patient.lastVisit)) 
                    : '未来院';
                document.getElementById('patientDetailLastVisit').textContent = lastVisitDisplay;

                this.renderPatientHistory(patient, 'all');
                document.getElementById('patientDetailModal').style.display = 'block';
            }

            renderPatientHistory(patient, period = 'all') {
                const historyContainer = document.getElementById('patientHistory');
                let filteredHistory = [...patient.history];

                if (period === '30days') {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    filteredHistory = filteredHistory.filter(h => new Date(h.date) >= thirtyDaysAgo);
                } else if (period === '3months') {
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    filteredHistory = filteredHistory.filter(h => new Date(h.date) >= threeMonthsAgo);
                }

                filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyContainer.innerHTML = filteredHistory.length > 0 
                    ? filteredHistory.map(h => {
                        // 日付に曜日を追加
                        const dateWithDayOfWeek = this.formatDateWithDayOfWeek(new Date(h.date));
                        return `
                            <div class="history-item">
                                <div class="history-date">${dateWithDayOfWeek}</div>
                                <div class="history-treatment">${h.treatment}</div>
                                <div class="history-nurse">${h.nurse}</div>
                            </div>
                        `;
                    }).join('')
                    : '<div class="no-history">施術履歴がありません</div>';
            }

            filterPatientHistory(period) {
                const patientId = document.getElementById('patientDetailId').textContent;
                const patient = this.patients.find(p => p.id === patientId);
                if (patient) {
                    this.renderPatientHistory(patient, period);
                    
                    // ボタンのアクティブ状態を更新
                    document.querySelectorAll('.history-filter .btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                }
            }

            closePatientDetailModal() {
                document.getElementById('patientDetailModal').style.display = 'none';
            }

            // 患者履歴表示モーダル（新機能）
            openPatientHistoryModal(patientId) {
                // 予約件数表示はモーダル表示時も表示し続ける
                
                console.log('履歴モーダル開始:', {
                    検索する患者ID: patientId,
                    患者ID型: typeof patientId,
                    全患者ID一覧: this.patients.map(p => ({id: p.id, name: p.name, type: typeof p.id}))
                });
                
                // より詳細なデバッグ情報
                console.log('🔍 患者検索詳細:', {
                    検索対象患者ID: patientId,
                    患者配列全体: this.patients,
                    検索結果: this.patients.find(p => p.id === patientId),
                    完全一致チェック: this.patients.map(p => ({
                        患者ID: p.id, 
                        一致: p.id === patientId,
                        厳密比較: p.id === patientId && typeof p.id === typeof patientId
                    }))
                });
                
                // 文字列として比較（型の不一致を回避）
                const patient = this.patients.find(p => String(p.id) === String(patientId));
                if (!patient) {
                    console.error('❌ 患者が見つかりません:', patientId);
                    console.error('利用可能な患者ID:', this.patients.map(p => p.id));
                    alert('患者データが見つかりません。患者ID: ' + patientId);
                    return;
                }
                
                console.log('見つかった患者:', patient);

                // 患者統計情報を更新（予約データベース）
                this.updatePatientStats(patient);

                // 基本情報を設定
                document.getElementById('historyPatientId').textContent = patient.id;
                
                // 患者名とマークを設定
                const patientNameElement = document.getElementById('historyPatientName');
                const marksHtml = this.generatePatientMarksHtml(patient.marks || []);
                patientNameElement.innerHTML = `${patient.name}${marksHtml ? ' ' + marksHtml : ''}`;
                document.getElementById('historyPatientVisits').textContent = `${patient.totalVisits}回`;
                // 履歴モーダルの最終来院日にも曜日を追加
                const historyLastVisitDisplay = patient.lastVisit && patient.lastVisit !== '未来院' 
                    ? this.formatDateWithDayOfWeek(new Date(patient.lastVisit)) 
                    : '未来院';
                document.getElementById('historyPatientLastVisit').textContent = historyLastVisitDisplay;

                // 履歴データを準備（予約データから生成）
                this.currentHistoryPatient = patient;
                this.currentHistoryFilter = 'all';
                
                // 履歴を表示
                this.renderHistoryModal(patient, 'all');
                
                // モーダルを表示
                const modal = document.getElementById('patientHistoryModal');
                console.log('モーダル表示前の確認:', {
                    モーダル要素: modal ? '存在' : '見つからない',
                    現在のdisplay: modal ? modal.style.display : 'N/A'
                });
                
                if (modal) {
                    modal.style.display = 'block';
                    // 他のモーダルのz-indexを一時的に下げる
                    const manageModal = document.getElementById('manageModal');
                    if (manageModal) {
                        const currentManageZIndex = manageModal.style.zIndex;
                        manageModal.style.zIndex = '5000'; // 一時的に低い値に
                        console.log('データ管理モーダルのz-indexを一時的に下げました:', currentManageZIndex, '→ 5000');
                    }
                    
                    // 予約編集モーダルのz-indexも一時的に下げる
                    const editModal = document.getElementById('editModal');
                    if (editModal && editModal.style.display === 'block') {
                        const currentEditZIndex = editModal.style.zIndex;
                        editModal.style.zIndex = '5000'; // 一時的に低い値に
                        console.log('予約編集モーダルのz-indexを一時的に下げました:', currentEditZIndex, '→ 5000');
                    }
                    
                    // 最後にbringToFrontで最前面に
                    bringToFront(modal);
                    console.log('モーダル表示設定完了。新しいdisplay:', modal.style.display);
                    console.log('モーダルの実際の表示状態:', window.getComputedStyle(modal).display);
                    
                    // 確実に最前面に表示するため、少し遅らせてもう一度実行
                    setTimeout(() => {
                        bringToFront(modal);
                        console.log('🔍 z-index比較:', {
                            履歴モーダル: modal.style.zIndex,
                            データ管理モーダル: manageModal ? manageModal.style.zIndex : 'N/A',
                            globalMaxZIndex: globalMaxZIndex
                        });
                    }, 10);
                } else {
                    console.error('patientHistoryModalが見つかりません！');
                }
            }
            
            // 患者統計情報を予約データから更新
            updatePatientStats(patient) {
                // 文字列として比較（型の不一致を回避）
                const patientAppointments = this.appointments.filter(apt => String(apt.patientId) === String(patient.id));
                
                // 来院回数を更新
                patient.totalVisits = patientAppointments.length;
                
                // 最終来院日を更新
                if (patientAppointments.length > 0) {
                    const latestDate = patientAppointments
                        .map(apt => new Date(apt.date))
                        .sort((a, b) => b - a)[0];
                    patient.lastVisit = latestDate.toISOString().split('T')[0];
                } else {
                    patient.lastVisit = '未来院';
                }
                
                console.log('患者統計更新:', {
                    患者: patient.name,
                    来院回数: patient.totalVisits,
                    最終来院: patient.lastVisit
                });
            }
            
            // 患者履歴データのクリーンアップ（重複除去）
            cleanupPatientHistory() {
                this.patients.forEach(patient => {
                    if (patient.history && patient.history.length > 0) {
                        const patientAppointments = this.appointments.filter(apt => apt.patientId === patient.id);
                        
                        // 予約データと重複する履歴データを除去
                        patient.history = patient.history.filter(historyItem => {
                            const isDuplicate = patientAppointments.some(apt => 
                                apt.date === historyItem.date &&
                                apt.treatmentType === historyItem.treatment &&
                                (apt.startTime === historyItem.startTime || !historyItem.startTime)
                            );
                            return !isDuplicate;
                        });
                        
                        console.log(`患者 ${patient.name} の履歴クリーンアップ完了:`, {
                            予約データ: patientAppointments.length,
                            履歴データ: patient.history.length
                        });
                    }
                    
                    // 統計情報も更新
                    this.updatePatientStats(patient);
                });
                
                console.log('✅ 全患者の履歴データクリーンアップ完了');
            }

            renderHistoryModal(patient, period = 'all') {
                console.log('履歴モーダル描画開始:', {
                    患者: patient.name,
                    患者ID: patient.id,
                    期間フィルタ: period
                });
                
                // 患者の予約データから履歴を生成（文字列として比較）
                const patientAppointments = this.appointments.filter(apt => String(apt.patientId) === String(patient.id));
                
                console.log('予約データフィルタ結果:', {
                    全予約数: this.appointments.length,
                    患者の予約数: patientAppointments.length,
                    患者ID検索条件: patient.id,
                    全予約一覧: this.appointments.map(apt => ({
                        予約ID: apt.id,
                        患者ID: apt.patientId,
                        患者名: apt.patientName,
                        日付: apt.date
                    }))
                });
                
                // 予約データを履歴形式に変換
                let historyData = patientAppointments.map(apt => ({
                    id: apt.id, // 編集用にIDを保持
                    date: apt.date,
                    startTime: apt.startTime,
                    treatment: apt.subItem ? `${apt.treatmentType}-${apt.subItem}` : apt.treatmentType,
                    nurse: apt.nurse,
                    device: apt.device || 'なし',
                    duration: apt.duration,
                    isAppointment: true, // 予約データかどうかのフラグ
                    source: 'appointment' // データソースを明確化
                }));

                // 過去の履歴データは削除済みのため、この処理は不要
                
                // 施術メニューフィルターを構築
                this.buildTreatmentFilter(historyData);
                
                console.log('履歴データ統合結果:', {
                    予約データ数: patientAppointments.length,
                    履歴データ数: patient.history ? patient.history.length : 0,
                    統合後データ数: historyData.length,
                    患者ID: patient.id,
                    患者名: patient.name
                });
                
                console.log('田中花子さんの予約データ詳細:', patientAppointments.map(apt => ({
                    予約ID: apt.id,
                    患者ID: apt.patientId,
                    患者名: apt.patientName,
                    日付: apt.date,
                    施術: apt.treatmentType
                })));
                
                // 8/16の予約を特別にチェック
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                console.log('明日（8/16）の日付文字列:', tomorrowStr);
                
                const aug16Appointments = patientAppointments.filter(apt => apt.date === tomorrowStr);
                console.log('8/16の予約:', aug16Appointments.length > 0 ? aug16Appointments : '見つかりません');

                // 期間フィルタリング
                if (period === '30days') {
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    historyData = historyData.filter(h => new Date(h.date) >= thirtyDaysAgo);
                } else if (period === '3months') {
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    historyData = historyData.filter(h => new Date(h.date) >= threeMonthsAgo);
                } else if (period === 'future') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    historyData = historyData.filter(h => new Date(h.date) > today);
                } else if (period === 'past') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    historyData = historyData.filter(h => new Date(h.date) < today);
                }

                // 施術メニューフィルターを適用
                historyData = this.applyTreatmentFilter(historyData);
                
                // 日付の新しい順でソート
                historyData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                console.log('フィルタ後の履歴データ:', {
                    期間フィルタ: period,
                    フィルタ後データ数: historyData.length,
                    データ詳細: historyData
                });
                
                // 各データの日付を詳しく表示
                console.log('履歴データの日付一覧:');
                historyData.forEach((item, index) => {
                    console.log(`  ${index + 1}. 日付: ${item.date}, 施術: ${item.treatment}, 時間: ${item.startTime}`);
                });

                // テーブルを更新
                const tbody = document.getElementById('historyModalList');
                const noDataDiv = document.getElementById('historyNoData');
                
                console.log('テーブル要素の確認:', {
                    tbody要素: tbody ? '存在' : '見つからない',
                    noDataDiv要素: noDataDiv ? '存在' : '見つからない'
                });
                
                if (historyData.length === 0) {
                    console.log('履歴データが0件のため、NoDataを表示');
                    tbody.innerHTML = '';
                    noDataDiv.style.display = 'block';
                } else {
                    console.log(`履歴データ ${historyData.length}件を表示します`);
                    noDataDiv.style.display = 'none';
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const htmlContent = historyData.map(item => {
                        const itemDate = new Date(item.date);
                        itemDate.setHours(0, 0, 0, 0);
                        
                        let status = '';
                        let statusIcon = '';
                        let rowClass = '';
                        let editButton = '';
                        
                        if (itemDate.getTime() === today.getTime()) {
                            // 今日
                            status = '今日';
                            statusIcon = '🔄';
                            rowClass = 'history-today';
                            editButton = item.isAppointment ? `<button class="btn-icon edit" onclick="calendar.editFromHistory('${item.id}')" title="編集">⚙️</button><button class="btn-icon delete" onclick="calendar.deleteFromHistory('${item.id}')" title="削除">🗑️</button>` : '';
                        } else if (itemDate > today) {
                            // 未来
                            status = '予定';
                            statusIcon = '📅';
                            rowClass = 'history-future';
                            editButton = item.isAppointment ? `<button class="btn-icon edit" onclick="calendar.editFromHistory('${item.id}')" title="編集">⚙️</button><button class="btn-icon delete" onclick="calendar.deleteFromHistory('${item.id}')" title="削除">🗑️</button>` : '';
                        } else {
                            // 過去（完了済み）
                            status = '完了';
                            statusIcon = '✓';
                            rowClass = 'history-past';
                            
                            // 完了済みは歯車ボタン非表示、ゴミ箱ボタンのみ表示
                            editButton = (item.isAppointment !== false) ? `<button class="btn-icon delete" onclick="calendar.deleteFromHistory('${item.id}')" title="削除">🗑️</button>` : '';
                        }
                        
                        // 終了時間を計算
                        const endTime = item.startTime && item.duration ? 
                            calendar.calculateEndTime(item.startTime, item.duration) : '';
                        const timeDisplay = item.startTime ? 
                            (endTime ? `${item.startTime}-${endTime}${item.duration ? `(${item.duration}分)` : ''}` : item.startTime) : '';
                        
                        // 日付に曜日を追加
                        const dateWithDayOfWeek = this.formatDateWithDayOfWeek(new Date(item.date));
                        
                        return `
                            <tr class="${rowClass}">
                                <td>
                                    <span class="status-icon">${statusIcon}</span>
                                    ${dateWithDayOfWeek}
                                    <span class="status-label">${status}</span>
                                </td>
                                <td>${timeDisplay}</td>
                                <td>${item.treatment}</td>
                                <td>${item.nurse}</td>
                                <td>${item.device}</td>
                                <td class="history-actions">${editButton}</td>
                            </tr>
                        `;
                    }).join('');
                    
                    console.log('生成されたHTML長さ:', htmlContent.length);
                    console.log('生成されたHTML（最初の500文字）:', htmlContent.substring(0, 500));
                    
                    tbody.innerHTML = htmlContent;
                    
                    console.log('テーブルにHTML設定完了。実際のtbody内容:', tbody.innerHTML.length > 0 ? 'データあり' : '空');
                }
            }

            filterHistoryDisplay(period) {
                if (!this.currentHistoryPatient) return;
                
                this.currentHistoryFilter = period;
                this.renderHistoryModal(this.currentHistoryPatient, period);
                
                // ボタンのアクティブ状態を更新
                document.querySelectorAll('.history-filter .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            // 施術メニューフィルターを構築
            buildTreatmentFilter(historyData) {
                // この患者が受けた施術メニューを抽出
                const patientTreatments = [...new Set(historyData.map(item => item.treatment))];
                
                // 施術メニューをメイン項目とサブ項目に分類
                const treatmentGroups = {};
                
                // まず、患者が受けた全ての施術を個別項目として追加
                patientTreatments.forEach(treatment => {
                    // システムの施術メニューにあるかチェック
                    const systemMenu = this.treatmentMenus.find(menu => {
                        if (menu.subItems && menu.subItems.length > 0) {
                            // サブ項目がある場合：メイン項目-サブ項目 形式をチェック
                            return menu.subItems.some(sub => `${menu.name}-${sub.name}` === treatment);
                        } else {
                            // サブ項目がない場合：メイン項目名と一致するかチェック
                            return menu.name === treatment;
                        }
                    });
                    
                    if (systemMenu) {
                        if (systemMenu.subItems && systemMenu.subItems.length > 0) {
                            // サブ項目がある施術の場合
                            const subName = treatment.replace(`${systemMenu.name}-`, '');
                            if (!treatmentGroups[systemMenu.name]) {
                                treatmentGroups[systemMenu.name] = {
                                    main: systemMenu.name,
                                    subs: []
                                };
                            }
                            if (!treatmentGroups[systemMenu.name].subs.includes(subName)) {
                                treatmentGroups[systemMenu.name].subs.push(subName);
                            }
                        } else {
                            // サブ項目がない施術の場合
                            treatmentGroups[treatment] = {
                                main: treatment,
                                subs: []
                            };
                        }
                    } else {
                        // システムメニューにない項目も個別に表示
                        treatmentGroups[treatment] = {
                            main: treatment,
                            subs: []
                        };
                    }
                });
                
                // フィルターHTMLを構築
                this.renderTreatmentFilter(treatmentGroups);
            }
            
            // 施術メニューフィルターのHTMLを生成（プルタブ形式）
            renderTreatmentFilter(treatmentGroups) {
                const container = document.getElementById('treatmentCheckboxes');
                if (!container) return;
                
                const hasData = Object.keys(treatmentGroups).length > 0;
                const filterDiv = document.getElementById('historyTreatmentFilter');
                
                if (!hasData) {
                    filterDiv.style.display = 'none';
                    return;
                }
                
                filterDiv.style.display = 'block';
                
                let html = '';
                let mainIndex = 0;
                Object.keys(treatmentGroups).forEach(mainName => {
                    const group = treatmentGroups[mainName];
                    const safeMainName = `main_${mainIndex}`;  // インデックスベースの一意なID
                    mainIndex++;
                    
                    if (group.subs.length > 0) {
                        // メイン項目チェックボックス（クリックで展開・折りたたみ）
                        // labelの代わりにdivを使用してイベント処理を分離
                        html += `
                            <div class="checkbox-item checkbox-item-main" data-main-name="${safeMainName}" style="cursor: pointer; display: flex; align-items: center;">
                                <input type="checkbox" id="treatment-main-${mainName}" 
                                       onchange="calendar.toggleMainTreatment('${mainName}')" 
                                       data-treatment-main="${mainName}"
                                       style="margin-right: 8px;">
                                <span class="treatment-expand-icon" id="expand-icon-${safeMainName}" style="margin-right: 4px;">▶</span>
                                <span class="treatment-main-label" data-safe-name="${safeMainName}">${mainName}</span>
                            </div>
                        `;
                        
                        // サブ項目コンテナ（初期状態は非表示）
                        html += `<div class="treatment-sub-container" id="treatment-subs-${safeMainName}" style="display: none;">`;
                        
                        // サブ項目チェックボックス
                        group.subs.forEach(subName => {
                            const fullName = `${mainName}-${subName}`;
                            html += `
                                <label class="checkbox-item checkbox-item-sub">
                                    <input type="checkbox" id="treatment-sub-${fullName}" 
                                           onchange="calendar.toggleSubTreatment('${mainName}', '${subName}')" 
                                           data-treatment-sub="${fullName}">
                                    <span>└ ${subName}</span>
                                </label>
                            `;
                        });
                        
                        html += '</div>';
                    } else {
                        // サブ項目がない施術
                        html += `
                            <label class="checkbox-item">
                                <input type="checkbox" id="treatment-single-${mainName}" 
                                       onchange="calendar.toggleSingleTreatment('${mainName}')" 
                                       data-treatment-single="${mainName}">
                                <span>${mainName}</span>
                            </label>
                        `;
                    }
                });
                
                container.innerHTML = html;
                
                // 展開アイコンとラベルにクリックイベントを追加
                container.querySelectorAll('.treatment-expand-icon, .treatment-main-label').forEach(element => {
                    element.addEventListener('click', (event) => {
                        event.stopPropagation();
                        
                        // safeMainNameを取得
                        let safeMainName;
                        if (element.classList.contains('treatment-expand-icon')) {
                            safeMainName = element.id.replace('expand-icon-', '');
                        } else {
                            safeMainName = element.dataset.safeName;
                        }
                        
                        const icon = document.getElementById(`expand-icon-${safeMainName}`);
                        const subContainer = document.getElementById(`treatment-subs-${safeMainName}`);
                        
                        console.log('展開クリック:', safeMainName, subContainer); // デバッグ用
                        
                        if (subContainer) {
                            if (subContainer.style.display === 'none') {
                                subContainer.style.display = 'block';
                                icon.classList.add('expanded');
                                icon.textContent = '▼';
                            } else {
                                subContainer.style.display = 'none';
                                icon.classList.remove('expanded');
                                icon.textContent = '▶';
                            }
                        }
                    });
                });
                
                // 現在の選択状態を復元
                this.restoreTreatmentFilterState();
                this.updateTreatmentFilterDisplay();
            }
            
            // メイン施術のトグル
            toggleMainTreatment(mainName) {
                const mainCheckbox = document.getElementById(`treatment-main-${mainName}`);
                const subCheckboxes = document.querySelectorAll(`[data-treatment-sub^="${mainName}-"]`);
                
                subCheckboxes.forEach(checkbox => {
                    checkbox.checked = mainCheckbox.checked;
                });
                
                this.updateTreatmentFilterDisplay();
                this.applyHistoryFilters();
            }
            
            // サブ施術のトグル
            toggleSubTreatment(mainName, subName) {
                const allSubs = document.querySelectorAll(`[data-treatment-sub^="${mainName}-"]`);
                const checkedSubs = document.querySelectorAll(`[data-treatment-sub^="${mainName}-"]:checked`);
                const mainCheckbox = document.getElementById(`treatment-main-${mainName}`);
                
                if (mainCheckbox) {
                    mainCheckbox.checked = checkedSubs.length === allSubs.length;
                    mainCheckbox.indeterminate = checkedSubs.length > 0 && checkedSubs.length < allSubs.length;
                }
                
                this.updateTreatmentFilterDisplay();
                this.applyHistoryFilters();
            }
            
            // 単一施術のトグル
            toggleSingleTreatment(treatmentName) {
                this.updateTreatmentFilterDisplay();
                this.applyHistoryFilters();
            }
            
            // 全施術のトグル
            toggleAllTreatments(checkbox) {
                const isChecked = checkbox.checked;
                
                document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]').forEach(cb => {
                    cb.checked = isChecked;
                });
                
                this.updateTreatmentFilterDisplay();
                this.applyHistoryFilters();
            }
            
            // 施術フィルター表示を更新
            updateTreatmentFilterDisplay() {
                const allCheckbox = document.getElementById('allTreatments');
                const allTreatmentCheckboxes = document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]');
                const checkedTreatmentCheckboxes = document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]:checked');
                const display = document.getElementById('treatmentFilterDisplay');
                
                if (!display) return;
                
                if (checkedTreatmentCheckboxes.length === 0) {
                    // 何も選択されていない場合
                    allCheckbox.checked = false;
                    display.textContent = 'なし';
                } else if (checkedTreatmentCheckboxes.length === allTreatmentCheckboxes.length) {
                    // 全て選択されている場合
                    allCheckbox.checked = true;
                    allCheckbox.indeterminate = false;
                    display.textContent = '全て';
                } else {
                    // 一部選択されている場合
                    allCheckbox.checked = false;
                    allCheckbox.indeterminate = true;
                    
                    // 「●個選択中」形式で表示
                    display.textContent = `${checkedTreatmentCheckboxes.length}個選択中`;
                }
            }
            
            // 施術フィルター状態を保存
            saveTreatmentFilterState() {
                const checkedTreatments = [];
                document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.dataset.treatmentSub) {
                        checkedTreatments.push(checkbox.dataset.treatmentSub);
                    } else if (checkbox.dataset.treatmentSingle) {
                        checkedTreatments.push(checkbox.dataset.treatmentSingle);
                    }
                });
                this.currentTreatmentFilter = checkedTreatments;
            }
            
            // 施術フィルター状態を復元
            restoreTreatmentFilterState() {
                if (!this.currentTreatmentFilter) {
                    // 初期状態では全て選択
                    const allTreatmentsCheckbox = document.getElementById('allTreatments');
                    if (allTreatmentsCheckbox) {
                        allTreatmentsCheckbox.checked = true;
                    }
                    
                    document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    
                    this.updateTreatmentFilterDisplay();
                    return;
                }
                
                // 保存された状態を復元
                this.currentTreatmentFilter.forEach(treatment => {
                    const subCheckbox = document.querySelector(`[data-treatment-sub="${treatment}"]`);
                    const singleCheckbox = document.querySelector(`[data-treatment-single="${treatment}"]`);
                    
                    if (subCheckbox) {
                        subCheckbox.checked = true;
                    } else if (singleCheckbox) {
                        singleCheckbox.checked = true;
                    }
                });
                
                // メインチェックボックスの状態を更新
                this.updateMainCheckboxStates();
                this.updateTreatmentFilterDisplay();
            }
            
            // メインチェックボックスの状態を更新
            updateMainCheckboxStates() {
                document.querySelectorAll('[data-treatment-main]').forEach(mainCheckbox => {
                    const mainName = mainCheckbox.dataset.treatmentMain;
                    const allSubs = document.querySelectorAll(`[data-treatment-sub^="${mainName}-"]`);
                    const checkedSubs = document.querySelectorAll(`[data-treatment-sub^="${mainName}-"]:checked`);
                    
                    if (allSubs.length > 0) {
                        mainCheckbox.checked = checkedSubs.length === allSubs.length;
                        mainCheckbox.indeterminate = checkedSubs.length > 0 && checkedSubs.length < allSubs.length;
                    }
                });
            }
            
            // 施術メニューフィルターを適用
            applyTreatmentFilter(historyData) {
                const treatmentFilterContainer = document.getElementById('treatmentCheckboxes');
                
                // フィルターが構築されていない場合は全て表示
                if (!treatmentFilterContainer || treatmentFilterContainer.children.length === 0) {
                    return historyData;
                }
                
                const checkedTreatments = [];
                
                // チェックされた施術を収集
                document.querySelectorAll('#treatmentCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                    if (checkbox.dataset.treatmentSub) {
                        checkedTreatments.push(checkbox.dataset.treatmentSub);
                    } else if (checkbox.dataset.treatmentSingle) {
                        checkedTreatments.push(checkbox.dataset.treatmentSingle);
                    }
                });
                
                // チェックされた項目がない場合は全て表示（初期状態対応）
                if (checkedTreatments.length === 0) {
                    return historyData;
                }
                
                // チェックされた施術のみをフィルター
                const filteredData = historyData.filter(item => 
                    checkedTreatments.includes(item.treatment)
                );
                return filteredData;
            }
            
            // 履歴フィルターを統合適用
            applyHistoryFilters() {
                if (!this.currentHistoryPatient) return;
                
                this.saveTreatmentFilterState();
                this.renderHistoryModal(this.currentHistoryPatient, this.currentHistoryFilter);
            }
            
            // 履歴から予約を編集
            editFromHistory(appointmentId) {
                console.log('編集対象の予約ID:', appointmentId, 'タイプ:', typeof appointmentId);
                console.log('現在の予約リスト:', this.appointments.map(apt => ({id: apt.id, type: typeof apt.id})));
                
                // 予約を検索
                const appointment = this.appointments.find(apt => 
                    apt.id === appointmentId || 
                    apt.id === String(appointmentId) || 
                    String(apt.id) === String(appointmentId)
                );
                
                if (!appointment) {
                    console.error('予約が見つかりません。ID:', appointmentId);
                    console.error('利用可能な予約ID一覧:', this.appointments.map(apt => apt.id));
                    alert('予約が見つかりません。');
                    return;
                }
                
                console.log('編集する予約:', appointment);
                
                // 予約編集モーダルを開く（履歴モーダルは閉じない）
                this.openModal(null, null, null, null, appointment);
                
                // 編集モーダルを確実に最前面に表示
                setTimeout(() => {
                    const editModal = document.getElementById('appointmentModal');
                    if (editModal) {
                        bringToFront(editModal);
                        console.log('履歴からの編集: 予約編集モーダルを最前面に移動');
                    }
                }, 50);
            }

            // 履歴から予約を削除
            deleteFromHistory(appointmentId) {
                console.log('削除対象の予約ID:', appointmentId);
                
                // 予約を検索
                const appointment = this.appointments.find(apt => 
                    apt.id === appointmentId || 
                    apt.id === String(appointmentId) || 
                    String(apt.id) === String(appointmentId)
                );
                
                if (!appointment) {
                    alert('予約が見つかりません。');
                    return;
                }
                
                // 確認モーダルを開く
                this.openDeleteConfirmModal('appointment', appointment, []);
                
                // 削除確認モーダルを確実に最前面に表示
                setTimeout(() => {
                    const deleteModal = document.getElementById('deleteConfirmationModal');
                    if (deleteModal) {
                        bringToFront(deleteModal);
                        console.log('履歴からの削除: 削除確認モーダルを最前面に移動');
                    }
                }, 50);
            }
            

            closePatientHistoryModal() {
                document.getElementById('patientHistoryModal').style.display = 'none';
                this.currentHistoryPatient = null;
                this.currentHistoryFilter = 'all';
                this.currentTreatmentFilter = null; // 施術フィルター状態をリセット
                
                // データ管理モーダルが開いている場合、z-indexを元に戻す
                const manageModal = document.getElementById('manageModal');
                if (manageModal && manageModal.style.display === 'block') {
                    bringToFront(manageModal);
                    console.log('データ管理モーダルのz-indexを元に戻しました');
                }
                
                // 予約件数表示を再表示
                const floatingSummaries = document.querySelectorAll('[id^="floatingSummaryContainer"]');
                floatingSummaries.forEach(summary => {
                    // 元のdisplay値に戻す（floatingSummaryContainer_数字はflex、メインコンテナもflex）
                    if (summary.id.includes('_')) {
                        summary.style.display = 'flex';
                    } else {
                        summary.style.display = 'flex';
                    }
                });
            }

            editPatientName(patientId, currentName) {
                // 文字列として比較（型の不一致を回避）
                const patient = this.patients.find(p => String(p.id) === String(patientId));
                if (!patient) {
                    alert('患者が見つかりません。');
                    return;
                }
                
                // 編集対象の患者IDを保存
                this.editingPatientId = patientId;
                
                // フォームに現在の値を設定
                document.getElementById('editPatientName').value = patient.name;
                document.getElementById('editPatientHiragana').value = patient.nameHiragana || '';
                
                // マークチェックボックスを生成
                const marksContainer = document.getElementById('editPatientMarks');
                marksContainer.innerHTML = this.generateMarkCheckboxes(patient.marks || []);
                
                // モーダルを表示
                const editModal = document.getElementById('editPatientModal');
                editModal.style.display = 'block';
                bringToFront(editModal); // モーダルを最前面に
            }

            closeEditPatientModal() {
                document.getElementById('editPatientModal').style.display = 'none';
                this.editingPatientId = null;
            }

            savePatientNameEdit() {
                const newName = document.getElementById('editPatientName').value.trim();
                const newHiragana = document.getElementById('editPatientHiragana').value.trim();
                
                // 選択されたマークを取得
                const selectedMarks = [];
                document.querySelectorAll('#editPatientMarks input[name="patientMarks"]:checked').forEach(checkbox => {
                    selectedMarks.push(checkbox.value);
                });
                
                if (!newName) {
                    alert('患者名を入力してください。');
                    return;
                }
                
                const patient = this.patients.find(p => p.id === this.editingPatientId);
                if (!patient) {
                    alert('患者が見つかりません。');
                    return;
                }
                
                // 重複チェック
                if (this.patients.find(p => p.id !== this.editingPatientId && p.name === newName)) {
                    alert('同名の患者が既に存在します。');
                    return;
                }

                const oldName = patient.name;
                patient.name = newName;
                patient.nameHiragana = newHiragana;
                patient.marks = selectedMarks;
                
                // 予約データの患者名も更新
                this.appointments.forEach(apt => {
                    if (apt.patientId === this.editingPatientId) {
                        apt.patientName = newName;
                    }
                });
                
                // 現在の検索条件でリスト再表示
                this.searchPatients();
                this.render();
                this.showSuccessMessage(`患者名を「${oldName}」から「${newName}」${newHiragana ? `（${newHiragana}）` : ''}に変更しました。`);
                
                // モーダルを閉じる
                this.closeEditPatientModal();
            }

            // 看護師名編集
            editNurseName(currentName) {
                this.editingNurseName = currentName;
                document.getElementById('editNurseName').value = currentName;
                const modal = document.getElementById('editNurseModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }

            closeEditNurseModal() {
                document.getElementById('editNurseModal').style.display = 'none';
                this.editingNurseName = null;
            }

            saveNurseNameEdit() {
                const newName = document.getElementById('editNurseName').value.trim();
                if (!newName) {
                    alert('看護師名を入力してください。');
                    return;
                }

                // 重複チェック
                if (this.nurses.includes(newName) && newName !== this.editingNurseName) {
                    alert('同名の看護師が既に存在します。');
                    return;
                }

                // 看護師名を更新
                const index = this.nurses.indexOf(this.editingNurseName);
                if (index !== -1) {
                    this.nurses[index] = newName;
                }

                // 予約データの看護師名も更新
                this.appointments.forEach(apt => {
                    if (apt.nurse === this.editingNurseName) {
                        apt.nurse = newName;
                    }
                });

                this.updateNurseOptions();
                this.render();
                this.renderManageLists();
                this.showSuccessMessage(`看護師名を「${this.editingNurseName}」から「${newName}」に変更しました。`);
                this.closeEditNurseModal();
            }

            // 施術メニュー名編集
            editTreatmentName(currentName) {
                this.editingTreatmentName = currentName;
                document.getElementById('editTreatmentName').value = currentName;
                const modal = document.getElementById('editTreatmentModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }

            closeEditTreatmentModal() {
                document.getElementById('editTreatmentModal').style.display = 'none';
                this.editingTreatmentName = null;
            }

            saveTreatmentNameEdit() {
                const newName = document.getElementById('editTreatmentName').value.trim();
                if (!newName) {
                    alert('施術メニュー名を入力してください。');
                    return;
                }

                // 重複チェック
                if (this.treatmentMenus.find(t => t.name === newName) && newName !== this.editingTreatmentName) {
                    alert('同名の施術メニューが既に存在します。');
                    return;
                }

                // 施術メニュー名を更新
                const treatmentMenu = this.treatmentMenus.find(t => t.name === this.editingTreatmentName);
                if (treatmentMenu) {
                    treatmentMenu.name = newName;
                }

                // treatments配列も更新
                const treatmentIndex = this.treatments.indexOf(this.editingTreatmentName);
                if (treatmentIndex !== -1) {
                    this.treatments[treatmentIndex] = newName;
                }

                // 予約データの施術メニュー名も更新
                this.appointments.forEach(apt => {
                    if (apt.treatmentType === this.editingTreatmentName) {
                        apt.treatmentType = newName;
                    }
                });

                this.updateTreatmentOptions();
                this.render();
                this.renderManageLists();
                this.showSuccessMessage(`施術メニュー名を「${this.editingTreatmentName}」から「${newName}」に変更しました。`);
                this.closeEditTreatmentModal();
            }

            // デバイス名編集
            editDeviceName(currentName) {
                this.editingDeviceName = currentName;
                document.getElementById('editDeviceName').value = currentName;
                const modal = document.getElementById('editDeviceModal');
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }

            closeEditDeviceModal() {
                document.getElementById('editDeviceModal').style.display = 'none';
                this.editingDeviceName = null;
            }

            saveDeviceNameEdit() {
                const newName = document.getElementById('editDeviceName').value.trim();
                if (!newName) {
                    alert('デバイス名を入力してください。');
                    return;
                }

                // 重複チェック
                if (this.devices.includes(newName) && newName !== this.editingDeviceName) {
                    alert('同名のデバイスが既に存在します。');
                    return;
                }

                // デバイス名を更新
                const index = this.devices.indexOf(this.editingDeviceName);
                if (index !== -1) {
                    this.devices[index] = newName;
                }

                // 予約データのデバイス名も更新
                this.appointments.forEach(apt => {
                    if (apt.device === this.editingDeviceName) {
                        apt.device = newName;
                    }
                });

                this.updateDeviceOptions();
                this.render();
                this.renderManageLists();
                this.showSuccessMessage(`デバイス名を「${this.editingDeviceName}」から「${newName}」に変更しました。`);
                this.closeEditDeviceModal();
            }

            // 【重複チェック完了】以下の関数群は重複なしを確認済み:
            // - updateDeviceOptions(): 1箇所のみ定義、複数箇所で呼び出し（正常）
            // - editPatientName(), editNurseName(), editTreatmentName(), editDeviceName(): それぞれ1箇所のみ定義
            // - closeEditPatientModal(), closeEditNurseModal(), closeEditTreatmentModal(), closeEditDeviceModal(): それぞれ1箇所のみ定義

            // 【動作テスト用】主要機能の動作確認
            testSystemFunctions() {
                console.log('=== システム動作確認テスト ===');
                
                const tests = {
                    '予約データ読み込み': this.appointments.length > 0,
                    '患者データ読み込み': this.patients.length > 0,
                    '看護師データ読み込み': this.nurses.length > 0,
                    '施術メニューデータ読み込み': this.treatments.length > 0,
                    'デバイスデータ読み込み': this.devices.length > 0,
                    'カレンダー表示': document.getElementById('scheduleTable') !== null,
                    'モーダル要素': document.getElementById('appointmentModal') !== null
                };
                
                let passed = 0;
                let total = Object.keys(tests).length;
                
                for (const [testName, result] of Object.entries(tests)) {
                    if (result) {
                        console.log(`✅ ${testName}: OK`);
                        passed++;
                    } else {
                        console.log(`❌ ${testName}: FAILED`);
                    }
                }
                
                console.log(`=== テスト結果: ${passed}/${total} 通過 ===`);
                return passed === total;
            }

            // ドラッグアンドドロップハンドラー - メイン項目用
            handleMainDragStart(e, index) {
                this.draggedMainIndex = index;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index.toString());
                e.target.style.opacity = '0.5';
            }

            handleMainDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            handleMainDrop(e, targetIndex) {
                e.preventDefault();
                
                if (this.draggedMainIndex === undefined || this.draggedMainIndex === targetIndex) {
                    return;
                }

                // メイン項目の順序を変更
                const draggedItem = this.treatmentMenus[this.draggedMainIndex];
                this.treatmentMenus.splice(this.draggedMainIndex, 1);
                this.treatmentMenus.splice(targetIndex, 0, draggedItem);

                // カレンダーを再描画
                this.render();
                console.log(`メイン項目「${draggedItem.name}」を移動しました`);
            }

            handleMainDragEnd(e) {
                e.target.style.opacity = '1';
                this.draggedMainIndex = undefined;
            }

            // ドラッグアンドドロップハンドラー - サブ項目用
            handleSubDragStart(e) {
                console.log('🎯 handleSubDragStart実行開始');
                // ドラッグ元の要素（下段のDIV）から直接データ属性を取得
                const dragSource = e.target;
                
                if (!dragSource.dataset.isSubItem) {
                    console.log('❌ isSubItemデータなし');
                    return;
                }
                
                const treatmentIndex = parseInt(dragSource.dataset.treatmentIndex);
                const subItemIndex = parseInt(dragSource.dataset.subItemIndex);
                
                console.log('🎯 ドラッグデータ:', {treatmentIndex, subItemIndex});
                
                this.draggedSubItem = {
                    treatmentIndex: treatmentIndex,
                    subItemIndex: subItemIndex
                };
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', 'subitem');
                
                // 親のTH要素を半透明にする
                const parentTh = dragSource.closest('th');
                if (parentTh) {
                    parentTh.style.opacity = '0.5';
                }
            }

            handleSubDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                e.dataTransfer.dropEffect = 'move';
            }

            handleSubDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!this.draggedSubItem) {
                    return;
                }
                
                // ドロップ先の要素を取得
                let dropTarget = e.target;
                
                // データ属性を持つ要素を探す
                while (dropTarget && !dropTarget.dataset.isSubItem) {
                    dropTarget = dropTarget.parentElement;
                    if (!dropTarget || dropTarget.tagName === 'TABLE') {
                        break;
                    }
                }
                
                if (!dropTarget || !dropTarget.dataset.isSubItem) {
                    return;
                }
                
                const targetTreatmentIndex = parseInt(dropTarget.dataset.treatmentIndex);
                const targetSubItemIndex = parseInt(dropTarget.dataset.subItemIndex);
                
                // 同じメイン項目内でのみ移動を許可
                if (this.draggedSubItem.treatmentIndex !== targetTreatmentIndex) {
                    return;
                }
                
                // 同じアイテムにドロップした場合は何もしない
                if (this.draggedSubItem.subItemIndex === targetSubItemIndex) {
                    return;
                }

                const treatmentMenu = this.treatmentMenus[targetTreatmentIndex];
                
                // 修正された挿入ロジック
                const sourceIndex = this.draggedSubItem.subItemIndex;
                const targetIndex = targetSubItemIndex;
                
                // 隣接項目対応の挿入ロジック
                const draggedItem = treatmentMenu.subItems[sourceIndex];
                const newSubItems = [];
                
                if (sourceIndex < targetIndex) {
                    // 前から後への移動：ターゲットの後に挿入
                    for (let i = 0; i < treatmentMenu.subItems.length; i++) {
                        if (i === sourceIndex) continue; // 元の位置をスキップ
                        
                        newSubItems.push(treatmentMenu.subItems[i]);
                        
                        if (i === targetIndex) {
                            newSubItems.push(draggedItem); // ターゲットの後に挿入
                        }
                    }
                } else {
                    // 後から前への移動：ターゲットの前に挿入
                    for (let i = 0; i < treatmentMenu.subItems.length; i++) {
                        if (i === targetIndex) {
                            newSubItems.push(draggedItem); // ターゲットの前に挿入
                        }
                        
                        if (i !== sourceIndex) {
                            newSubItems.push(treatmentMenu.subItems[i]);
                        }
                    }
                }
                
                treatmentMenu.subItems = newSubItems;

                // カレンダーを再描画
                this.render();
            }

            handleSubDragEnd(e) {
                // 親のTH要素の透明度を戻す
                const dragSource = e.target;
                const parentTh = dragSource.closest('th');
                if (parentTh) {
                    parentTh.style.opacity = '1';
                }
                
                this.draggedSubItem = undefined;
            }

            // サブ項目管理機能
            addSubItem(treatmentIndex) {
                this.currentTreatmentIndex = treatmentIndex;
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                
                // モーダルタイトルを更新
                document.getElementById('addSubItemTitle').textContent = `「${treatmentMenu.name}」のサブ項目追加`;
                
                // フォームをクリア
                document.getElementById('subItemName').value = '';
                
                // モーダルを表示
                document.getElementById('addSubItemModal').style.display = 'block';
                bringToFront(document.getElementById('addSubItemModal'));
                
                // 入力フィールドにフォーカス
                setTimeout(() => {
                    document.getElementById('subItemName').focus();
                }, 100);
            }

            closeAddSubItemModal() {
                document.getElementById('addSubItemModal').style.display = 'none';
                this.currentTreatmentIndex = null;
            }

            // 自動で色を生成する関数
            generateSubItemColor(parentColor) {
                // 親の色を少し明るくまたは暗くして、似ているけど区別できる色を作る
                const hex = parentColor.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                
                // 少し明るくする（255に近づける）
                const newR = Math.min(255, r + 30);
                const newG = Math.min(255, g + 30);
                const newB = Math.min(255, b + 30);
                
                return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
            }

            saveSubItem() {
                if (this.currentTreatmentIndex === null) return;
                
                const treatmentMenu = this.treatmentMenus[this.currentTreatmentIndex];
                const subItemName = document.getElementById('subItemName').value.trim();
                
                // バリデーション
                if (!subItemName) {
                    alert('サブ項目名を入力してください。');
                    document.getElementById('subItemName').focus();
                    return;
                }
                
                // サブ項目の重複チェック
                if (treatmentMenu.subItems && treatmentMenu.subItems.some(sub => sub.name === subItemName)) {
                    alert('同名のサブ項目が既に存在します。');
                    document.getElementById('subItemName').focus();
                    return;
                }
                
                // サブ項目配列の初期化
                if (!treatmentMenu.subItems) {
                    treatmentMenu.subItems = [];
                }
                
                // 新しいサブ項目を追加（色はメイン項目から継承するため設定しない）
                const newSubItem = {
                    name: subItemName,
                    duration: 60
                };
                
                treatmentMenu.subItems.push(newSubItem);
                
                // UI更新
                this.renderManageLists();
                this.render(); // スケジュール表も更新
                this.showSuccessMessage(`サブ項目「${subItemName}」を追加しました。`);
                
                // モーダルを閉じる
                this.closeAddSubItemModal();
            }

            editSubItemName(treatmentIndex, subIndex) {
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                const subItem = treatmentMenu.subItems[subIndex];
                const oldName = subItem.name;
                
                const newName = prompt(`サブ項目名を編集してください:`, oldName);
                
                if (!newName || !newName.trim() || newName.trim() === oldName) {
                    return;
                }
                
                // 同じメイン項目内での重複チェック
                if (treatmentMenu.subItems.some((sub, idx) => idx !== subIndex && sub.name === newName.trim())) {
                    alert('同名のサブ項目が既に存在します。');
                    return;
                }
                
                // サブ項目名を更新
                subItem.name = newName.trim();
                
                // 予約データのサブ項目名も更新
                this.appointments.forEach(apt => {
                    if (apt.treatmentType === treatmentMenu.name && apt.subItem === oldName) {
                        apt.subItem = newName.trim();
                    }
                });
                
                this.render();
                this.renderManageLists();
                this.showSuccessMessage(`サブ項目名を「${oldName}」から「${newName.trim()}」に変更しました。`);
            }

            // 標準施術時間編集機能
            editTreatmentDuration(treatmentIndex) {
                console.log('editTreatmentDuration called with index:', treatmentIndex);
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                console.log('treatmentMenu:', treatmentMenu);
                const modal = document.getElementById('durationEditModal');
                console.log('modal:', modal);
                const titleElement = document.getElementById('durationEditTitle');
                const durationInput = document.getElementById('durationEditValue');
                const intervalMinInput = document.getElementById('intervalMinValue');
                const intervalMaxInput = document.getElementById('intervalMaxValue');
                
                titleElement.textContent = `「${treatmentMenu.name}」の施術設定`;
                durationInput.value = treatmentMenu.defaultDuration || '';
                intervalMinInput.value = treatmentMenu.intervalMin || '';
                intervalMaxInput.value = treatmentMenu.intervalMax || '';
                
                // 制限設定を読み込み
                const restrictions = treatmentMenu.restrictions || { weeklySchedule: {} };
                
                // 曜日ごとの時間帯設定を読み込み
                [0, 2, 3, 4, 5, 6].forEach(day => {
                    const enabledCheckbox = document.getElementById(`dayEnabled${day}`);
                    const startTimeInput = document.getElementById(`startTime${day}`);
                    const endTimeInput = document.getElementById(`endTime${day}`);
                    const timeRangeDiv = document.getElementById(`timeRange${day}`);
                    
                    if (enabledCheckbox && restrictions.weeklySchedule && restrictions.weeklySchedule[day]) {
                        const schedule = restrictions.weeklySchedule[day];
                        enabledCheckbox.checked = schedule.enabled !== false;
                        if (startTimeInput) startTimeInput.value = schedule.startTime || '10:00';
                        if (endTimeInput) endTimeInput.value = schedule.endTime || (day === 6 ? '17:00' : '19:00');
                        if (timeRangeDiv) {
                            timeRangeDiv.style.opacity = enabledCheckbox.checked ? '1' : '0.3';
                            timeRangeDiv.style.pointerEvents = enabledCheckbox.checked ? 'auto' : 'none';
                        }
                    } else if (enabledCheckbox) {
                        // デフォルト値
                        enabledCheckbox.checked = true;
                        if (startTimeInput) startTimeInput.value = '10:00';
                        if (endTimeInput) endTimeInput.value = day === 6 ? '17:00' : '19:00';
                        if (timeRangeDiv) {
                            timeRangeDiv.style.opacity = '1';
                            timeRangeDiv.style.pointerEvents = 'auto';
                        }
                    }
                });
                
                // データを保存
                modal.dataset.treatmentIndex = treatmentIndex;
                modal.dataset.editType = 'treatment';
                
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
                durationInput.focus();
            }
            
            editSubItemDuration(treatmentIndex, subIndex) {
                console.log('editSubItemDuration called with:', treatmentIndex, subIndex);
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                const subItem = treatmentMenu.subItems[subIndex];
                console.log('subItem:', subItem);
                const modal = document.getElementById('durationEditModal');
                console.log('modal:', modal);
                const titleElement = document.getElementById('durationEditTitle');
                const durationInput = document.getElementById('durationEditValue');
                const intervalMinInput = document.getElementById('intervalMinValue');
                const intervalMaxInput = document.getElementById('intervalMaxValue');
                
                titleElement.textContent = `「${subItem.name}」の施術設定`;
                durationInput.value = subItem.defaultDuration || '';
                intervalMinInput.value = subItem.intervalMin || '';
                intervalMaxInput.value = subItem.intervalMax || '';
                
                // 制限設定を読み込み
                const restrictions = subItem.restrictions || { weeklySchedule: {} };
                
                // 曜日ごとの時間帯設定を読み込み
                [0, 2, 3, 4, 5, 6].forEach(day => {
                    const enabledCheckbox = document.getElementById(`dayEnabled${day}`);
                    const startTimeInput = document.getElementById(`startTime${day}`);
                    const endTimeInput = document.getElementById(`endTime${day}`);
                    const timeRangeDiv = document.getElementById(`timeRange${day}`);
                    
                    if (enabledCheckbox && restrictions.weeklySchedule && restrictions.weeklySchedule[day]) {
                        const schedule = restrictions.weeklySchedule[day];
                        enabledCheckbox.checked = schedule.enabled !== false;
                        if (startTimeInput) startTimeInput.value = schedule.startTime || '10:00';
                        if (endTimeInput) endTimeInput.value = schedule.endTime || (day === 6 ? '17:00' : '19:00');
                        if (timeRangeDiv) {
                            timeRangeDiv.style.opacity = enabledCheckbox.checked ? '1' : '0.3';
                            timeRangeDiv.style.pointerEvents = enabledCheckbox.checked ? 'auto' : 'none';
                        }
                    } else if (enabledCheckbox) {
                        // デフォルト値
                        enabledCheckbox.checked = true;
                        if (startTimeInput) startTimeInput.value = '10:00';
                        if (endTimeInput) endTimeInput.value = day === 6 ? '17:00' : '19:00';
                        if (timeRangeDiv) {
                            timeRangeDiv.style.opacity = '1';
                            timeRangeDiv.style.pointerEvents = 'auto';
                        }
                    }
                });
                
                // データを保存
                modal.dataset.treatmentIndex = treatmentIndex;
                modal.dataset.subIndex = subIndex;
                modal.dataset.editType = 'subItem';
                
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
                durationInput.focus();
            }
            
            saveDurationEdit() {
                const modal = document.getElementById('durationEditModal');
                const durationInput = document.getElementById('durationEditValue');
                const intervalMinInput = document.getElementById('intervalMinValue');
                const intervalMaxInput = document.getElementById('intervalMaxValue');
                const treatmentIndex = parseInt(modal.dataset.treatmentIndex);
                const editType = modal.dataset.editType;
                const newDuration = durationInput.value ? parseInt(durationInput.value) : null;
                const newIntervalMin = intervalMinInput.value ? parseInt(intervalMinInput.value) : null;
                const newIntervalMax = intervalMaxInput.value ? parseInt(intervalMaxInput.value) : null;
                
                // 曜日ごとの時間帯制限設定を取得
                const weeklySchedule = {};
                [0, 2, 3, 4, 5, 6].forEach(day => {
                    const enabledCheckbox = document.getElementById(`dayEnabled${day}`);
                    const startTimeInput = document.getElementById(`startTime${day}`);
                    const endTimeInput = document.getElementById(`endTime${day}`);
                    
                    if (enabledCheckbox) {
                        weeklySchedule[day] = {
                            enabled: enabledCheckbox.checked,
                            startTime: startTimeInput ? startTimeInput.value : '10:00',
                            endTime: endTimeInput ? endTimeInput.value : (day === 6 ? '17:00' : '19:00')
                        };
                    }
                });
                const restrictions = { weeklySchedule };
                
                // 標準時間が設定されている場合のみバリデーション
                if (newDuration !== null && newDuration <= 0) {
                    alert('正しい施術時間を入力してください（1分以上）。');
                    return;
                }
                
                // 間隔設定のバリデーション
                if (newIntervalMin !== null && newIntervalMax !== null) {
                    if (newIntervalMax <= newIntervalMin) {
                        alert('最高間隔は最低間隔より大きい値を入力してください。');
                        return;
                    }
                }
                
                if (editType === 'treatment') {
                    const treatmentMenu = this.treatmentMenus[treatmentIndex];
                    const oldDuration = treatmentMenu.defaultDuration;
                    treatmentMenu.defaultDuration = newDuration;
                    treatmentMenu.intervalMin = newIntervalMin;
                    treatmentMenu.intervalMax = newIntervalMax;
                    treatmentMenu.restrictions = restrictions;
                    
                    let message = `「${treatmentMenu.name}」の設定を更新しました。\n`;
                    message += `標準時間: ${oldDuration}分 → ${newDuration}分`;
                    
                    if (newIntervalMin !== null) {
                        if (newIntervalMax !== null) {
                            message += `\n間隔設定: ${newIntervalMin}日～${newIntervalMax}日`;
                        } else {
                            message += `\n間隔設定: ${newIntervalMin}日以上`;
                        }
                    } else {
                        message += `\n間隔設定: 未設定`;
                    }
                    
                    this.showSuccessMessage(message);
                } else if (editType === 'subItem') {
                    const subIndex = parseInt(modal.dataset.subIndex);
                    const treatmentMenu = this.treatmentMenus[treatmentIndex];
                    const subItem = treatmentMenu.subItems[subIndex];
                    const oldDuration = subItem.defaultDuration;
                    subItem.defaultDuration = newDuration;
                    subItem.intervalMin = newIntervalMin;
                    subItem.intervalMax = newIntervalMax;
                    subItem.restrictions = restrictions;
                    
                    let message = `「${subItem.name}」の設定を更新しました。\n`;
                    message += `標準時間: ${oldDuration}分 → ${newDuration}分`;
                    
                    if (newIntervalMin !== null) {
                        if (newIntervalMax !== null) {
                            message += `\n間隔設定: ${newIntervalMin}日～${newIntervalMax}日`;
                        } else {
                            message += `\n間隔設定: ${newIntervalMin}日以上`;
                        }
                    } else {
                        message += `\n間隔設定: 未設定`;
                    }
                    
                    this.showSuccessMessage(message);
                }
                
                this.renderManageLists();
                this.closeDurationEditModal();
            }
            
            closeDurationEditModal() {
                const modal = document.getElementById('durationEditModal');
                modal.style.display = 'none';
                
                // データをクリア
                delete modal.dataset.treatmentIndex;
                delete modal.dataset.subIndex;
                delete modal.dataset.editType;
            }

            deleteSubItem(treatmentIndex, subIndex) {
                const treatmentMenu = this.treatmentMenus[treatmentIndex];
                const subItem = treatmentMenu.subItems[subIndex];
                
                // 関連する予約をチェック
                const relatedAppointments = this.appointments.filter(apt => 
                    apt.treatmentType === treatmentMenu.name && apt.subItem === subItem.name
                );
                
                // サブ項目削除情報を保存
                this.pendingSubItemDelete = { treatmentIndex, subIndex };
                
                // モーダルで確認
                this.openDeleteConfirmModal('subitem', `${treatmentMenu.name} - ${subItem.name}`, relatedAppointments);
            }

            deletePatient(patientId) {
                // 文字列として比較（型の不一致を回避）
                const patient = this.patients.find(p => String(p.id) === String(patientId));
                if (!patient) return;

                // 文字列として比較（型の不一致を回避）
                const relatedAppointments = this.appointments.filter(apt => String(apt.patientId) === String(patientId));
                this.openPatientDeleteConfirmModal(patient.id, patient.name, relatedAppointments);
            }

            openPatientDeleteConfirmModal(patientId, patientName, affectedAppointments) {
                const modal = document.getElementById('deleteConfirmationModal');
                const warningText = document.getElementById('deleteWarningText');
                const affectedSection = document.getElementById('affectedAppointmentsSection');
                const affectedList = document.getElementById('affectedAppointmentsList');
                
                // 警告テキストの設定
                warningText.innerHTML = `<strong>${patientName}</strong> を削除しようとしています。`;
                
                // 影響を受ける予約の処理
                if (affectedAppointments.length > 0) {
                    affectedSection.style.display = 'block';
                    affectedList.innerHTML = affectedAppointments.map(apt => `
                        <tr>
                            <td>${apt.date}</td>
                            <td>${apt.startTime}</td>
                            <td>${apt.treatmentType}</td>
                        </tr>
                    `).join('');
                    
                    const warningMessage = document.getElementById('deleteWarningMessage');
                    warningMessage.textContent = '削除すると、上記の予約の患者情報が「未設定」に変更されます。';
                } else {
                    affectedSection.style.display = 'none';
                }
                
                // 削除ボタンのイベントハンドラーを設定
                const deleteButton = document.getElementById('confirmDeleteBtn');
                deleteButton.onclick = () => this.executePatientDelete(patientId, patientName, affectedAppointments);
                
                modal.style.display = 'block';
                bringToFront(modal); // モーダルを最前面に
            }

            executePatientDelete(patientId, patientName, affectedAppointments) {
                // 影響を受ける予約の患者情報を「未設定」に変更
                affectedAppointments.forEach(apt => {
                    apt.patientId = '';
                    apt.patientName = '未設定';
                });
                
                // 患者を削除
                this.patients = this.patients.filter(p => p.id !== patientId);
                
                // UIを更新
                this.searchPatients();
                this.render();
                this.closeDeleteConfirmModal();
                
                const message = affectedAppointments.length > 0 
                    ? `患者「${patientName}」を削除し、${affectedAppointments.length}件の予約の患者情報を「未設定」に変更しました。`
                    : `患者「${patientName}」を削除しました。`;
                this.showSuccessMessage(message);
            }

            // 予約フォーム内の患者検索
            searchPatientsInForm() {
                console.log('🔍 searchPatientsInForm called');
                const input = document.getElementById('patientName');
                const suggestions = document.getElementById('patientSuggestions');
                const searchTerm = input.value.toLowerCase().trim();
                
                console.log('📝 Search details:', {
                    input: input,
                    suggestions: suggestions,
                    searchTerm: searchTerm,
                    inputValue: input?.value,
                    patientsLength: this.patients?.length
                });

                if (searchTerm.length === 0) {
                    suggestions.style.display = 'none';
                    document.getElementById('patientId').value = '';
                    // 履歴表示ボタンを非表示
                    const historyBtn = document.getElementById('showHistoryBtn');
                    if (historyBtn) {
                        historyBtn.style.display = 'none';
                    }
                    return;
                }

                console.log('👥 Patients data:', this.patients);
                
                const filteredPatients = this.patients.filter(patient => 
                    patient.name.toLowerCase().includes(searchTerm) ||
                    patient.nameHiragana.toLowerCase().includes(searchTerm) ||
                    patient.id.toLowerCase().includes(searchTerm)
                );
                
                console.log('🎯 Filtered results:', {
                    searchTerm: searchTerm,
                    totalPatients: this.patients.length,
                    filteredCount: filteredPatients.length,
                    filteredPatients: filteredPatients
                });

                if (filteredPatients.length === 0) {
                    console.log('❌ No patients found');
                    suggestions.style.display = 'none';
                    document.getElementById('patientId').value = '';
                    // 履歴表示ボタンを非表示
                    const historyBtn = document.getElementById('showHistoryBtn');
                    if (historyBtn) {
                        historyBtn.style.display = 'none';
                    }
                    return;
                }

                console.log('🎨 Generating HTML for suggestions...');
                
                suggestions.innerHTML = filteredPatients.map(patient => {
                    // 患者のマーク情報を取得
                    let marksHtml = '';
                    if (patient.marks && patient.marks.length > 0) {
                        const markSymbols = patient.marks.map(mark => {
                            const markInfo = this.patientMarks[mark];
                            return `<span style="color: ${markInfo.color}; font-size: 10px; margin-right: 0px; font-family: monospace; display: inline-block; width: 8px; text-align: center;">${markInfo.symbol}</span>`;
                        }).join('');
                        marksHtml = markSymbols;
                    }
                    
                    return `
                        <div class="patient-suggestion" onclick="calendar.selectPatient('${patient.id}', '${patient.name}')">
                            <div class="suggestion-name">
                                <span style="color: #6b7280; font-size: 14px; margin-right: 12px;">${patient.id}</span>
                                ${patient.name}${marksHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('✅ Suggestions HTML generated:', suggestions.innerHTML);
                console.log('👀 Showing suggestions element:', suggestions);
                suggestions.style.display = 'block';
                console.log('📋 Final suggestions display:', suggestions.style.display);
            }

            selectPatient(patientId, patientName) {
                // 患者の詳細情報を取得
                const patient = this.patients.find(p => p.id === patientId);
                let displayName = `${patientId}　${patientName}`;
                
                // マーク情報があれば追加
                if (patient && patient.marks && patient.marks.length > 0) {
                    const markSymbols = patient.marks.map(mark => {
                        const markInfo = this.patientMarks[mark];
                        return markInfo.symbol;
                    }).join('');
                    displayName += ` ${markSymbols}`;
                }
                
                // 患者IDと名前を組み合わせて表示
                const patientNameField = document.getElementById('patientName');
                patientNameField.value = displayName;
                patientNameField.readOnly = true; // 選択後は読み取り専用
                
                document.getElementById('patientId').value = patientId;
                document.getElementById('patientSuggestions').style.display = 'none';
                
                // 履歴表示ボタンを表示
                const historyBtn = document.getElementById('showHistoryBtn');
                if (historyBtn) {
                    historyBtn.style.display = 'block';
                }
                
                // 時間枠検索が表示されている場合は期間を再計算
                const searchContainer = document.getElementById('searchSuggestionContainer');
                if (searchContainer && searchContainer.style.display !== 'none') {
                    console.log('🔄 患者選択により自動日付計算を実行');
                    this.calculateRecommendedDateRange();
                }
            }

            showHistoryFromEdit() {
                const patientId = document.getElementById('patientId').value;
                const patientName = document.getElementById('patientName').value;
                const currentEditingAppointment = this.appointments.find(apt => apt.id === this.currentEditingId);
                
                console.log('🔍 showHistoryFromEdit実行:', {
                    フォームの患者ID: patientId,
                    フォームの患者名: patientName,
                    現在編集中のID: this.currentEditingId,
                    現在編集中の予約: currentEditingAppointment,
                    期待する患者ID: currentEditingAppointment?.patientId,
                    期待する患者名: currentEditingAppointment?.patientName,
                    IDが一致: patientId === (currentEditingAppointment?.patientId || '').toString()
                });
                
                // フォームの値ではなく、現在編集中の予約から直接患者IDを取得
                const correctPatientId = currentEditingAppointment?.patientId;
                
                if (correctPatientId) {
                    console.log('✅ 現在編集中の予約から患者IDを取得:', correctPatientId);
                    this.openPatientHistoryModal(correctPatientId);
                } else if (patientId) {
                    console.log('⚠️ フォールバック: フォームの患者IDを使用:', patientId);
                    this.openPatientHistoryModal(patientId);
                } else {
                    console.log('❌ 患者IDが特定できません');
                    alert('患者を選択してください。');
                }
            }

            // ============ 新規予約時間枠検索機能 ============
            
            // 時間枠検索に必要な条件をチェック
            checkSearchRequirements() {
                const patientId = document.getElementById('patientId');
                const treatmentType = document.getElementById('treatmentType');
                const device = document.getElementById('device');
                const duration = document.getElementById('duration');
                
                const hasPatient = patientId && patientId.value;
                const hasTreatment = treatmentType && treatmentType.value;
                const hasDevice = device && device.value;
                const hasDuration = duration && duration.value;
                
                return hasPatient && hasTreatment && hasDevice && hasDuration;
            }
            
            // 検索要件メッセージを表示/非表示
            showSearchRequirementMessage(show) {
                const messageElement = document.getElementById('searchInstructionText');
                if (messageElement) {
                    messageElement.style.display = show ? 'block' : 'none';
                }
            }
            
            // 検索エリアの表示/非表示を切り替え
            toggleSearchSuggestion() {
                // 必要条件をチェック
                const requirementsMet = this.checkSearchRequirements();
                
                if (!requirementsMet) {
                    // 条件が満たされていない場合はメッセージを表示
                    this.showSearchRequirementMessage(true);
                    return;
                }
                
                // 条件が満たされている場合はメッセージを非表示
                this.showSearchRequirementMessage(false);
                
                const container = document.getElementById('searchSuggestionContainer');
                const isVisible = container.style.display !== 'none';
                
                if (isVisible) {
                    container.style.display = 'none';
                    // 推奨メッセージをクリア
                    this.clearRecommendationMessage();
                } else {
                    container.style.display = 'block';
                    // 検索結果をクリア
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('searchResultsList').innerHTML = '';
                    // 間隔設定に基づく自動期間計算を実行
                    this.calculateRecommendedDateRange();
                }
            }

            // 検索用日付ピッカーを開く（期間選択モード）
            openSearchDatePicker(type) {
                // 期間選択モードを開始
                this.periodSelectionMode = true;
                
                // 既存の入力値をチェック
                const startInput = document.getElementById('searchStartDate');
                const endInput = document.getElementById('searchEndDate');
                
                this.selectedStartDate = null;
                this.selectedEndDate = null;
                this.periodSelectionStep = 1;
                
                // 既存の開始日がある場合
                if (startInput && startInput.dataset.dateValue) {
                    this.selectedStartDate = new Date(startInput.dataset.dateValue);
                    this.periodSelectionStep = 2; // 終了日選択待ち
                }
                
                // 既存の終了日がある場合
                if (endInput && endInput.dataset.dateValue && this.selectedStartDate) {
                    this.selectedEndDate = new Date(endInput.dataset.dateValue);
                    this.periodSelectionStep = 3; // 選択完了状態
                }
                
                // カレンダー表示月を設定（既存の日付がある場合はその月を表示）
                if (this.selectedStartDate) {
                    this.datePickerDate = new Date(this.selectedStartDate.getFullYear(), this.selectedStartDate.getMonth(), 1);
                } else {
                    this.datePickerDate = new Date(this.currentDate);
                }
                this.renderDatePickerCalendar();
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'block';
                bringToFront(modal);
                
                // タイトルを状態に応じて設定
                const title = document.querySelector('#datePickerModal h3');
                if (title) {
                    if (this.periodSelectionStep === 1) {
                        title.textContent = '検索期間を選択（開始日を選択してください）';
                    } else if (this.periodSelectionStep === 2) {
                        title.textContent = '検索期間を選択（終了日を選択してください）';
                    } else if (this.periodSelectionStep === 3) {
                        title.textContent = '検索期間を選択（期間を変更または決定してください）';
                    }
                }
                
                // 決定ボタンを表示
                const confirmBtn = document.getElementById('confirmPeriodBtn');
                if (confirmBtn) {
                    confirmBtn.style.display = 'block';
                }
                
                // 決定ボタンの初期状態を設定
                this.updateConfirmButtonState();
                
                setTimeout(() => {
                    bringToFront(modal);
                }, 50);
            }

            // 日付を曜日付きフォーマットで表示する関数
            formatDateWithDayOfWeek(date) {
                const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dayOfWeek = dayNames[date.getDay()];
                return `${year}-${month}-${day} (${dayOfWeek})`;
            }
            
            // 日付入力フィールドに曜日表示機能を設定
            setupDateInputWithDayOfWeek(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                input.addEventListener('change', (e) => {
                    const dateValue = e.target.value;
                    if (!dateValue) return;
                    
                    try {
                        // YYYY-MM-DD形式の日付をパース
                        const date = new Date(dateValue + 'T00:00:00');
                        if (isNaN(date.getTime())) return;
                        
                        // 曜日付きフォーマットで表示を更新
                        const displayValue = this.formatDateWithDayOfWeek(date);
                        e.target.value = displayValue;
                        
                        // dataset.dateValueにはISO形式を保存
                        e.target.dataset.dateValue = dateValue;
                        e.target.style.color = '#2d3748';
                        
                        console.log(`📅 ${inputId}に曜日表示を適用:`, {
                            original: dateValue,
                            display: displayValue
                        });
                        
                    } catch (error) {
                        console.warn(`日付フォーマット変換エラー (${inputId}):`, error);
                    }
                });
                
                // blur時にもチェック（タブで移動した場合など）
                input.addEventListener('blur', (e) => {
                    const dateValue = e.target.dataset?.dateValue;
                    if (dateValue && !e.target.value.includes('(')) {
                        try {
                            const date = new Date(dateValue + 'T00:00:00');
                            if (!isNaN(date.getTime())) {
                                e.target.value = this.formatDateWithDayOfWeek(date);
                            }
                        } catch (error) {
                            // エラーは無視
                        }
                    }
                });
            }
            
            // 期間選択の確認
            confirmPeriodSelection() {
                if ((!this.periodSelectionMode && !this.patientPeriodSelectionMode) || !this.selectedStartDate || !this.selectedEndDate || this.periodSelectionStep !== 3) {
                    return;
                }
                
                // 患者モードか通常モードかで入力フィールドを変更
                let startInput, endInput;
                if (this.patientPeriodSelectionMode) {
                    startInput = document.getElementById('patientSearchStartDate');
                    endInput = document.getElementById('patientSearchEndDate');
                } else {
                    startInput = document.getElementById('searchStartDate');
                    endInput = document.getElementById('searchEndDate');
                }
                
                // 曜日付きフォーマットで表示
                const startDisplayFormat = this.formatDateWithDayOfWeek(this.selectedStartDate);
                const endDisplayFormat = this.formatDateWithDayOfWeek(this.selectedEndDate);
                const startDateStr = `${this.selectedStartDate.getFullYear()}-${String(this.selectedStartDate.getMonth() + 1).padStart(2, '0')}-${String(this.selectedStartDate.getDate()).padStart(2, '0')}`;
                const endDateStr = `${this.selectedEndDate.getFullYear()}-${String(this.selectedEndDate.getMonth() + 1).padStart(2, '0')}-${String(this.selectedEndDate.getDate()).padStart(2, '0')}`;
                
                console.log('📅 曜日付き期間設定:', {
                    start: startDisplayFormat,
                    end: endDisplayFormat
                });
                
                if (startInput && endInput) {
                    startInput.value = startDisplayFormat;
                    startInput.dataset.dateValue = startDateStr;
                    startInput.style.color = '#2d3748';
                    
                    endInput.value = endDisplayFormat;
                    endInput.dataset.dateValue = endDateStr;
                    endInput.style.color = '#2d3748';
                }
                
                // 期間選択モードを終了してモーダルを閉じる
                this.periodSelectionMode = false;
                this.patientPeriodSelectionMode = false;
                this.periodSelectionStep = 1;
                this.selectedStartDate = null;
                this.selectedEndDate = null;
                
                // 決定ボタンを隠す
                const confirmBtn = document.getElementById('confirmPeriodBtn');
                if (confirmBtn) {
                    confirmBtn.style.display = 'none';
                }
                
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'none';
            }

            // 決定ボタンの状態更新
            updateConfirmButtonState() {
                const confirmBtn = document.getElementById('confirmPeriodBtn');
                if (!confirmBtn) return;
                
                // 期間選択モードで両方の日付が選択されている場合のみ有効（通常モード または 患者モード）
                if ((this.periodSelectionMode || this.patientPeriodSelectionMode) && this.selectedStartDate && this.selectedEndDate && this.periodSelectionStep === 3) {
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            }

            // クイック期間設定
            setQuickPeriod(days) {
                const startInput = document.getElementById('searchStartDate');
                const endInput = document.getElementById('searchEndDate');
                
                // 開始日が入力されているかチェック
                let startDate;
                if (startInput.dataset.dateValue) {
                    // 開始日が入力されている場合：その日を基準にする
                    startDate = new Date(startInput.dataset.dateValue);
                } else {
                    // 開始日が未入力の場合：今日を開始日として設定
                    startDate = new Date();
                    
                    const formatDate = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    
                    const formatDisplay = (date) => {
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    };
                    
                    // 開始日を今日に設定
                    startInput.value = formatDisplay(startDate);
                    startInput.dataset.dateValue = formatDate(startDate);
                    startInput.style.color = '#2d3748';
                }
                
                // 開始日から指定期間後の終了日を計算
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + days);
                
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                const formatDisplay = (date) => {
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                };
                
                // 終了日を設定（上書き）
                endInput.value = formatDisplay(endDate);
                endInput.dataset.dateValue = formatDate(endDate);
                endInput.style.color = '#2d3748';
            }
            
            // 利用可能な時間枠を検索
            searchAvailableSlots() {
                // 必須項目のバリデーション
                const patientId = document.getElementById('patientId').value;
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value;
                const device = document.getElementById('device').value;
                const duration = parseInt(document.getElementById('duration').value);
                const specifiedNurse = document.getElementById('nurse').value; // 指定看護師（オプション）
                
                console.log('🔍 検索開始:', {
                    patientId,
                    treatmentType,
                    device,
                    duration,
                    specifiedNurse: specifiedNurse || '指定なし'
                });
                
                if (!patientId || !treatmentType || !device || !duration) {
                    alert('時間枠検索を行うには、「患者」「施術メニュー」「デバイス」「所要時間」を選択してください');
                    return;
                }
                
                // 日付範囲の取得
                const startDateInput = document.getElementById('searchStartDate');
                const endDateInput = document.getElementById('searchEndDate');
                
                if (!startDateInput.dataset.dateValue || !endDateInput.dataset.dateValue) {
                    alert('検索期間の開始日と終了日を選択してください。');
                    return;
                }
                
                const startDate = new Date(startDateInput.dataset.dateValue);
                const endDate = new Date(endDateInput.dataset.dateValue);
                
                console.log('📅 検索期間:', {
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0]
                });
                
                if (startDate > endDate) {
                    alert('開始日は終了日より前の日付を選択してください。');
                    return;
                }
                
                console.log('📋 現在の予約一覧:', this.appointments);
                
                const searchResults = this.findAvailableTimeSlotsInRange(patientId, treatmentType, device, duration, startDate, endDate, subItem, specifiedNurse);
                
                console.log('🎯 検索結果:', searchResults);
                
                this.displaySearchResults(searchResults);
            }
            
            // 指定された日付範囲で利用可能な時間枠を検索
            findAvailableTimeSlotsInRange(patientId, treatmentType, device, duration, startDate, endDate, subItem = null, specifiedNurse = null) {
                const results = [];
                
                // 営業時間の設定（11:00-14:30, 16:00-20:30）
                const businessPeriods = [
                    { start: 11 * 60, end: 14 * 60 + 30 }, // 11:00-14:30
                    { start: 16 * 60, end: 20 * 60 + 30 }  // 16:00-20:30
                ];
                const slotInterval = 5; // 5分間隔
                
                console.log('⚙️ 検索設定:', {
                    businessPeriods: businessPeriods.map(p => `${Math.floor(p.start/60)}:${String(p.start%60).padStart(2,'0')}-${Math.floor(p.end/60)}:${String(p.end%60).padStart(2,'0')}`),
                    slotInterval: slotInterval,
                    duration: duration
                });
                
                // 期間内の各日付をチェック
                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    console.log(`📆 日付チェック: ${dateString}`);
                    
                    // 過去の日付はスキップ
                    if (date.getTime() < today.getTime()) {
                        console.log(`⏭️ 過去の日付のためスキップ: ${dateString}`);
                        continue;
                    }
                    
                    // 休診日はスキップ（日曜・月曜・祝日。ただし土曜祝日は営業）
                    const dayOfWeek = date.getDay();
                    const isHoliday = this.holidays.includes(dateString);
                    const isSaturdayHoliday = isHoliday && dayOfWeek === 6;
                    
                    // 休診日の判定（日曜・月曜・祝日は休診、ただし土曜祝日は営業）
                    const isClosedDay = (dayOfWeek === 0 || dayOfWeek === 1 || isHoliday) && !isSaturdayHoliday;
                    
                    if (isClosedDay) {
                        const dayType = dayOfWeek === 0 ? '日曜' : dayOfWeek === 1 ? '月曜' : '祝日';
                        console.log(`🚫 休診日のためスキップ: ${dateString} (${dayType})`);
                        continue;
                    }
                    
                    const currentMinutes = date.toDateString() === new Date().toDateString() 
                        ? new Date().getHours() * 60 + new Date().getMinutes() 
                        : 0;
                    
                    // 各営業時間帯で検索
                    businessPeriods.forEach(period => {
                        let dayStartMinutes = period.start;
                        
                        // 今日の場合は現在時刻以降のみチェック
                        if (currentMinutes > 0) {
                            dayStartMinutes = Math.max(period.start, currentMinutes);
                        }
                        
                        // この時間帯がまだ有効かチェック
                        if (dayStartMinutes >= period.end) {
                            return; // この営業時間帯はもう過ぎている
                        }
                        
                        console.log(`🕐 ${dateString} 時間帯 ${Math.floor(period.start/60)}:${String(period.start%60).padStart(2,'0')}-${Math.floor(period.end/60)}:${String(period.end%60).padStart(2,'0')}`);
                        
                        const daySlots = this.findDayAvailableSlots(dateString, dayStartMinutes, period.end, duration, slotInterval, patientId, treatmentType, device, subItem, specifiedNurse);
                        console.log(`✅ ${dateString} (${Math.floor(period.start/60)}:${String(period.start%60).padStart(2,'0')}-${Math.floor(period.end/60)}:${String(period.end%60).padStart(2,'0')}) の利用可能枠: ${daySlots.length}件`);
                        
                        results.push(...daySlots);
                    });
                }
                
                console.log(`🎯 総検索結果: ${results.length}件`);
                return results;
            }

            // ========== 患者閲覧モード関連機能 ==========
            
            // 患者閲覧モードに入る
            enterPatientViewMode() {
                console.log('🚀 患者閲覧モード開始処理開始');
                
                // スタッフ画面の期間設定状態をデバッグ
                const staffStartInput = document.getElementById('searchStartDate');
                const staffEndInput = document.getElementById('searchEndDate');
                console.log('📊 スタッフ画面期間設定状態:', {
                    startInput: staffStartInput,
                    endInput: staffEndInput,
                    startValue: staffStartInput?.value,
                    endValue: staffEndInput?.value,
                    startDataset: staffStartInput?.dataset?.dateValue,
                    endDataset: staffEndInput?.dataset?.dateValue
                });
                
                // 必須項目の確認
                const patientId = document.getElementById('patientId').value;
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value;
                const device = document.getElementById('device').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                if (!patientId || !treatmentType || !device || !duration) {
                    alert('患者、施術メニュー、デバイス、所要時間を選択してから患者閲覧モードに入ってください。');
                    return;
                }
                
                // 患者閲覧モード用のデータを保存
                this.patientViewData = {
                    patientId: patientId,
                    treatmentType: treatmentType,
                    subItem: subItem || '',
                    nurse: document.getElementById('nurse').value || '',
                    device: document.getElementById('device').value || '',
                    duration: parseInt(document.getElementById('duration').value) || 0
                };
                
                // 施術メニュー名を表示
                const treatmentName = subItem ? `${treatmentType} - ${subItem}` : treatmentType;
                document.getElementById('patientSelectedTreatment').textContent = treatmentName;
                
                // スタッフ画面の期間設定を患者モードに引き継ぐ
                this.copyStaffPeriodToPatientMode();
                
                // コピー後の患者モード期間設定状態をデバッグ  
                const patientStartInput = document.getElementById('patientSearchStartDate');
                const patientEndInput = document.getElementById('patientSearchEndDate');
                console.log('🎯 患者モード期間設定結果:', {
                    startValue: patientStartInput?.value,
                    endValue: patientEndInput?.value,
                    startDataset: patientStartInput?.dataset?.dateValue,
                    endDataset: patientEndInput?.dataset?.dateValue
                });
                
                // 患者画面を表示
                document.getElementById('patientViewOverlay').style.display = 'block';
                document.getElementById('patientSearchScreen').style.display = 'block';
                document.getElementById('patientConfirmScreen').style.display = 'none';
                
                // 管理画面のモーダルをすべて隠す
                document.getElementById('appointmentModal').style.display = 'none';
                document.getElementById('patientHistoryModal').style.display = 'none';
                
                // 前回の検索結果をクリアして新しい期間で自動検索を実行
                console.log('🔄 新しい期間で患者モード自動検索を実行');
                this.patientSearchSlots();
            }
            
            // 患者用日付ピッカーを開く
            openPatientDatePicker() {
                // 期間選択モードを開始（患者用）
                this.patientPeriodSelectionMode = true;
                this.periodSelectionMode = false; // 通常の期間選択モードは無効化
                
                // 既存の入力値をチェック
                const startInput = document.getElementById('patientSearchStartDate');
                const endInput = document.getElementById('patientSearchEndDate');
                
                this.selectedStartDate = null;
                this.selectedEndDate = null;
                this.periodSelectionStep = 1;
                
                // 既存の開始日がある場合
                if (startInput && startInput.dataset.dateValue) {
                    this.selectedStartDate = new Date(startInput.dataset.dateValue);
                    this.periodSelectionStep = 2; // 終了日選択待ち
                }
                
                // 既存の終了日がある場合
                if (endInput && endInput.dataset.dateValue && this.selectedStartDate) {
                    this.selectedEndDate = new Date(endInput.dataset.dateValue);
                    this.periodSelectionStep = 3; // 選択完了状態
                }
                
                // カレンダー表示月を設定
                if (this.selectedStartDate) {
                    this.datePickerDate = new Date(this.selectedStartDate.getFullYear(), this.selectedStartDate.getMonth(), 1);
                } else {
                    this.datePickerDate = new Date(this.currentDate);
                }
                this.renderDatePickerCalendar();
                const modal = document.getElementById('datePickerModal');
                modal.style.display = 'block';
                bringToFront(modal);
                
                // タイトルを状態に応じて設定
                const title = document.querySelector('#datePickerModal h3');
                if (title) {
                    if (this.periodSelectionStep === 1) {
                        title.textContent = '希望期間を選択（開始日を選択してください）';
                    } else if (this.periodSelectionStep === 2) {
                        title.textContent = '希望期間を選択（終了日を選択してください）';
                    } else if (this.periodSelectionStep === 3) {
                        title.textContent = '希望期間を選択（期間を変更または決定してください）';
                    }
                }
                
                // 決定ボタンを表示
                const confirmBtn = document.getElementById('confirmPeriodBtn');
                if (confirmBtn) {
                    confirmBtn.style.display = 'block';
                }
                
                // 決定ボタンの初期状態を設定
                this.updateConfirmButtonState();
                
                setTimeout(() => {
                    bringToFront(modal);
                }, 50);
            }
            
            // スタッフ画面の期間設定を患者モードにコピー
            copyStaffPeriodToPatientMode() {
                const staffStartInput = document.getElementById('searchStartDate');
                const staffEndInput = document.getElementById('searchEndDate');
                const patientStartInput = document.getElementById('patientSearchStartDate');
                const patientEndInput = document.getElementById('patientSearchEndDate');
                
                // スタッフ画面の期間が設定されているかチェック
                if (staffStartInput && staffEndInput && 
                    staffStartInput.dataset && staffStartInput.dataset.dateValue &&
                    staffEndInput.dataset && staffEndInput.dataset.dateValue) {
                    
                    console.log('📅 スタッフ画面の期間を患者モードにコピー:', {
                        startDate: staffStartInput.dataset.dateValue,
                        endDate: staffEndInput.dataset.dateValue,
                        startDisplay: staffStartInput.value,
                        endDisplay: staffEndInput.value
                    });
                    
                    // スタッフ画面の期間設定をそのまま患者モードにコピー
                    patientStartInput.value = staffStartInput.value;
                    patientStartInput.dataset.dateValue = staffStartInput.dataset.dateValue;
                    patientStartInput.style.color = '#2d3748';
                    
                    patientEndInput.value = staffEndInput.value;
                    patientEndInput.dataset.dateValue = staffEndInput.dataset.dateValue;
                    patientEndInput.style.color = '#2d3748';
                } else {
                    // スタッフ画面で期間が設定されていない場合はデフォルト2週間
                    console.log('📅 スタッフ画面の期間未設定のため、デフォルト2週間を設定');
                    this.setPatientQuickPeriod(14);
                }
            }
            
            // 患者閲覧モード用の期間設定
            setPatientQuickPeriod(days) {
                const startInput = document.getElementById('patientSearchStartDate');
                const endInput = document.getElementById('patientSearchEndDate');
                
                // 開始日が入力されているかチェック
                let startDate;
                if (startInput.dataset && startInput.dataset.dateValue) {
                    // 開始日が入力されている場合：その日を基準にする
                    startDate = new Date(startInput.dataset.dateValue);
                } else {
                    // 開始日が未入力の場合：今日を開始日として設定
                    startDate = new Date();
                }
                
                // 開始日から指定期間後の終了日を計算
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + days - 1);
                
                // 日付フォーマット関数
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                
                // 曜日付きフォーマットで表示
                startInput.value = this.formatDateWithDayOfWeek(startDate);
                startInput.dataset.dateValue = formatDate(startDate);
                startInput.style.color = '#2d3748';
                
                endInput.value = this.formatDateWithDayOfWeek(endDate);
                endInput.dataset.dateValue = formatDate(endDate);
                endInput.style.color = '#2d3748';
            }
            
            // 患者用の時間枠検索
            patientSearchSlots() {
                console.log('🔍 患者モード検索開始');
                
                const startDateValue = document.getElementById('patientSearchStartDate').dataset.dateValue;
                const endDateValue = document.getElementById('patientSearchEndDate').dataset.dateValue;
                
                console.log('📅 患者モード検索期間:', {
                    startDateValue: startDateValue,
                    endDateValue: endDateValue
                });
                
                if (!startDateValue || !endDateValue) {
                    alert('検索期間を設定してください。');
                    return;
                }
                
                // 前回の検索結果をクリア
                const resultsContainer = document.getElementById('patientResultsList');
                if (resultsContainer) {
                    resultsContainer.innerHTML = '';
                    console.log('🧹 前回の患者モード検索結果をクリア');
                }
                
                // 検索処理（通常の検索ロジックを流用、結果を患者用に表示）
                const startDate = new Date(startDateValue);
                const endDate = new Date(endDateValue);
                
                console.log('🏥 患者モード検索パラメータ:', {
                    patientId: this.patientViewData.patientId,
                    treatmentType: this.patientViewData.treatmentType,
                    device: this.patientViewData.device,
                    duration: this.patientViewData.duration,
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: endDate.toISOString().split('T')[0],
                    subItem: this.patientViewData.subItem || '(なし)'
                });
                
                const results = this.findAvailableTimeSlotsInRange(
                    this.patientViewData.patientId,
                    this.patientViewData.treatmentType,
                    this.patientViewData.device,
                    this.patientViewData.duration,
                    startDate,
                    endDate,
                    this.patientViewData.subItem,
                    null // 看護師指定なし
                );
                
                console.log('🎯 患者モード検索結果:', results);
                
                this.displayPatientResults(results);
            }
            
            // 患者用の検索結果表示
            displayPatientResults(results) {
                const resultsContainer = document.getElementById('patientResultsList');
                const searchResultsDiv = document.getElementById('patientSearchResults');
                
                if (!results || results.length === 0) {
                    resultsContainer.innerHTML = '<div style="text-align: center; padding: 40px; font-size: 18px; color: #718096;">該当する空き時間が見つかりませんでした。<br>期間を変更して再検索してください。</div>';
                    searchResultsDiv.style.display = 'block';
                    return;
                }
                
                // 患者用の検索結果を保存
                this.currentPatientSearchResults = results;
                this.currentPatientSortMode = 'earliest';
                
                this.renderPatientSearchResults();
                
                searchResultsDiv.style.display = 'block';
                
                // 結果までスクロール
                searchResultsDiv.scrollIntoView({ behavior: 'smooth' });
            }
            
            // 患者用検索結果をレンダリング（日付でグループ化、連続時間帯をまとめる）
            renderPatientSearchResults() {
                const resultsContainer = document.getElementById('patientResultsList');
                
                // 日付でグループ化
                const groupedResults = this.currentPatientSearchResults.reduce((groups, slot) => {
                    const date = slot.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(slot);
                    return groups;
                }, {});
                
                // 日付ごとの総枠数を計算
                const dateTotals = {};
                Object.keys(groupedResults).forEach(date => {
                    dateTotals[date] = groupedResults[date].length;
                });
                
                // ソート順を決定
                let sortedDates;
                if (this.currentPatientSortMode === 'earliest') {
                    // 日付順（早い順）
                    sortedDates = Object.keys(groupedResults).sort((a, b) => {
                        return new Date(a) - new Date(b);
                    });
                } else if (this.currentPatientSortMode === 'available') {
                    // 空き枠が多い順（その日の総枠数順）
                    sortedDates = Object.keys(groupedResults).sort((a, b) => {
                        const totalA = dateTotals[a];
                        const totalB = dateTotals[b];
                        if (totalB !== totalA) return totalB - totalA; // 枠数が多い順
                        return new Date(a) - new Date(b); // 同数なら日付順
                    });
                }
                
                // ソート済みの日付順でグループを再構成
                const sortedGroupedResults = {};
                sortedDates.forEach(date => {
                    // 各日付内では時間順にソート
                    sortedGroupedResults[date] = groupedResults[date].sort((a, b) => {
                        return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                    });
                });
                
                // 各日付内で連続する時間帯をまとめる
                Object.keys(sortedGroupedResults).forEach(date => {
                    sortedGroupedResults[date] = this.groupConsecutiveTimeSlots(sortedGroupedResults[date]);
                });
                
                // HTML生成
                const resultsHtml = sortedDates.map(date => {
                    const dateObj = new Date(date);
                    const formattedDate = `${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
                    const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
                    const slots = sortedGroupedResults[date];
                    
                    // 実際の総枠数を計算（グループ化前の枠数）
                    const totalSlots = slots.reduce((sum, group) => {
                        if (group.type === 'single') {
                            return sum + 1;
                        } else {
                            return sum + group.slots.length;
                        }
                    }, 0);
                    
                    const slotsHtml = slots.map((group, groupIndex) => {
                        if (group.type === 'single') {
                            // 単独の時間帯
                            const slot = group.slot;
                            return `
                                <div class="time-slot-item" style="margin-left: 30px;" onclick="calendar.selectPatientTimeSlot('${slot.date}', '${slot.startTime}', ${this.patientViewData.duration})">
                                    <span class="slot-time">${slot.startTime}-${slot.endTime}</span>
                                    <span class="slot-info" style="color: #4a5568; font-size: 14px;">${this.patientViewData.duration}分間</span>
                                </div>
                            `;
                        } else {
                            // 連続する時間帯の範囲
                            const rangeId = `patient-range-${date}-${groupIndex}`;
                            const endTimeForLastSlot = group.slots[group.slots.length - 1].endTime;
                            return `
                                <div class="time-range-group">
                                    <div class="time-range-header" onclick="calendar.togglePatientTimeRange('${rangeId}')" style="cursor: pointer; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; background: #f8f9fa; transition: all 0.2s ease;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 500; color: #2d3748;">${group.startTime}-${endTimeForLastSlot} <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; margin-left: 8px;">${group.slots.length}枠</span></span>
                                            <span class="expand-icon" style="color: #4a5568;">▼</span>
                                        </div>
                                    </div>
                                    <div class="time-range-details" id="${rangeId}" style="display: none; margin-left: 16px; margin-bottom: 16px;">
                                        ${group.slots.map(slot => `
                                            <div class="time-slot-item individual" onclick="calendar.selectPatientTimeSlot('${slot.date}', '${slot.startTime}', ${this.patientViewData.duration})">
                                                <span class="slot-time">${slot.startTime}-${slot.endTime}</span>
                                                <span class="slot-info" style="color: #4a5568; font-size: 14px;">${this.patientViewData.duration}分間</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    return `
                        <div class="search-date-group" style="margin-bottom: 24px;">
                            <div class="date-header" style="background: #f7fafc; border-left: 4px solid #4299e1; padding: 12px 16px; margin-bottom: 12px; font-weight: 600; color: #2d3748; font-size: 16px;">
                                ${formattedDate}（${dayOfWeek}） <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; margin-left: 8px;">${totalSlots}枠</span>
                            </div>
                            <div class="date-slots" style="margin-left: 12px;">
                                ${slotsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsContainer.innerHTML = resultsHtml;
            }
            
            // 患者用検索のソート方法を切り替え
            switchPatientSearchTab(sortMode, event = null) {
                // イベントの伝播を防ぐ
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                this.currentPatientSortMode = sortMode;
                
                // タブの見た目を更新
                document.querySelectorAll('.patient-search-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#4a5568';
                    tab.style.border = '1px solid #e2e8f0';
                });
                
                const activeTab = document.querySelector(`.patient-search-tab[data-sort="${sortMode}"]`);
                activeTab.classList.add('active');
                activeTab.style.background = '#667eea';
                activeTab.style.color = 'white';
                activeTab.style.border = 'none';
                
                // 検索結果を再レンダリング
                this.renderPatientSearchResults();
            }
            
            // 患者用時間範囲の展開/折りたたみ
            togglePatientTimeRange(rangeId) {
                const rangeDetails = document.getElementById(rangeId);
                const expandIcon = document.querySelector(`[onclick="calendar.togglePatientTimeRange('${rangeId}')"] .expand-icon`);
                
                if (rangeDetails.style.display === 'none') {
                    rangeDetails.style.display = 'block';
                    expandIcon.textContent = '▲';
                } else {
                    rangeDetails.style.display = 'none';
                    expandIcon.textContent = '▼';
                }
            }
            
            // 患者が時間帯を選択
            selectPatientTimeSlot(date, startTime, duration) {
                // 終了時間を計算（検索結果のendTimeを使用）
                const selectedSlot = this.currentPatientSearchResults.find(slot => 
                    slot.date === date && slot.startTime === startTime
                );
                const endTime = selectedSlot ? selectedSlot.endTime : this.timeToString(this.timeToMinutes(startTime) + duration);
                
                // 選択内容を保存
                this.selectedPatientSlot = {
                    date: date,
                    time: startTime,
                    endTime: endTime,
                    duration: duration
                };
                
                // 確認画面を表示
                const dateStr = new Date(date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                const treatmentName = this.patientViewData.subItem ? 
                    `${this.patientViewData.treatmentType} - ${this.patientViewData.subItem}` : 
                    this.patientViewData.treatmentType;
                
                document.getElementById('patientSelectedDetails').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <strong>施術内容:</strong><br>
                        <span style="font-size: 24px; color: #2b6cb0;">${treatmentName}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <strong>日時:</strong><br>
                        <span style="font-size: 24px; color: #2b6cb0;">${dateStr}</span><br>
                        <span style="font-size: 24px; color: #2b6cb0;">${startTime}〜${endTime} (${duration}分間)</span>
                    </div>
                `;
                
                // パスワード欄をクリア
                document.getElementById('staffPassword').value = '';
                
                // 確認画面に切り替え
                document.getElementById('patientSearchScreen').style.display = 'none';
                document.getElementById('patientConfirmScreen').style.display = 'block';
            }
            
            // 検索画面に戻る
            backToPatientSearch() {
                document.getElementById('patientConfirmScreen').style.display = 'none';
                document.getElementById('patientSearchScreen').style.display = 'block';
            }
            
            // スタッフパスワード確認
            confirmStaffPassword() {
                const password = document.getElementById('staffPassword').value;
                const correctPassword = this.getSystemPassword(); // 設定されたパスワードを使用
                
                if (password === correctPassword) {
                    // パスワード正解 - 新規予約モーダルに情報を設定して患者モード終了
                    this.setupAppointmentFromPatientSelection();
                } else {
                    alert('パスワードが正しくありません。');
                    document.getElementById('staffPassword').value = '';
                }
            }
            
            // 患者の選択内容を新規予約モーダルに設定
            setupAppointmentFromPatientSelection() {
                try {
                    // 患者閲覧モードを終了
                    document.getElementById('patientViewOverlay').style.display = 'none';
                    
                    // 選択された時間帯の詳細情報を取得
                    const selectedSlot = this.currentPatientSearchResults.find(slot => 
                        slot.date === this.selectedPatientSlot.date && 
                        slot.startTime === this.selectedPatientSlot.time
                    );
                    
                    if (!selectedSlot) {
                        throw new Error('選択された時間帯の情報が見つかりません。');
                    }
                    
                    // 施術可能な看護師の先頭1名を自動選択
                    const availableNurse = selectedSlot.availableNurses && selectedSlot.availableNurses.length > 0 
                        ? selectedSlot.availableNurses[0] 
                        : '';
                    
                    // 新規予約モーダルを表示
                    this.currentEditingId = null;
                    document.getElementById('modalTitle').textContent = '新規予約作成';
                    
                    // 患者情報を取得してフォームに設定
                    const patient = this.patients.find(p => String(p.id) === String(this.patientViewData.patientId));
                    const patientName = patient ? patient.name : `ID: ${this.patientViewData.patientId}`;
                    
                    // フォームに患者選択内容を設定（安全に）
                    const setElementValue = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value;
                            if (element.style) element.style.color = '#2d3748';
                        }
                    };
                    
                    setElementValue('patientId', this.patientViewData.patientId);
                    setElementValue('patientName', patientName);
                    setElementValue('treatmentType', this.patientViewData.treatmentType);
                    setElementValue('subItem', this.patientViewData.subItem || '');
                    setElementValue('treatmentDisplay', this.patientViewData.subItem ? 
                        `${this.patientViewData.treatmentType} - ${this.patientViewData.subItem}` : 
                        this.patientViewData.treatmentType);
                    setElementValue('nurse', availableNurse);
                    setElementValue('device', this.patientViewData.device);
                    setElementValue('duration', this.patientViewData.duration);
                    
                    // 日時設定（時間は "HH:MM" 形式に分割）
                    setElementValue('appointmentDate', this.selectedPatientSlot.date);
                    const [hour, minute] = this.selectedPatientSlot.time.split(':');
                    setElementValue('startHour', hour);
                    setElementValue('startMinute', minute);
                    
                    // モーダルを表示
                    document.getElementById('appointmentModal').style.display = 'flex';
                    bringToFront(document.getElementById('appointmentModal'));
                    
                    // 成功通知を表示（患者名を含む）
                    this.showSuccessMessage(`${patientName}様の予約が入力されました`);
                    
                } catch (error) {
                    console.error('患者予約設定エラー:', error);
                    alert(`エラーが発生しました: ${error.message}\n患者閲覧モードに戻ります。`);
                    
                    // エラー時は患者閲覧モードに戻る
                    document.getElementById('patientViewOverlay').style.display = 'block';
                }
            }
            
            // 患者閲覧モードを終了（パスワード認証付き）
            exitPatientViewMode() {
                const password = prompt('スタッフ画面に戻るにはパスワードを入力してください:');
                const correctPassword = this.getSystemPassword(); // 設定されたパスワードを使用
                
                if (password === correctPassword) {
                    document.getElementById('patientViewOverlay').style.display = 'none';
                    // 管理画面のモーダルに戻る
                    document.getElementById('appointmentModal').style.display = 'flex';
                    alert('スタッフ画面に戻りました。');
                } else if (password !== null) { // nullでない場合（キャンセルボタンを押していない場合）
                    alert('パスワードが正しくありません。');
                }
                // password === null の場合（キャンセル）は何もしない
            }

            // 利用可能な時間枠を検索するメインロジック（旧式・互換性のため残す）
            findAvailableTimeSlots(patientId, treatmentType, device, duration, searchPeriodDays) {
                const startDate = new Date();
                const endDate = new Date();
                endDate.setDate(startDate.getDate() + searchPeriodDays);
                
                return this.findAvailableTimeSlotsInRange(patientId, treatmentType, device, duration, startDate, endDate, null, null);
            }
            
            // 指定日の利用可能時間枠を検索
            findDayAvailableSlots(dateString, startMinutes, endMinutes, duration, slotInterval, patientId, treatmentType, device, subItem = null, specifiedNurse = null) {
                const slots = [];
                const dayAppointments = this.appointments.filter(apt => apt.date === dateString);
                
                console.log(`🗓️ ${dateString}の詳細検索:`, {
                    startTime: `${Math.floor(startMinutes/60)}:${String(startMinutes%60).padStart(2,'0')}`,
                    endTime: `${Math.floor(endMinutes/60)}:${String(endMinutes%60).padStart(2,'0')}`,
                    duration: duration,
                    dayAppointments: dayAppointments.length,
                    existingAppointments: dayAppointments.map(apt => `${apt.startTime}(${apt.treatmentType}, ${apt.nurse}, ${apt.device})`)
                });
                
                // 患者の前回施術からの間隔チェック用
                const patientLastAppointment = this.getPatientLastAppointment(patientId, dateString);
                const intervalRestriction = this.getTreatmentIntervalRestriction(treatmentType);
                
                const ignoreRestriction = document.getElementById('ignoreIntervalRestriction')?.checked || false;
                
                if (intervalRestriction && patientLastAppointment) {
                    const daysDiff = this.calculateDaysDifference(patientLastAppointment.date, dateString);
                    console.log(`⏰ 間隔制限チェック:`, {
                        treatmentType,
                        intervalRestriction,
                        lastAppointment: patientLastAppointment.date,
                        daysDiff,
                        ignoreRestriction,
                        allowed: ignoreRestriction || daysDiff >= intervalRestriction
                    });
                } else if (ignoreRestriction) {
                    console.log(`⏰ 間隔制限: 無視設定により全時間枠を検索`);
                }
                
                let checkedSlots = 0;
                let availableSlots = 0;
                
                for (let minutes = startMinutes; minutes <= endMinutes - duration; minutes += slotInterval) {
                    const startTime = this.minutesToTime(minutes);
                    const endTime = this.minutesToTime(minutes + duration);
                    checkedSlots++;
                    
                    // 間隔制限チェック
                    const ignoreRestriction = document.getElementById('ignoreIntervalRestriction')?.checked || false;
                    if (!ignoreRestriction && intervalRestriction && patientLastAppointment) {
                        const daysDiff = this.calculateDaysDifference(patientLastAppointment.date, dateString);
                        if (daysDiff < intervalRestriction) {
                            console.log(`⚠️ 間隔制限により除外: ${startTime} (${daysDiff}日 < ${intervalRestriction}日)`);
                            continue;
                        }
                    }

                    // 施術制限チェック（曜日・時間）
                    const treatmentRestrictionViolation = this.checkTreatmentRestrictions({
                        treatmentType: treatmentType,
                        subItem: subItem,
                        date: dateString,
                        startTime: startTime
                    });
                    if (treatmentRestrictionViolation) {
                        console.log(`⚠️ 施術制限により除外: ${startTime} - ${treatmentRestrictionViolation}`);
                        continue;
                    }
                    
                    // 時間枠の利用可能性をチェック
                    const availability = this.checkSlotAvailability(dateString, startTime, duration, treatmentType, device, dayAppointments, subItem, patientId);
                    
                    if (availability.isAvailable) {
                        // 指定看護師でのフィルタリング
                        let finalAvailableNurses = availability.availableNurses;
                        
                        if (specifiedNurse) {
                            // 指定看護師がこの時間帯で利用可能かチェック
                            if (availability.availableNurses.includes(specifiedNurse)) {
                                finalAvailableNurses = [specifiedNurse]; // 指定看護師のみ
                            } else {
                                // 指定看護師が利用不可な場合はこの時間枠をスキップ
                                console.log(`👩‍⚕️ 指定看護師「${specifiedNurse}」が利用不可のためスキップ: ${startTime}`);
                                continue;
                            }
                        }
                        
                        availableSlots++;
                        slots.push({
                            date: dateString,
                            startTime: startTime,
                            endTime: endTime,
                            duration: duration,
                            availableNurses: finalAvailableNurses,
                            conflictLevel: availability.conflictLevel,
                            dayOfWeek: new Date(dateString).toLocaleDateString('ja-JP', { weekday: 'short' })
                        });
                    } else {
                        console.log(`❌ 利用不可: ${startTime} - 看護師:${availability.availableNurses.length}名, デバイス利用可能:${this.isDeviceAvailable(dateString, startTime, duration, device, dayAppointments)}, 施術行重複:${this.hasTreatmentRowConflict(dateString, startTime, duration, treatmentType, dayAppointments)}`);
                    }
                }
                
                console.log(`📊 ${dateString}サマリー: ${checkedSlots}枠をチェック → ${availableSlots}枠が利用可能`);
                
                return slots;
            }
            
            // 時間枠の利用可能性をチェック
            checkSlotAvailability(dateString, startTime, duration, treatmentType, device, dayAppointments, subItem = null, patientId = null) {
                const startMinutes = this.timeToMinutes(startTime);
                const endMinutes = startMinutes + duration;
                
                // 利用可能な看護師を取得
                const availableNurses = this.getAvailableNurses(dateString, startTime, duration, dayAppointments, treatmentType, subItem);
                
                // デバイスの利用可能性をチェック
                const isDeviceAvailable = this.isDeviceAvailable(dateString, startTime, duration, device, dayAppointments);
                
                // 同じ施術メニューの行での重複チェック
                const hasTreatmentConflict = this.hasTreatmentRowConflict(dateString, startTime, duration, treatmentType, dayAppointments);
                
                // 同一患者の時間重複チェック
                const hasPatientConflict = this.hasPatientTimeConflict(dateString, startTime, duration, patientId, dayAppointments);
                
                let conflictLevel = 0;
                if (availableNurses.length === 0) conflictLevel += 3;
                else if (availableNurses.length === 1) conflictLevel += 1;
                if (!isDeviceAvailable && device !== 'なし') conflictLevel += 2;
                if (hasTreatmentConflict) conflictLevel += 1;
                if (hasPatientConflict) conflictLevel += 3; // 患者重複は高優先度
                
                return {
                    isAvailable: availableNurses.length > 0 && isDeviceAvailable && !hasTreatmentConflict && !hasPatientConflict,
                    availableNurses: availableNurses,
                    conflictLevel: conflictLevel
                };
            }
            
            // 同一患者の時間重複をチェック
            hasPatientTimeConflict(dateString, startTime, duration, patientId, dayAppointments) {
                if (!patientId) return false; // 患者IDが指定されていない場合はチェックしない
                
                const startMinutes = this.timeToMinutes(startTime);
                const endMinutes = startMinutes + duration;
                
                return dayAppointments.some(apt => {
                    // 同じ患者の予約のみチェック
                    if (apt.patientId !== patientId) return false;
                    
                    const aptStart = this.timeToMinutes(apt.startTime);
                    const aptEnd = aptStart + apt.duration;
                    
                    // 時間の重複チェック
                    return startMinutes < aptEnd && endMinutes > aptStart;
                });
            }
            
            // 利用可能な看護師を取得
            getAvailableNurses(dateString, startTime, duration, dayAppointments, treatmentType = null, subItem = null) {
                const startMinutes = this.timeToMinutes(startTime);
                const endMinutes = startMinutes + duration;
                
                // 施術名を作成（サブ項目がある場合）
                const treatmentName = subItem ? `${treatmentType} - ${subItem}` : treatmentType;
                
                // 看護師名を文字列として正規化
                const availableNurseNames = this.nurses
                    .filter(nurse => {
                        const nurseName = typeof nurse === 'string' ? nurse : nurse.name;
                        const treatmentTypes = typeof nurse === 'string' ? [] : nurse.treatmentTypes;
                        
                        // 施術対応可能性をチェック（treatmentTypeが指定されている場合のみ）
                        if (treatmentType && treatmentTypes.length > 0) {
                            const canPerformTreatment = treatmentTypes.includes(treatmentName) || 
                                                      treatmentTypes.includes(treatmentType);
                            if (!canPerformTreatment) {
                                return false;
                            }
                        }
                        
                        // 時間的な空きをチェック
                        return !dayAppointments.some(apt => {
                            if (apt.nurse !== nurseName) return false;
                            
                            const aptStart = this.timeToMinutes(apt.startTime);
                            const aptEnd = aptStart + apt.duration;
                            
                            // 時間の重複チェック
                            return startMinutes < aptEnd && endMinutes > aptStart;
                        });
                    })
                    .map(nurse => typeof nurse === 'string' ? nurse : nurse.name);
                
                return availableNurseNames;
            }
            
            // デバイスの利用可能性をチェック
            isDeviceAvailable(dateString, startTime, duration, device, dayAppointments) {
                if (device === 'なし' || !device) return true;
                
                const startMinutes = this.timeToMinutes(startTime);
                const endMinutes = startMinutes + duration;
                
                return !dayAppointments.some(apt => {
                    if (apt.device !== device || apt.device === 'なし') return false;
                    
                    const aptStart = this.timeToMinutes(apt.startTime);
                    const aptEnd = aptStart + apt.duration;
                    
                    // 時間の重複チェック
                    return startMinutes < aptEnd && endMinutes > aptStart;
                });
            }
            
            // 同じ施術メニュー行での重複チェック
            hasTreatmentRowConflict(dateString, startTime, duration, treatmentType, dayAppointments) {
                const startMinutes = this.timeToMinutes(startTime);
                const endMinutes = startMinutes + duration;
                
                return dayAppointments.some(apt => {
                    if (apt.treatmentType !== treatmentType) return false;
                    
                    const aptStart = this.timeToMinutes(apt.startTime);
                    const aptEnd = aptStart + apt.duration;
                    
                    // 時間の重複チェック
                    return startMinutes < aptEnd && endMinutes > aptStart;
                });
            }
            
            // 患者の最後の施術を取得
            getPatientLastAppointment(patientId, beforeDate) {
                const patientAppointments = this.appointments
                    .filter(apt => apt.patientId === patientId && apt.date < beforeDate)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return patientAppointments[0] || null;
            }
            
            // 同じ施術メニューの最後の予約を取得
            getPatientLastSameTreatment(patientId, treatmentType, subItem, beforeDate) {
                const sameTreatmentAppointments = this.appointments
                    .filter(apt => {
                        if (apt.patientId !== patientId || apt.date >= beforeDate) return false;
                        if (apt.treatmentType !== treatmentType) return false;
                        
                        // サブ項目がある場合は完全一致でチェック
                        if (subItem && subItem !== '') {
                            return apt.subItem === subItem;
                        }
                        
                        // サブ項目がない場合はメイン施術のみでチェック
                        return !apt.subItem || apt.subItem === '';
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return sameTreatmentAppointments[0] || null;
            }
            
            // 間隔情報を更新表示
            updateIntervalInfo() {
                console.log('🔄 updateIntervalInfoが呼ばれました');
                
                const patientId = document.getElementById('patientId').value.trim();
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value;
                const appointmentDate = this.getDateOnlyFromInput();
                
                console.log('📋 入力値:', {
                    patientId,
                    treatmentType,
                    subItem,
                    appointmentDate
                });
                
                const intervalInfo = document.getElementById('intervalInfo');
                const intervalInfoContent = document.getElementById('intervalInfoContent');
                
                if (!intervalInfo || !intervalInfoContent) {
                    console.error('❌ 間隔表示要素が見つかりません');
                    return;
                }
                
                // 完了済み予約の場合は非表示
                if (appointmentDate && this.isCompletedAppointment(appointmentDate)) {
                    console.log('✅ 完了済み予約のため間隔表示を非表示');
                    intervalInfo.style.display = 'none';
                    return;
                }
                
                // 必要な情報が揃っていない場合は非表示
                if (!patientId || !treatmentType || !appointmentDate) {
                    console.log('ℹ️ 必要情報不足で非表示');
                    intervalInfo.style.display = 'none';
                    return;
                }
                
                // 前回の同じ施術を検索
                const lastSameTreatment = this.getPatientLastSameTreatment(patientId, treatmentType, subItem, appointmentDate);
                
                let message = '';
                let color = '#3182ce'; // デフォルトの青
                
                if (!lastSameTreatment) {
                    // 初回の場合
                    const treatmentName = subItem && subItem !== '' ? `${treatmentType}(${subItem})` : treatmentType;
                    message = `これが初回の${treatmentName}です`;
                    color = '#38a169'; // 緑色
                } else {
                    // 2回目以降の場合
                    const daysDiff = this.calculateDaysDifference(lastSameTreatment.date, appointmentDate);
                    const lastDate = new Date(lastSameTreatment.date).toLocaleDateString('ja-JP');
                    const lastTime = lastSameTreatment.startTime;
                    const treatmentName = subItem && subItem !== '' ? `${treatmentType}(${subItem})` : treatmentType;
                    
                    message = `前回の施術から${daysDiff}日経過しています<br>`;
                    message += `<small style="color: #718096;">前回: ${lastDate} ${lastTime} (${treatmentName})</small>`;
                    
                    // 間隔制限チェックと推奨日付表示
                    const restriction = this.getTreatmentIntervalRestriction(treatmentType, subItem);
                    if (restriction) {
                        const { min, max } = restriction;
                        
                        // 推奨日付の計算
                        const lastTreatmentDate = new Date(lastSameTreatment.date);
                        const recommendedStartDate = new Date(lastTreatmentDate);
                        recommendedStartDate.setDate(lastTreatmentDate.getDate() + min);
                        const recommendedStart = recommendedStartDate.toLocaleDateString('ja-JP');
                        
                        let recommendedEndDate = null;
                        let recommendedEnd = '';
                        if (max) {
                            recommendedEndDate = new Date(lastTreatmentDate);
                            recommendedEndDate.setDate(lastTreatmentDate.getDate() + max);
                            recommendedEnd = recommendedEndDate.toLocaleDateString('ja-JP');
                        }
                        
                        let warningMessage = '';
                        let isViolation = false;
                        
                        if (daysDiff < min) {
                            // 最小間隔未満
                            isViolation = true;
                            if (max) {
                                warningMessage = `⚠️ 推奨間隔: ${min}\u301c${max}日 (${recommendedStart} \u301c ${recommendedEnd})`;
                            } else {
                                warningMessage = `⚠️ 推奨間隔: ${min}日以上 (${recommendedStart}以降)`;
                            }
                        } else if (max && daysDiff > max) {
                            // 最大間隔超過
                            isViolation = true;
                            warningMessage = `⚠️ 推奨間隔: ${min}\u301c${max}日 (${recommendedStart} \u301c ${recommendedEnd})`;
                        } else {
                            // 適正範囲内でも推奨日付を表示
                            if (max) {
                                message += `<br><small style="color: #16a34a; font-weight: bold;">✅ 推奨間隔: ${min}\u301c${max}日 (${recommendedStart} \u301c ${recommendedEnd})</small>`;
                            } else {
                                message += `<br><small style="color: #16a34a; font-weight: bold;">✅ 推奨間隔: ${min}日以上 (${recommendedStart}以降)</small>`;
                            }
                        }
                        
                        if (isViolation) {
                            color = '#e53e3e'; // 赤色（警告）
                            message += `<br><small style="color: #e53e3e; font-weight: bold;">${warningMessage}</small>`;
                        }
                    }
                }
                
                intervalInfoContent.innerHTML = message;
                intervalInfo.style.borderLeftColor = color;
                intervalInfo.style.display = 'block';
                
                console.log('✅ 間隔表示更新完了:', {
                    message: message.replace(/<br>/g, ' | ').replace(/<[^>]*>/g, ''),
                    color
                });
            }
            
            // 施術の間隔制限を取得（管理タブ設定から）
            getTreatmentIntervalRestriction(treatmentType, subItem = null) {
                // 管理タブで設定された間隔制限を取得
                const treatmentMenu = this.treatmentMenus.find(menu => menu.name === treatmentType);
                if (!treatmentMenu) {
                    console.log(`⚠️ 施術メニューが見つかりません: ${treatmentType}`);
                    return null;
                }
                
                // サブアイテムがある場合はサブアイテムの設定を優先
                if (subItem && subItem !== '' && treatmentMenu.subItems && treatmentMenu.subItems.length > 0) {
                    const subItemData = treatmentMenu.subItems.find(item => item.name === subItem);
                    if (subItemData && subItemData.intervalMin) {
                        return {
                            min: subItemData.intervalMin,
                            max: subItemData.intervalMax || null
                        };
                    }
                }
                
                // メイン施術の設定を使用
                if (treatmentMenu.intervalMin) {
                    return {
                        min: treatmentMenu.intervalMin,
                        max: treatmentMenu.intervalMax || null
                    };
                }
                
                // 間隔制限設定なし
                return null;
            }
            
            // 日付の差を計算（当日を0日とする）
            calculateDaysDifference(date1, date2) {
                const d1 = new Date(date1);
                const d2 = new Date(date2);
                const diffTime = d2.getTime() - d1.getTime();
                return Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }

            // 施術制限チェック（曜日・時間）
            checkTreatmentRestrictions(formData) {
                const treatment = this.treatmentMenus.find(t => t.name === formData.treatmentType);
                if (!treatment) return null;

                let restrictions;
                if (formData.subItem) {
                    const subItem = treatment.subItems?.find(s => s.name === formData.subItem);
                    restrictions = subItem?.restrictions;
                } else {
                    restrictions = treatment.restrictions;
                }

                if (!restrictions) return null;

                const appointmentDate = new Date(formData.date);
                const dayOfWeek = appointmentDate.getDay(); // 0=日曜, 1=月曜...6=土曜
                const appointmentTime = formData.startTime;
                const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
                
                const treatmentName = formData.subItem ? 
                    `${formData.treatmentType}（${formData.subItem}）` : 
                    formData.treatmentType;

                // 新しい週間スケジュール形式をチェック
                if (restrictions.weeklySchedule) {
                    const daySchedule = restrictions.weeklySchedule[dayOfWeek];
                    
                    // その曜日が実施不可に設定されているかチェック
                    if (daySchedule && daySchedule.enabled === false) {
                        return `${treatmentName}は${dayNames[dayOfWeek]}曜日は実施できません。`;
                    }
                    
                    // 時間帯制限をチェック
                    if (daySchedule && daySchedule.enabled && daySchedule.startTime && daySchedule.endTime) {
                        if (appointmentTime < daySchedule.startTime || appointmentTime >= daySchedule.endTime) {
                            return `${treatmentName}は${dayNames[dayOfWeek]}曜日の${daySchedule.startTime}～${daySchedule.endTime}の時間内でのみ実施可能です。`;
                        }
                    }
                }
                
                // 旧形式の制限もサポート（後方互換性）
                else {
                    // 曜日制限チェック
                    if (restrictions.blockedDays && restrictions.blockedDays.includes(dayOfWeek)) {
                        return `${treatmentName}は${dayNames[dayOfWeek]}曜日は実施できません。`;
                    }

                    // 時間制限チェック
                    if (restrictions.startTimeLimit && appointmentTime >= restrictions.startTimeLimit) {
                        return `${treatmentName}は${restrictions.startTimeLimit}以降は開始できません。`;
                    }
                }

                return null;
            }
            
            // 間隔制限チェック
            checkIntervalRestriction(formData) {
                const lastSameTreatment = this.getPatientLastSameTreatment(
                    formData.patientId, 
                    formData.treatmentType, 
                    formData.subItem, 
                    formData.date
                );
                
                if (!lastSameTreatment) {
                    return null; // 初回の場合は制限なし
                }
                
                const restriction = this.getTreatmentIntervalRestriction(formData.treatmentType, formData.subItem);
                if (!restriction) {
                    return null; // 制限が設定されていない場合
                }
                
                const daysDiff = this.calculateDaysDifference(lastSameTreatment.date, formData.date);
                const { min, max } = restriction;
                
                let isViolation = false;
                let violationType = '';
                
                if (daysDiff < min) {
                    isViolation = true;
                    violationType = 'too_soon';
                } else if (max && daysDiff > max) {
                    isViolation = true;
                    violationType = 'too_late';
                }
                
                if (isViolation) {
                    return {
                        lastTreatment: lastSameTreatment,
                        daysDiff: daysDiff,
                        restriction: { min, max },
                        violationType: violationType,
                        treatmentName: formData.subItem && formData.subItem !== '' 
                            ? `${formData.treatmentType}(${formData.subItem})` 
                            : formData.treatmentType
                    };
                }
                
                return null; // 制限クリア
            }
            
            // 間隔制限警告モーダルを表示
            showIntervalWarningModal(intervalViolation, formData) {
                const modal = document.getElementById('intervalWarningModal');
                const content = document.getElementById('intervalWarningContent');
                
                // 日付のフォーマット
                const lastDate = new Date(intervalViolation.lastTreatment.date).toLocaleDateString('ja-JP');
                const lastTime = intervalViolation.lastTreatment.startTime;
                const appointmentDate = new Date(formData.date).toLocaleDateString('ja-JP');
                
                // 推奨期間の計算
                const { min, max } = intervalViolation.restriction;
                const recommendedStartDate = new Date(intervalViolation.lastTreatment.date);
                recommendedStartDate.setDate(recommendedStartDate.getDate() + min);
                const recommendedStart = recommendedStartDate.toLocaleDateString('ja-JP');
                
                let recommendedEndDate = null;
                let recommendedEnd = '';
                if (max) {
                    recommendedEndDate = new Date(intervalViolation.lastTreatment.date);
                    recommendedEndDate.setDate(recommendedEndDate.getDate() + max);
                    recommendedEnd = recommendedEndDate.toLocaleDateString('ja-JP');
                }
                
                // 違反タイプによるメッセージ分岐
                let violationMessage = '';
                let recommendationText = '';
                
                if (intervalViolation.violationType === 'too_soon') {
                    violationMessage = '間隔が短すぎます';
                    if (max) {
                        recommendationText = `<div><strong>推奨間隔:</strong> ${min}\u301c${max}日</div>
                                              <div><strong>推奨期間:</strong> ${recommendedStart} \u301c ${recommendedEnd}</div>`;
                    } else {
                        recommendationText = `<div><strong>推奨間隔:</strong> ${min}日以上</div>
                                              <div><strong>推奨開始日:</strong> ${recommendedStart}以降</div>`;
                    }
                } else if (intervalViolation.violationType === 'too_late') {
                    violationMessage = '間隔が長すぎます';
                    recommendationText = `<div><strong>推奨間隔:</strong> ${min}\u301c${max}日</div>
                                          <div><strong>推奨期間:</strong> ${recommendedStart} \u301c ${recommendedEnd}</div>`;
                }
                
                const warningMessage = `
                    <div style="margin-bottom: 15px;">
                        <strong>${intervalViolation.treatmentName}</strong>の間隔制限に抵触しています。<br>
                        <span style="color: #dc2626; font-weight: bold;">${violationMessage}</span>
                    </div>
                    <div style="background: #f7fafc; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                        <div><strong>前回の施術:</strong> ${lastDate} ${lastTime}</div>
                        <div><strong>今回の予約:</strong> ${appointmentDate}</div>
                        <div><strong>経過日数:</strong> ${intervalViolation.daysDiff}日</div>
                    </div>
                    <div style="background: #fff3cd; padding: 12px; border-radius: 4px; border-left: 4px solid #ffc107;">
                        ${recommendationText}
                    </div>
                `;
                
                content.innerHTML = warningMessage;
                
                // フォームデータを保存して強制作成時に使用
                this.pendingAppointmentData = formData;
                
                modal.style.display = 'block';
                
                // 警告モーダルを最前面に表示
                bringToFront(modal);
                
                console.log('⚠️ 間隔制限警告モーダル表示', {
                    treatmentName: intervalViolation.treatmentName,
                    daysDiff: intervalViolation.daysDiff,
                    restriction: intervalViolation.restriction
                });
            }
            
            // 間隔制限警告モーダルを閉じる
            closeIntervalWarningModal() {
                const modal = document.getElementById('intervalWarningModal');
                modal.style.display = 'none';
                this.pendingAppointmentData = null;
            }
            
            // 強制予約作成
            forceCreateAppointment() {
                if (!this.pendingAppointmentData) return;
                
                // 間隔制限をスキップして予約を作成
                this.createAppointmentWithoutIntervalCheck(this.pendingAppointmentData);
                
                // モーダルを閉じる
                this.closeIntervalWarningModal();
            }
            
            // 間隔制限チョックをスキップして予約作成
            createAppointmentWithoutIntervalCheck(formData) {
                if (this.currentEditingId) {
                    const appointment = this.appointments.find(apt => apt.id === this.currentEditingId);
                    Object.assign(appointment, formData);
                    
                    // 編集時も患者がマスターに存在しない場合は自動登録
                    if (formData.patientId && formData.patientName) {
                        const existingPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                        if (!existingPatient) {
                            console.log(`🆕 編集時に新規患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                            
                            const nameHiragana = formData.patientName.toLowerCase().replace(/[　\s]+/g, ' ');
                            
                            const newPatient = {
                                id: formData.patientId,
                                name: formData.patientName,
                                nameHiragana: nameHiragana,
                                registrationDate: new Date().toISOString().split('T')[0],
                                totalVisits: 0,
                                lastVisit: '',
                                history: []
                            };
                            
                            this.patients.push(newPatient);
                            
                            // 患者IDでソート
                            this.patients.sort((a, b) => {
                                const aNum = parseInt(a.id.replace(/[^\d]/g, ''));
                                const bNum = parseInt(b.id.replace(/[^\d]/g, ''));
                                return aNum - bNum;
                            });
                        }
                    }
                } else {
                    const newId = Math.max(0, ...this.appointments.map(apt => apt.id)) + 1;
                    const appointment = {
                        id: newId,
                        ...formData
                    };
                    
                    this.appointments.push(appointment);

                    // 患者情報を更新（履歴は予約データから動的に生成するため追加しない）
                    let selectedPatient = this.patients.find(p => String(p.id) === String(formData.patientId));
                    
                    // 患者がマスターに存在しない場合は自動登録
                    if (!selectedPatient && formData.patientId && formData.patientName) {
                        console.log(`🆕 新規患者を自動登録: ${formData.patientId} - ${formData.patientName}`);
                        
                        // ひらがな名を簡易生成
                        const nameHiragana = formData.patientName.toLowerCase()
                            .replace(/[　\s]+/g, ' ');
                        
                        const newPatient = {
                            id: formData.patientId,
                            name: formData.patientName,
                            nameHiragana: nameHiragana,
                            registrationDate: new Date().toISOString().split('T')[0],
                            totalVisits: 0,
                            lastVisit: '',
                            history: []
                        };
                        
                        this.patients.push(newPatient);
                        
                        // 患者IDでソート
                        this.patients.sort((a, b) => {
                            const aNum = parseInt(a.id.replace(/[^\d]/g, ''));
                            const bNum = parseInt(b.id.replace(/[^\d]/g, ''));
                            return aNum - bNum;
                        });
                        
                        selectedPatient = newPatient;
                    }

                    console.log('予約保存完了:', {
                        予約ID: appointment.id,
                        患者: selectedPatient ? selectedPatient.name : 'なし',
                        総予約数: this.appointments.length
                    });
                }

                // 予約保存後の位置同期確認
                console.log('💾 予約保存完了:', {
                    '予約ID': this.currentEditingId || '新規',
                    '患者名': formData.patientName,
                    '時間': formData.startTime,
                    '施術': formData.treatmentType
                });
                
                this.closeModal();
                this.render(); // 同じ位置計算ロジックで再描画
                this.showSuccessMessage('予約が保存されました。');
            }
            
            // 検索結果を表示
            displaySearchResults(results) {
                const searchResults = document.getElementById('searchResults');
                const searchResultsList = document.getElementById('searchResultsList');
                
                if (results.length === 0) {
                    searchResultsList.innerHTML = '<div class="no-results">指定された期間内に利用可能な時間枠が見つかりませんでした。</div>';
                    // 看護師フィルタを非表示
                    document.getElementById('searchNurseFilter').style.display = 'none';
                    searchResults.style.display = 'block';
                    return;
                }
                
                // デフォルトで最も早い時間順でソート
                this.currentSearchResults = results;
                this.currentSortMode = 'earliest';
                
                // 検索結果から看護師フィルタを生成
                this.generateSearchNurseFilter(results);
                
                this.renderSearchResults();
                
                searchResults.style.display = 'block';
            }
            
            // 検索結果から看護師フィルタを生成
            generateSearchNurseFilter(results) {
                const nurseFilter = document.getElementById('searchNurseFilter');
                const dropdownMenu = document.getElementById('searchNurseDropdownMenu');
                
                // 検索結果に含まれる全看護師を取得
                const allNursesInResults = new Set();
                results.forEach(result => {
                    result.availableNurses.forEach(nurse => {
                        allNursesInResults.add(nurse);
                    });
                });
                
                const uniqueNurses = Array.from(allNursesInResults).sort();
                this.searchAvailableNurses = uniqueNurses;
                
                // フィルタ状態を初期化（全員チェック）
                this.searchNurseFilter = {};
                uniqueNurses.forEach(nurse => {
                    this.searchNurseFilter[nurse] = true;
                });
                
                // ドロップダウンメニューを生成
                let menuHtml = '';
                
                // 「全員」オプション
                menuHtml += `
                    <div class="dropdown-item" onclick="calendar.selectAllSearchNurses(event)" 
                         style="padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f1f1f1;">
                        <input type="checkbox" checked style="margin-right: 8px; pointer-events: none;">
                        全員
                    </div>
                `;
                
                // 各看護師のオプション
                uniqueNurses.forEach(nurse => {
                    menuHtml += `
                        <div class="dropdown-item" onclick="calendar.toggleSearchNurseFromDropdown('${nurse}', event)" 
                             style="padding: 8px 12px; cursor: pointer; font-size: 13px; hover:background: #f8f9fa;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'">
                            <input type="checkbox" checked style="margin-right: 8px; pointer-events: none;" data-nurse="${nurse}">
                            ${nurse}
                        </div>
                    `;
                });
                
                dropdownMenu.innerHTML = menuHtml;
                nurseFilter.style.display = 'block';
            }
            
            // 検索結果の看護師プルダウンを開閉
            toggleSearchNurseDropdown(event = null) {
                // イベントの伝播を防ぐ
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                const menu = document.getElementById('searchNurseDropdownMenu');
                const arrow = document.querySelector('#searchNurseDropdownBtn .dropdown-arrow');
                const isOpen = menu.style.display === 'block';
                
                if (isOpen) {
                    menu.style.display = 'none';
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.style.display = 'block';
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                    
                    // ドキュメントクリックで閉じるイベントを追加
                    setTimeout(() => {
                        const handleClickOutside = (e) => {
                            if (!e.target.closest('.search-nurse-dropdown')) {
                                menu.style.display = 'none';
                                if (arrow) arrow.style.transform = 'rotate(0deg)';
                                document.removeEventListener('click', handleClickOutside);
                            }
                        };
                        document.addEventListener('click', handleClickOutside);
                    }, 0);
                }
            }
            
            // プルダウンから看護師フィルタを切り替え
            toggleSearchNurseFromDropdown(nurseName, event = null) {
                // イベントの伝播を防ぐ
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                const currentState = this.searchNurseFilter[nurseName];
                this.searchNurseFilter[nurseName] = !currentState;
                
                // チェックボックスの表示を更新
                const checkbox = document.querySelector(`#searchNurseDropdownMenu input[data-nurse="${nurseName}"]`);
                if (checkbox) {
                    checkbox.checked = !currentState;
                }
                
                // ボタンテキストとメニュー状態を更新
                this.updateSearchNurseDropdownDisplay();
                
                // 検索結果を再レンダリング
                this.renderSearchResults();
            }
            
            // 検索結果の「全員」選択
            selectAllSearchNurses(event = null) {
                // イベントの伝播を防ぐ
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                const allChecked = this.searchAvailableNurses.every(nurse => this.searchNurseFilter[nurse]);
                const newState = !allChecked;
                
                // 全看護師の状態を更新
                this.searchAvailableNurses.forEach(nurse => {
                    this.searchNurseFilter[nurse] = newState;
                });
                
                // チェックボックスの表示を更新
                const checkboxes = document.querySelectorAll('#searchNurseDropdownMenu input');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = newState;
                });
                
                // ボタンテキストを更新
                this.updateSearchNurseDropdownDisplay();
                
                // 検索結果を再レンダリング
                this.renderSearchResults();
            }
            
            // 検索結果の看護師プルダウン表示を更新
            updateSearchNurseDropdownDisplay() {
                const button = document.getElementById('searchNurseDropdownBtn');
                const textSpan = button.querySelector('span:first-child');
                const selectedNurses = this.searchAvailableNurses.filter(nurse => this.searchNurseFilter[nurse]);
                
                let buttonText = '';
                if (selectedNurses.length === 0) {
                    buttonText = 'なし';
                } else if (selectedNurses.length === this.searchAvailableNurses.length) {
                    buttonText = '全員';
                } else if (selectedNurses.length === 1) {
                    buttonText = selectedNurses[0];
                } else {
                    buttonText = `${selectedNurses.length}名選択`;
                }
                
                if (textSpan) {
                    textSpan.textContent = buttonText;
                }
            }
            
            // 検索結果をレンダリング（日付でグループ化）
            renderSearchResults() {
                const searchResultsList = document.getElementById('searchResultsList');
                
                // 看護師フィルタを適用
                let filteredResults = this.currentSearchResults;
                if (this.searchNurseFilter) {
                    filteredResults = this.currentSearchResults.filter(slot => {
                        // この時間枠に含まれる看護師のいずれかがフィルタでチェックされているか
                        return slot.availableNurses.some(nurse => this.searchNurseFilter[nurse]);
                    }).map(slot => {
                        // 表示する看護師もフィルタリング
                        return {
                            ...slot,
                            availableNurses: slot.availableNurses.filter(nurse => this.searchNurseFilter[nurse])
                        };
                    });
                }
                
                // まず日付でグループ化
                const groupedResults = filteredResults.reduce((groups, slot) => {
                    const date = slot.date;
                    if (!groups[date]) {
                        groups[date] = [];
                    }
                    groups[date].push(slot);
                    return groups;
                }, {});
                
                // 日付ごとの総枠数を計算
                const dateTotals = {};
                Object.keys(groupedResults).forEach(date => {
                    dateTotals[date] = groupedResults[date].length;
                });
                
                // ソート順を決定
                let sortedDates;
                if (this.currentSortMode === 'earliest') {
                    // 日付順（早い順）
                    sortedDates = Object.keys(groupedResults).sort((a, b) => {
                        return new Date(a) - new Date(b);
                    });
                } else if (this.currentSortMode === 'available') {
                    // 空き枠が多い順（その日の総枠数順）
                    sortedDates = Object.keys(groupedResults).sort((a, b) => {
                        const totalA = dateTotals[a];
                        const totalB = dateTotals[b];
                        if (totalB !== totalA) return totalB - totalA; // 枠数が多い順
                        return new Date(a) - new Date(b); // 同数なら日付順
                    });
                }
                
                // ソート済みの日付順でグループを再構成
                const sortedGroupedResults = {};
                sortedDates.forEach(date => {
                    // 各日付内では時間順にソート
                    sortedGroupedResults[date] = groupedResults[date].sort((a, b) => {
                        return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                    });
                });
                
                // 各日付内で連続する時間帯をまとめる
                Object.keys(sortedGroupedResults).forEach(date => {
                    sortedGroupedResults[date] = this.groupConsecutiveTimeSlots(sortedGroupedResults[date]);
                });
                
                // HTML生成
                const resultsHtml = sortedDates.map(date => {
                    const dateObj = new Date(date);
                    const formattedDate = `${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
                    const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][dateObj.getDay()];
                    const slots = sortedGroupedResults[date];
                    
                    // 実際の総枠数を計算（グループ化前の枠数）
                    const totalSlots = slots.reduce((sum, group) => {
                        if (group.type === 'single') {
                            return sum + 1;
                        } else {
                            return sum + group.slots.length;
                        }
                    }, 0);
                    
                    const slotsHtml = slots.map((group, groupIndex) => {
                        if (group.type === 'single') {
                            // 単独の時間帯
                            const slot = group.slot;
                            return `
                                <div class="time-slot-item" onclick="calendar.selectTimeSlot('${slot.date}', '${slot.startTime}', ['${slot.availableNurses.join("','")}'])">
                                    <span class="slot-time">${slot.startTime}-${slot.endTime}</span>
                                    <span class="slot-nurses">
                                        施術可能看護師: ${slot.availableNurses.length}名 
                                        <span class="nurse-names">(${slot.availableNurses.join(', ')})</span>
                                    </span>
                                </div>
                            `;
                        } else {
                            // 連続する時間帯の範囲
                            const rangeId = `range-${date}-${groupIndex}`;
                            return `
                                <div class="time-range-group">
                                    <div class="time-range-header" onclick="calendar.toggleTimeRange('${rangeId}')">
                                        <span class="range-time">${group.startTime} ~ ${group.endTime}</span>
                                        <span class="range-count">${group.slots.length}枠</span>
                                        <span class="expand-icon">▼</span>
                                    </div>
                                    <div class="time-range-details" id="${rangeId}" style="display: none;">
                                        ${group.slots.map(slot => `
                                            <div class="time-slot-item expanded" onclick="calendar.selectTimeSlot('${slot.date}', '${slot.startTime}', ['${slot.availableNurses.join("','")}'])">
                                                <span class="slot-time">${slot.startTime}-${slot.endTime}</span>
                                                <span class="slot-nurses">
                                                    施術可能看護師: ${slot.availableNurses.length}名 
                                                    <span class="nurse-names">(${slot.availableNurses.join(', ')})</span>
                                                </span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    return `
                        <div class="date-group">
                            <div class="date-header">
                                <span class="date-text">${formattedDate}(${dayOfWeek})</span>
                                <span class="slot-count">${totalSlots}枠</span>
                            </div>
                            <div class="time-slots">
                                ${slotsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                searchResultsList.innerHTML = resultsHtml;
            }
            
            // 連続する時間帯をグループ化
            groupConsecutiveTimeSlots(slots) {
                if (slots.length === 0) return [];
                
                const groups = [];
                let currentGroup = [slots[0]];
                
                for (let i = 1; i < slots.length; i++) {
                    const currentSlot = slots[i];
                    const prevSlot = slots[i - 1];
                    
                    const currentTime = this.timeToMinutes(currentSlot.startTime);
                    const prevTime = this.timeToMinutes(prevSlot.startTime);
                    
                    // 5分間隔で連続しているかチェック
                    if (currentTime - prevTime === 5) {
                        currentGroup.push(currentSlot);
                    } else {
                        // 連続が途切れた場合、現在のグループを保存して新しいグループを開始
                        groups.push(this.createTimeSlotGroup(currentGroup));
                        currentGroup = [currentSlot];
                    }
                }
                
                // 最後のグループを追加
                groups.push(this.createTimeSlotGroup(currentGroup));
                
                return groups;
            }
            
            // 時間帯グループを作成
            createTimeSlotGroup(slots) {
                if (slots.length === 1) {
                    // 単独の時間帯
                    return {
                        type: 'single',
                        slot: slots[0],
                        isExpanded: false
                    };
                } else {
                    // 連続する時間帯
                    return {
                        type: 'range',
                        slots: slots,
                        startTime: slots[0].startTime,
                        endTime: slots[slots.length - 1].startTime,
                        isExpanded: false
                    };
                }
            }
            
            // 時間範囲の展開/折りたたみ
            toggleTimeRange(rangeId) {
                const rangeDetails = document.getElementById(rangeId);
                const expandIcon = document.querySelector(`[onclick="calendar.toggleTimeRange('${rangeId}')"] .expand-icon`);
                
                if (rangeDetails.style.display === 'none') {
                    rangeDetails.style.display = 'block';
                    expandIcon.textContent = '▲';
                } else {
                    rangeDetails.style.display = 'none';
                    expandIcon.textContent = '▼';
                }
            }
            
            // 検索結果のソート方法を切り替え
            switchSearchTab(sortMode, event = null) {
                // イベントの伝播を防ぐ
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                this.currentSortMode = sortMode;
                
                // タブの見た目を更新
                document.querySelectorAll('.search-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#4a5568';
                    tab.style.border = '1px solid #e2e8f0';
                });
                
                const activeTab = document.querySelector(`[data-sort="${sortMode}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                    activeTab.style.background = '#667eea';
                    activeTab.style.color = 'white';
                    activeTab.style.border = 'none';
                }
                
                // 結果を再レンダリング
                this.renderSearchResults();
            }
            
            // 時間枠を選択
            selectTimeSlot(date, startTime, availableNurses = null) {
                // 曜日表示を更新
                this.updateAppointmentDateDayOfWeek(date);
                
                const [hour, minute] = startTime.split(':');
                document.getElementById('startHour').value = hour;
                document.getElementById('startMinute').value = minute;
                document.getElementById('startHour').style.color = '#2d3748';
                document.getElementById('startMinute').style.color = '#2d3748';
                
                // 看護師を自動選択（利用可能な看護師リストが提供された場合）
                if (availableNurses && availableNurses.length > 0) {
                    const nurseSelect = document.getElementById('nurse');
                    const treatmentType = document.getElementById('treatmentType').value;
                    const subItem = document.getElementById('subItem').value;
                    
                    // 施術可能な看護師から最適な看護師を選択
                    let selectedNurse = null;
                    
                    if (treatmentType) {
                        // 施術が選択されている場合、その施術に対応可能な看護師を優先
                        for (const nurseName of availableNurses) {
                            const nurse = this.nurses.find(n => 
                                (typeof n === 'string' ? n : n.name) === nurseName
                            );
                            
                            if (nurse && typeof nurse === 'object' && nurse.treatmentTypes) {
                                const canPerform = subItem ? 
                                    nurse.treatmentTypes.includes(`${treatmentType} - ${subItem}`) :
                                    nurse.treatmentTypes.includes(treatmentType);
                                
                                if (canPerform) {
                                    selectedNurse = nurseName;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // 適切な看護師が見つからない場合、最初の利用可能な看護師を選択
                    if (!selectedNurse) {
                        selectedNurse = availableNurses[0];
                    }
                    
                    nurseSelect.value = selectedNurse;
                    nurseSelect.style.color = '#2d3748';
                } else {
                    // 従来の自動割り当て処理
                    this.autoAssignNurse(date, startTime);
                }
                
                // 検索エリアを非表示
                document.getElementById('searchSuggestionContainer').style.display = 'none';
                
                // 成功メッセージを表示
                this.showSuccessMessage(`${date} ${startTime}の時間枠を選択しました。`);
            }
            
            // 看護師を自動割り当て
            autoAssignNurse(date, startTime) {
                const nurseSelect = document.getElementById('nurse');
                if (nurseSelect.value) return; // 既に選択されている場合は何もしない
                
                const treatmentType = document.getElementById('treatmentType').value;
                const subItem = document.getElementById('subItem').value;
                const duration = parseInt(document.getElementById('duration').value);
                const dayAppointments = this.appointments.filter(apt => apt.date === date);
                const availableNurses = this.getAvailableNurses(date, startTime, duration, dayAppointments, treatmentType, subItem);
                
                if (availableNurses.length > 0) {
                    // 最初の利用可能な看護師を自動選択
                    nurseSelect.value = availableNurses[0];
                    nurseSelect.style.color = '#2d3748'; // 色を変更して選択されたことを示す
                }
            }

            addNewAppointmentFromHistory() {
                // 現在表示中の患者情報を取得
                const patientId = document.getElementById('historyPatientId').textContent;
                const patientName = document.getElementById('historyPatientName').textContent;
                
                if (!patientId || !patientName) {
                    alert('患者情報を取得できませんでした。');
                    return;
                }
                
                // 施術履歴モーダルを閉じる
                document.getElementById('patientHistoryModal').style.display = 'none';
                
                // 新規予約モーダルを開く
                this.openModal();
                
                // 患者情報を自動入力
                const patientNameField = document.getElementById('patientName');
                patientNameField.value = `${patientId}　${patientName}`;
                patientNameField.readOnly = true; // 選択後は読み取り専用
                
                document.getElementById('patientId').value = patientId;
                
                // 履歴表示ボタンを表示
                const historyBtn = document.getElementById('showHistoryBtn');
                if (historyBtn) {
                    historyBtn.style.display = 'block';
                }
            }

            updatePatientHistory(patientId, treatment, nurse, date) {
                const patient = this.patients.find(p => p.id === patientId);
                if (!patient) return;

                // 履歴に追加
                patient.history.unshift({
                    date: date,
                    treatment: treatment,
                    nurse: nurse
                });

                // 来院回数更新
                patient.totalVisits++;
                patient.lastVisit = date;
            }
            
            // 印刷メニューの表示・非表示
            togglePrintMenu() {
                const dropdown = document.getElementById('printMenuDropdown');
                if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            }
            
            // 表印刷（従来の印刷機能）
            printSchedule() {
                document.getElementById('printMenuDropdown').style.display = 'none';
                window.print();
            }
            
            // フィルター情報を取得
            getFilterInfo() {
                const allNursesElement = document.getElementById('allNurses');
                const allDevicesElement = document.getElementById('allDevices');
                const allNursesChecked = allNursesElement ? allNursesElement.checked : true;
                const allDevicesChecked = allDevicesElement ? allDevicesElement.checked : true;
                
                const filterParts = [];
                
                // 看護師フィルター
                if (!allNursesChecked) {
                    const selectedNurses = [];
                    const nurseCheckboxes = document.querySelectorAll('#nurseCheckboxes input[type="checkbox"]:checked');
                    nurseCheckboxes.forEach(checkbox => {
                        selectedNurses.push(checkbox.value);
                    });
                    if (selectedNurses.length > 0) {
                        filterParts.push(`看護師: ${selectedNurses.join(', ')}`);
                    }
                }
                
                // デバイスフィルター
                if (!allDevicesChecked) {
                    const selectedDevices = [];
                    const deviceCheckboxes = document.querySelectorAll('#deviceCheckboxes input[type="checkbox"]:checked');
                    deviceCheckboxes.forEach(checkbox => {
                        selectedDevices.push(checkbox.value);
                    });
                    if (selectedDevices.length > 0) {
                        filterParts.push(`デバイス: ${selectedDevices.join(', ')}`);
                    }
                }
                
                return filterParts.length > 0 ? ` (${filterParts.join(' / ')})` : '';
            }

            // 一覧印刷
            printList() {
                document.getElementById('printMenuDropdown').style.display = 'none';
                this.generatePrintAppointmentList();
                document.body.classList.add('print-list-mode');
                
                // 印刷実行
                setTimeout(() => {
                    window.print();
                }, 100);
                
                // 印刷完了後にモードを戻す
                setTimeout(() => {
                    document.body.classList.remove('print-list-mode');
                    // 一覧HTMLをクリア
                    document.getElementById('printAppointmentList').innerHTML = '';
                }, 1000);
            }
            
            // 施術ごとにグループ化した予約一覧を生成
            generatePrintAppointmentList() {
                const year = this.currentDate.getFullYear();
                const month = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                const day = this.currentDate.getDate().toString().padStart(2, '0');
                const currentDateStr = `${year}-${month}-${day}`;
                
                // フィルターを適用した予約から当日分を取得
                const filteredAppointments = this.getFilteredAppointments();
                const todayAppointments = filteredAppointments.filter(apt => apt.date === currentDateStr);
                
                // フィルター情報を取得
                const filterInfo = this.getFilterInfo();
                
                if (todayAppointments.length === 0) {
                    document.getElementById('printAppointmentList').innerHTML = `
                        <div class="print-list-header">
                            <div class="print-list-date">${this.currentDate.getFullYear()}年${this.currentDate.getMonth() + 1}月${this.currentDate.getDate()}日 予約一覧${filterInfo}</div>
                            <div>予約はありません</div>
                        </div>
                    `;
                    return;
                }
                
                // 施術タイプでグループ化
                const appointmentsByTreatment = {};
                todayAppointments.forEach(apt => {
                    if (!appointmentsByTreatment[apt.treatmentType]) {
                        appointmentsByTreatment[apt.treatmentType] = [];
                    }
                    appointmentsByTreatment[apt.treatmentType].push(apt);
                });
                
                // 各グループ内で時間順にソート
                Object.keys(appointmentsByTreatment).forEach(treatmentType => {
                    appointmentsByTreatment[treatmentType].sort((a, b) => {
                        return a.startTime.localeCompare(b.startTime);
                    });
                });
                
                // HTML生成
                let html = `
                    <div class="print-list-header">
                        <div class="print-list-date">${this.currentDate.getFullYear()}年${this.currentDate.getMonth() + 1}月${this.currentDate.getDate()}日 予約一覧${filterInfo}</div>
                    </div>
                `;
                
                Object.keys(appointmentsByTreatment).forEach(treatmentType => {
                    const appointments = appointmentsByTreatment[treatmentType];
                    
                    html += `
                        <div class="print-treatment-group">
                            <div class="print-treatment-title">${treatmentType} (${appointments.length}件)</div>
                            <table class="print-appointment-table">
                                <thead>
                                    <tr>
                                        <th class="print-time-col">時間</th>
                                        <th class="print-patient-col">患者名</th>
                                        <th class="print-nurse-col">看護師</th>
                                        <th class="print-treatment-col">詳細</th>
                                        <th class="print-device-col">デバイス</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    appointments.forEach(apt => {
                        const endTime = this.calculateEndTime(apt.startTime, apt.duration);
                        const deviceText = apt.device && apt.device !== 'なし' ? apt.device : '-';
                        const nurseText = apt.nurse || '-';
                        
                        // 施術詳細にサブ項目を含める
                        let treatmentDetail = apt.treatmentDetails || apt.treatmentType;
                        if (apt.subItem) {
                            treatmentDetail = `${apt.treatmentType} - ${apt.subItem}`;
                        }
                        
                        html += `
                            <tr>
                                <td>${apt.startTime} - ${endTime}</td>
                                <td>${apt.patientName}</td>
                                <td>${nurseText}</td>
                                <td>${treatmentDetail}</td>
                                <td>${deviceText}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                document.getElementById('printAppointmentList').innerHTML = html;
            }
        
            // ========== 設定管理機能 ==========
            
            // パスワードの取得
            getSystemPassword() {
                // ページ更新時はデフォルトパスワードに戻る（localStorageは使わない）
                return this.temporaryPassword || '1234';
            }
            
            // パスワードの設定
            setSystemPassword(password) {
                // 一時的にメモリ上にのみ保存（ページ更新でリセット）
                this.temporaryPassword = password;
            }
            
            // パスワード変更処理
            changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // 入力値検証
                if (!currentPassword || !newPassword || !confirmPassword) {
                    alert('すべての項目を入力してください。');
                    return;
                }
                
                // 現在のパスワード確認
                if (currentPassword !== this.getSystemPassword()) {
                    alert('現在のパスワードが正しくありません。');
                    document.getElementById('currentPassword').focus();
                    return;
                }
                
                // 新しいパスワードの形式チェック
                if (!/^[0-9]{4}$/.test(newPassword)) {
                    alert('新しいパスワードは4桁の数字で入力してください。');
                    document.getElementById('newPassword').focus();
                    return;
                }
                
                // パスワード確認チェック
                if (newPassword !== confirmPassword) {
                    alert('新しいパスワードと確認パスワードが一致しません。');
                    document.getElementById('confirmPassword').focus();
                    return;
                }
                
                // 同じパスワードチェック
                if (currentPassword === newPassword) {
                    alert('新しいパスワードは現在のパスワードと異なるものを入力してください。');
                    document.getElementById('newPassword').focus();
                    return;
                }
                
                // パスワード更新
                this.setSystemPassword(newPassword);
                
                // フィールドクリア
                this.clearPasswordFields();
                
                alert('パスワードが正常に変更されました。');
            }
            
            // パスワード入力フィールドのクリア
            clearPasswordFields() {
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }

        } // BeautyClinicScheduleManagerクラス終了

        // グローバル変数として calendar を設定
        let calendar;

        function initializeFallback() {
            // フォールバック初期化関数
            console.log('🔄 フォールバック初期化実行');
            try {
                if (!calendar) {
                    calendar = new BeautyClinicScheduleManager();
                }
                calendar.emergencyFallback();
                window.clinic = calendar;
                console.log('✅ フォールバック初期化完了');
            } catch (error) {
                console.error('💀 フォールバック初期化も失敗:', error);
                // 最後の手段: 直接HTML操作
                const scheduleBody = document.getElementById('scheduleBody');
                if (scheduleBody) {
                    scheduleBody.innerHTML = '<tr><td>エラー: システムの初期化に失敗しました</td></tr>';
                }
            }
        }

        // フィルタードロップダウンの開閉
        function toggleFilterDropdown(filterId) {
            const dropdownId = filterId + 'Dropdown';
            const dropdown = document.getElementById(dropdownId);
            const trigger = dropdown.previousElementSibling;
            
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                // 他のドロップダウンを閉じる
                document.querySelectorAll('.filter-dropdown-content').forEach(content => {
                    content.style.display = 'none';
                    if (content.previousElementSibling) {
                        content.previousElementSibling.classList.remove('open');
                    }
                });
                
                dropdown.style.display = 'block';
                trigger.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
        }

        // 印刷時の縮尺を自動調整
        function adjustPrintScale() {
            const headers = document.querySelectorAll('#scheduleHeaderRow th');
            const treatmentCount = headers.length - 1; // 時間列を除く
            
            // 施術メニュー数に応じて縮尺とフォントサイズを調整
            let scale = 1;
            let fontSize = 10;
            let cellFontSize = 10;
            let padding = 4;
            let countFontSize = 9;
            let appointmentFontSize = 8;
            
            if (treatmentCount > 20) {
                scale = 0.6;
                fontSize = 8;
                cellFontSize = 8;
                padding = 2;
                countFontSize = 7;
                appointmentFontSize = 6;
            } else if (treatmentCount > 15) {
                scale = 0.7;
                fontSize = 9;
                cellFontSize = 9;
                padding = 3;
                countFontSize = 8;
                appointmentFontSize = 7;
            } else if (treatmentCount > 12) {
                scale = 0.8;
                fontSize = 9;
                cellFontSize = 9;
                padding = 3;
                countFontSize = 8;
                appointmentFontSize = 7;
            } else if (treatmentCount > 10) {
                scale = 0.9;
                fontSize = 10;
                cellFontSize = 10;
                padding = 3;
                countFontSize = 9;
                appointmentFontSize = 8;
            }
            
            // CSS変数を設定
            const root = document.documentElement;
            root.style.setProperty('--print-scale', scale);
            root.style.setProperty('--print-font-size', `${fontSize}px`);
            root.style.setProperty('--print-cell-font-size', `${cellFontSize}px`);
            root.style.setProperty('--print-padding', `${padding}px`);
            root.style.setProperty('--print-count-font-size', `${countFontSize}px`);
            root.style.setProperty('--print-appointment-font-size', `${appointmentFontSize}px`);
            
            console.log(`印刷設定: ${treatmentCount}個の施術メニュー、縮尺${scale}`);
        }
        
        // 印刷時の診断情報を出力する関数
        function diagnosePrintLayout() {
            const scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--print-scale')) || 0.8;
            console.log(`🔍 印刷診断開始 - 縮尺: ${scale}`);
            
            // セルの実際の高さを確認
            const timeCell = document.querySelector('[data-time="11:00"]');
            if (timeCell) {
                const cellHeight = timeCell.getBoundingClientRect().height;
                console.log(`📏 11:00セルの実際の高さ: ${cellHeight}px`);
            }
            
            // 予約ブロックの診断
            document.querySelectorAll('.appointment').forEach(appointment => {
                const duration = appointment.dataset.duration;
                const actualHeight = appointment.getBoundingClientRect().height;
                const computedHeight = getComputedStyle(appointment).height;
                
                console.log(`📋 予約診断: 期間${duration}分, 実際の高さ=${actualHeight}px, CSS高さ=${computedHeight}`);
            });
        }

        // 印刷前に診断実行
        window.addEventListener('beforeprint', () => {
            console.log('🖨️ beforeprintイベント発火');
            adjustPrintScale();
            setTimeout(() => {
                diagnosePrintLayout();
            }, 50);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM読み込み完了 - 強制初期化開始');
            
            // マルチ端末同期開始
            dataManager.startSync();
            console.log('🔄 マルチ端末同期機能を有効化');
            
            // テスト表示は無効化
            // setTimeout(() => {
            //     console.log('予約件数表示テスト開始');
            //     
            //     // 予約件数表示を直接作成
            //     let summaryContainer = document.createElement('div');
            //     summaryContainer.id = 'floatingSummaryContainer';
            //     summaryContainer.innerHTML = '<div style="color: black; font-weight: bold; background: white; padding: 5px; border-radius: 5px;">●件の予約（直接作成）</div>';
            //     summaryContainer.style.cssText = `
            //         position: fixed;
            //         top: 110px;
            //         left: 0;
            //         right: 0;
            //         z-index: 9999;
            //         display: flex;
            //         height: 30px;
            //         background: transparent;
            //         padding-left: 80px;
            //         pointer-events: none;
            //     `;
            //     document.body.appendChild(summaryContainer);
            //     console.log('予約件数表示を直接作成しました');
            // }, 1000);
            
            try {
                calendar = new BeautyClinicScheduleManager();
                console.log('✅ カレンダーインスタンス作成完了');
                
                // 【緊急修正】強制的な表示確認
                setTimeout(() => {
                    console.log('🔄 強制再描画実行');
                    calendar.forceRender();
                }, 100);
                
                // グローバルアクセス用（コンソール制御）
                window.clinic = calendar;
                
                // select要素の色更新イベントハンドラーを追加
                setTimeout(() => {
                    document.querySelectorAll('.form-select').forEach(select => {
                        // 色更新関数
                        const updateColor = () => {
                            if (!select.value || select.value === '') {
                                select.style.color = '#a0aec0';
                            } else {
                                select.style.color = '#2d3748';
                            }
                        };
                        
                        // 初期状態の色を設定
                        updateColor();
                        
                        // 変更時のイベントリスナーを追加
                        select.addEventListener('change', updateColor);
                        
                        // 看護師選択時の追加処理
                        if (select.id === 'nurse') {
                            select.addEventListener('change', function() {
                                if (this.value) {
                                    calendar.updateTreatmentOptionsForNurse(this.value);
                                }
                            });
                        }
                        
                        // プログラム的な値設定時の色更新（MutationObserver使用）
                        const observer = new MutationObserver(() => {
                            updateColor();
                        });
                        observer.observe(select, { attributes: true, attributeFilter: ['value'] });
                    });
                }, 200);
            } catch (error) {
                console.error('💥 初期化エラー:', error);
                // エラー時のフォールバック
                setTimeout(() => {
                    console.log('🆘 フォールバック初期化試行');
                    initializeFallback();
                }, 500);
            }
            
            console.log('🎮 コンソール制御コマンド:');
            console.log('  clinic.enableDebugMode()  - デバッグモード有効');
            console.log('  clinic.disableDebugMode() - デバッグモード無効');  
            console.log('  clinic.showDropStatistics() - ドロップ統計表示');
            console.log('  clinic.testDropIntegrity() - 整合性テスト');
            console.log('  clinic.validateSystemIntegrity() - システム検証');
            console.log('🔧 予約位置修正コマンド:');
            console.log('  clinic.forceUpdateAllAppointmentPositions() - 全予約の位置を強制更新');
            console.log('  clinic.validateAllAppointmentPositions() - 予約位置の検証');
            
            // 日付ナビゲーションの初期化
            initializeDateNavigation();
            console.log('日付ナビゲーション初期化完了');
            
            // カレンダーの月移動ボタンの初期化（1回のみ）
            initializeCalendarNavigation();
            
            // モーダル外側クリックで閉じる処理を追加
            document.addEventListener('click', function(e) {
                // クリックされた要素がモーダル自体（背景）の場合
                if (e.target.classList.contains('modal')) {
                    const modal = e.target;
                    // モーダルを閉じる
                    modal.style.display = 'none';
                    
                    // 特定のモーダルの場合は追加の処理を実行
                    if (modal.id === 'appointmentModal') {
                        // calendarのcloseModal処理を呼ぶ
                        if (calendar && calendar.closeModal) {
                            calendar.closeModal();
                        }
                    } else if (modal.id === 'datePickerModal') {
                        hideCalendarPopup();
                    } else if (modal.id === 'patientDetailModal') {
                        closePatientDetailModal();
                    } else if (modal.id === 'patientHistoryModal') {
                        closePatientHistoryModal();
                    }
                }
            });
            
            // キーボードショートカットの初期化
            initializeKeyboardShortcuts();
            
            // 患者検索のサジェスションを外側クリックで閉じる
            document.addEventListener('click', (e) => {
                const patientSelectContainer = document.querySelector('.patient-select-container');
                if (patientSelectContainer && !patientSelectContainer.contains(e.target)) {
                    document.getElementById('patientSuggestions').style.display = 'none';
                }
            });
        });

        // 【追加保険】ウィンドウロード時にも再実行
        window.addEventListener('load', () => {
            console.log('🔄 ウィンドウロード完了 - 追加確認');
            if (calendar) {
                setTimeout(() => {
                    console.log('🔄 追加再描画実行');
                    calendar.forceRender();
                }, 300);
            } else {
                console.log('🆘 ウィンドウロード時にカレンダーなし - フォールバック実行');
                initializeFallback();
            }
        });

        // 日付ナビゲーション機能の初期化
        function initializeDateNavigation() {
            const currentDateElement = document.getElementById('currentDate');
            const calendarPopup = document.getElementById('calendarPopup');
            const todayBtn = document.getElementById('todayBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            
            // カレンダーアイコンクリックでポップアップ表示
            currentDateElement.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleCalendarPopup();
            });
            
            // オーバーレイクリックでポップアップを閉じる
            const calendarOverlay = document.getElementById('calendarOverlay');
            if (calendarOverlay) {
                calendarOverlay.addEventListener('click', () => {
                    hideCalendarPopup();
                });
            }
            
            // カレンダーポップアップ内のクリックは伝播させない
            if (calendarPopup) {
                calendarPopup.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // 今日ボタン
            todayBtn?.addEventListener('click', () => {
                navigateToToday();
            });
            
            // 前日/次日ボタン
            prevBtn?.addEventListener('click', () => {
                calendar.navigate(-1);
            });
            
            nextBtn?.addEventListener('click', () => {
                calendar.navigate(1);
            });
            
            // 週ナビゲーション
            prevWeekBtn?.addEventListener('click', () => {
                calendar.navigate(-7);
            });
            
            nextWeekBtn?.addEventListener('click', () => {
                calendar.navigate(7);
            });
            
            // 月ナビゲーション
            prevMonthBtn?.addEventListener('click', () => {
                navigateMonth(-1);
            });
            
            nextMonthBtn?.addEventListener('click', () => {
                navigateMonth(1);
            });
            
            // カレンダーポップアップ内のナビゲーション
            const calendarPrevBtn = document.getElementById('calendarPrevMonth');
            const calendarNextBtn = document.getElementById('calendarNextMonth');
            
            if (calendarPrevBtn) {
                calendarPrevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('前月ボタンがクリックされました');
                    navigateCalendarMonth(-1);
                });
            } else {
                console.error('前月ボタンが見つかりません');
            }
            
            if (calendarNextBtn) {
                calendarNextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('次月ボタンがクリックされました');
                    navigateCalendarMonth(1);
                });
            } else {
                console.error('次月ボタンが見つかりません');
            }
            
            // 初期カレンダー描画
            renderCalendarPopup();
        }

        // カレンダーポップアップの表示切替
        // カレンダーポップアップの表示切替
        function toggleCalendarPopup() {
            const calendarPopup = document.getElementById('calendarPopup');
            if (calendarPopup.classList.contains('show')) {
                hideCalendarPopup();
            } else {
                showCalendarPopup();
            }
        }

        function showCalendarPopup() {
            const calendarPopup = document.getElementById('calendarPopup');
            const calendarOverlay = document.getElementById('calendarOverlay');
            
            // オーバーレイとポップアップを表示
            if (calendarOverlay) {
                calendarOverlay.classList.add('show');
            }
            calendarPopup.classList.add('show');
            bringToFront(calendarPopup); // カレンダーを最前面に
            bringToFront(calendarOverlay); // オーバーレイも最前面に
            
            // 確実に最前面に表示するため、少し遅延してもう一度実行
            setTimeout(() => {
                bringToFront(calendarPopup);
                if (calendarOverlay) {
                    bringToFront(calendarOverlay);
                }
                console.log('メインカレンダーを最前面に配置');
            }, 50);
            
            // bodyにクラスを追加してスクロール禁止
            document.body.classList.add('calendar-open');
            
            // カレンダー表示開始時に現在日付に合わせる（初回のみ）
            if (!window.calendarDisplayDate) {
                window.calendarDisplayDate = new Date(calendar.currentDate);
                console.log('初回カレンダー日付設定:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            } else {
                console.log('既存カレンダー日付を維持:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            }
            renderCalendarPopup();
        }

        function hideCalendarPopup() {
            const calendarPopup = document.getElementById('calendarPopup');
            const calendarOverlay = document.getElementById('calendarOverlay');
            
            // オーバーレイとポップアップを非表示
            calendarPopup.classList.remove('show');
            if (calendarOverlay) {
                calendarOverlay.classList.remove('show');
            }
            
            // bodyからクラスを削除してスクロール許可
            document.body.classList.remove('calendar-open');
        }

        // カレンダー月移動機能の初期化（完全リセット）
        function initializeCalendarNavigation() {
            const calendarPrevBtn = document.getElementById('calendarPrevMonth');
            const calendarNextBtn = document.getElementById('calendarNextMonth');
            const calendarPrev6Btn = document.getElementById('calendarPrev6Month');
            const calendarNext6Btn = document.getElementById('calendarNext6Month');
            
            console.log('カレンダーボタン要素チェック:', {
                前月ボタン: calendarPrevBtn ? '存在' : '見つからない',
                次月ボタン: calendarNextBtn ? '存在' : '見つからない',
                前6ヶ月ボタン: calendarPrev6Btn ? '存在' : '見つからない',
                次6ヶ月ボタン: calendarNext6Btn ? '存在' : '見つからない'
            });
            
            if (calendarPrevBtn) {
                const newPrevBtn = calendarPrevBtn.cloneNode(true);
                calendarPrevBtn.parentNode.replaceChild(newPrevBtn, calendarPrevBtn);
                newPrevBtn.addEventListener('click', handlePrevMonth);
                console.log('前月ボタンのイベントリスナー設定完了');
            }
            
            if (calendarNextBtn) {
                const newNextBtn = calendarNextBtn.cloneNode(true);
                calendarNextBtn.parentNode.replaceChild(newNextBtn, calendarNextBtn);
                newNextBtn.addEventListener('click', handleNextMonth);
                console.log('次月ボタンのイベントリスナー設定完了');
            }
            
            if (calendarPrev6Btn) {
                const newPrev6Btn = calendarPrev6Btn.cloneNode(true);
                calendarPrev6Btn.parentNode.replaceChild(newPrev6Btn, calendarPrev6Btn);
                newPrev6Btn.addEventListener('click', handlePrev6Month);
                console.log('前6ヶ月ボタンのイベントリスナー設定完了');
            }
            
            if (calendarNext6Btn) {
                const newNext6Btn = calendarNext6Btn.cloneNode(true);
                calendarNext6Btn.parentNode.replaceChild(newNext6Btn, calendarNext6Btn);
                newNext6Btn.addEventListener('click', handleNext6Month);
                console.log('次6ヶ月ボタンのイベントリスナー設定完了');
            }
            
            // カレンダー表示日を現在の日付に初期化
            if (!window.calendarDisplayDate) {
                window.calendarDisplayDate = new Date(calendar.currentDate);
            }
            
            console.log('カレンダー月移動機能初期化完了');
        }
        
        // イベントハンドラー関数を分離（実行回数カウンター付き）
        let prevMonthClickCount = 0;
        let nextMonthClickCount = 0;
        let prev6MonthClickCount = 0;
        let next6MonthClickCount = 0;
        
        function handlePrevMonth(e) {
            e.preventDefault();
            e.stopPropagation();
            prevMonthClickCount++;
            console.log(`前月ボタンがクリックされました（${prevMonthClickCount}回目）`);
            navigateCalendarMonth(-1);
        }
        
        function handleNextMonth(e) {
            e.preventDefault();
            e.stopPropagation();
            nextMonthClickCount++;
            console.log(`次月ボタンがクリックされました（${nextMonthClickCount}回目）`);
            navigateCalendarMonth(1);
        }
        
        function handlePrev6Month(e) {
            e.preventDefault();
            e.stopPropagation();
            prev6MonthClickCount++;
            console.log(`前6ヶ月ボタンがクリックされました（${prev6MonthClickCount}回目）`);
            navigateCalendarMonth(-6);
        }
        
        function handleNext6Month(e) {
            e.preventDefault();
            e.stopPropagation();
            next6MonthClickCount++;
            console.log(`次6ヶ月ボタンがクリックされました（${next6MonthClickCount}回目）`);
            navigateCalendarMonth(6);
        }

        // カレンダーの月を移動
        function navigateCalendarMonth(monthOffset) {
            if (!window.calendarDisplayDate) {
                window.calendarDisplayDate = new Date(calendar.currentDate);
            }
            
            window.calendarDisplayDate.setMonth(window.calendarDisplayDate.getMonth() + monthOffset);
            console.log('カレンダー月移動:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            renderCalendarPopup();
        }

        // 今日に移動
        function navigateToToday() {
            calendar.currentDate = new Date();
            calendar.render();
            hideCalendarPopup();
        }

        // 月ナビゲーション
        function navigateMonth(direction) {
            const newDate = new Date(calendar.currentDate);
            newDate.setMonth(newDate.getMonth() + direction);
            calendar.currentDate = newDate;
            calendar.render();
        }

        // カレンダーポップアップの月ナビゲーション
        function navigateCalendarMonth(direction) {
            // window.calendarDisplayDateが存在しない場合は初期化
            if (!window.calendarDisplayDate) {
                window.calendarDisplayDate = new Date(calendar.currentDate);
            }
            
            console.log(`月ナビゲーション: ${direction > 0 ? '次月' : '前月'}`);
            console.log('変更前の日付:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            
            // 年またぎの処理を含む月変更
            const currentYear = window.calendarDisplayDate.getFullYear();
            const currentMonth = window.calendarDisplayDate.getMonth();
            
            // window.calendarDisplayDateを直接変更
            window.calendarDisplayDate.setMonth(currentMonth + direction);
            
            // 年またぎ処理の確認
            if (direction > 0 && currentMonth === 11) {
                console.log('年またぎ（次年）:', currentYear, '→', window.calendarDisplayDate.getFullYear());
            } else if (direction < 0 && currentMonth === 0) {
                console.log('年またぎ（前年）:', currentYear, '→', window.calendarDisplayDate.getFullYear());
            }
            
            console.log('変更後の日付:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            renderCalendarPopup();
        }

        // カレンダーポップアップの描画
        // カレンダーポップアップの描画
        function renderCalendarPopup() {
            // calendarDisplayDateは他の関数で設定済みなので、ここでは初期化しない
            console.log('カレンダー描画開始:', window.calendarDisplayDate ? window.calendarDisplayDate.toLocaleDateString('ja-JP') : '未設定');
            
            const monthYearElement = document.getElementById('calendarMonthYear');
            const calendarGridElement = document.getElementById('calendarGrid');
            
            if (!monthYearElement || !calendarGridElement) {
                console.error('カレンダー要素が見つかりません');
                return;
            }
            
            // calendarDisplayDateが存在しない場合のみ初期化
            if (!window.calendarDisplayDate) {
                window.calendarDisplayDate = new Date(calendar.currentDate);
                console.log('カレンダー初期化:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            } else {
                console.log('既存のカレンダー日付を使用:', window.calendarDisplayDate.toLocaleDateString('ja-JP'));
            }
            
            // 月年表示更新
            const options = { year: 'numeric', month: 'long' };
            const displayText = window.calendarDisplayDate.toLocaleDateString('ja-JP', options);
            console.log('月年表示を更新:', {
                calendarDisplayDate: window.calendarDisplayDate,
                表示テキスト: displayText,
                年: window.calendarDisplayDate.getFullYear(),
                月: window.calendarDisplayDate.getMonth() + 1
            });
            monthYearElement.textContent = displayText;
            
            // カレンダーグリッド作成
            calendarGridElement.innerHTML = '';
            
            // 曜日ヘッダー
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-weekday';
                dayElement.textContent = day;
                calendarGridElement.appendChild(dayElement);
            });
            
            // 月の最初の日と最後の日を取得
            const firstDay = new Date(window.calendarDisplayDate.getFullYear(), window.calendarDisplayDate.getMonth(), 1);
            const lastDay = new Date(window.calendarDisplayDate.getFullYear(), window.calendarDisplayDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // 6週間分の日付を表示
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = currentDate.getDate();
                
                // 現在の月以外の日付
                if (currentDate.getMonth() !== window.calendarDisplayDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                // 今日の日付
                const today = new Date();
                if (currentDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                    console.log('今日の日付を発見:', currentDate.toDateString());
                }
                
                // 選択中の日付
                // 1. スケジュール表のカレンダーの場合は calendar.currentDate を使用
                // 2. 日付入力モーダルの場合は入力フィールドの値を使用
                const appointmentDateInput = document.getElementById('appointmentDate');
                let isSelected = false;
                
                // メインスケジュールの選択日
                if (currentDate.toDateString() === calendar.currentDate.toDateString()) {
                    isSelected = true;
                }
                
                // 日付入力モーダルが表示されている場合は入力フィールドの値も確認
                if (appointmentDateInput && appointmentDateInput.value) {
                    const inputDate = new Date(appointmentDateInput.value);
                    if (currentDate.toDateString() === inputDate.toDateString()) {
                        isSelected = true;
                    }
                }
                
                if (isSelected) {
                    dayElement.classList.add('selected');
                }
                
                // 休診日の判定とスタイル適用
                const isClosedDay = calendar.isClosedDay(currentDate);
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().split('T')[0];
                const isHoliday = calendar.holidays.includes(dateStr);
                const isSaturdayHoliday = isHoliday && dayOfWeek === 6;
                
                // デバッグログ：休診日判定の確認
                if (currentDate.getDate() <= 7) { // 月初の1週間のみログ出力
                    console.log(`日付: ${dateStr}, 曜日: ${dayOfWeek} (0=日,1=月), 休診日: ${isClosedDay}`);
                }
                
                if (isClosedDay && !isSaturdayHoliday) {
                    dayElement.classList.add('closed-day');
                } else if (isSaturdayHoliday) {
                    dayElement.classList.add('saturday-holiday');
                }
                
                // クリックイベント
                dayElement.addEventListener('click', () => {
                    // 休診日（土曜祝日以外）は選択不可
                    if (isClosedDay && !isSaturdayHoliday) {
                        // 警告メッセージを表示（後で実装）
                        console.log('休診日のため選択できません:', currentDate.toLocaleDateString('ja-JP'));
                        return;
                    }
                    
                    // タイムゾーンの問題を避けるため、年月日を直接設定
                    const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                    console.log('📆 カレンダー日付選択:', {
                        '選択した日付': currentDate.toLocaleDateString('ja-JP'),
                        '設定する日付': selectedDate.toISOString().split('T')[0]
                    });
                    calendar.currentDate = selectedDate;
                    calendar.render();
                    hideCalendarPopup();
                });
                
                calendarGridElement.appendChild(dayElement);
            }
            
            console.log('カレンダー描画完了:', window.calendarDisplayDate.getFullYear() + '年' + (window.calendarDisplayDate.getMonth() + 1) + '月');
        }

        // キーボードショートカットの初期化
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // モーダルが開いている場合はスキップ
                if (document.getElementById('appointmentModal').style.display === 'block' ||
                    document.getElementById('manageModal').style.display === 'block') {
                    return;
                }
                
                // 入力フィールドにフォーカスがある場合はスキップ
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch (e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        calendar.navigate(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        calendar.navigate(1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        calendar.navigate(-7);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        calendar.navigate(7);
                        break;
                    case ' ': // スペースキー
                        e.preventDefault();
                        navigateToToday();
                        break;
                    case 'c':
                    case 'C':
                        e.preventDefault();
                        toggleCalendarPopup();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        hideCalendarPopup();
                        break;
                    case 't':
                    case 'T':
                        e.preventDefault();
                        navigateToToday();
                        break;
                    case ',':
                        e.preventDefault();
                        navigateMonth(-1);
                        break;
                    case '.':
                        e.preventDefault();
                        navigateMonth(1);
                        break;
                }
            });
        }

        // 履歴の施術メニューフィルタープルタブの開閉
        function toggleHistoryTreatmentFilter() {
            const dropdown = document.getElementById('treatmentFilterDropdown');
            const trigger = dropdown.previousElementSibling;
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                trigger.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                trigger.classList.remove('open');
            }
            
            // 他のドロップダウンを閉じる
            document.querySelectorAll('.filter-dropdown-content').forEach(content => {
                if (content !== dropdown) {
                    content.style.display = 'none';
                    if (content.previousElementSibling) {
                        content.previousElementSibling.classList.remove('open');
                    }
                }
            });
        }

        // 【クリーンアップ完了】
        // バックアップファイル: beauty-clinic-enhanced-backup-clean.html
        // 動作確認方法: ブラウザコンソールで calendar.testSystemFunctions() を実行
        // クリーンアップ内容: 不要なconsole.log削除、重複コード確認済み、動作テスト機能追加
    </script>

    <!-- 施術設定統合モーダル -->
    <div id="durationEditModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="calendar.closeDurationEditModal()">&times;</span>
            <h2 id="durationEditTitle">施術設定</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="durationEditValue">標準所要時間（分）:</label>
                    <select id="durationEditValue" class="form-select" required>
                        <!-- JavaScriptで動的生成 -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>間隔設定（日）:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" 
                               id="intervalMinValue" 
                               class="form-input" 
                               min="1" 
                               max="365" 
                               placeholder="未設定"
                               style="width: 80px;">
                        <span>日～</span>
                        <input type="number" 
                               id="intervalMaxValue" 
                               class="form-input" 
                               min="1" 
                               max="365" 
                               placeholder="未設定"
                               style="width: 80px;">
                        <span>日</span>
                    </div>
                    <small style="color: #6b7280; display: block; margin-top: 8px;">
                        最低間隔のみ、または両方を入力してください
                    </small>
                </div>

                <!-- 曜日ごとの時間帯制限設定 -->
                <div class="form-group" style="border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
                    <label class="form-label" style="font-weight: bold; margin-bottom: 15px;">曜日ごとの実施可能時間帯</label>
                    <div id="weeklyTimeRestrictions" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- 日曜日 -->
                        <div class="day-restriction-row" data-day="0" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500; color: #e53e3e;">日</label>
                            <span style="color: #9ca3af;">休診日</span>
                        </div>
                        
                        <!-- 月曜日 -->
                        <div class="day-restriction-row" data-day="1" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500;">月</label>
                            <span style="color: #9ca3af;">休診日</span>
                        </div>
                        
                        <!-- 火曜日 -->
                        <div class="day-restriction-row" data-day="2" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500;">火</label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="dayEnabled2" onchange="calendar.toggleDayRestriction(2)" checked>
                                <span>実施可</span>
                            </label>
                            <div class="time-range-inputs" id="timeRange2" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <input type="time" id="startTime2" value="10:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span>〜</span>
                                <input type="time" id="endTime2" value="19:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- 水曜日 -->
                        <div class="day-restriction-row" data-day="3" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500;">水</label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="dayEnabled3" onchange="calendar.toggleDayRestriction(3)" checked>
                                <span>実施可</span>
                            </label>
                            <div class="time-range-inputs" id="timeRange3" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <input type="time" id="startTime3" value="10:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span>〜</span>
                                <input type="time" id="endTime3" value="19:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- 木曜日 -->
                        <div class="day-restriction-row" data-day="4" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500;">木</label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="dayEnabled4" onchange="calendar.toggleDayRestriction(4)" checked>
                                <span>実施可</span>
                            </label>
                            <div class="time-range-inputs" id="timeRange4" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <input type="time" id="startTime4" value="10:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span>〜</span>
                                <input type="time" id="endTime4" value="19:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- 金曜日 -->
                        <div class="day-restriction-row" data-day="5" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500;">金</label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="dayEnabled5" onchange="calendar.toggleDayRestriction(5)" checked>
                                <span>実施可</span>
                            </label>
                            <div class="time-range-inputs" id="timeRange5" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <input type="time" id="startTime5" value="10:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span>〜</span>
                                <input type="time" id="endTime5" value="19:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <!-- 土曜日 -->
                        <div class="day-restriction-row" data-day="6" style="display: flex; align-items: center; gap: 15px; padding: 10px; background: #f9fafb; border-radius: 6px;">
                            <label style="width: 40px; font-weight: 500; color: #3b82f6;">土</label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="dayEnabled6" onchange="calendar.toggleDayRestriction(6)" checked>
                                <span>実施可</span>
                            </label>
                            <div class="time-range-inputs" id="timeRange6" style="display: flex; gap: 10px; align-items: center; flex: 1;">
                                <input type="time" id="startTime6" value="10:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <span>〜</span>
                                <input type="time" id="endTime6" value="17:00" style="padding: 5px; border: 1px solid #e2e8f0; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                    <small style="color: #6b7280; display: block; margin-top: 10px;">
                        ※ 各曜日で施術可能な時間帯を設定できます。チェックを外すとその曜日は施術不可になります。
                    </small>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="calendar.saveDurationEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 所要時間管理モーダル -->
    <div id="durationManageModal" class="modal">
        <div class="modal-content modal-large" style="max-width: 600px;">
            <span class="close" onclick="calendar.closeDurationManageModal()">&times;</span>
            <h2>所要時間管理</h2>
            <div class="modal-body">
                <div class="manage-header" style="margin-bottom: 20px;">
                    <div class="add-item-form">
                        <input type="number" class="form-input" id="newDuration" 
                               placeholder="分数を入力（5分単位）" min="5" step="5" style="width: 200px;">
                        <button class="btn btn-add" onclick="calendar.addDuration()">
                            <span class="btn-icon">+</span> 追加
                        </button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                        💡 5分単位で入力してください（例：30, 45, 60分など）
                    </div>
                </div>
                <div class="manage-table-container">
                    <table class="manage-table">
                        <thead>
                            <tr>
                                <th width="70%">所要時間</th>
                                <th width="30%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="durationList">
                            <!-- JavaScriptで動的生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- サブ項目追加モーダル -->
    <div id="addSubItemModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="calendar.closeAddSubItemModal()">&times;</span>
            <h2 id="addSubItemTitle">サブ項目追加</h2>
            <div class="modal-body">
                <div class="form-group">
                    <label for="subItemName">サブ項目名:</label>
                    <input type="text" id="subItemName" class="form-input" placeholder="サブ項目名を入力してください" maxlength="50">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="calendar.saveSubItem()">追加</button>
            </div>
        </div>
    </div>
    
    <!-- 間隔制限警告モーダル -->
    <div id="intervalWarningModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="calendar.closeIntervalWarningModal()">&times;</span>
            <h2 style="color: #e53e3e; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 24px;">⚠️</span>
                間隔制限の警告
            </h2>
            <div class="modal-body">
                <div id="intervalWarningContent" style="line-height: 1.6; color: #4a5568;"></div>
                <div style="margin-top: 20px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; color: #991b1b;">
                    <strong>ℹ️ 間隔を無視して予約を入れますか？</strong>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="calendar.forceCreateAppointment()" style="background: #e53e3e; border-color: #e53e3e;">強制予約</button>
                <button type="button" class="btn" onclick="calendar.closeIntervalWarningModal()" style="background: #6b7280; border-color: #6b7280;">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // 全ルール違反をチェックする関数
        function checkAllConflicts() {
            console.log('🔍 全ルール違反チェック開始');
            
            if (!calendar || !calendar.appointments) {
                console.error('❌ カレンダーまたは予約データが見つかりません');
                return;
            }
            
            const conflicts = [];
            const appointments = calendar.appointments;
            
            // 看護師重複チェック
            for (let i = 0; i < appointments.length; i++) {
                for (let j = i + 1; j < appointments.length; j++) {
                    const apt1 = appointments[i];
                    const apt2 = appointments[j];
                    
                    // 同じ日付かつ同じ看護師の場合のみチェック
                    if (apt1.date === apt2.date && apt1.nurse === apt2.nurse) {
                        const start1 = timeToMinutes(apt1.startTime);
                        const end1 = start1 + apt1.duration;
                        const start2 = timeToMinutes(apt2.startTime);
                        const end2 = start2 + apt2.duration;
                        
                        // 時間重複チェック
                        if (start1 < end2 && start2 < end1) {
                            conflicts.push({
                                type: '看護師重複',
                                details: `${apt1.nurse}: ${apt1.patientName}(${apt1.startTime}-${minutesToTime(end1)}) vs ${apt2.patientName}(${apt2.startTime}-${minutesToTime(end2)})`,
                                date: apt1.date
                            });
                        }
                    }
                }
            }
            
            // 機器重複チェック
            for (let i = 0; i < appointments.length; i++) {
                for (let j = i + 1; j < appointments.length; j++) {
                    const apt1 = appointments[i];
                    const apt2 = appointments[j];
                    
                    // 同じ日付かつ同じ機器の場合のみチェック（機器が設定されている場合のみ）
                    if (apt1.date === apt2.date && apt1.device && apt2.device && apt1.device === apt2.device) {
                        const start1 = timeToMinutes(apt1.startTime);
                        const end1 = start1 + apt1.duration;
                        const start2 = timeToMinutes(apt2.startTime);
                        const end2 = start2 + apt2.duration;
                        
                        // 時間重複チェック
                        if (start1 < end2 && start2 < end1) {
                            conflicts.push({
                                type: '機器重複',
                                details: `${apt1.device}: ${apt1.patientName}(${apt1.startTime}-${minutesToTime(end1)}) vs ${apt2.patientName}(${apt2.startTime}-${minutesToTime(end2)})`,
                                date: apt1.date
                            });
                        }
                    }
                }
            }
            
            // 休憩時間チェック（14:30-16:00）
            const breakStart = 14 * 60 + 30; // 14:30
            const breakEnd = 16 * 60; // 16:00
            
            appointments.forEach(apt => {
                const start = timeToMinutes(apt.startTime);
                const end = start + apt.duration;
                
                // 休憩時間と重複チェック
                if (start < breakEnd && end > breakStart) {
                    conflicts.push({
                        type: '休憩時間重複',
                        details: `${apt.patientName}(${apt.startTime}-${minutesToTime(end)}) - 休憩時間14:30-16:00と重複`,
                        date: apt.date
                    });
                }
            });
            
            // 結果表示
            console.log(`\n📊 ルール違反チェック結果: ${conflicts.length}件`);
            
            if (conflicts.length === 0) {
                console.log('✅ ルール違反は見つかりませんでした！');
            } else {
                conflicts.forEach((conflict, index) => {
                    console.log(`${index + 1}. [${conflict.type}] ${conflict.details} (${conflict.date})`);
                });
            }
            
            return conflicts;
        }
        
        // 時間を分に変換
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // 分を時間に変換
        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }
    </script>

    <!-- 患者閲覧モード用全画面オーバーレイ -->
    <div id="patientViewOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000;">
        <!-- 検索条件画面 -->
        <div id="patientSearchScreen" style="padding: 20px; height: 100%; overflow-y: auto;">
            <div style="max-width: 800px; margin: 0 auto;">
                <h2 style="text-align: center; margin-bottom: 40px; font-size: 28px; color: #2d3748;">希望の診療時間を選択してください</h2>
                
                <!-- 施術メニュー表示 -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px; font-size: 20px; color: #4a5568;">施術内容</h3>
                    <div id="patientSelectedTreatment" style="font-size: 24px; font-weight: bold; color: #2b6cb0;"></div>
                </div>
                
                <!-- 日付範囲選択 -->
                <div style="margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; font-size: 20px; color: #4a5568;">希望期間</h3>
                    <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px;">開始日</label>
                            <div style="position: relative;">
                                <input type="text" id="patientSearchStartDate" readonly required 
                                       placeholder="開始日を選択"
                                       onclick="calendar.openPatientDatePicker()"
                                       style="cursor: pointer; background: white; padding: 12px; padding-right: 50px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 8px; width: 180px;">
                                <button type="button" onclick="calendar.openPatientDatePicker()" 
                                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; font-size: 20px; color: #4a5568; cursor: pointer;">
                                    📅
                                </button>
                            </div>
                        </div>
                        <div style="font-size: 24px; color: #718096;">〜</div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px;">終了日</label>
                            <div style="position: relative;">
                                <input type="text" id="patientSearchEndDate" readonly required 
                                       placeholder="終了日を選択"
                                       onclick="calendar.openPatientDatePicker()"
                                       style="cursor: pointer; background: white; padding: 12px; padding-right: 50px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 8px; width: 180px;">
                                <button type="button" onclick="calendar.openPatientDatePicker()" 
                                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; font-size: 20px; color: #4a5568; cursor: pointer;">
                                    📅
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 期間ボタン -->
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                        <button type="button" onclick="calendar.setPatientQuickPeriod(7)" 
                                style="padding: 12px 24px; font-size: 16px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            1週間
                        </button>
                        <button type="button" onclick="calendar.setPatientQuickPeriod(14)" 
                                style="padding: 12px 24px; font-size: 16px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            2週間
                        </button>
                        <button type="button" onclick="calendar.setPatientQuickPeriod(28)" 
                                style="padding: 12px 24px; font-size: 16px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            1ヶ月
                        </button>
                    </div>
                </div>
                
                <!-- 検索ボタン -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button type="button" onclick="calendar.patientSearchSlots()" 
                            style="padding: 15px 50px; font-size: 20px; background: #48bb78; color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        空き時間を検索
                    </button>
                </div>
                
                <!-- 検索結果 -->
                <div id="patientSearchResults" style="display: none;">
                    <!-- ソートタブ -->
                    <div class="patient-search-tabs" style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">
                        <button class="patient-search-tab active" data-sort="earliest" onclick="calendar.switchPatientSearchTab('earliest', event)" 
                                style="padding: 8px 16px; border: none; background: #667eea; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            最も早い時間順
                        </button>
                        <button class="patient-search-tab" data-sort="available" onclick="calendar.switchPatientSearchTab('available', event)" 
                                style="padding: 8px 16px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            空き枠が多い順
                        </button>
                    </div>
                    
                    <div id="patientResultsList"></div>
                </div>
                
                <!-- 戻るボタン -->
                <div style="position: fixed; top: 20px; right: 20px;">
                    <button onclick="calendar.exitPatientViewMode()" 
                            style="padding: 12px 20px; font-size: 16px; background: #e53e3e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        スタッフ画面に戻る
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 予約確認・返却画面 -->
        <div id="patientConfirmScreen" style="display: none; padding: 20px; height: 100%; overflow-y: auto;">
            <div style="max-width: 600px; margin: 0 auto; text-align: center; padding-top: 100px;">
                <div style="background: #f7fafc; padding: 40px; border-radius: 12px; margin-bottom: 40px;">
                    <h2 style="margin-bottom: 30px; font-size: 28px; color: #2d3748;">選択された予約</h2>
                    
                    <div id="patientSelectedDetails" style="margin-bottom: 30px; font-size: 20px; color: #4a5568;">
                        <!-- 選択内容がここに表示される -->
                    </div>
                    
                    <div style="background: #fed7d7; padding: 20px; border-radius: 8px; margin: 30px 0;">
                        <p style="font-size: 22px; color: #c53030; font-weight: bold; margin: 0;">
                            📱 スタッフに端末を返却してください
                        </p>
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <label style="display: block; margin-bottom: 15px; font-size: 18px; color: #4a5568;">スタッフ確認パスワード</label>
                        <input type="password" id="staffPassword" placeholder="パスワードを入力" 
                               style="padding: 15px; font-size: 18px; border: 2px solid #e2e8f0; border-radius: 8px; width: 200px; text-align: center; margin-bottom: 20px;">
                        <br>
                        <button onclick="calendar.confirmStaffPassword()" 
                                style="padding: 15px 30px; font-size: 18px; background: #4299e1; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            確認
                        </button>
                    </div>
                </div>
                
                <!-- 戻るボタン -->
                <button onclick="calendar.backToPatientSearch()" 
                        style="padding: 12px 24px; font-size: 16px; background: #a0aec0; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    時間を選び直す
                </button>
            </div>
        </div>
    </div>

</body>
</html>